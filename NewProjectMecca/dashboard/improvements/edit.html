<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ุชุนุฏูู ุงููุดุฑูุน ุงูุชุญุณููู</title>

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme:{ extend:{ colors:{ primary:'#002B5B' } } } }
  </script>

  <!-- Tajawal -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>body{font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,sans-serif}</style>

  <!-- ูููุฉ ูุดุฑูุนู -->
  <link rel="stylesheet" href="../hospital/hospital.css">
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- Header - ุดุฑูุท ุงูุชููู ุงูุนููู -->
  <header id="navbar" class="fixed w-full top-0 z-50 navbar-scroll" style="background-color: #002B5B;">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <!-- Logo - ุงูุดุนุงุฑ -->
        <div class="flex items-center">
          <img src="../../public/assets/img/logo3.png" alt="ุดุนุงุฑ ุชุฌูุน ููุฉ ุงูููุฑูุฉ ุงูุตุญู" class="h-16 w-auto">
        </div>
        
        <!-- Navigation - ูุงุฆูุฉ ุงูุชููู -->
        <nav class="hidden md:flex items-center space-x-reverse space-x-8">
          <a href="../../index/index.html" id="nav-home" class="text-white hover:text-blue-200 transition-colors">ุงูุฑุฆูุณูุฉ</a>
          <a href="../dashboard.html" id="nav-dashboard" class="text-white hover:text-blue-200 transition-colors">ููุญุฉ ุงูุชุญูู</a>
          <a href="../../public/profile.html" id="nav-profile" class="text-white hover:text-blue-200 transition-colors hidden">ูููู ุงูุดุฎุตู</a>
          <a href="../../index/about-system.html" id="nav-about" class="text-white hover:text-blue-200 transition-colors">ุญูู ุงููุธุงู</a>
          <a href="../../index/help.html" id="nav-help" class="text-white hover:text-blue-200 transition-colors">ุงููุณุงุนุฏุฉ</a>
          <a href="../../index/contact.html" id="nav-contact" class="text-white hover:text-blue-200 transition-colors">ุงุชุตู ุจูุง</a>
          <button id="languageToggle" class="text-white hover:text-blue-200 transition-colors flex items-center">
            ๐ English
          </button>
        </nav>
        
        <!-- Mobile menu button - ุฒุฑ ุงููุงุฆูุฉ ููููุจุงูู -->
        <button class="md:hidden text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <div class="pt-20 max-w-4xl mx-auto px-4 md:px-6 lg:px-8 py-8">

    <!-- ุดุฑูุท ุงูุชููู -->
    <div class="flex items-center gap-4 mb-6">
      <button onclick="history.back()" class="flex items-center gap-2 text-gray-600 hover:text-gray-800">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        ุงูุนูุฏุฉ
      </button>
      <div class="h-6 w-px bg-gray-300"></div>
      <h1 class="text-2xl font-bold text-gray-900">ุชุนุฏูู ุงููุดุฑูุน ุงูุชุญุณููู</h1>
    </div>

    <!-- ูููุฐุฌ ุงูุชุนุฏูู -->
    <form id="editForm" class="space-y-6">
      <!-- Loading -->
      <div id="loading" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
        <p class="mt-2 text-gray-500">ุฌุงุฑู ุชุญููู ุจูุงูุงุช ุงููุดุฑูุน...</p>
      </div>

      <!-- Error -->
      <div id="error" class="hidden bg-red-50 border border-red-200 rounded-xl p-6 text-center">
        <div class="text-red-600 mb-2">ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงููุดุฑูุน</div>
        <button onclick="loadProject()" class="text-red-600 hover:text-red-800 underline">ุฅุนุงุฏุฉ ุงููุญุงููุฉ</button>
      </div>

      <!-- Form Content -->
      <div id="formContent" class="hidden space-y-6">
        <!-- Basic Info -->
        <div class="bg-white rounded-2xl border border-gray-100 shadow p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ุนููุงู ุงููุดุฑูุน *</label>
              <input type="text" id="title" name="title" required
                     class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ุงููุณู *</label>
              <select id="departmentId" name="departmentId" required
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent">
                <option value="">ุงุฎุชุฑ ุงููุณู</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ุงูุญุงูุฉ *</label>
              <select id="status" name="status" required
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent">
                <option value="DRAFT">ูุณูุฏุฉ</option>
                <option value="PROPOSED">ููุชุฑุญ</option>
                <option value="APPROVED">ูุนุชูุฏ</option>
                <option value="IN_PROGRESS">ููุฏ ุงูุชูููุฐ</option>
                <option value="COMPLETED">ููุชูู</option>
                <option value="CANCELLED">ููุบู</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ุงูุฃููููุฉ *</label>
              <select id="priority" name="priority" required
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent">
                <option value="LOW">ููุฎูุถุฉ</option>
                <option value="MEDIUM">ูุชูุณุทุฉ</option>
                <option value="HIGH">ุนุงููุฉ</option>
                <option value="CRITICAL">ุญุฑุฌุฉ</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Timeline -->
        <div class="bg-white rounded-2xl border border-gray-100 shadow p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">ุงูุฌุฏูู ุงูุฒููู</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ุชุงุฑูุฎ ุงูุจุฏุงูุฉ</label>
              <input type="date" id="startDate" name="startDate"
                     class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ุชุงุฑูุฎ ุงูุงูุชูุงุก ุงููุชููุน</label>
              <input type="date" id="dueDate" name="dueDate"
                     class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
          </div>
        </div>

        <!-- Project Details -->
        <div class="bg-white rounded-2xl border border-gray-100 shadow p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">ุชูุงุตูู ุงููุดุฑูุน</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ูุตู ุงููุดููุฉ *</label>
              <textarea id="problemStatement" name="problemStatement" rows="4" required
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent"
                        placeholder="ูุตู ุงููุดููุฉ ุงูุชู ูุญุงูู ุงููุดุฑูุน ุญููุง..."></textarea>
            </div>
            <!-- ูุนุงููุฑ SMART -->
            <div class="bg-white rounded-xl border border-gray-200 p-5 mb-4">
              <div class="mb-4">
                <h3 class="text-lg font-semibold text-gray-900">ูุนุงููุฑ SMART ูููุฏู ุงูุชุญุณููู</h3>
                <p class="text-sm text-gray-600 mt-1">
                  ุญุฏุฏู ุงููุนุงููุฑ ุงููุชููุฑุฉ ูู ุงููุฏู ุงูุฎุงุต ุจุงููุดุฑูุน ุงูุชุญุณููู.
                </p>
              </div>

              <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                  <thead>
                    <tr class="bg-gray-50 border-b border-gray-200">
                      <th class="text-right py-3 px-4 font-semibold text-sm text-gray-700">ุงููุนูุงุฑ</th>
                      <th class="text-right py-3 px-4 font-semibold text-sm text-gray-700">ุงููุตู</th>
                      <th class="text-center py-3 px-4 font-semibold text-sm text-gray-700">ูุชููุฑ ูู ุงููุฏูุ</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                      <td class="py-3 px-4 text-sm font-medium text-gray-900">ูุญุฏุฏ (Specific)</td>
                      <td class="py-3 px-4 text-sm text-gray-600">ูุตู ุงููุฏู ุจูุถูุญ ูุจุดูู ูุญุฏุฏ.</td>
                      <td class="py-3 px-4 text-center">
                        <input type="checkbox" id="smart_specific" name="SmartSpecific" 
                               class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                      </td>
                    </tr>

                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                      <td class="py-3 px-4 text-sm font-medium text-gray-900">ูุงุจู ููููุงุณ (Measurable)</td>
                      <td class="py-3 px-4 text-sm text-gray-600">ุญุฏุฏ ููููุฉ ููุงุณ ุงูุชูุฏู ุฃู ุงููุฌุงุญ ุจุงูุฃุฑูุงู ุฃู ุงููุณุจ.</td>
                      <td class="py-3 px-4 text-center">
                        <input type="checkbox" id="smart_measurable" name="SmartMeasurable"
                               class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                      </td>
                    </tr>

                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                      <td class="py-3 px-4 text-sm font-medium text-gray-900">ูุงุจู ููุชุญูู (Achievable)</td>
                      <td class="py-3 px-4 text-sm text-gray-600">ูู ูููู ุชุญููู ุงููุฏู ูุนูุงู ุจุงูุฅููุงููุงุช ุงูุญุงููุฉุ</td>
                      <td class="py-3 px-4 text-center">
                        <input type="checkbox" id="smart_achievable" name="SmartAchievable"
                               class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                      </td>
                    </tr>

                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                      <td class="py-3 px-4 text-sm font-medium text-gray-900">ูุงูุนู (Realistic)</td>
                      <td class="py-3 px-4 text-sm text-gray-600">ูู ุงููุฏู ููุงุณุจ ูููุงูุน ุงูุญุงูู ูุงูุฅููุงููุงุชุ</td>
                      <td class="py-3 px-4 text-center">
                        <input type="checkbox" id="smart_realistic" name="SmartRealistic"
                               class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                      </td>
                    </tr>

                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                      <td class="py-3 px-4 text-sm font-medium text-gray-900">ุจุฒูู ูุญุฏุฏ (Time-bound)</td>
                      <td class="py-3 px-4 text-sm text-gray-600">ุญุฏุฏ ุงูุฅุทุงุฑ ุงูุฒููู ูุชุญููู ุงููุฏู.</td>
                      <td class="py-3 px-4 text-center">
                        <input type="checkbox" id="smart_timebound" name="SmartTimebound"
                               class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ุงููุฏู ูู ุงููุดุฑูุน *</label>
              <p class="text-xs text-gray-500 mb-2">ุงูุชุจ/ู ุงููุฏู ุงูููุงุฆู ุจุตูุบุฉ ุชุฌูุน ูู ุงููุนุงููุฑ ุงูุณุงุจูุฉ.</p>
              <textarea id="aimStatement" name="aimStatement" rows="4" required
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent"
                        placeholder="ุงููุฏู ุงููุญุฏุฏ ูู ูุฐุง ุงููุดุฑูุน..."></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ูุนุงููุฑ ุงููุฌุงุญ</label>
              <textarea id="successCriteria" name="successCriteria" rows="3"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent"
                        placeholder="ููู ุณูุชู ููุงุณ ูุฌุงุญ ุงููุดุฑูุน..."></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ูุฑูู ุงูุนูู ูุงูููุงู</label>
              
              <!-- ูุงุฆูุฉ ุงููุฑูู -->
              <div id="teamEditList" class="space-y-3 mb-3"></div>
              
              <!-- ุฃุฒุฑุงุฑ ุงูุฅุถุงูุฉ -->
              <button type="button" id="btnAddMember"
                      class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors text-sm font-medium">
                โ ุฅุถุงูุฉ ุนุถู ุฌุฏูุฏ
              </button>
              
              <p class="text-xs text-gray-500 mt-2">ููููู ุฅุฏุฎุงู ุฃุณูุงุก ุฃุนุถุงุก ุงููุฑููุ ููุงูููุ ูุชุญุฏูุฏ ูุง ุฅุฐุง ุชู ุชูููุฐ ุงููููุฉ ุฃู ูุง.</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ููุงุญุธุงุช ุงูุชูุฏู</label>
              <textarea id="progressNotes" name="progressNotes" rows="3"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent"
                        placeholder="ููุงุญุธุงุช ุญูู ุชูุฏู ุงููุดุฑูุน..."></textarea>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex justify-end gap-4">
          <button type="button" onclick="history.back()"
                  class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
            ุฅูุบุงุก
          </button>
          <button type="submit" id="btnSave"
                  class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-[#00366f] disabled:opacity-50">
            ุญูุธ ุงูุชุบููุฑุงุช
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-6 right-6 z-[9999] hidden">
    <div id="toastInner" class="rounded-xl shadow-lg px-4 py-3 text-sm"></div>
  </div>

  <script>
    const API_BASE = localStorage.getItem('apiBase') || 'http://localhost:3001';
    const token = localStorage.getItem('token') || '';
    const projectId = new URLSearchParams(window.location.search).get('id');

    // โ ุฏุงูุฉ ููุญูุฏุฉ ูุฅูุฌุงุฏ hospitalId (ุญุชู ููุฏูุฑ ุงูุชุฌูุน)
    function effectiveHospitalId() {
      const u = JSON.parse(localStorage.getItem('userData') || '{}');
      const q = new URLSearchParams(location.search);
      const fromUrl = Number(q.get('hospitalId') || q.get('hid') || 0);
      const fromLS1 = Number(localStorage.getItem('selectedHospitalId') || 0);
      const fromLS2 = Number(localStorage.getItem('hospitalId') || 0);
      const fromUser = Number(u.HospitalID || u.hospitalId || u.hid || 0);
      return fromUrl || fromLS1 || fromLS2 || fromUser || null;
    }

    const $ = (s,c=document)=>c.querySelector(s);

    const loadingEl = $('#loading');
    const errorEl = $('#error');
    const formContentEl = $('#formContent');
    const formEl = $('#editForm');
    const btnSave = $('#btnSave');

    const toast = (msg, type='info')=>{
      const el = $('#toast'), box = $('#toastInner');
      const cls = {
        success:'bg-green-600 text-white',
        error:'bg-red-600 text-white',
        info:'bg-gray-800 text-white',
        warn:'bg-amber-500 text-white'
      }[type] || 'bg-gray-800 text-white';
      box.className = 'rounded-xl shadow-lg px-4 py-3 text-sm ' + cls;
      box.textContent = msg; el.classList.remove('hidden');
      setTimeout(()=>el.classList.add('hidden'), 2500);
    };

    // โ ุชุญุฏูุซ authHeaders ูุฅุถุงูุฉ x-hospital-id ุฏุงุฆูุงู ุฅุฐุง ุชููุฑ
    const authHeaders = () => {
      const h = token ? { 'Authorization': 'Bearer ' + token } : {};
      const hid = effectiveHospitalId();
      if (hid) h['x-hospital-id'] = String(hid);
      return h;
    };

    // ูุญุต ุงูุตูุงุญูุงุช ูุจู ุงูุณูุงุญ ุจุงูุชุนุฏูู
    async function ensureCanEdit(){
      const hid = effectiveHospitalId();
      const url = `${API_BASE}/api/permissions/me${hid ? '?hospitalId=' + hid : ''}`;
      const r = await fetch(url, { headers: authHeaders(), credentials:'include' });
      const p = r.ok ? (await r.json()).data || {} : {};
      
      // ูุฏูุฑ ุงูุชุฌูุน (RoleID = 1) ูุฑู ูู ุดูุก ุจุฏูู ูููุฏ
      const isCentralAdmin = p.adminPanel && !p.hospitalCreate; // ูุฏูุฑ ุงูุชุฌูุน ุงููุฑูุฒู
      
      if (isCentralAdmin) {
        return; // ูุฏูุฑ ุงูุชุฌูุน ููููู ุงููุตูู
      }
      
      if (!p || p.improvementCreate || p.adminPanel) return; // ูู ุนูุฏู ุฅูุดุงุก ูุนุชุจุฑู ุบุงูุจุงู ูุคูู ููุชุนุฏูู (ุงุฎุชูุงุฑู)
      if (!p || !p.statusUpdate) { /* ุงุฎุชูุงุฑู ุญุณุจ ุณูุงุณุงุชู */ }
      // ุงูุฃูู:
      if (!p.improvementEdit) {
        toast('ูุง ุชููู ุตูุงุญูุฉ ุงูุชุนุฏูู', 'error');
        history.back();
        throw new Error('NO_EDIT_PERMISSION');
      }
    }

    // ุชุญููู ุงูุฃูุณุงู
    async function loadDepartments(){
      try{
        const hid = effectiveHospitalId();
        const url = `${API_BASE}/api/departments${hid ? '?hospitalId=' + hid : ''}`;
        const res = await fetch(url, { headers: authHeaders() });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        const list = data.items || data.data || data || [];
        const select = $('#departmentId');
        select.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุณู</option>';
        list.forEach(d=>{
          const o=document.createElement('option');
          o.value=d.DepartmentID; o.textContent=d.NameAr || d.DepartmentName || d.Name;
          select.appendChild(o);
        });
      }catch(e){ 
        console.error('Load departments error:', e);
        toast('ุชุนุฐูุฑ ุชุญููู ุงูุฃูุณุงู', 'error'); 
      }
    }

    async function loadProject(){
      if (!projectId) {
        showError('ูุนุฑู ุงููุดุฑูุน ุบูุฑ ุตุญูุญ');
        return;
      }

      loadingEl.classList.remove('hidden');
      errorEl.classList.add('hidden');
      formContentEl.classList.add('hidden');

      try {
        const hid = effectiveHospitalId();
        if (!hid) {
          showError('ูู ูุชู ุชุญุฏูุฏ ุงููุณุชุดูู. ูุฑุฌู ุงูุชุฃูุฏ ูู ุชุณุฌูู ุงูุฏุฎูู.');
          return;
        }
        
        const url = `${API_BASE}/api/improvements/${encodeURIComponent(projectId)}${hid ? '?hospitalId=' + hid : ''}`;
        console.log('Loading project:', { projectId, hospitalId: hid, url });
        
        const res = await fetch(url, { headers: authHeaders() });
        
        if (!res.ok) {
          if (res.status === 404) {
            const errorMsg = `ุงููุดุฑูุน (ID: ${projectId}) ุบูุฑ ููุฌูุฏ ูู ุงููุณุชุดูู (ID: ${hid}) ุฃู ุชู ุญุฐูู.`;
            console.error(errorMsg);
            showError(errorMsg);
            return;
          }
          const errorData = await res.json().catch(() => ({ error: 'ุฎุทุฃ ุบูุฑ ูุนุฑูู' }));
          throw new Error(errorData.error || 'HTTP ' + res.status);
        }
        
        const project = await res.json();
        console.log('Project loaded:', project);
        
        if (!project || !project.ProjectID) {
          showError('ุจูุงูุงุช ุงููุดุฑูุน ุบูุฑ ุตุญูุญุฉ');
          return;
        }
        
        populateForm(project);
        
        loadingEl.classList.add('hidden');
        formContentEl.classList.remove('hidden');
        
      } catch (e) {
        console.error('Error loading project:', e);
        showError('ูุดู ูู ุชุญููู ุจูุงูุงุช ุงููุดุฑูุน: ' + e.message);
      }
    }

    function showError(message) {
      loadingEl.classList.add('hidden');
      errorEl.classList.remove('hidden');
      formContentEl.classList.add('hidden');
      
      // ุชุญุฏูุซ ุฑุณุงูุฉ ุงูุฎุทุฃ ูู ุงูู HTML
      const errorMessageEl = errorEl.querySelector('.text-red-600');
      if (errorMessageEl) {
        errorMessageEl.textContent = message || 'ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงููุดุฑูุน';
      }
      
      toast(message || 'ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงููุดุฑูุน', 'error');
    }

    function populateForm(project) {
      $('#title').value = project.Title || '';
      $('#departmentId').value = project.DepartmentID || '';
      $('#status').value = project.Status || 'DRAFT';
      $('#priority').value = project.Priority || 'MEDIUM';
      $('#startDate').value = project.StartDate ? project.StartDate.split('T')[0] : '';
      $('#dueDate').value = project.DueDate ? project.DueDate.split('T')[0] : '';
      $('#problemStatement').value = project.ProblemStatement || '';
      $('#aimStatement').value = project.AimStatement || '';
      $('#successCriteria').value = project.SuccessCriteria || '';
      // ุชุญููู ูุฑูู ุงูุนูู
      renderExistingTeam(project.TeamMembers || '');
      $('#progressNotes').value = project.ProgressNotes || '';
      // ูุนุงููุฑ SMART
      $('#smart_specific').checked = project.SmartSpecific === 1 || project.SmartSpecific === true;
      $('#smart_measurable').checked = project.SmartMeasurable === 1 || project.SmartMeasurable === true;
      $('#smart_achievable').checked = project.SmartAchievable === 1 || project.SmartAchievable === true;
      $('#smart_realistic').checked = project.SmartRealistic === 1 || project.SmartRealistic === true;
      $('#smart_timebound').checked = project.SmartTimebound === 1 || project.SmartTimebound === true;
    }

    // Form submission
    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      btnSave.disabled = true;
      btnSave.textContent = 'ุฌุงุฑู ุงูุญูุธ...';

      try {
        const formData = new FormData(formEl);
        const raw = Object.fromEntries(formData.entries());
        
        // ุชุญููู ุฃุณูุงุก ุงูุญููู ูุชุทุงุจู ูุง ูุชููุนู ุงูู backend (ุฃุญุฑู ูุจูุฑุฉ ูู ุงูุจุฏุงูุฉ)
        const data = {
          Title: raw.title?.trim() || '',
          ProblemStatement: raw.problemStatement?.trim() || '',
          AimStatement: raw.aimStatement?.trim() || '',
          DepartmentID: raw.departmentId ? Number(raw.departmentId) : null,
          Priority: raw.priority || 'MEDIUM',
          Status: raw.status || 'DRAFT',
          StartDate: raw.startDate || null,
          DueDate: raw.dueDate || null,
          BudgetEstimate: raw.budgetEstimate ? parseFloat(raw.budgetEstimate) : null,
          SuccessCriteria: raw.successCriteria?.trim() || null,
          TeamMembers: collectTeamMembersForSave().length > 0 ? JSON.stringify(collectTeamMembersForSave()) : null,
          ProgressNotes: raw.progressNotes?.trim() || null,
          // ูุนุงููุฑ SMART
          SmartSpecific: $('#smart_specific').checked,
          SmartMeasurable: $('#smart_measurable').checked,
          SmartAchievable: $('#smart_achievable').checked,
          SmartRealistic: $('#smart_realistic').checked,
          SmartTimebound: $('#smart_timebound').checked
        };

        const hid = effectiveHospitalId();
        const url = `${API_BASE}/api/improvements/${encodeURIComponent(projectId)}${hid ? '?hospitalId=' + hid : ''}`;
        const res = await fetch(url, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            ...authHeaders()
          },
          body: JSON.stringify(data)
        });

        if (!res.ok) {
          const errorData = await res.json().catch(() => ({ error: 'ุฎุทุฃ ุบูุฑ ูุนุฑูู' }));
          throw new Error(errorData.error || 'HTTP ' + res.status);
        }

        const result = await res.json();
        toast(result.message || 'ุชู ุญูุธ ุงูุชุบููุฑุงุช ุจูุฌุงุญ', 'success');
        setTimeout(() => {
          window.location.href = `./view.html?id=${projectId}`;
        }, 1500);

      } catch (e) {
        console.error('Error saving project:', e);
        toast('ูุดู ูู ุญูุธ ุงูุชุบููุฑุงุช: ' + e.message, 'error');
      } finally {
        btnSave.disabled = false;
        btnSave.textContent = 'ุญูุธ ุงูุชุบููุฑุงุช';
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await ensureCanEdit();
      await loadDepartments();
      await loadProject();
    });
  </script>

  <!-- ูุธุงู ุงูุชุฑุฌูุฉ -->
  <script>
    // ุจูุงูุงุช ุงูุชุฑุฌูุฉ
    const translations = {
      ar: {
        'nav-home': 'ุงูุฑุฆูุณูุฉ',
        'nav-dashboard': 'ููุญุฉ ุงูุชุญูู',
        'nav-profile': 'ูููู ุงูุดุฎุตู',
        'nav-about': 'ุญูู ุงููุธุงู',
        'nav-help': 'ุงููุณุงุนุฏุฉ',
        'nav-contact': 'ุงุชุตู ุจูุง',
        'language-button': '๐ English'
      },
      en: {
        'nav-home': 'Home',
        'nav-dashboard': 'Dashboard',
        'nav-profile': 'My Profile',
        'nav-about': 'About System',
        'nav-help': 'Help',
        'nav-contact': 'Contact Us',
        'language-button': '๐ ุงูุนุฑุจูุฉ'
      }
    };

    // ุงูุญุงูุฉ ุงูุญุงููุฉ ููุบุฉ
    let currentLanguage = 'ar';

    // ุฏุงูุฉ ุชุทุจูู ุงูุชุฑุฌูุฉ
    function applyTranslation(lang) {
      const elements = translations[lang];
      if (!elements) return;

      // ุชุทุจูู ุงูุชุฑุฌูุฉ ุนูู ุฌููุน ุงูุนูุงุตุฑ
      Object.keys(elements).forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = elements[id];
        }
      });

      // ุชุบููุฑ ุงุชุฌุงู ุงููุต
      if (lang === 'en') {
        document.documentElement.setAttribute('dir', 'ltr');
        document.documentElement.setAttribute('lang', 'en');
      } else {
        document.documentElement.setAttribute('dir', 'rtl');
        document.documentElement.setAttribute('lang', 'ar');
      }

      currentLanguage = lang;
    }

    // ุชููุฆุฉ ุงููุธุงู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
    document.addEventListener('DOMContentLoaded', function() {
      // ุชุทุจูู ุงููุบุฉ ุงููุญููุธุฉ ุฃู ุงูุงูุชุฑุงุถูุฉ
      const savedLanguage = localStorage.getItem('selectedLanguage') || 'ar';
      applyTranslation(savedLanguage);
      
      // ุฑุจุท ุฒุฑ ุงููุบุฉ
      const languageToggle = document.getElementById('languageToggle');
      if (languageToggle) {
        languageToggle.addEventListener('click', function() {
          const newLang = currentLanguage === 'ar' ? 'en' : 'ar';
          applyTranslation(newLang);
          localStorage.setItem('selectedLanguage', newLang);
        });
      }
    });

    // -------------------------
    // ูุงุฆูุฉ ูุฑูู ุงูุนูู ุงูุชูุงุนููุฉ ูุน ุญุงูุฉ ุงูุชูููุฐ
    // -------------------------
    const teamEditList = document.getElementById('teamEditList');
    const btnAddMember = document.getElementById('btnAddMember');

    if (btnAddMember) {
      btnAddMember.addEventListener('click', () => addTeamMemberRow());
    }

    // ุฅูุดุงุก ุตู ุฌุฏูุฏ ูุนุถู ูุฑูู
    function addTeamMemberRow(member = { name: '', task: '', done: false }) {
      if (!teamEditList) return;
      
      const div = document.createElement('div');
      div.className = "border border-gray-300 rounded-lg p-4 bg-gray-50 space-y-3 relative shadow-sm transition-all hover:shadow-md";

      const escapedName = (member.name || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const escapedTask = (member.task || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

      div.innerHTML = `
        <button type="button" class="absolute top-2 left-2 text-red-500 hover:text-red-700 text-lg font-bold remove-member w-6 h-6 flex items-center justify-center rounded-full hover:bg-red-50 transition-colors" title="ุญุฐู ุงูุนุถู">โ</button>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-start pt-1">
          <div>
            <label class="text-sm font-medium text-gray-700 mb-1 block">ุงุณู ุงูุนุถู</label>
            <input type="text" class="member-name w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-transparent" value="${escapedName}" placeholder="ูุซูุงู: ุฏ. ุณุงุฑุฉ ุงูุนุชูุจู">
          </div>
          <div>
            <label class="text-sm font-medium text-gray-700 mb-1 block">ุงููููุฉ</label>
            <input type="text" class="member-task w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-transparent" value="${escapedTask}" placeholder="ูุซูุงู: ูุชุงุจุนุฉ ุงูุชุญููู...">
          </div>
          <div class="flex items-center gap-2 mt-6">
            <input type="checkbox" class="member-done w-5 h-5 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500" ${member.done ? 'checked' : ''}>
            <label class="text-sm text-gray-700 font-medium cursor-pointer">ุชู ุงูุชูููุฐ</label>
          </div>
        </div>
      `;
      
      teamEditList.appendChild(div);

      // ุฒุฑ ุญุฐู ุงูุนุถู
      div.querySelector('.remove-member').addEventListener('click', () => div.remove());
    }

    // ุชุญููู ุงููุฑูู ุงูุญุงูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    function renderExistingTeam(teamData) {
      if (!teamEditList) return;
      
      teamEditList.innerHTML = '';
      let team = [];
      
      try {
        team = JSON.parse(teamData || '[]');
      } catch (e) {
        // fallback ูู ุงููุต ูุฏูู (ูุงู plain text)
        const oldText = (teamData || '').trim();
        if (oldText) {
          team = [{ name: oldText, task: '', done: false }];
        }
      }
      
      if (!Array.isArray(team) || team.length === 0) {
        addTeamMemberRow();
      } else {
        team.forEach(m => addTeamMemberRow(m));
      }
    }

    // ุฌูุน ุงูุจูุงูุงุช ุนูุฏ ุงูุญูุธ
    function collectTeamMembersForSave() {
      const members = [];
      if (!teamEditList) return members;
      
      const rows = teamEditList.querySelectorAll('.border');
      rows.forEach(row => {
        const name = row.querySelector('.member-name')?.value.trim() || '';
        const task = row.querySelector('.member-task')?.value.trim() || '';
        const done = row.querySelector('.member-done')?.checked || false;
        if (name || task) {
          members.push({ name, task, done });
        }
      });
      return members;
    }

    // ุฏุงูุฉ ูุชุญููู ุจูุงูุงุช ุงููุฑูู ูู ุงููููุฐุฌ (ููุชูุงูู ูุน ุงูููุฏ ุงููุฏูู)
    function populateTeamMembers(teamMembersStr) {
      renderExistingTeam(teamMembersStr);
    }
  </script>
  <footer class="bg-gray-900 text-white py-14 mt-16">
    <div class="container mx-auto px-4">
      <div class="grid md:grid-cols-3 gap-8">
        <div>
          <div class="flex items-center space-x-reverse space-x-3 mb-4">
            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 2L2 7v10c0 5.55 3.84 9.74 9 11 5.16-1.26 9-5.45 9-11V7l-10-5z"/>
              </svg>
            </div>
            <div>
              <div class="font-bold">ุชุฌูุน ููุฉ ุงูุตุญู</div>
              <div class="text-sm text-gray-300">ูุธุงู ุงูุจูุงุบุงุช</div>
            </div>
          </div>
          <p class="text-gray-300 text-sm">ููุตุฉ ุฑุณููุฉ ูุชูุฏูู ููุชุงุจุนุฉ ุงูุจูุงุบุงุช</p>
        </div>

        <div>
          <h3 class="font-bold mb-4">ุฑูุงุจุท ุณุฑูุนุฉ</h3>
          <ul class="space-y-2 text-sm">
            <li><a href="../../index/index.html" class="text-gray-300 hover:text-white hover:underline transition-colors">ุงูุฑุฆูุณูุฉ</a></li>
            <li><a href="../../public/complaints/history/complaints-history.html" class="text-gray-300 hover:text-white hover:underline transition-colors">ุณุฌู ุงูุจูุงุบุงุช</a></li>
            <li><a href="../../index/help.html" class="text-gray-300 hover:text-white hover:underline transition-colors">ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ</a></li>
            <li><a href="../../index/contact.html" class="text-gray-300 hover:text-white hover:underline transition-colors">ุงุชุตู ุจูุง</a></li>
          </ul>
        </div>

        <div>
          <h3 class="font-bold mb-4">ูุนูููุงุช ุงูุชูุงุตู</h3>
          <div class="space-y-2 text-sm text-gray-300">
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
              <span>ุฑูู ุงูุฏุนู: 0559735137</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
              <span>support@makkahhealth.gov.sa</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span>ุณุงุนุงุช ุงูุนูู: 24/7</span>
            </div>
          </div>
        </div>
      </div>

      <div class="border-t border-gray-700 mt-8 pt-8 text-center text-sm text-gray-300">
        ยฉ 2025 ุชุฌูุน ููุฉ ุงูููุฑูุฉ ุงูุตุญู โ ุฌููุน ุงูุญููู ูุญููุธุฉ
      </div>
    </div>
  </footer>
</body>
</html>
