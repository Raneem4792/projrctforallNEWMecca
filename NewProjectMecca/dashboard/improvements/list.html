<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>المشاريع التحسينية</title>

  <!-- Tailwind via CDN -->
  <!-- Theme controller -->
  <script src="../../public/assets/js/theme.js"></script>

<script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme:{ extend:{ colors:{ primary:'#002B5B' } } } }
  </script>

  <!-- Tajawal -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>body{font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,sans-serif}</style>

  <!-- هوية مشروعك -->
    <link rel="stylesheet" href="../../public/assets/css/styles.css" />
<link rel="stylesheet" href="../hospital/hospital.css">
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- Header - شريط التنقل العلوي -->
  <header id="navbar" class="fixed w-full top-0 z-50 navbar-scroll" style="background-color: #002B5B;">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <!-- Logo - الشعار -->
        <div class="flex items-center">
          <img src="../../public/assets/img/logo3.png" alt="شعار تجمع مكة المكرمة الصحي" class="h-16 w-auto">
        </div>
        
        <!-- Navigation - قائمة التنقل -->
        <nav class="hidden md:flex items-center space-x-reverse space-x-8">
          <a href="../../index/index.html" id="nav-home" class="text-white hover:text-blue-200 transition-colors">الرئيسية</a>
          <a href="../dashboard.html" id="nav-dashboard" class="text-white hover:text-blue-200 transition-colors">لوحة التحكم</a>
          <a href="../../public/profile.html" id="nav-profile" class="text-white hover:text-blue-200 transition-colors hidden">ملفي الشخصي</a>
          <a href="../../index/about-system.html" id="nav-about" class="text-white hover:text-blue-200 transition-colors">حول النظام</a>
          <a href="../../index/help.html" id="nav-help" class="text-white hover:text-blue-200 transition-colors">المساعدة</a>
          <a href="../../index/contact.html" id="nav-contact" class="text-white hover:text-blue-200 transition-colors">اتصل بنا</a>
          <button id="languageToggle" class="text-white hover:text-blue-200 transition-colors flex items-center">
            🌐 English
          </button>
        </nav>
        
        <!-- Mobile menu button - زر القائمة للموبايل -->
        <button class="md:hidden text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <div class="pt-20 max-w-7xl mx-auto px-4 md:px-6 lg:px-8 py-8">

    <!-- العنوان + زر إضافة -->
    <div class="flex items-center justify-between gap-4 mb-6">
      <div>
        <h1 class="text-3xl md:text-4xl font-extrabold text-primary" data-i18n="page-title">المشاريع التحسينية</h1>
        <p class="text-gray-500 mt-1" data-i18n="page-subtitle">استعرض، صفِّ، وعدِّل مشاريع التحسين لكل مستشفى.</p>
      </div>
      <button id="btnAdd"
              class="rounded-full bg-blue-600 text-white px-5 py-2.5 text-sm font-medium hover:bg-blue-700 shadow-sm"
              data-i18n="btn-add">
        + مشروع تحسيني
      </button>
    </div>

    <!-- فلاتر -->
    <div class="bg-white border border-gray-100 rounded-2xl shadow p-4 md:p-5 mb-5">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3" id="filtersContainer">
        <!-- فلتر المستشفى (للمدير فقط) -->
        <div id="hospitalFilterContainer" class="hidden">
          <label class="block text-sm text-gray-600 mb-1" data-i18n="filter-hospital">المستشفى</label>
          <select id="fltHospital" class="w-full border rounded-xl p-2.5 bg-white">
            <option value="" data-i18n="filter-hospital-all">جميع المستشفيات</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1" data-i18n="filter-status-label">الحالة</label>
          <select id="fltStatus" class="w-full border rounded-xl p-2.5 bg-white">
            <option value="" data-i18n="filter-option-all">الكل</option>
            <option value="PROPOSED" data-i18n="filter-option-proposed">مقترح</option>
            <option value="APPROVED" data-i18n="filter-option-approved">معتمد</option>
            <option value="IN_PROGRESS" data-i18n="filter-option-in-progress">قيد التنفيذ</option>
            <option value="COMPLETED" data-i18n="filter-option-completed">مكتمل</option>
            <option value="CANCELLED" data-i18n="filter-option-cancelled">ملغي</option>
            <option value="DRAFT" data-i18n="filter-option-draft">مسودة</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1" data-i18n="filter-dept-label">القسم</label>
          <select id="fltDept" class="w-full border rounded-xl p-2.5 bg-white">
            <option value="" data-i18n="filter-option-all">الكل</option>
          </select>
        </div>
        <div class="md:col-span-2" id="searchContainer">
          <label class="block text-sm text-gray-600 mb-1" data-i18n="filter-search-label">بحث</label>
          <div class="flex gap-2">
            <input id="fltQ" class="w-full border rounded-xl p-2.5" placeholder="عنوان / وصف المشكلة / الهدف" data-i18n-placeholder="filter-search-placeholder">
            <button id="btnApply" class="px-4 py-2 rounded-xl bg-primary text-white hover:bg-[#00366f]" data-i18n="filter-apply">تطبيق</button>
            <button id="btnReset" class="px-4 py-2 rounded-xl border border-gray-300 hover:bg-gray-50" data-i18n="filter-reset">إعادة</button>
          </div>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-5">
      <div class="bg-white rounded-2xl border border-gray-100 shadow p-4">
        <div class="text-gray-500 text-sm" data-i18n="kpi-in-progress">مشاريع قيد التنفيذ</div>
        <div id="kpiInProgress" class="text-3xl font-bold mt-1">0</div>
      </div>
      <div class="bg-white rounded-2xl border border-gray-100 shadow p-4">
        <div class="text-gray-500 text-sm" data-i18n="kpi-completed-90">مشاريع مكتملة (آخر 90 يوم)</div>
        <div id="kpiCompleted" class="text-3xl font-bold mt-1">0</div>
      </div>
      <div class="bg-white rounded-2xl border border-gray-100 shadow p-4">
        <div class="text-gray-500 text-sm" data-i18n="kpi-proposed">مقترحة/قيد الاعتماد</div>
        <div id="kpiProposed" class="text-3xl font-bold mt-1">0</div>
      </div>
    </div>

    <!-- الجدول -->
    <div class="bg-white rounded-2xl border border-gray-100 shadow">
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50 text-gray-600">
            <tr>
              <th class="px-4 py-3 text-right" id="hospitalHeader" style="display: none;" data-i18n="th-hospital">المستشفى</th>
              <th class="px-4 py-3 text-right">نوع المشروع</th>
              <th class="px-4 py-3 text-right" data-i18n="th-title">العنوان</th>
              <th class="px-4 py-3 text-right" data-i18n="th-dept">القسم</th>
              <th class="px-4 py-3 text-right" data-i18n="th-priority">الأولوية</th>
              <th class="px-4 py-3 text-right" data-i18n="th-status">الحالة</th>
              <th class="px-4 py-3 text-right" data-i18n="th-start">البدء</th>
              <th class="px-4 py-3 text-right" data-i18n="th-due">الانتهاء المتوقع</th>
              <th class="px-4 py-3 text-right" data-i18n="th-updated">آخر تحديث</th>
              <th class="px-4 py-3 text-right" data-i18n="th-actions">إجراءات</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <!-- لا توجد بيانات -->
      <div id="emptyState" class="hidden py-16 text-center text-gray-500" data-i18n="empty-state">
        لا توجد مشاريع مطابقة للبحث الحالي.
      </div>
    </div>
  </div>

  <!-- Toast بسيط -->
  <div id="toast" class="fixed bottom-6 right-6 z-[9999] hidden">
    <div id="toastInner" class="rounded-xl shadow-lg px-4 py-3 text-sm"></div>
  </div>

  <footer class="bg-gray-900 text-white py-14 mt-16">
    <div class="container mx-auto px-4">
      <div class="grid md:grid-cols-3 gap-8">
        <div>
          <div class="flex items-center space-x-reverse space-x-3 mb-4">
            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 2L2 7v10c0 5.55 3.84 9.74 9 11 5.16-1.26 9-5.45 9-11V7l-10-5z"/>
              </svg>
            </div>
            <div>
              <div class="font-bold">تجمع مكة الصحي</div>
              <div class="text-sm text-gray-300">نظام البلاغات</div>
            </div>
          </div>
          <p class="text-gray-300 text-sm">منصة رسمية لتقديم ومتابعة البلاغات</p>
        </div>

        <div>
          <h3 class="font-bold mb-4">روابط سريعة</h3>
          <ul class="space-y-2 text-sm">
            <li><a href="../../index/index.html" class="text-gray-300 hover:text-white hover:underline transition-colors">الرئيسية</a></li>
            <li><a href="../../public/complaints/history/complaints-history.html" class="text-gray-300 hover:text-white hover:underline transition-colors">سجل البلاغات</a></li>
            <li><a href="../../index/help.html" class="text-gray-300 hover:text-white hover:underline transition-colors">الأسئلة الشائعة</a></li>
            <li><a href="../../index/contact.html" class="text-gray-300 hover:text-white hover:underline transition-colors">اتصل بنا</a></li>
          </ul>
        </div>

        <div>
          <h3 class="font-bold mb-4">معلومات التواصل</h3>
          <div class="space-y-2 text-sm text-gray-300">
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
              <span>رقم الدعم: 0559735137</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
              <span>support@makkahhealth.gov.sa</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span>ساعات العمل: 24/7</span>
            </div>
          </div>
        </div>
      </div>

      <div class="border-t border-gray-700 mt-8 pt-8 text-center text-sm text-gray-300">
        © 2025 تجمع مكة المكرمة الصحي – جميع الحقوق محفوظة
      </div>
    </div>
  </footer>

  <script>
    const API_BASE = localStorage.getItem('apiBase') || 'http://localhost:3001';
    const token    = localStorage.getItem('token') || '';
    let currentLanguage = localStorage.getItem('selectedLanguage') || 'ar';

    // ✅ دالة للتحقق من مدير التجمع
    function isClusterManager() {
      try {
        const u = JSON.parse(localStorage.getItem('userData') || '{}');
        return u.RoleID === 1 || u.IsClusterManager === true;
      } catch { return false; }
    }

    // ✅ دالة موحّدة لإيجاد hospitalId (حتى لمدير التجمع)
    function effectiveHospitalId() {
      const u = JSON.parse(localStorage.getItem('userData') || '{}');
      const q = new URLSearchParams(location.search);
      const fromUrl = Number(q.get('hospitalId') || q.get('hid') || 0);
      const fromLS1 = Number(localStorage.getItem('selectedHospitalId') || 0); // من صفحة الفلتر/القائمة
      const fromLS2 = Number(localStorage.getItem('hospitalId') || 0);
      const fromUser = Number(u.HospitalID || u.hospitalId || u.hid || 0);
      return fromUrl || fromLS1 || fromLS2 || fromUser || null;
    }

    let hospitalId = effectiveHospitalId();
    console.log('🏥 [improvements/list] effectiveHospitalId =', hospitalId, '| Cluster Manager:', isClusterManager());

    const $  = (s,c=document)=>c.querySelector(s);
    const $$ = (s,c=document)=>[...c.querySelectorAll(s)];

    const rowsEl = $('#rows');
    const emptyEl = $('#emptyState');
    const btnAdd = $('#btnAdd');
    const fltStatus = $('#fltStatus');
    const fltDept = $('#fltDept');
    const fltQ = $('#fltQ');
    const fltHospital = $('#fltHospital');
    const hospitalFilterContainer = $('#hospitalFilterContainer');
    const hospitalHeader = $('#hospitalHeader');
    
    // متغير لتخزين حالة المدير
    let isCentralAdmin = false;
    let lastProjects = [];
    let projectsLoaded = false;

    const I18N = {
      ar: {
        'page-title': 'المشاريع التحسينية',
        'page-subtitle': 'استعرض، صفِّ، وعدِّل مشاريع التحسين لكل مستشفى.',
        'btn-add': '+ مشروع تحسيني',
        'filter-hospital': 'المستشفى',
        'filter-hospital-all': 'جميع المستشفيات',
        'filter-status-label': 'الحالة',
        'filter-option-all': 'الكل',
        'filter-option-proposed': 'مقترح',
        'filter-option-approved': 'معتمد',
        'filter-option-in-progress': 'قيد التنفيذ',
        'filter-option-completed': 'مكتمل',
        'filter-option-cancelled': 'ملغي',
        'filter-option-draft': 'مسودة',
        'filter-dept-label': 'نوع المشروع',
        'filter-search-label': 'بحث',
        'filter-search-placeholder': 'عنوان / وصف المشكلة / الهدف',
        'filter-apply': 'تطبيق',
        'filter-reset': 'إعادة',
        'kpi-in-progress': 'مشاريع قيد التنفيذ',
        'kpi-completed-90': 'مشاريع مكتملة (آخر 90 يوم)',
        'kpi-proposed': 'مقترحة/قيد الاعتماد',
        'th-hospital': 'المستشفى',
        'th-title': 'العنوان',
        'th-dept': 'القسم',
        'th-priority': 'الأولوية',
        'th-status': 'الحالة',
        'th-start': 'البدء',
        'th-due': 'الانتهاء المتوقع',
        'th-updated': 'آخر تحديث',
        'th-actions': 'إجراءات',
        'empty-state': 'لا توجد مشاريع مطابقة للبحث الحالي.',
        'dept-select-hospital-first': 'اختر مستشفى أولاً',
        'nav-home': 'الرئيسية',
        'nav-dashboard': 'لوحة التحكم',
        'nav-profile': 'ملفي الشخصي',
        'nav-about': 'حول النظام',
        'nav-help': 'المساعدة',
        'nav-contact': 'اتصل بنا',
        'language-button': '🌐 English'
      },
      en: {
        'page-title': 'Improvement Projects',
        'page-subtitle': 'Review, filter, and edit improvement projects per hospital.',
        'btn-add': '+ Improvement Project',
        'filter-hospital': 'Hospital',
        'filter-hospital-all': 'All hospitals',
        'filter-status-label': 'Status',
        'filter-option-all': 'All',
        'filter-option-proposed': 'Proposed',
        'filter-option-approved': 'Approved',
        'filter-option-in-progress': 'In Progress',
        'filter-option-completed': 'Completed',
        'filter-option-cancelled': 'Cancelled',
        'filter-option-draft': 'Draft',
        'filter-dept-label': 'Project Type',
        'filter-search-label': 'Search',
        'filter-search-placeholder': 'Title / Problem / Aim',
        'filter-apply': 'Apply',
        'filter-reset': 'Reset',
        'kpi-in-progress': 'Projects In Progress',
        'kpi-completed-90': 'Completed Projects (last 90 days)',
        'kpi-proposed': 'Proposed / Pending approval',
        'th-hospital': 'Hospital',
        'th-title': 'Title',
        'th-dept': 'Department',
        'th-priority': 'Priority',
        'th-status': 'Status',
        'th-start': 'Start',
        'th-due': 'Expected finish',
        'th-updated': 'Last update',
        'th-actions': 'Actions',
        'empty-state': 'No projects match the current filters.',
        'dept-select-hospital-first': 'Select a hospital first',
        'nav-home': 'Home',
        'nav-dashboard': 'Dashboard',
        'nav-profile': 'My Profile',
        'nav-about': 'About System',
        'nav-help': 'Help',
        'nav-contact': 'Contact Us',
        'language-button': '🌐 العربية'
      }
    };

    function t(key, fallback='') {
      const lang = currentLanguage === 'en' ? 'en' : 'ar';
      return (I18N[lang] && I18N[lang][key]) || (I18N.ar && I18N.ar[key]) || fallback || key || '';
    }

    function updateFilterStatics(){
      if (fltHospital) {
        const defaultHospital = fltHospital.querySelector('option[value=""]');
        if (defaultHospital) {
          defaultHospital.dataset.i18n = 'filter-hospital-all';
          defaultHospital.textContent = t('filter-hospital-all', 'جميع المستشفيات');
        }
      }
      if (fltStatus) {
        const statusAll = fltStatus.querySelector('option[value=""]');
        if (statusAll) {
          statusAll.dataset.i18n = 'filter-option-all';
          statusAll.textContent = t('filter-option-all', 'الكل');
        }
      }
      if (fltDept) {
        const deptAll = fltDept.querySelector('option[value=""]');
        if (deptAll) {
          deptAll.dataset.i18n = 'filter-option-all';
          deptAll.textContent = t('filter-option-all', 'الكل');
        }
      }
      if (fltQ) {
        const placeholderKey = fltQ.dataset.i18nPlaceholder;
        if (placeholderKey) {
          fltQ.placeholder = t(placeholderKey, fltQ.placeholder);
        }
      }
    }

    const toast = (msg, type='info')=>{
      const el = $('#toast'), box = $('#toastInner');
      const cls = {
        success:'bg-green-600 text-white',
        error:'bg-red-600 text-white',
        info:'bg-gray-800 text-white',
        warn:'bg-amber-500 text-white'
      }[type] || 'bg-gray-800 text-white';
      box.className = 'rounded-xl shadow-lg px-4 py-3 text-sm ' + cls;
      box.textContent = msg; el.classList.remove('hidden');
      setTimeout(()=>el.classList.add('hidden'), 2500);
    };

    // ✅ تحديث authHeaders لإضافة x-hospital-id دائماً إذا توفر
    const authHeaders = () => {
      const h = token ? { 'Authorization': 'Bearer ' + token } : {};
      const hid = effectiveHospitalId();
      if (hid) h['x-hospital-id'] = String(hid);   // ✅ حتى لمدير التجمع
      return h;
    };

    // تحميل قائمة المستشفيات (للمدير فقط)
    async function loadHospitals(){
      try{
        const res = await fetch(`${API_BASE}/api/hospitals?active=1`, {
          headers: token ? { Authorization: `Bearer ${token}` } : {}
        });
        
        if(!res.ok) throw new Error('HTTP '+res.status);
        
        const hospitals = await res.json();
        fltHospital.innerHTML = '';

        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.dataset.i18n = 'filter-hospital-all';
        defaultOption.textContent = t('filter-hospital-all', 'جميع المستشفيات');
        fltHospital.appendChild(defaultOption);
        
        hospitals.forEach(h => {
          const option = document.createElement('option');
          option.value = h.HospitalID;
          option.textContent = h.NameAr || h.NameEn || `مستشفى ${h.Code}`;
          fltHospital.appendChild(option);
        });
        
        // إذا كان هناك hospitalId في الرابط، حدده
        const urlParams = new URLSearchParams(location.search);
        const preHospitalId = urlParams.get('hospitalId') || urlParams.get('hid');
        if (preHospitalId) {
          fltHospital.value = preHospitalId;
        }
        updateFilterStatics();
      }catch(e){ 
        console.error('❌ [loadHospitals] Error:', e);
        toast('تعذّر تحميل المستشفيات', 'error'); 
      }
    }

    // تحميل خيارات نوع المشروع (بدلاً من الأقسام)
    async function loadDepartments(){
      try{
        fltDept.innerHTML = '';
        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.dataset.i18n = 'filter-option-all';
        defaultOpt.textContent = t('filter-option-all', 'الكل');
        fltDept.appendChild(defaultOpt);

        const types = [
          { value: 'OTHER', labelAr: 'أخرى', labelEn: 'Other' },
          { value: 'PRESSGANEY', labelAr: 'PressGaney', labelEn: 'PressGaney' },
          { value: '937', labelAr: '937', labelEn: '937' }
        ];
        const lang = currentLanguage === 'en' ? 'en' : 'ar';
        types.forEach(ti => {
          const o = document.createElement('option');
          o.value = ti.value;
          o.textContent = lang === 'en' ? (ti.labelEn || ti.labelAr) : (ti.labelAr || ti.labelEn);
          fltDept.appendChild(o);
        });
        updateFilterStatics();
      }catch(e){
        console.error('❌ [loadTypes] Error:', e);
        toast('تعذّر تحميل أنواع المشاريع', 'error');
      }
    }

    // تحميل KPIs سريعة
    async function loadKPIs(){
      try {
        // ✅ بناء الـ URL مع hospitalId دائماً إذا توفر
        const hid = effectiveHospitalId();
        // إذا كان مدير تجمع ولم يحدد مستشفى -> لا نجلب KPIs لتجنب أخطاء 400
        if (isCentralAdmin && (!fltHospital || !fltHospital.value) && !hid) {
          // جمع من جميع المستشفيات عبر الدوال الموحدة
          const hospitalsRes = await fetch(`${API_BASE}/api/hospitals?active=1`, {
            headers: token ? { Authorization: `Bearer ${token}` } : {}
          });
          if (!hospitalsRes.ok) throw new Error('Failed to load hospitals for KPIs');
          const hospitals = await hospitalsRes.json();

          const [inLists, compLists, propLists] = await Promise.all([
            Promise.all(hospitals.map(h => fetchProjectsForHospital(h.HospitalID, 'IN_PROGRESS', null, ''))),
            Promise.all(hospitals.map(h => fetchProjectsForHospital(h.HospitalID, 'COMPLETED', null, ''))),
            Promise.all(hospitals.map(h => fetchProjectsForHospital(h.HospitalID, 'PROPOSED', null, ''))),
          ]);

          const inProg = inLists.flat();
          const comp   = compLists.flat();
          const prop   = propLists.flat();

          const ninety = new Date(); ninety.setDate(ninety.getDate()-90);
          const comp90 = comp.filter(x=> x.StartDate ? new Date(x.StartDate) >= ninety : true);
          $('#kpiInProgress').textContent = inProg.length || 0;
          $('#kpiCompleted').textContent  = comp90.length || 0;
          $('#kpiProposed').textContent   = prop.length || 0;
          return;
        }

        // مستشفى واحد
        const [inProg, comp, prop] = await Promise.all([
          fetchProjectsForHospital(hid, 'IN_PROGRESS', null, ''),
          fetchProjectsForHospital(hid, 'COMPLETED', null, ''),
          fetchProjectsForHospital(hid, 'PROPOSED', null, '')
        ]);

        const ninety = new Date(); ninety.setDate(ninety.getDate()-90);
        const comp90 = comp.filter(x=> x.StartDate ? new Date(x.StartDate) >= ninety : true);
        $('#kpiInProgress').textContent = inProg.length || 0;
        $('#kpiCompleted').textContent  = comp90.length || 0;
        $('#kpiProposed').textContent   = prop.length || 0;
      } catch(err) {
        console.error('❌ [loadKPIs] Error:', err);
      }
    }

    // توحيد الحقول بين الجداول الثلاثة
    function normalizeOther(p, hospitalId) {
      return {
        _source: 'OTHER',
        _hospitalId: hospitalId,
        ProjectID: p.ProjectID,
        Title: p.Title,
        AimStatement: p.AimStatement || null,
        DepartmentID: p.DepartmentID,
        DepartmentName: p.DepartmentName || null,
        Priority: p.Priority || 'MEDIUM',
        Status: p.Status || 'PROPOSED',
        StartDate: p.StartDate || null,
        DueDate: p.DueDate || null,
        UpdatedAt: p.UpdatedAt || p.CreatedAt || null
      };
    }
    function normalizePressganey(p, hospitalId) {
      return {
        _source: 'PRESSGANEY',
        _hospitalId: hospitalId,
        ProjectID: p.ProjectID,
        Title: p.ProjectTitle || p.Title,
        AimStatement: p.AimStatement || null,
        DepartmentID: p.DepartmentID || null,
        DepartmentName: p.DepartmentName || null,
        Priority: p.Priority || 'MEDIUM',
        Status: p.Status || 'PROPOSED',
        StartDate: p.StartDate || null,
        DueDate: p.DueDate || null,
        UpdatedAt: p.UpdatedAt || p.CreatedAt || null
      };
    }
    function normalize937(p, hospitalId) {
      return {
        _source: '937',
        _hospitalId: hospitalId,
        ProjectID: p.Project937ID || p.ProjectID || p.ID,
        Title: p.ProjectName || p.ProjectTitle || p.Title,
        AimStatement: p.AimStatement || null,
        DepartmentID: p.DepartmentID || null,
        DepartmentName: p.DepartmentName || null,
        Priority: p.PriorityCode || p.Priority || 'MEDIUM',
        Status: p.StatusCode || p.Status || 'PROPOSED',
        StartDate: p.StartDate || null,
        DueDate: p.DueDate || null,
        UpdatedAt: p.UpdatedAt || p.CreatedAt || null
      };
    }

    // جلب المشاريع من المستشفى من كل الجداول (OTHER + PRESSGANEY + 937)
    async function fetchProjectsForHospital(hospitalId, status, dept, q) {
      try {
        const headers = { 
          ...authHeaders(),
          'x-hospital-id': String(hospitalId)
        };
        const buildQs = () => {
          const qs = new URLSearchParams();
          // hospitalId في الهيدر، لكن نضيفه أيضاً للوضوح لبعض المسارات
          qs.set('hospitalId', hospitalId);
          if (status) qs.set('status', status);
          // لا نرسل dept هنا لأننا نستخدمه لنوع المشروع محلياً
          if (q) qs.set('q', q);
          return qs.toString();
        };
        const qs = buildQs();

        const [resOther, resPG, res937] = await Promise.all([
          fetch(`${API_BASE}/api/improvements/other?${qs}`, { headers }),
          fetch(`${API_BASE}/api/improvements/pressganey?${qs}`, { headers }),
          fetch(`${API_BASE}/api/improvements/937?${qs}`, { headers })
        ]);

        const [otherJson, pgJson, nineJson] = await Promise.all([
          resOther.ok ? resOther.json() : null,
          resPG.ok ? resPG.json() : null,
          res937.ok ? res937.json() : null
        ]);

        const otherList = Array.isArray(otherJson?.data) ? otherJson.data : (Array.isArray(otherJson) ? otherJson : []);
        const pgList    = Array.isArray(pgJson?.data) ? pgJson.data : (Array.isArray(pgJson) ? pgJson : []);
        const nListRaw  = Array.isArray(nineJson?.items) ? nineJson.items : (Array.isArray(nineJson) ? nineJson : []);

        let normalized = [
          ...otherList.map(p => normalizeOther(p, hospitalId)),
          ...pgList.map(p => normalizePressganey(p, hospitalId)),
          ...nListRaw.map(p => normalize937(p, hospitalId))
        ];
        // فلترة موحدة على العميل لضمان الاتساق (خاصة dept و q لعدم دعمها في كل المسارات)
        normalized = applyFilters(normalized, status, dept, q);
        return normalized;
      } catch (e) {
        console.error(`❌ Error fetching projects for hospital ${hospitalId}:`, e);
        return [];
      }
    }

    // فلترة موحدة بحسب الحالة والقسم والبحث
    function applyFilters(list, status, dept, q) {
      let result = Array.isArray(list) ? list.slice() : [];
      if (status) {
        const s = String(status).toUpperCase();
        result = result.filter(p => String(p.Status || '').toUpperCase() === s);
      }
      if (dept) {
        // إذا كانت قيمة الفلتر نوع مشروع (OTHER/PRESSGANEY/937)
        const typeUpper = String(dept).toUpperCase();
        if (['OTHER','PRESSGANEY','937'].includes(typeUpper)) {
          result = result.filter(p => String(p._source || '').toUpperCase() === typeUpper);
        } else {
          // دعم قديم: قسم رقمي
          const d = Number(dept);
          if (!Number.isNaN(d)) {
            result = result.filter(p => Number(p.DepartmentID || 0) === d);
          }
        }
      }
      if (q) {
        const term = String(q).toLowerCase();
        result = result.filter(p => {
          const title = (p.Title || '').toLowerCase();
          const aim = (p.AimStatement || '').toLowerCase();
          return title.includes(term) || aim.includes(term);
        });
      }
      return result;
    }

    // تحميل قائمة المشاريع
    async function loadProjects(){
      rowsEl.innerHTML = '';
      emptyEl.classList.add('hidden');

      try {
        let list = [];
        
        // إذا كان مدير تجمع ولم يختر مستشفى: جلب من جميع المستشفيات
        if (isCentralAdmin && (!fltHospital || !fltHospital.value)) {
          console.log('👑 [loadProjects] Central Admin - Loading from all hospitals');
          
          // جلب جميع المستشفيات النشطة
          const hospitalsRes = await fetch(`${API_BASE}/api/hospitals?active=1`, {
            headers: token ? { Authorization: `Bearer ${token}` } : {}
          });
          
          if (!hospitalsRes.ok) throw new Error('Failed to load hospitals');
          
          const hospitals = await hospitalsRes.json();
          console.log(`📋 [loadProjects] Found ${hospitals.length} hospitals`);
          
          // جلب المشاريع من كل مستشفى
          const promises = hospitals.map(h => 
            fetchProjectsForHospital(
              h.HospitalID, 
              fltStatus.value, 
              fltDept.value, 
              fltQ.value.trim()
            )
          );
          
          const results = await Promise.all(promises);
          list = results.flat();
          
          // إضافة اسم المستشفى لكل مشروع
          const hospitalsMap = new Map(hospitals.map(h => [h.HospitalID, h]));
          list = list.map(p => ({
            ...p,
            HospitalName: hospitalsMap.get(p._hospitalId)?.NameAr || hospitalsMap.get(p._hospitalId)?.NameEn || `مستشفى ${p._hospitalId}`
          }));
        } else {
          // حالة عادية: مستشفى واحد
          const qs = new URLSearchParams();
          let hid = effectiveHospitalId();
          
          // إذا كان مدير واختار مستشفى، استخدمه
          if (isCentralAdmin && fltHospital && fltHospital.value) {
            hid = Number(fltHospital.value);
          }
          
          if (!hid) {
            emptyEl.classList.remove('hidden');
            toast('يجب اختيار مستشفى', 'warn');
            return;
          }
          
          qs.set('hospitalId', hid);
          
          if (fltStatus.value) qs.set('status', fltStatus.value);
          // لا ترسل dept لأن الفلتر أصبح نوع المشروع
          if (fltQ.value.trim()) qs.set('q', fltQ.value.trim());
          
          // جلب من الجداول الثلاثة للمستشفى الحالي
          list = await fetchProjectsForHospital(
            hid,
            fltStatus.value,
            fltDept.value,
            fltQ.value.trim()
          );
        }
        
        console.log('📋 [loadProjects] Projects count:', list?.length || 0);
        
        lastProjects = Array.isArray(list) ? list : [];
        projectsLoaded = true;

        if(!lastProjects || lastProjects.length===0){
          emptyEl.classList.remove('hidden');
          return;
        }
        renderRows(lastProjects);
      }catch(e){
        console.error('❌ [loadProjects] Exception:', e);
        emptyEl.classList.remove('hidden');
        toast('تعذّر تحميل المشاريع', 'error');
      }
    }

    const PRIORITY_CLASSES = {
      LOW : 'bg-gray-100 text-gray-700',
      MEDIUM:'bg-blue-100 text-blue-700',
      HIGH:'bg-amber-100 text-amber-700',
      CRITICAL:'bg-red-100 text-red-700'
    };
    const PRIORITY_LABELS = {
      ar: { LOW:'منخفضة', MEDIUM:'متوسطة', HIGH:'عالية', CRITICAL:'حرجة' },
      en: { LOW:'Low', MEDIUM:'Medium', HIGH:'High', CRITICAL:'Critical' }
    };
    const STATUS_CLASSES = {
      DRAFT:'bg-gray-100 text-gray-700',
      PROPOSED:'bg-sky-100 text-sky-700',
      APPROVED:'bg-emerald-100 text-emerald-700',
      IN_PROGRESS:'bg-indigo-100 text-indigo-700',
      COMPLETED:'bg-green-100 text-green-700',
      CANCELLED:'bg-rose-100 text-rose-700'
    };
    const STATUS_LABELS = {
      ar: {
        DRAFT:'مسودة',
        PROPOSED:'مقترح',
        APPROVED:'معتمد',
        IN_PROGRESS:'قيد التنفيذ',
        COMPLETED:'مكتمل',
        CANCELLED:'ملغي'
      },
      en: {
        DRAFT:'Draft',
        PROPOSED:'Proposed',
        APPROVED:'Approved',
        IN_PROGRESS:'In Progress',
        COMPLETED:'Completed',
        CANCELLED:'Cancelled'
      }
    };
    const ACTION_LABELS = {
      ar: { view:'عرض', edit:'تعديل', report:'تقرير', approve:'اعتماد' },
      en: { view:'View', edit:'Edit', report:'Report', approve:'Approve' }
    };
    function getPriorityLabel(code){
      const lang = currentLanguage === 'en' ? 'en' : 'ar';
      return PRIORITY_LABELS[lang][code] || PRIORITY_LABELS.ar[code] || code || '-';
    }
    function getStatusLabel(code){
      const lang = currentLanguage === 'en' ? 'en' : 'ar';
      return STATUS_LABELS[lang][code] || STATUS_LABELS.ar[code] || code || '-';
    }
    function getActionLabel(key){
      const lang = currentLanguage === 'en' ? 'en' : 'ar';
      return ACTION_LABELS[lang][key] || ACTION_LABELS.ar[key] || key;
    }
    function badgePriority(p){
      return `<span class="px-2.5 py-1 rounded-full text-xs ${PRIORITY_CLASSES[p]||'bg-gray-100 text-gray-700'}">${getPriorityLabel(p)}</span>`;
    }
    function badgeStatus(s){
      return `<span class="px-2.5 py-1 rounded-full text-xs ${STATUS_CLASSES[s]||'bg-gray-100 text-gray-700'}">${getStatusLabel(s)}</span>`;
    }
    function badgeType(src){
      const map = {
        OTHER: { text: 'أخرى', cls: 'bg-amber-100 text-amber-700' },
        PRESSGANEY: { text: 'PressGaney', cls: 'bg-purple-100 text-purple-700' },
        937: { text: '937', cls: 'bg-sky-100 text-sky-700' }
      };
      const m = map[String(src||'').toUpperCase()] || { text: '—', cls: 'bg-gray-100 text-gray-700' };
      return `<span class="px-2.5 py-1 rounded-full text-xs ${m.cls}">${m.text}</span>`;
    }
    const fmt = (d)=> {
      if(!d) return '—';
      const locale = currentLanguage === 'en' ? 'en-GB' : 'ar-SA';
      try{
        return new Date(d).toLocaleDateString(locale);
      }catch{
        return new Date(d).toLocaleDateString('ar-SA');
      }
    };

    // متغيرات الصلاحيات
    let userPermissions = {};

    function renderRows(list){
      const frag = document.createDocumentFragment();
      list.forEach(item=>{
        const tr = document.createElement('tr');
        tr.className = 'border-b last:border-b-0 hover:bg-gray-50';
        
        // بناء أزرار الإجراءات حسب الصلاحيات
        let actionButtons = '';
        if (userPermissions.improvementView) {
          actionButtons += `<button type="button" class="px-3 py-1.5 rounded-lg border hover:bg-gray-50 text-xs" data-act="view" data-id="${item.ProjectID}" data-hospital="${item._hospitalId || item.HospitalID || ''}">${getActionLabel('view')}</button>`;
        }
        if (userPermissions.improvementEdit) {
          actionButtons += `<button type="button" class="px-3 py-1.5 rounded-lg border hover:bg-gray-50 text-xs" data-act="edit" data-id="${item.ProjectID}" data-hospital="${item._hospitalId || item.HospitalID || ''}">${getActionLabel('edit')}</button>`;
        }
        if (userPermissions.improvementReportView) {
          actionButtons += `<button type="button" class="px-3 py-1.5 rounded-lg bg-primary text-white hover:bg-[#00366f] text-xs" data-act="report" data-id="${item.ProjectID}" data-hospital="${item._hospitalId || item.HospitalID || ''}">${getActionLabel('report')}</button>`;
        }
        if (userPermissions.improvementApprove && item.Status === 'PROPOSED') {
          actionButtons += `<button type="button" class="px-3 py-1.5 rounded-lg bg-green-600 text-white hover:bg-green-700 text-xs" data-act="approve" data-id="${item.ProjectID}" data-hospital="${item._hospitalId || item.HospitalID || ''}">${getActionLabel('approve')}</button>`;
        }
        
        // عمود المستشفى (للمدير فقط عند عرض جميع المستشفيات)
        const hospitalCell = isCentralAdmin && (!fltHospital || !fltHospital.value) 
          ? `<td class="px-4 py-3 align-top">${escapeHtml(item.HospitalName || '—')}</td>`
          : '';
        const typeCell = `<td class="px-4 py-3 align-top">${badgeType(item._source)}</td>`;
        
        tr.innerHTML = `
          ${hospitalCell}
          ${typeCell}
          <td class="px-4 py-3 align-top">
            <div class="font-semibold text-gray-900">${escapeHtml(item.Title)}</div>
            <div class="text-xs text-gray-500">${item.AimStatement ? escapeHtml(item.AimStatement).slice(0,120)+'…' : ''}</div>
          </td>
          <td class="px-4 py-3 align-top">${escapeHtml(item.DepartmentName || item.DepartmentID || '—')}</td>
          <td class="px-4 py-3 align-top">${badgePriority(item.Priority)}</td>
          <td class="px-4 py-3 align-top">${badgeStatus(item.Status)}</td>
          <td class="px-4 py-3 align-top">${fmt(item.StartDate)}</td>
          <td class="px-4 py-3 align-top">${fmt(item.DueDate)}</td>
          <td class="px-4 py-3 align-top">${fmt(item.UpdatedAt)}</td>
          <td class="px-4 py-3 align-top">
            <div class="flex gap-2">
              ${actionButtons}
            </div>
          </td>
        `;
        frag.appendChild(tr);
      });
      rowsEl.appendChild(frag);
    }

    function applyTranslation(lang){
      const effectiveLang = I18N[lang] ? lang : 'ar';
      const map = I18N[effectiveLang] || I18N.ar;

      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        if (key && map[key] !== undefined) {
          el.textContent = map[key];
        }
      });

      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.dataset.i18nPlaceholder;
        if (key && map[key] !== undefined) {
          el.placeholder = map[key];
        }
      });

      ['nav-home','nav-dashboard','nav-profile','nav-about','nav-help','nav-contact'].forEach(id => {
        const el = document.getElementById(id);
        if (el && map[id] !== undefined) {
          el.textContent = map[id];
        }
      });

      const toggleBtn = document.getElementById('languageToggle');
      if (toggleBtn && map['language-button']) {
        toggleBtn.textContent = map['language-button'];
      }

      if (effectiveLang === 'en') {
        document.documentElement.setAttribute('dir', 'ltr');
        document.documentElement.setAttribute('lang', 'en');
      } else {
        document.documentElement.setAttribute('dir', 'rtl');
        document.documentElement.setAttribute('lang', 'ar');
      }

      currentLanguage = effectiveLang;
      localStorage.setItem('selectedLanguage', effectiveLang);
      updateFilterStatics();

      if (projectsLoaded) {
        rowsEl.innerHTML = '';
        if (lastProjects && lastProjects.length) {
          emptyEl.classList.add('hidden');
          renderRows(lastProjects);
        } else {
          emptyEl.classList.remove('hidden');
        }
      }
    }

    function escapeHtml(str=''){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    // صلاحيات: إظهار زر الإضافة فقط للمصرّح لهم
    async function applyPermissions(){
      try{
        // ✅ مدير التجمع: منحه كامل الصلاحيات مباشرة
        if (isClusterManager()) {
          console.log('👑 [applyPermissions] Cluster Manager - Full permissions granted');
          isCentralAdmin = true; // تعيين المتغير
          userPermissions = {
            improvementView: true,
            improvementCreate: true,
            improvementEdit: true,
            improvementDelete: true,
            improvementApprove: true,
            improvementReportView: true
          };
          
          // إظهار فلتر المستشفى وعمود المستشفى
          if (hospitalFilterContainer) {
            hospitalFilterContainer.classList.remove('hidden');
            // تحديث grid layout
            const filtersContainer = document.getElementById('filtersContainer');
            if (filtersContainer) {
              filtersContainer.className = 'grid grid-cols-1 md:grid-cols-5 gap-3';
            }
            const searchContainer = document.getElementById('searchContainer');
            if (searchContainer) {
              searchContainer.className = 'md:col-span-2';
            }
          }
          if (hospitalHeader) {
            hospitalHeader.style.display = '';
          }
          
          // تحميل قائمة المستشفيات
          await loadHospitals();
          
          return;
        }

        // ✅ للموظفين: استدعاء API الصلاحيات
        const params = new URLSearchParams();
        const hid = effectiveHospitalId();
        if (hid) params.set('hospitalId', hid);
        
        const url = `${API_BASE}/api/permissions/me${params.toString() ? '?' + params.toString() : ''}`;
        console.log('🔐 [applyPermissions] Request URL:', url);
        
        const res = await fetch(url, { headers: authHeaders(), credentials:'include' });
        
        if(!res.ok) {
          console.warn('⚠️ [applyPermissions] API failed, status:', res.status);
          // محاولة احتياطية: فحص localStorage
          const userData = JSON.parse(localStorage.getItem('userData') || '{}');
          if (userData.RoleID === 1 || userData.IsClusterManager) {
            console.log('✅ [applyPermissions] Cluster Manager from userData - Full permissions');
            userPermissions = {
              improvementView: true,
              improvementCreate: true,
              improvementEdit: true,
              improvementDelete: true,
              improvementApprove: true,
              improvementReportView: true
            };
            return;
          }
          throw new Error('Permissions API failed');
        }
        
        const json = await res.json();
        const p = json?.data || {};
        console.log('📋 [applyPermissions] Permissions:', p);
        
        // حفظ الصلاحيات في متغير عام
        userPermissions = p;

        // تحديد ما إذا كان المستخدم مدير تجمع
        const detectedCentral = Boolean(p.isCentralAdmin);
        isCentralAdmin = detectedCentral || isClusterManager();
        
        if (isCentralAdmin) {
          console.log('✅ [applyPermissions] Central Admin detected - Full permissions');
          userPermissions = {
            improvementView: true,
            improvementCreate: true,
            improvementEdit: true,
            improvementDelete: true,
            improvementApprove: true,
            improvementReportView: true
          };
          
          // إظهار فلتر المستشفى وعمود المستشفى
          if (hospitalFilterContainer) {
            hospitalFilterContainer.classList.remove('hidden');
            // تحديث grid layout
            const filtersContainer = document.getElementById('filtersContainer');
            if (filtersContainer) {
              filtersContainer.className = 'grid grid-cols-1 md:grid-cols-5 gap-3';
            }
            const searchContainer = document.getElementById('searchContainer');
            if (searchContainer) {
              searchContainer.className = 'md:col-span-2';
            }
          }
          if (hospitalHeader) {
            hospitalHeader.style.display = '';
          }
          
          // تحميل قائمة المستشفيات
          await loadHospitals();
          
          return;
        }
        
        // إخفاء فلتر المستشفى للموظفين العاديين
        if (hospitalFilterContainer) {
          hospitalFilterContainer.classList.add('hidden');
        }
        if (hospitalHeader) {
          hospitalHeader.style.display = 'none';
        }

        // حراسة دخول الموديول/الصفحة: لو ما عنده صلاحية عرض التحسينات، رجعيه صفحة 403 أو الرئيسية
        if (!p.improvementView && !p.improvementCreate) {
          console.warn('❌ [applyPermissions] No view or create permission - Redirecting');
          window.location.href = '../../index/index.html';
          return;
        }

        // إظهار زر + إضافة فقط إذا عنده إنشاء
        if (!p.improvementCreate) {
          console.log('ℹ️ [applyPermissions] Hiding create button - No create permission');
          document.getElementById('btnAdd')?.classList.add('hidden');
        }
      }catch(err){
        console.error('❌ [applyPermissions] Error:', err);
        // محاولة أخيرة: التحقق من localStorage
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        if (userData.RoleID === 1 || userData.IsClusterManager) {
          console.log('✅ [applyPermissions] Cluster Manager (fallback) - Full permissions');
          isCentralAdmin = true; // تعيين المتغير
          userPermissions = {
            improvementView: true,
            improvementCreate: true,
            improvementEdit: true,
            improvementDelete: true,
            improvementApprove: true,
            improvementReportView: true
          };
          
          // إظهار فلتر المستشفى وعمود المستشفى
          if (hospitalFilterContainer) {
            hospitalFilterContainer.classList.remove('hidden');
            const filtersContainer = document.getElementById('filtersContainer');
            if (filtersContainer) {
              filtersContainer.className = 'grid grid-cols-1 md:grid-cols-5 gap-3';
            }
            const searchContainer = document.getElementById('searchContainer');
            if (searchContainer) {
              searchContainer.className = 'md:col-span-2';
            }
          }
          if (hospitalHeader) {
            hospitalHeader.style.display = '';
          }
          
          // تحميل قائمة المستشفيات
          await loadHospitals();
          
          return;
        }
        // لو فشل، خليه يشوف الصفحة بس بدون أزرار حساسة
        document.getElementById('btnAdd')?.classList.add('hidden');
      }
    }

    // أحداث الفلاتر
    $('#btnApply').addEventListener('click', loadProjects);
    $('#btnReset').addEventListener('click', ()=>{
      fltStatus.value=''; fltDept.value=''; fltQ.value=''; 
      if (fltHospital) fltHospital.value='';
      loadProjects();
    });
    
    // عند تغيير المستشفى: إعادة تحميل الأقسام والمشاريع
    if (fltHospital) {
      fltHospital.addEventListener('change', async () => {
        await loadDepartments();
        await loadProjects();
      });
    }

    btnAdd.addEventListener('click', ()=>{
      window.location.href = './select-type.html';
    });

    // ✅ مستمع دائم لأزرار الإجراءات (عرض، تعديل، تقرير)
    rowsEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-act]');
      if(!btn) return;
      const id = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-act');
      const hospitalId = btn.getAttribute('data-hospital');
      
      // بناء URL مع hospitalId إذا كان مدير واختار مستشفى
      let url = '';
      if (act === 'view'){
        url = `./view.html?id=${id}`;
      } else if (act === 'edit'){
        url = `./edit.html?id=${id}`;
      } else if (act === 'report'){
        url = `./report.html?id=${id}`;
      } else if (act === 'approve') {
        if (!confirm("هل تريد اعتماد هذا المشروع؟")) return;

        const selectedHospital = hospitalId || (isCentralAdmin ? (fltHospital?.value || effectiveHospitalId()) : effectiveHospitalId());
        let requestUrl = `${API_BASE}/api/improvements/approve/${id}`;

        if (isCentralAdmin && selectedHospital) {
          requestUrl += `?hospitalId=${selectedHospital}`;
        }

        const headers = { ...authHeaders() };
        if (isCentralAdmin && selectedHospital) {
          headers['x-hospital-id'] = String(selectedHospital);
        }

        fetch(requestUrl, {
          method: 'PUT',
          headers
        })
        .then(res => res.json().catch(() => ({ success: false, message: 'استجابة غير صالحة' })))
        .then(data => {
          if (data.success) {
            toast('✅ ' + (data.message || 'تم اعتماد المشروع بنجاح'), 'success');
            loadProjects();
          } else {
            toast('⚠️ ' + (data.message || 'المشروع لم يتم اعتماده'), 'warn');
          }
        })
        .catch(err => {
          console.error(err);
          toast('❌ خطأ أثناء الاعتماد', 'error');
        });
        return;
      }
      
      if (url) {
        if (isCentralAdmin && hospitalId) {
          url += `&hospitalId=${hospitalId}`;
        }
        window.location.href = url;
      }
    });

    const languageToggleBtn = document.getElementById('languageToggle');
    if (languageToggleBtn) {
      languageToggleBtn.addEventListener('click', () => {
        const newLang = currentLanguage === 'ar' ? 'en' : 'ar';
        applyTranslation(newLang);
      });
    }

    applyTranslation(currentLanguage);

    // بدء
    (async function init(){
      await applyPermissions();
      await loadDepartments();
      await Promise.all([loadKPIs(), loadProjects()]);
    })();
  </script>

</body>
</html>
