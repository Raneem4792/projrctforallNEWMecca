<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ูุดุฑูุน ุชุญุณููู - ููุชูุญ / ุฃุฎุฑู</title>

  <!-- Tailwind via CDN -->
  <!-- Theme controller -->
  <script src="../../public/assets/js/theme.js"></script>

<script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme:{ extend:{ colors:{ primary:'#002B5B' } } } }
  </script>

  <!-- Tajawal -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>body{font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,sans-serif}</style>

  <!-- ูููุฉ ูุดุฑูุนู -->
    <link rel="stylesheet" href="../../public/assets/css/styles.css" />
<link rel="stylesheet" href="../hospital/hospital.css">
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- Header -->
  <header id="navbar" class="fixed w-full top-0 z-50 navbar-scroll" style="background-color: #002B5B;">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center">
          <img src="../../public/assets/img/logo3.png" alt="ุดุนุงุฑ ุชุฌูุน ููุฉ ุงูููุฑูุฉ ุงูุตุญู" class="h-16 w-auto">
        </div>
        <nav class="hidden md:flex items-center space-x-reverse space-x-8">
          <a href="../../index/index.html" class="text-white hover:text-blue-200 transition-colors">ุงูุฑุฆูุณูุฉ</a>
          <a href="../dashboard.html" class="text-white hover:text-blue-200 transition-colors">ููุญุฉ ุงูุชุญูู</a>
          <a href="./list.html" class="text-white hover:text-blue-200 transition-colors">ุงููุดุงุฑูุน ุงูุชุญุณูููุฉ</a>
        </nav>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="pt-24 min-h-screen pb-12">
    <div class="max-w-4xl mx-auto px-4 md:px-6 lg:px-8">

      <!-- ุงูุนููุงู ูุน Badge -->
      <div class="mb-8">
        <div class="flex items-center gap-3 mb-3">
          <span class="px-4 py-1.5 bg-amber-100 text-amber-700 rounded-full text-sm font-semibold">ูุดุฑูุน ููุชูุญ / ุฃุฎุฑู</span>
        </div>
        <h1 class="text-3xl md:text-4xl font-extrabold text-primary mb-2">
          ูุดุฑูุน ุชุญุณููู ุนุงู
        </h1>
        <p class="text-gray-600">
          ุงููุฃ ุงูุจูุงูุงุช ุงูุชุงููุฉ ูุฅุถุงูุฉ ูุดุฑูุน ุชุญุณููู ุนุงู ูู ุฃู ูุฌุงู ูู ูุฌุงูุงุช ุงูุนูู
        </p>
      </div>

      <!-- ุงุฎุชูุงุฑ ุงููุณุชุดูู (ูุธูุฑ ููุฏูุฑ ุงูุชุฌูุน) -->
      <div id="hospitalContainer" class="mb-6 hidden">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          ุงููุณุชุดูู
        </label>
        <select id="selectHospital"
                class="w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-amber-500 focus:border-transparent">
          <option value="">ุงุฎุชุฑ ุงููุณุชุดูู</option>
        </select>
      </div>

      <!-- ุงููููุฐุฌ -->
      <form id="projectForm" class="bg-white rounded-2xl shadow-lg p-6 md:p-8 space-y-6">

        <!-- ูุนูููุงุช ุงููุดุฑูุน ุงูุฃุณุงุณูุฉ -->
        <div class="border-b border-gray-200 pb-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
            <svg class="w-6 h-6 ml-2 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
            ูุนูููุงุช ุงููุดุฑูุน ุงูุฃุณุงุณูุฉ
          </h2>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                ุนููุงู ุงููุดุฑูุน <span class="text-red-500">*</span>
              </label>
              <input type="text" id="projectTitle" required
                     class="w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                     placeholder="ุนููุงู ูุงุถุญ ููุฎุชุตุฑ ูููุดุฑูุน ุงูุชุญุณููู">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  ุงููุณู ุงููุณุคูู <span class="text-red-500">*</span>
                </label>
                <select id="department" required
                        class="w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                  <option value="">ุงุฎุชุฑ ุงููุณู</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  ูุฌุงู ุงูุชุญุณูู <span class="text-red-500">*</span>
                </label>
                <select id="improvementArea" required
                        class="w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                  <option value="">ุงุฎุชุฑ ุงููุฌุงู</option>
                  <option value="quality">ุงูุฌูุฏุฉ</option>
                  <option value="safety">ุงูุณูุงูุฉ</option>
                  <option value="efficiency">ุงูููุงุกุฉ ุงูุชุดุบูููุฉ</option>
                  <option value="patient-experience">ุชุฌุฑุจุฉ ุงููุฑูุถ</option>
                  <option value="clinical">ุงูุฑุนุงูุฉ ุงูุณุฑูุฑูุฉ</option>
                  <option value="administrative">ุฅุฏุงุฑู</option>
                  <option value="technology">ุชูููุฉ ุงููุนูููุงุช</option>
                  <option value="infection-control">ููุงูุญุฉ ุงูุนุฏูู</option>
                  <option value="medication-safety">ุณูุงูุฉ ุงูุฏูุงุก</option>
                  <option value="other">ุฃุฎุฑู</option>
                </select>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                ูุฆุฉ ุงููุดุฑูุน
              </label>
              <select id="projectCategory"
                      class="w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                <option value="">ุงุฎุชุฑ ุงููุฆุฉ (ุงุฎุชูุงุฑู)</option>
                <option value="lean">Lean / ุงูุฅุฏุงุฑุฉ ุงูุฑุดููุฉ</option>
                <option value="six-sigma">Six Sigma</option>
                <option value="kaizen">Kaizen / ุงูุชุญุณูู ุงููุณุชูุฑ</option>
                <option value="pdsa">PDSA Cycle</option>
                <option value="quality-improvement">Quality Improvement</option>
                <option value="performance">ุชุญุณูู ุงูุฃุฏุงุก</option>
                <option value="innovation">ุงูุงุจุชูุงุฑ</option>
              </select>
            </div>
          </div>
        </div>

        <!-- ูุตู ุงููุดููุฉ ูุงููุฏู -->
        <div class="border-b border-gray-200 pb-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
            <svg class="w-6 h-6 ml-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            ูุตู ุงููุดููุฉ ูุงููุฏู
          </h2>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                ูุตู ุงููุดููุฉ ุฃู ูุฑุตุฉ ุงูุชุญุณูู <span class="text-red-500">*</span>
              </label>
              <textarea id="problemStatement" required rows="4"
                        class="w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                        placeholder="ุงุดุฑุญ ุงููุดููุฉ ุงูุญุงููุฉ ุฃู ุงููุฑุตุฉ ุงูุชุญุณูููุฉ ุจูุถูุญ"></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                ุงููุฏู ูู ุงููุดุฑูุน (AIM Statement) <span class="text-red-500">*</span>
              </label>
              <textarea id="aimStatement" required rows="3"
                        class="w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                        placeholder="ูุซุงู: ุชูููู ููุช ุงูุชุธุงุฑ ุงููุฑุถู ูู 45 ุฏูููุฉ ุฅูู 20 ุฏูููุฉ ุฎูุงู 3 ุฃุดูุฑ"></textarea>
              <p class="text-xs text-gray-500 mt-1">ูููุถู ุฃู ูููู ุงููุฏู ูุญุฏุฏุงู ููุงุจูุงู ููููุงุณ (SMART)</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                ุงููุถุน ุงูุญุงูู (Baseline)
              </label>
              <textarea id="currentState" rows="3"
                        class="w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                        placeholder="ูุซุงู: ูุชูุณุท ููุช ุงูุงูุชุธุงุฑ ุงูุญุงูู 45 ุฏูููุฉุ ุนุฏุฏ ุงูุดูุงูู ุงูุดูุฑูุฉ 12 ุดููู"></textarea>
            </div>
          </div>
        </div>

        <!-- ุงูุฅุฌุฑุงุกุงุช ูุงูุฎุทุฉ -->
        <div class="border-b border-gray-200 pb-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
            <svg class="w-6 h-6 ml-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
            </svg>
            ุงูุฅุฌุฑุงุกุงุช ูุงูุฎุทุฉ ุงูุชูููุฐูุฉ
          </h2>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                ุงูุฅุฌุฑุงุกุงุช ูุงูุชุฏุฎูุงุช ุงูููุชุฑุญุฉ <span class="text-red-500">*</span>
              </label>
              <textarea id="proposedActions" required rows="5"
                        class="w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                        placeholder="ุงุฐูุฑ ุงูุฎุทูุงุช ูุงูุฅุฌุฑุงุกุงุช ุงูุชู ุณูุชู ุชูููุฐูุง ูุชุญููู ุงููุฏู"></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                ูุคุดุฑุงุช ุงูููุงุณ (KPIs)
              </label>
              <textarea id="kpis" rows="3"
                        class="w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                        placeholder="ูุซุงู: ูุชูุณุท ููุช ุงูุงูุชุธุงุฑุ ูุณุจุฉ ุฑุถุง ุงููุฑุถูุ ุนุฏุฏ ุงูุดูุงูู"></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                ุงูููุงุฑุฏ ุงููุทููุจุฉ
              </label>
              <textarea id="requiredResources" rows="3"
                        class="w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                        placeholder="ูุซุงู: ููุธููู ุฅุถุงููููุ ููุฒุงููุฉุ ูุนุฏุงุชุ ุชุฏุฑูุจ"></textarea>
            </div>
          </div>
        </div>

        <!-- ุงูุชูุงุตูู ุงูุฅุฏุงุฑูุฉ -->
        <div class="pb-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
            <svg class="w-6 h-6 ml-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
            </svg>
            ุงูุชูุงุตูู ุงูุฅุฏุงุฑูุฉ
          </h2>

          <div class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  ุงูุฃููููุฉ <span class="text-red-500">*</span>
                </label>
                <select id="priority" required
                        class="w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                  <option value="">ุงุฎุชุฑ ุงูุฃููููุฉ</option>
                  <option value="LOW">ููุฎูุถุฉ</option>
                  <option value="MEDIUM">ูุชูุณุทุฉ</option>
                  <option value="HIGH">ุนุงููุฉ</option>
                  <option value="CRITICAL">ุญุฑุฌุฉ</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  ูุณุคูู ุงููุดุฑูุน
                </label>
                <input type="text" id="projectOwner"
                       class="w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                       placeholder="ุงุณู ุงููุณุคูู ุนู ุงููุดุฑูุน">
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  ุชุงุฑูุฎ ุงูุจุฏุก ุงููุชููุน
                </label>
                <input type="date" id="startDate"
                       class="w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-amber-500 focus:border-transparent">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  ุชุงุฑูุฎ ุงูุงูุชูุงุก ุงููุชููุน
                </label>
                <input type="date" id="dueDate"
                       class="w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-amber-500 focus:border-transparent">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  ุงููุฏุฉ ุงููุชููุนุฉ (ุจุงูุฃุดูุฑ)
                </label>
                <input type="number" id="duration" min="1" max="24"
                       class="w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                       placeholder="ูุซุงู: 6">
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                ูุฑูู ุงูุนูู
              </label>
              <textarea id="teamMembers" rows="2"
                        class="w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                        placeholder="ุฃุณูุงุก ุฃุนุถุงุก ุงููุฑูู ุงููุดุงุฑููู ูู ุงููุดุฑูุน"></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                ููุงุญุธุงุช ุฅุถุงููุฉ
              </label>
              <textarea id="notes" rows="3"
                        class="w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                        placeholder="ุฃู ููุงุญุธุงุช ุฃู ูุนูููุงุช ุฅุถุงููุฉ"></textarea>
            </div>
          </div>
        </div>

        <!-- ุงูุฃุฒุฑุงุฑ -->
        <div class="flex gap-3 pt-4">
          <button type="submit"
                  class="flex-1 bg-amber-600 text-white px-6 py-3 rounded-xl hover:bg-amber-700 font-semibold transition-colors">
            ุญูุธ ุงููุดุฑูุน
          </button>
          <button type="button" id="draftBtn"
                  class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 font-semibold transition-colors">
            ุญูุธ ููุณูุฏุฉ
          </button>
          <a href="./select-type.html"
             class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 font-semibold transition-colors text-center">
            ุฅูุบุงุก
          </a>
        </div>

      </form>

    </div>
  </div>

  <!-- Toast ููุฑุณุงุฆู -->
  <div id="toast" class="fixed bottom-6 right-6 z-[9999] hidden">
    <div id="toastInner" class="rounded-xl shadow-lg px-4 py-3 text-sm"></div>
  </div>

  <script>
    const API_BASE = localStorage.getItem('apiBase') || 'http://localhost:3001';
    const token = localStorage.getItem('token') || '';

    // Helper functions
    const toast = (msg, type='info') => {
      const el = document.getElementById('toast');
      const box = document.getElementById('toastInner');
      const cls = {
        success:'bg-green-600 text-white',
        error:'bg-red-600 text-white',
        info:'bg-gray-800 text-white',
        warn:'bg-amber-500 text-white'
      }[type] || 'bg-gray-800 text-white';
      box.className = 'rounded-xl shadow-lg px-4 py-3 text-sm ' + cls;
      box.textContent = msg;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 3000);
    };

    // ุงูุชุญูู ูู ูุฏูุฑ ุงูุชุฌูุน
    function isClusterManager() {
      try {
        const u = JSON.parse(localStorage.getItem('userData') || '{}');
        return u.RoleID === 1 || u.IsClusterManager === true;
      } catch { return false; }
    }

    function effectiveHospitalId() {
      // ุฃููููุฉ ูุงุฎุชูุงุฑ ุงููุณุชุฎุฏู ูู ุงููุงุฆูุฉ (ุฅู ููุฌุฏุช)
      const sel = document.getElementById('selectHospital');
      if (sel && sel.value) {
        const v = Number(sel.value);
        if (!Number.isNaN(v) && v > 0) return v;
      }

      const u = JSON.parse(localStorage.getItem('userData') || '{}');
      const q = new URLSearchParams(location.search);
      const fromUrl = Number(q.get('hospitalId') || q.get('hid') || 0);
      const fromLS1 = Number(localStorage.getItem('selectedHospitalId') || 0);
      const fromLS2 = Number(localStorage.getItem('hospitalId') || 0);
      const fromUser = Number(u.HospitalID || u.hospitalId || u.hid || 0);
      return fromUrl || fromLS1 || fromLS2 || fromUser || null;
    }

    const authHeaders = () => {
      const h = token ? { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' };
      const hid = effectiveHospitalId();
      if (hid) h['x-hospital-id'] = String(hid);
      return h;
    };

    // ุชุญููู ูุงุฆูุฉ ุงููุณุชุดููุงุช (ูููุฏูุฑ ููุท)
    async function loadHospitalsIfNeeded() {
      const container = document.getElementById('hospitalContainer');
      const select = document.getElementById('selectHospital');

      if (!isClusterManager()) {
        container.classList.add('hidden');
        return;
      }

      container.classList.remove('hidden');

      try {
        const res = await fetch(`${API_BASE}/api/hospitals?active=1`, {
          headers: token ? { Authorization: `Bearer ${token}` } : {}
        });
        if (!res.ok) throw new Error('Failed to load hospitals');

        const hospitals = await res.json();
        // ุชุนุจุฆุฉ ุงููุงุฆูุฉ
        select.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุณุชุดูู</option>';
        hospitals.forEach(h => {
          const opt = document.createElement('option');
          opt.value = h.HospitalID;
          opt.textContent = h.NameAr || h.NameEn || `ูุณุชุดูู ${h.Code}`;
          select.appendChild(opt);
        });

        // ุชุญุฏูุฏ ูููุฉ ูุจุฏุฆูุฉ ูู URL/LS ุฅู ููุฌุฏุช
        const preset = new URLSearchParams(location.search).get('hospitalId')
          || new URLSearchParams(location.search).get('hid')
          || localStorage.getItem('selectedHospitalId')
          || localStorage.getItem('hospitalId');
        if (preset) {
          select.value = preset;
        } else if (hospitals?.length) {
          // ูู ุญุงู ูุง ุชูุฌุฏ ูููุฉ ูุณุจูุฉุ ุญุฏูุฏ ุฃูู ูุณุชุดูู ุชููุงุฆูุงู ูุชุณููู ุงูุงุณุชุฎุฏุงู
          select.value = String(hospitals[0].HospitalID);
        }
      } catch (e) {
        console.error('Error loading hospitals:', e);
        toast('ุชุนุฐูุฑ ุชุญููู ุงููุณุชุดููุงุช', 'error');
      }

      // ุนูุฏ ุชุบููุฑ ุงููุณุชุดูู: ุฅุนุงุฏุฉ ุชุญููู ุงูุฃูุณุงู
      select.addEventListener('change', () => {
        loadDepartments();
      });
    }

    // ุชุญููู ุงูุฃูุณุงู
    async function loadDepartments() {
      try {
        const params = new URLSearchParams();
        const hid = effectiveHospitalId();
        if (hid) params.set('hospitalId', hid);
        
        // ุงุณุชุฎุฏุงู ููุณ ูุณุงุฑ ุตูุญุฉ ุงูุจูุงุบุงุช
        const url = `${API_BASE}/api/departments${params.toString() ? '?' + params.toString() : ''}`;
        console.log('๐ฅ [improvement_other] loadDepartments URL:', url);
        const tokenLocal = localStorage.getItem('token') || '';
        const headers = {
          'Accept': 'application/json'
        };
        if (tokenLocal) headers['Authorization'] = `Bearer ${tokenLocal}`;
        const res = await fetch(url, { headers });
        console.log('๐ฅ [improvement_other] loadDepartments status:', res.status);
        
        if (!res.ok) throw new Error('HTTP ' + res.status);
        
        const response = await res.json();
        // ุงูุชุนุงูู ูุน ุงูุตูุบุชูู ูุซู ุตูุญุฉ ุงูุจูุงุบุงุช
        let list = [];
        if (response && response.success && Array.isArray(response.data)) {
          list = response.data;
        } else if (Array.isArray(response)) {
          list = response;
        } else if (response && Array.isArray(response.items)) {
          list = response.items;
        }
        console.log('๐ฅ [improvement_other] departments count:', Array.isArray(list) ? list.length : 0);
        
        const deptSelect = document.getElementById('department');
        deptSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุณู</option>';
        
        (list || []).forEach(d => {
          const o = document.createElement('option');
          o.value = d.DepartmentID;
          o.textContent = d.NameAr || d.DepartmentName;
          deptSelect.appendChild(o);
        });

        if ((list || []).length === 0) {
          toast('ูุง ุชูุฌุฏ ุฃูุณุงู ูุชุงุญุฉ ููุฐุง ุงููุณุชุดูู', 'warn');
        }
      } catch(e) {
        console.error('Error loading departments:', e);
        toast('ุชุนุฐุฑ ุชุญููู ุงูุฃูุณุงู', 'error');
      }
    }

    // ูุนุงูุฌุฉ ุงููููุฐุฌ
    document.getElementById('projectForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      await submitProject('PROPOSED');
    });

    document.getElementById('draftBtn').addEventListener('click', async () => {
      await submitProject('DRAFT');
    });

    async function submitProject(status) {
      try {
        const hid = effectiveHospitalId();
        if (!hid) {
          toast('ูุฌุจ ุชุญุฏูุฏ ุงููุณุชุดูู', 'warn');
          return;
        }

        const data = {
          hospitalId: hid,
          projectType: 'OTHER',
          title: document.getElementById('projectTitle').value,
          departmentId: document.getElementById('department').value,
          improvementArea: document.getElementById('improvementArea').value,
          projectCategory: document.getElementById('projectCategory').value || null,
          problemStatement: document.getElementById('problemStatement').value,
          aimStatement: document.getElementById('aimStatement').value,
          currentState: document.getElementById('currentState').value || null,
          proposedSolution: document.getElementById('proposedActions').value,
          kpis: document.getElementById('kpis').value || null,
          requiredResources: document.getElementById('requiredResources').value || null,
          projectOwner: document.getElementById('projectOwner').value || null,
          teamMembers: document.getElementById('teamMembers').value || null,
          notes: document.getElementById('notes').value || null,
          priority: document.getElementById('priority').value || 'MEDIUM',
          status: status,
          startDate: document.getElementById('startDate').value || null,
          dueDate: document.getElementById('dueDate').value || null,
          duration: parseInt(document.getElementById('duration').value) || null
        };

        const res = await fetch(`${API_BASE}/api/improvements/other`, {
          method: 'POST',
          headers: authHeaders(),
          body: JSON.stringify(data)
        });

        const result = await res.json();

        if (res.ok && result.success) {
          toast(status === 'DRAFT' ? 'ุชู ุญูุธ ุงููุณูุฏุฉ ุจูุฌุงุญ' : 'ุชู ุฅุถุงูุฉ ุงููุดุฑูุน ุจูุฌุงุญ', 'success');
          setTimeout(() => window.location.href = './list.html', 1500);
        } else {
          toast(result.message || 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญูุธ', 'error');
        }
      } catch(err) {
        console.error('Error:', err);
        toast('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญูุธ', 'error');
      }
    }

    // ุงูุชุญููู ุงูุฃููู
    loadHospitalsIfNeeded().then(loadDepartments);
  </script>

</body>
</html>

