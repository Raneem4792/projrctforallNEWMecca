<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800&display=swap" rel="stylesheet">
  <!-- Theme controller -->
  <script src="../assets/js/theme.js"></script>

<script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="../assets/css/styles.css" />
</head>
<body class="min-h-screen flex flex-col bg-gray-50" style="font-family:'Tajawal',sans-serif">
  <!-- Header - Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
  <header id="navbar" class="fixed w-full top-0 z-50 navbar-scroll" style="background-color: #002B5B;">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <!-- Logo - Ø§Ù„Ø´Ø¹Ø§Ø± -->
        <div class="flex items-center">
          <img src="../assets/img/logo3.png" alt="Ø´Ø¹Ø§Ø± ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„ØµØ­ÙŠ" class="h-16 w-auto">
        </div>
        
        <!-- Navigation - Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ†Ù‚Ù„ -->
        <nav class="hidden md:flex items-center space-x-reverse space-x-8">
          <a href="../../index/index.html" id="nav-home" class="text-white hover:text-blue-200 transition-colors">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
          <a href="../../dashboard/dashboard.html" id="nav-dashboard" class="text-white hover:text-blue-200 transition-colors">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
          <a href="../../index/about-system.html" id="nav-about" class="text-white hover:text-blue-200 transition-colors">Ø­ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</a>
          <a href="../../index/help.html" id="nav-help" class="text-white hover:text-blue-200 transition-colors">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</a>
          <a href="../../index/contact.html" id="nav-contact" class="text-white hover:text-blue-200 transition-colors">Ø§ØªØµÙ„ Ø¨Ù†Ø§</a>
          <button id="languageToggle" class="text-white hover:text-blue-200 transition-colors flex items-center">
            ğŸŒ English
          </button>
        </nav>
        
        <!-- Mobile menu button - Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
        <button class="md:hidden text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 pt-24 pb-10 flex-1">
    <section class="text-center mb-8">
      <h1 class="text-3xl md:text-4xl font-extrabold text-[#002B5B] mb-2">Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª</h1>
      <p class="text-gray-600">Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª Ù…Ø¹ Ø®ÙŠØ§Ø± Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹</p>
    </section>

    <div class="bg-white rounded-2xl p-6 shadow-xl border border-gray-100 mb-6 flex flex-wrap items-center justify-between gap-3">
      <div class="text-sm text-gray-600">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©</div>

      <div class="flex items-center gap-3">
        <!-- ğŸ‘‡ Ø³ÙŠØªÙ… Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© -->
        <div id="hospitalSelectContainer" class="flex items-center gap-3">
          <label for="hospitalSelect" class="text-sm text-gray-600 whitespace-nowrap">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰:</label>
          <select id="hospitalSelect"
                  class="h-10 min-w-[240px] rounded-xl border border-gray-200 px-3 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-100">
            <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ â€”</option>
          </select>
        </div>

        <a href="admin-hospital.html" class="h-10 px-4 rounded-xl bg-gray-100 text-gray-700 text-sm hover:bg-gray-200 inline-flex items-center justify-center">Ø±Ø¬ÙˆØ¹</a>
        <button id="emptyTrashBtn" class="h-10 px-4 rounded-xl bg-rose-600 text-white text-sm hover:bg-rose-700">ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©</button>
      </div>
    </div>

    <div id="trashList" class="grid md:grid-cols-2 gap-4"></div>
  </main>

  <!-- Footer - Ø§Ù„ØªØ°ÙŠÙŠÙ„ -->
  <footer class="bg-gray-900 text-white py-14">
    <div class="container mx-auto px-4">
      <div class="grid md:grid-cols-3 gap-8">
        <!-- Column 1 - Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ -->
        <div>
          <div class="flex items-center space-x-reverse space-x-3 mb-4">
            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 2L2 7v10c0 5.55 3.84 9.74 9 11 5.16-1.26 9-5.45 9-11V7l-10-5z"/>
              </svg>
            </div>
            <div>
              <div class="font-bold">ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„ØµØ­ÙŠ</div>
              <div class="text-sm text-gray-300">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</div>
            </div>
          </div>
          <p class="text-gray-300 text-sm">Ù…Ù†ØµØ© Ø±Ø³Ù…ÙŠØ© Ù„ØªÙ‚Ø¯ÙŠÙ… ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</p>
        </div>

        <!-- Column 2 - Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ -->
        <div>
          <h3 class="font-bold mb-4">Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©</h3>
          <ul class="space-y-2 text-sm">
            <li><a href="../../index/index.html" class="text-gray-300 hover:text-white hover:underline transition-colors">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
            <li><a href="../complaints/submit/submit-complaint.html" class="text-gray-300 hover:text-white hover:underline transition-colors">ØªÙ‚Ø¯ÙŠÙ… Ø¨Ù„Ø§Øº</a></li>
            <li><a href="../complaints/track/track-complaint.html" class="text-gray-300 hover:text-white hover:underline transition-colors">Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ù„Ø§Øº</a></li>
            <li><a href="../../index/help.html" class="text-gray-300 hover:text-white hover:underline transition-colors">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©</a></li>
          </ul>
        </div>

        <!-- Column 3 - Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù„Ø« -->
        <div>
          <h3 class="font-bold mb-4">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</h3>
          <div class="space-y-2 text-sm text-gray-300">
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
              <span>Ø±Ù‚Ù… Ø§Ù„Ø¯Ø¹Ù…: 0559735137</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
              <span>support@makkahhealth.gov.sa</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„: 24/7</span>
            </div>
          </div>
        </div>
      </div>

      <div class="border-t border-gray-700 mt-8 pt-8 text-center text-sm text-gray-300">
        Â© 2025 ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„ØµØ­ÙŠ â€“ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©
      </div>
    </div>
  </footer>

  <script>
  const API_BASE = 'http://localhost:3001/api';
  const trashList = document.getElementById('trashList');
  const hospitalSelect = document.getElementById('hospitalSelect');
  const emptyTrashBtn = document.getElementById('emptyTrashBtn');

  // Ø­ÙØ¸ Ø¢Ø®Ø± Ø§Ø®ØªÙŠØ§Ø±
  const STORAGE_KEY = 'currentHospital';
  const saveSel = (obj) => localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
  const getSel  = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null'); } catch { return null; } };

  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†
  function getToken() {
    return localStorage.getItem('token');
  }

  // ØªØ±Ø¬Ù…Ø© Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
  const entityTypeLabels = {
    'COMPLAINT': 'Ø¨Ù„Ø§Øº',
    'DEPARTMENT': 'Ù‚Ø³Ù…',
    'USER': 'Ù…Ø³ØªØ®Ø¯Ù…',
    'HOSPITAL': 'Ù…Ø³ØªØ´ÙÙ‰',
    'ATTACHMENT': 'Ù…Ø±ÙÙ‚',
    'REPLY': 'Ø±Ø¯',
    'OTHER': 'Ø¢Ø®Ø±'
  };

  // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
  function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('ar-SA', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
  async function loadHospitals() {
    try {
      const token = getToken();
      
      // ğŸ‘‡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© (Ø§Ù„Ø³ÙŠØ±ÙØ± Ø³ÙŠØªØ­ÙƒÙ… Ø¨Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª)
      await loadTrash();
      
      // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© (Ù„Ù„Ù…Ø¯Ø±Ø§Ø¡ ÙÙ‚Ø·)
      const response = await fetch(`${API_BASE}/hospitals`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      const hospitals = Array.isArray(data) ? data : (data.data || []);
      
      if (hospitals.length === 0) {
        return;
      }

      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
      hospitals.forEach(h => {
        const opt = document.createElement('option');
        opt.value = h.HospitalID;
        opt.textContent = h.NameAr || h.NameEn || `Ù…Ø³ØªØ´ÙÙ‰ #${h.HospitalID}`;
        hospitalSelect.appendChild(opt);
      });

      // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¢Ø®Ø± Ø§Ø®ØªÙŠØ§Ø± Ù„Ù„Ù…Ø¯Ø±Ø§Ø¡
      const saved = getSel();
      if (saved && saved.id) {
        hospitalSelect.value = saved.id;
      }
      
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©:', error);
      showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: ' + error.message, 'error');
    }
  }

  // Ø¬Ù„Ø¨ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
  async function loadTrash(hospitalId = null) {
    try {
      const token = getToken();
      
      // ğŸ‘‡ Ù†Ø¨Ù†ÙŠ Ø§Ù„Ù€ URL Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙˆØ¬ÙˆØ¯ hospitalId
      let url = `${API_BASE}/trash?entityType=COMPLAINT`;
      if (hospitalId) {
        url += `&hospitalId=${hospitalId}`;
      }
      
      const response = await fetch(url, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø¬Ø§Ø­ Ø§Ù„Ø·Ù„Ø¨
      if (!response.ok) {
        if (response.status === 403) {
          showNotification('ØºÙŠØ± Ù…ØµØ±Ù‘Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
          renderEmpty('ØºÙŠØ± Ù…ØµØ±Ù‘Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„.');
          return;
        }
        throw new Error(`HTTP ${response.status}`);
      }

      const data = await response.json();
      
      // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰
      const canChooseHospital = data.canChooseHospital || false;
      const hospitalSelectContainer = document.getElementById('hospitalSelectContainer');
      
      if (canChooseHospital) {
        // Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ù‘Ø¹: Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
        hospitalSelectContainer.style.display = 'flex';
      } else {
        // Ù…ÙˆØ¸Ù: Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
        hospitalSelectContainer.style.display = 'none';
      }
      
      const items = data.items || data.data || [];

      if (items.length > 0) {
        renderTrash(items);
      } else {
        renderEmpty('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù…Ø­Ø°ÙˆÙØ©.');
      }
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª:', error);
      showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: ' + error.message, 'error');
      renderEmpty('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
    }
  }

  // Ø±Ø³Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
  function renderTrash(items = []) {
    if (!items || items.length === 0) {
      return renderEmpty('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù…Ø­Ø°ÙˆÙØ©.');
    }

    trashList.innerHTML = items.map(item => {
      // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† EntitySnapshot
      const snap = safeParseJSON(item.EntitySnapshot) || {};
      const entityType = item.EntityType || 'COMPLAINT';
      const typeLabel = entityTypeLabels[entityType] || entityType;
      const typeColor = getTypeColor(entityType);
      const ticket = snap.TicketNumber || `#${item.EntityID}`;
      const deletedAt = formatDate(item.DeletedAt);
      
      return `
      <div class="bg-white rounded-2xl p-5 border border-gray-100 shadow" data-trash-id="${item.TrashID}">
        <div class="flex items-center justify-between mb-3">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-2">
              <span class="inline-block px-2 py-0.5 rounded text-xs font-medium ${typeColor}">
                ${typeLabel}
              </span>
            </div>
            <div class="font-bold text-[#002B5B] text-lg">${escapeHTML(item.EntityTitle || ticket)}</div>
            
            ${snap.DepartmentID ? `<div class="text-sm text-gray-600 mt-1">Ø§Ù„Ù‚Ø³Ù…: ${escapeHTML(snap.DepartmentName || snap.DepartmentID)}</div>` : ''}
            ${snap.PriorityCode ? `<div class="text-sm text-gray-600">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: ${escapeHTML(snap.PriorityCode)}</div>` : ''}
            ${snap.SubmissionType ? `<div class="text-sm text-gray-600">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…: ${escapeHTML(snap.SubmissionType)}</div>` : ''}
            ${item.DeleteReason ? `<div class="text-sm text-amber-600 mt-2">ğŸ’¡ Ø§Ù„Ø³Ø¨Ø¨: ${escapeHTML(item.DeleteReason)}</div>` : ''}
          </div>
          <div class="text-xs text-gray-500 text-left">
            <div class="font-semibold text-gray-700">Ø­ÙØ°Ù ÙÙŠ:</div>
            <div>${deletedAt}</div>
            ${item.DeletedByUserName ? `<div class="mt-2 text-gray-600">Ø¨ÙˆØ§Ø³Ø·Ø©:</div><div>${escapeHTML(item.DeletedByUserName)}</div>` : ''}
          </div>
        </div>
        <div class="flex gap-2 justify-end mt-4 pt-3 border-t border-gray-100">
          <button onclick="restoreItem(${item.TrashID})" 
                  class="text-sm px-4 py-2 rounded-lg bg-emerald-50 text-emerald-700 hover:bg-emerald-100 transition-colors font-medium">
            â†©ï¸ Ø§Ø³ØªØ±Ø¬Ø§Ø¹
          </button>
          <button onclick="purgeItem(${item.TrashID}, '${escapeHTML((item.EntityTitle || ticket).replace(/'/g, "\\'"))}')" 
                  class="text-sm px-4 py-2 rounded-lg bg-rose-50 text-rose-600 hover:bg-rose-100 transition-colors font-medium">
            ğŸ—‘ï¸ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ
          </button>
        </div>
      </div>
    `;
    }).join('');
  }

  // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ù„ÙŠÙ„ JSON Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
  function safeParseJSON(str) {
    if (!str) return null;
    if (typeof str === 'object') return str;
    try {
      return JSON.parse(str);
    } catch (e) {
      console.warn('ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ JSON:', e);
      return null;
    }
  }

  // Ù„ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
  function getTypeColor(type) {
    const colors = {
      'COMPLAINT': 'bg-blue-100 text-blue-700',
      'DEPARTMENT': 'bg-purple-100 text-purple-700',
      'USER': 'bg-green-100 text-green-700',
      'HOSPITAL': 'bg-red-100 text-red-700',
      'ATTACHMENT': 'bg-yellow-100 text-yellow-700',
      'REPLY': 'bg-indigo-100 text-indigo-700'
    };
    return colors[type] || 'bg-gray-100 text-gray-700';
  }

  // Ø±Ø³Ø§Ù„Ø© ÙØ§Ø±ØºØ©
  function renderEmpty(msg) {
    trashList.innerHTML = `
      <div class="col-span-full text-center text-gray-400 p-10">${escapeHTML(msg)}</div>
    `;
  }

  // Ø­Ù…Ø§ÙŠØ© HTML
  function escapeHTML(s) {
    return String(s ?? '')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  }

  // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¹Ù†ØµØ±
  async function restoreItem(trashId) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±ØŸ')) return;

    try {
      const token = getToken();
      const response = await fetch(`${API_BASE}/trash/${trashId}/restore`, {
        method: 'POST',
        headers: { 
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      const data = await response.json();

      if (data.success) {
        showNotification('ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ù„Ø©
        const hospitalId = hospitalSelect.value;
        if (hospitalId) loadTrash(hospitalId);
      } else {
        showNotification(data.message || 'ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹', 'error');
      }
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹:', error);
      showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
    }
  }

  // Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ
  async function purgeItem(trashId, title) {
    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù€ "${title}"ØŸ\n\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!`)) return;

    try {
      const token = getToken();
      const response = await fetch(`${API_BASE}/trash/${trashId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();

      if (data.success) {
        showNotification('ØªÙ… Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ù„Ø©
        const hospitalId = hospitalSelect.value;
        if (hospitalId) loadTrash(hospitalId);
      } else {
        showNotification(data.message || 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ', 'error');
      }
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:', error);
      showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
    }
  }

  // ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
  async function emptyTrash() {
    try {
      const token = getToken();
      
      // ğŸ‘‡ Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØªØ­Ø¯ÙŠØ¯ hospitalId
      const userResponse = await fetch(`${API_BASE}/auth/me`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const userData = await userResponse.json();
      const user = userData.user || userData;
      
      // ØªØ­Ø¯ÙŠØ¯ hospitalId Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
      let hospitalId;
      const isClusterMgr = Number(user?.RoleID) === 1;
      
      if (isClusterMgr) {
        // Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ù‘Ø¹: ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªØ´ÙÙ‰
        hospitalId = hospitalSelect.value;
        if (!hospitalId) {
          showNotification('Ø§Ø®ØªØ± Ù…Ø³ØªØ´ÙÙ‰ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
          return;
        }
      } else {
        // Ù…ÙˆØ¸Ù: Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø³ØªØ´ÙØ§Ù‡
        hospitalId = user?.HospitalID;
        if (!hospitalId) {
          showNotification('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰', 'error');
          return;
        }
      }

      const hospitalName = isClusterMgr && hospitalSelect.value 
        ? hospitalSelect.options[hospitalSelect.selectedIndex].textContent
        : 'Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰';
        
      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ±ÙŠØº Ø³Ù„Ø© "${hospitalName}" Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ\n\nØ³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹!`)) return;

      const response = await fetch(`${API_BASE}/trash/empty`, {
        method: 'POST',
        headers: { 
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ hospitalId })
      });
      const data = await response.json();

      if (data.ok || data.success) {
        showNotification(`ØªÙ… ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ (${data.deletedCount || 0} Ø¹Ù†ØµØ±)`, 'success');
        loadTrash(isClusterMgr ? hospitalId : null);
      } else {
        showNotification(data.message || 'ÙØ´Ù„ ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©', 'error');
      }
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©:', error);
      showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
    }
  }

  // Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  function showNotification(message, type = 'info') {
    const colors = {
      success: 'bg-green-500',
      error: 'bg-red-500',
      warning: 'bg-yellow-500',
      info: 'bg-blue-500'
    };

    const notification = document.createElement('div');
    notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
      notification.style.opacity = '0';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  // ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰
  hospitalSelect?.addEventListener('change', () => {
    const id = hospitalSelect.value;
    if (!id) {
      renderEmpty('Ø§Ø®ØªØ± Ù…Ø³ØªØ´ÙÙ‰ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©.');
      return;
    }
    const name = hospitalSelect.options[hospitalSelect.selectedIndex].textContent.trim();
    saveSel({ id, name });
    loadTrash(id);
  });

  // ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©
  emptyTrashBtn?.addEventListener('click', emptyTrash);

  // Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  document.addEventListener('DOMContentLoaded', loadHospitals);

  // ØªØ£Ø«ÙŠØ± ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ù‡ÙŠØ¯Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ±
  window.addEventListener("scroll", function () {
    const navbar = document.getElementById("navbar");
    if (window.scrollY > 50) {
      navbar.style.backgroundColor = "#ffffff";
      navbar.classList.add("shadow-md");
      navbar.querySelectorAll("a").forEach(link => {
        link.classList.remove("text-white", "hover:text-blue-200");
        link.classList.add("text-[#002B5B]", "hover:text-blue-700");
      });
    } else {
      navbar.style.backgroundColor = "#002B5B";
      navbar.classList.remove("shadow-md");
      navbar.querySelectorAll("a").forEach(link => {
        link.classList.add("text-white", "hover:text-blue-200");
        link.classList.remove("text-[#002B5B]", "hover:text-blue-700");
      });
    }
  });
</script>
</body>
</html>

