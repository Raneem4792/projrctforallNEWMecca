<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>ุงูุตูุงุญูุงุช</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen flex flex-col bg-gray-50" style="font-family:'Tajawal',sans-serif">
  <!-- Header - ุดุฑูุท ุงูุชููู ุงูุนููู -->
  <header id="navbar" class="fixed w-full top-0 z-50 navbar-scroll" style="background-color: #002B5B;">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <!-- Logo - ุงูุดุนุงุฑ -->
        <div class="flex items-center">
          <img src="../assets/img/logo3.png" alt="ุดุนุงุฑ ุชุฌูุน ููุฉ ุงูููุฑูุฉ ุงูุตุญู" class="h-16 w-auto">
        </div>
        
        <!-- Navigation - ูุงุฆูุฉ ุงูุชููู -->
        <nav class="hidden md:flex items-center space-x-reverse space-x-8">
          <a href="../../index/index.html" id="nav-home" class="text-white hover:text-blue-200 transition-colors">ุงูุฑุฆูุณูุฉ</a>
          <a href="../../dashboard/dashboard.html" id="nav-dashboard" class="text-white hover:text-blue-200 transition-colors">ููุญุฉ ุงูุชุญูู</a>
          <a href="../../index/about-system.html" id="nav-about" class="text-white hover:text-blue-200 transition-colors">ุญูู ุงููุธุงู</a>
          <a href="../../index/help.html" id="nav-help" class="text-white hover:text-blue-200 transition-colors">ุงููุณุงุนุฏุฉ</a>
          <a href="../../index/contact.html" id="nav-contact" class="text-white hover:text-blue-200 transition-colors">ุงุชุตู ุจูุง</a>
          <button id="languageToggle" class="text-white hover:text-blue-200 transition-colors flex items-center">
            ๐ English
          </button>
        </nav>
        
        <!-- Mobile menu button - ุฒุฑ ุงููุงุฆูุฉ ููููุจุงูู -->
        <button class="md:hidden text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 pt-24 pb-10 flex-1">
    <section class="text-center mb-8">
      <h1 class="text-3xl md:text-4xl font-extrabold text-[#002B5B] mb-2">ุงูุตูุงุญูุงุช</h1>
      <p class="text-gray-600">ุฃุฏูุงุฑ ูููุฒุงุช ูููุณุชุฎุฏููู</p>
    </section>


    <div class="bg-white rounded-2xl p-6 shadow-xl border border-gray-100 mb-6">
      <div class="flex items-center gap-3">
        <label for="hospitalSelect" class="text-sm text-gray-600 whitespace-nowrap">ุงุฎุชุฑ ุงููุณุชุดูู:</label>
        <select id="hospitalSelect"
                class="h-10 min-w-[220px] rounded-xl border border-gray-200 px-3 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-100">
          <option value="">โ ุงุฎุชุฑ ุงููุณุชุดูู โ</option>
        </select>
      </div>
    </div>

    <section class="mt-4 grid grid-cols-12 gap-4">
      <!-- ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ -->
      <aside class="col-span-12 lg:col-span-4">
        <div class="bg-white rounded-2xl shadow p-3 border" style="min-height: 360px;">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-bold text-[#002B5B] text-sm">ูุณุชุฎุฏูู ุงููุณุชุดูู</h3>
            <span id="usersCount" class="text-xs text-gray-500">0</span>
          </div>
          <div id="usersList" class="divide-y">
            <!-- ูุชู ุงูุญูู ููุง -->
          </div>
          <div id="usersEmpty" class="text-center text-gray-400 py-8 hidden">ูุง ููุฌุฏ ูุณุชุฎุฏููู.</div>
        </div>
      </aside>

      <!-- ูุณุงุญุฉ ุงูุตูุงุญูุงุช -->
      <main class="col-span-12 lg:col-span-8">
        <div id="permEmpty" class="bg-white rounded-2xl shadow border min-h-72 flex items-center justify-center">
          <div class="text-gray-400 text-center">
            ุงุฎุชุฑ ูุณุชุฎุฏููุง ูู ุงููุงุฆูุฉ ูุนุฑุถ ุตูุงุญูุงุชู.
          </div>
        </div>

        <form id="permForm" class="hidden">
          <div class="bg-white rounded-2xl shadow border overflow-hidden">
            <!-- ุฑุฃุณ ุงููุฑุช -->
            <div class="flex items-center justify-between px-5 py-4 bg-gray-50 border-b">
              <div class="text-sm text-gray-500">
                <span id="selectedUserLabel" class="font-medium text-[#002B5B]">ูุณุชุฎุฏู ุฑูู โ ูุณุชุดูู โ</span>
              </div>
              <button id="savePerm" type="button" class="px-4 py-2 rounded-xl bg-[#2d60ff] text-white text-sm hover:opacity-90">
                ุญูุธ
              </button>
            </div>

            <!-- ุฌุณู ุงููุฑุช -->
            <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-8">

              <!-- ุงูุฃุณุงุณูุงุช -->
              <section class="space-y-4">
                <h4 class="text-sm font-semibold text-[#002B5B] flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-[#2d60ff]"></span> ุงูุฃุณุงุณูุงุช
                </h4>

                <!-- ูุชุงุจุนุฉ + ูุทุงููุง ุชุญุชูุง ูุจุงุดุฑุฉ -->
                <div class="space-y-2">
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_view" class="w-4 h-4">
                    <span>ูุชุงุจุนุฉ/ุนุฑุถ ุงูุจูุงุบุงุช</span>
                  </label>

                  <div id="scopeRow" class="pl-7">
                    <label for="p_scope" class="block text-xs text-gray-600 mb-1">ูุทุงู ุณุฌู ุงูุจูุงุบุงุช:</label>
                    <select id="p_scope" class="border rounded-lg px-3 py-2 w-full">
                      <option value="">โ ูุง ูุดุงูุฏุฉ โ</option>
                      <option value="ASSIGNED">ุงููุณููุฏุฉ ูู</option>
                      <option value="DEPARTMENT">ุจูุงุบุงุช ุงููุณู</option>
                      <option value="HOSPITAL">ุจูุงุบุงุช ุงููุณุชุดูู</option>
                    </select>
                    <p class="text-[11px] text-gray-400 mt-1">ูุทูุจู ููุท ุนูุฏ ุชูุนูู "ูุชุงุจุนุฉ/ุนุฑุถ ุงูุจูุงุบุงุช".</p>
                  </div>
                </div>

                <!-- ุชูุฏูู ุจูุงุบ -->
                <label class="flex items-center gap-3">
                  <input type="checkbox" id="p_submit" class="w-4 h-4">
                  <span>ุชูุฏูู ุจูุงุบ</span>
                </label>
              </section>

              <!-- ุฅุฌุฑุงุกุงุช ุนูู ุงูุจูุงุบ -->
              <section class="space-y-4">
                <h4 class="text-sm font-semibold text-[#002B5B] flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-emerald-500"></span> ุฅุฌุฑุงุกุงุช ุนูู ุงูุจูุงุบ
                </h4>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_reply" class="w-4 h-4">
                    <span>ุงูุฑุฏ ุนูู ุงูุจูุงุบ</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_transfer_dept" class="w-4 h-4">
                    <span>ุชุญููู ุจูู ุงูุฃูุณุงู</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_transfer_user" class="w-4 h-4">
                    <span>ุชุญููู ุจูู ุงูููุธููู</span>
                  </label>

                  <label class="flex items-center gap-2">
                    <input type="checkbox" id="p_complaint_transfer_hospital" class="w-4 h-4">
                    <span>ุชุญููู ุงูุจูุงุบ ุจูู ุงููุณุชุดููุงุช</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_status" class="w-4 h-4">
                    <span>ุชุบููุฑ ุงูุญุงูุฉ</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_delete" class="w-4 h-4">
                    <span>ุญุฐู ุงูุจูุงุบ</span>
                  </label>
                </div>
              </section>

              <!-- ุตูุงุญูุงุช ุฅุฏุงุฑูุฉ -->
              <section class="space-y-4">
                <h4 class="text-sm font-semibold text-[#002B5B] flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-purple-500"></span> ุตูุงุญูุงุช ุฅุฏุงุฑูุฉ
                </h4>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_admin_panel" class="w-4 h-4">
                    <span>ููุญุฉ ุงูุฅุฏุงุฑุฉ</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_admin_depts" class="w-4 h-4">
                    <span>ุฅุฏุงุฑุฉ ุงูุฃูุณุงู</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_admin_hospital" class="w-4 h-4">
                    <span>ุฅุฏุงุฑุฉ ุงููุณุชุดูู</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_admin_clusters" class="w-4 h-4">
                    <span>ุฅุฏุงุฑุฉ ุงููุณุชุดููุงุช (ุงูุชุฌูุน)</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_hospital_create" class="w-4 h-4">
                    <span>ุฅุถุงูุฉ ูุณุชุดูู ุฌุฏูุฏ</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_hospital_trash" class="w-4 h-4">
                    <span>ุฅุฏุงุฑุฉ ุงููุญุฐููุงุช</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_hospital_logs" class="w-4 h-4">
                    <span>ุนุฑุถ ุงูุณุฌูุงุช</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_hospital_permissions" class="w-4 h-4">
                    <span>ุฅุฏุงุฑุฉ ุงูุตูุงุญูุงุช</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_hospital_users" class="w-4 h-4">
                    <span>ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_hospital_user_create" class="w-4 h-4">
                    <span>ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_hospital_user_edit" class="w-4 h-4">
                    <span>ุชุนุฏูู ุงููุณุชุฎุฏู</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_hospital_user_delete" class="w-4 h-4">
                    <span>ุญุฐู ุงููุณุชุฎุฏู</span>
                  </label>
                </div>
              </section>

              <!-- ุฅุฑูุงู ุงูุฅูุณู -->
              <section class="space-y-4">
                <h4 class="text-sm font-semibold text-[#002B5B] flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-blue-500"></span> ุฅุฑูุงู ุงูุฅูุณู
                </h4>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_imports_page" class="w-4 h-4">
                    <span>ุนุฑุถ ุตูุญุฉ ุฅุฑูุงู ุงูุฅูุณู</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_imports_depts" class="w-4 h-4">
                    <span>ุงุณุชูุฑุงุฏ ุงูุฃูุณุงู</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_imports_mystery" class="w-4 h-4">
                    <span>ุงุณุชูุฑุงุฏ ุงูุฒุงุฆุฑ ุงูุณุฑู</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_imports_937" class="w-4 h-4">
                    <span>ุงุณุชูุฑุงุฏ 937</span>
                  </label>
                </div>
              </section>

              <!-- ุตูุงุญูุงุช ููุญุฉ ุงูุชุญูู -->
              <section class="space-y-4">
                <h4 class="text-sm font-semibold text-[#002B5B] flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-orange-500"></span> ุตูุงุญูุงุช ููุญุฉ ุงูุชุญูู
                </h4>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_page" class="w-4 h-4">
                    <span>ุนุฑุถ ููุญุฉ ุงูุชุญูู</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_card_totals" class="w-4 h-4">
                    <span>ุจุทุงูุฉ ุฅุฌูุงูู ุงูุจูุงุบุงุช</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_card_open" class="w-4 h-4">
                    <span>ุจุทุงูุฉ ุงูุจูุงุบุงุช ุงูููุชูุญุฉ</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_card_closed" class="w-4 h-4">
                    <span>ุจุทุงูุฉ ุงูุจูุงุบุงุช ุงููุบููุฉ</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_card_urgent" class="w-4 h-4">
                    <span>ุจุทุงูุฉ ุงูุจูุงุบุงุช ุงูุญุฑุฌุฉ</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_card_close_rate" class="w-4 h-4">
                    <span>ุจุทุงูุฉ ูุนุฏู ุงูุฅุบูุงู</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_card_hosp_count" class="w-4 h-4">
                    <span>ุจุทุงูุฉ ุนุฏุฏ ุงููุณุชุดููุงุช</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_chart_mystery" class="w-4 h-4">
                    <span>ุฑุณู ุงูุฒุงุฆุฑ ุงูุณุฑู ุญุณุจ ุงูุฃูุณุงู</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_chart_classes" class="w-4 h-4">
                    <span>ุฑุณู ุงูุชุตูููุงุช</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_chart_top_clinics" class="w-4 h-4">
                    <span>ุฑุณู ุฃุนูู ุงูุนูุงุฏุงุช</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_chart_daily_trend" class="w-4 h-4">
                    <span>ุฑุณู ุงูุดูุงูู ุงูููููุฉ</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_urgent_list" class="w-4 h-4">
                    <span>ูุงุฆูุฉ ุงูุจูุงุบุงุช ุงูุญูุฑุงุก</span>
                  </label>
                </div>
              </section>

              <!-- ุงููุดุงุฑูุน ุงูุชุญุณูููุฉ -->
              <section class="space-y-4">
                <h4 class="text-sm font-semibold text-[#002B5B] flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-red-500"></span> ุงููุดุงุฑูุน ุงูุชุญุณูููุฉ
                </h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_impr_module" class="w-4 h-4">
                    <span>ุงูุฏุฎูู ููุตูุญุฉ</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_impr_view" class="w-4 h-4">
                    <span>ุนุฑุถ ูุดุฑูุน</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_impr_create" class="w-4 h-4">
                    <span>ุฅุถุงูุฉ ูุดุฑูุน</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_impr_edit" class="w-4 h-4">
                    <span>ุชุนุฏูู ูุดุฑูุน</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_impr_delete" class="w-4 h-4">
                    <span>ุญุฐู ูุดุฑูุน</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_impr_report" class="w-4 h-4">
                    <span>ุนุฑุถ ุงูุชูุฑูุฑ</span>
                  </label>
                </div>
              </section>

              <!-- ุงูุฒุงุฆุฑ ุงูุณุฑู -->
              <section class="space-y-4">
                <h4 class="text-sm font-semibold text-[#002B5B] flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-purple-500"></span> ุงูุฒุงุฆุฑ ุงูุณุฑู
                </h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_mys_module" class="w-4 h-4">
                    <span>ุงูุฏุฎูู ููุตูุญุฉ</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_mys_view" class="w-4 h-4">
                    <span>ุนุฑุถ ุชูููู</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_mys_reply" class="w-4 h-4">
                    <span>ุฅุถุงูุฉ ุฑุฏ/ุชุนููู</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_mys_status" class="w-4 h-4">
                    <span>ุชุบููุฑ ุงูุญุงูุฉ</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_mys_t_dept" class="w-4 h-4">
                    <span>ุชุญููู ุจูู ุงูุฃูุณุงู</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_mys_t_emp" class="w-4 h-4">
                    <span>ุชุญููู ุจูู ุงูููุธููู</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_mys_del" class="w-4 h-4">
                    <span>ุญุฐู ุชูููู</span>
                  </label>
                </div>
              </section>

              <!-- ุตูุงุญูุงุช ุงูุชูุงุฑูุฑ ูุงูุฅุญุตุงุฆูุงุช -->
              <section class="space-y-4">
                <h4 class="text-sm font-semibold text-[#002B5B] flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-cyan-500"></span> ุตูุงุญูุงุช ุงูุชูุงุฑูุฑ ูุงูุฅุญุตุงุฆูุงุช
                </h4>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_page" class="w-4 h-4"><span>ุนุฑุถ ุตูุญุฉ ุงูุชูุงุฑูุฑ</span></label>

                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_card_totals" class="w-4 h-4"><span>ุจุทุงูุฉ ุงูุฅุฌูุงูู</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_card_open" class="w-4 h-4"><span>ุจุทุงูุฉ ุงูููุชูุญุฉ</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_card_closed" class="w-4 h-4"><span>ุจุทุงูุฉ ุงููุบููุฉ</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_card_urgent" class="w-4 h-4"><span>ุจุทุงูุฉ ุงูุญุฑุฌุฉ</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_card_sla" class="w-4 h-4"><span>ุจุทุงูุฉ SLA</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_card_hospitals" class="w-4 h-4"><span>ุจุทุงูุฉ ุนุฏุฏ ุงููุณุชุดููุงุช</span></label>

                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_chart_by_hosp_type" class="w-4 h-4"><span>ุฑุณู ุญุณุจ ููุน ุงูุจูุงุบ/ุงููุณุชุดูู</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_chart_status_dist" class="w-4 h-4"><span>ุฑุณู ุชูุฒูุน ุงูุญุงูุฉ</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_chart_trend6" class="w-4 h-4"><span>ุฑุณู ุงูุงุชุฌุงู (6 ุฃุดูุฑ)</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_chart_urgent_pct" class="w-4 h-4"><span>ุฑุณู ูุณุจุฉ ุงูุญุฑุฌุฉ</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_chart_by_dept" class="w-4 h-4"><span>ุฑุณู ุนุฏุฏ ุงูุจูุงุบุงุช ููู ูุณู</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_chart_top_employees" class="w-4 h-4"><span>ุงูููุธููู ุงูุฃูุซุฑ ุชูุฑูุฑูุง ูู ุงูุจูุงุบุงุช</span></label>
                  <!-- ุตูุงุญูุงุช ุชุตุฏูุฑ ุงูุชูุงุฑูุฑ -->
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_report_summary_export" class="w-4 h-4"><span>ุชุตุฏูุฑ ุชูุฑูุฑ ููุฎุต ุงูุชุฌูุน</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_report_details_export" class="w-4 h-4"><span>ุชุตุฏูุฑ ุชูุฑูุฑ ุงูุจูุงุบุงุช ุงูุชูุตูููุฉ</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_report_departments_export" class="w-4 h-4"><span>ุชุตุฏูุฑ ุชูุฑูุฑ ุฃุฏุงุก ุงูุฃูุณุงู</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_report_employees_export" class="w-4 h-4"><span>ุชุตุฏูุฑ ุชูุฑูุฑ ุฃุฏุงุก ุงูููุธููู</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_report_critical_export" class="w-4 h-4"><span>ุชุตุฏูุฑ ุชูุฑูุฑ ุงูุจูุงุบุงุช ุงูุญุฑุฌุฉ</span></label>
                </div>
              </section>

              <!-- ุจูุงุบุงุช ุฅุฏุงุฑุฉ ุงูุชุฌูุน -->
              <section class="space-y-4">
                <h4 class="text-sm font-semibold text-[#002B5B] flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-teal-500"></span> ุจูุงุบุงุช ุฅุฏุงุฑุฉ ุงูุชุฌูุน
                </h4>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_cluster_submit" class="w-4 h-4">
                    <span>ุชูุฏูู ุจูุงุบ ุฅุฏุงุฑุฉ ุงูุชุฌูุน</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_cluster_view" class="w-4 h-4">
                    <span>ุนุฑุถ ุจูุงุบุงุช ุฅุฏุงุฑุฉ ุงูุชุฌูุน</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_cluster_details" class="w-4 h-4">
                    <span>ุนุฑุถ ุชูุงุตูู ุงูุจูุงุบ</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_cluster_reply" class="w-4 h-4">
                    <span>ุงูุฑุฏ ุนูู ุงูุจูุงุบ</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_cluster_status" class="w-4 h-4">
                    <span>ุชุบููุฑ ุญุงูุฉ ุงูุจูุงุบ</span>
                  </label>
                </div>
              </section>

              <!-- ุงูุฃุฑุดูู -->
              <section class="space-y-4">
                <h4 class="text-sm font-semibold text-[#002B5B] flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-amber-500"></span> ุงูุฃุฑุดูู
                </h4>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_archive_view" class="w-4 h-4">
                    <span>ุนุฑุถ ุงูุฃุฑุดูู</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_archive_upload" class="w-4 h-4">
                    <span>ุฅุถุงูุฉ ูุฑููุงุช ููุฃุฑุดูู</span>
                  </label>
                </div>
              </section>
            </div>
          </div>
        </form>
      </main>
    </section>

  </main>

  <!-- Footer - ุงูุชุฐููู -->
  <footer class="bg-gray-900 text-white py-14">
    <div class="container mx-auto px-4">
      <div class="grid md:grid-cols-3 gap-8">
        <!-- Column 1 - ุงูุนููุฏ ุงูุฃูู -->
        <div>
          <div class="flex items-center space-x-reverse space-x-3 mb-4">
            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 2L2 7v10c0 5.55 3.84 9.74 9 11 5.16-1.26 9-5.45 9-11V7l-10-5z"/>
              </svg>
            </div>
            <div>
              <div class="font-bold">ุชุฌูุน ููุฉ ุงูุตุญู</div>
              <div class="text-sm text-gray-300">ูุธุงู ุงูุจูุงุบุงุช</div>
            </div>
          </div>
          <p class="text-gray-300 text-sm">ููุตุฉ ุฑุณููุฉ ูุชูุฏูู ููุชุงุจุนุฉ ุงูุจูุงุบุงุช</p>
        </div>

        <!-- Column 2 - ุงูุนููุฏ ุงูุซุงูู -->
        <div>
          <h3 class="font-bold mb-4">ุฑูุงุจุท ุณุฑูุนุฉ</h3>
          <ul class="space-y-2 text-sm">
            <li><a href="../../index/index.html" class="text-gray-300 hover:text-white hover:underline transition-colors">ุงูุฑุฆูุณูุฉ</a></li>
            <li><a href="../complaints/submit/submit-complaint.html" class="text-gray-300 hover:text-white hover:underline transition-colors">ุชูุฏูู ุจูุงุบ</a></li>
            <li><a href="../complaints/track/track-complaint.html" class="text-gray-300 hover:text-white hover:underline transition-colors">ูุชุงุจุนุฉ ุจูุงุบ</a></li>
            <li><a href="../../index/help.html" class="text-gray-300 hover:text-white hover:underline transition-colors">ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ</a></li>
          </ul>
        </div>

        <!-- Column 3 - ุงูุนููุฏ ุงูุซุงูุซ -->
        <div>
          <h3 class="font-bold mb-4">ูุนูููุงุช ุงูุชูุงุตู</h3>
          <div class="space-y-2 text-sm text-gray-300">
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
              <span>ุฑูู ุงูุฏุนู: 0559735137</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
              <span>support@makkahhealth.gov.sa</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span>ุณุงุนุงุช ุงูุนูู: 24/7</span>
            </div>
          </div>
        </div>
      </div>

      <div class="border-t border-gray-700 mt-8 pt-8 text-center text-sm text-gray-300">
        ยฉ 2025 ุชุฌูุน ููุฉ ุงูููุฑูุฉ ุงูุตุญู โ ุฌููุน ุงูุญููู ูุญููุธุฉ
      </div>
    </div>
  </footer>

  <script>
const API_BASE = window.API_BASE || 'http://localhost:3001'; // ุนุฏููู ุญุณุจู
const token = localStorage.getItem('token'); // ูู ุนูุฏู JWT

const $  = (s,c=document)=>c.querySelector(s);
let selectedUserId = null;
let currentUser = null; // ูุนูููุงุช ุงููุณุชุฎุฏู ุงูุญุงูู

// ุฏุงูุฉ ูุชุฒุงูู ุญุงูุฉ ูุทุงู ุงูุณุฌู ูุน ุฎูุงุฑ ูุชุงุจุนุฉ/ุนุฑุถ
function syncScopeState(){
  const enabled = $('#p_view').checked;
  $('#p_scope').disabled = !enabled;
  $('#scopeRow').classList.toggle('opacity-50', !enabled);
}

// ุฏุงูุฉ ููุญุตูู ุนูู ูุนูููุงุช ุงููุณุชุฎุฏู ุงูุญุงูู
async function getCurrentUser() {
  try {
    const res = await fetch(`${API_BASE}/api/auth/me-permissions`, {
      headers: {
        'Accept': 'application/json',
        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
      },
      credentials: 'include'
    });
    
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    
    if (json.ok && json.user) {
      currentUser = json.user;
      console.log('๐ค ูุนูููุงุช ุงููุณุชุฎุฏู:', currentUser);
      return currentUser;
    } else {
      throw new Error('ูุดู ูู ุงูุญุตูู ุนูู ูุนูููุงุช ุงููุณุชุฎุฏู');
    }
  } catch (err) {
    console.error('โ ูุดู ุชุญููู ูุนูููุงุช ุงููุณุชุฎุฏู:', err);
    throw err;
  }
}

async function loadHospitals() {
  try {
    // ุงูุชุญูู ูู ูุฌูุฏ ูุนูููุงุช ุงููุณุชุฎุฏู
    if (!currentUser) {
      await getCurrentUser();
    }

    const sel = $('#hospitalSelect');
    let hospitals = [];

    // ูุฏูุฑ ุงูุชุฌูุน (RoleID = 1) - ูุฑู ุฌููุน ุงููุณุชุดููุงุช
    if (currentUser.RoleID === 1 || currentUser.HospitalID === null) {
      console.log('๐ฅ ูุฏูุฑ ุงูุชุฌูุน - ุชุญููู ุฌููุน ุงููุณุชุดููุงุช');
      
      const res = await fetch(`${API_BASE}/api/hospitals`, {
        headers: {
          'Accept': 'application/json',
          ...(token ? { 'Authorization': `Bearer ${token}` } : {})
        },
        credentials: 'include'
      });
      const json = await res.json();
      
      // ุงูุชุนุงูู ูุน ุงูุชูุณูููู: Array ูุจุงุดุฑ ุฃู { ok: true, data: [...] }
      if (Array.isArray(json)) {
        hospitals = json;
      } else if (json.ok && json.data) {
        hospitals = json.data;
      } else {
        throw new Error(json.error || 'ุชูุณูู ุจูุงูุงุช ุบูุฑ ุตุญูุญ');
      }

      sel.innerHTML = `<option value="">โ ุงุฎุชุฑ ุงููุณุชุดูู โ</option>` +
        hospitals.map(h => `<option value="${h.HospitalID}">${h.NameAr}</option>`).join('');
        
    } else {
      // ูุฏูุฑ ูุณุชุดูู ุฃู ููุธู - ูุฑู ูุณุชุดูุงู ููุท
      console.log('๐ฅ ูุณุชุฎุฏู ูุณุชุดูู - ุชุญููู ูุณุชุดูู ูุงุญุฏ:', currentUser.HospitalID, 'RoleID:', currentUser.RoleID);
      
      const res = await fetch(`${API_BASE}/api/hospitals`, {
        headers: {
          'Accept': 'application/json',
          ...(token ? { 'Authorization': `Bearer ${token}` } : {})
        },
        credentials: 'include'
      });
      const json = await res.json();
      
      let allHospitals = [];
      if (Array.isArray(json)) {
        allHospitals = json;
      } else if (json.ok && json.data) {
        allHospitals = json.data;
      }

      // ููุชุฑุฉ ุงููุณุชุดููุงุช ููุนุฑุถ ุงููุณุชุดูู ุงูุฎุงุต ููุท
      hospitals = allHospitals.filter(h => h.HospitalID === currentUser.HospitalID);
      
      if (hospitals.length > 0) {
        // ุฅุฎูุงุก ูุงุฆูุฉ ุงูุงุฎุชูุงุฑ ูุฅุธูุงุฑ ุงููุณุชุดูู ูุจุงุดุฑุฉ
        const hospitalContainer = document.querySelector('.bg-white.rounded-2xl.p-6.shadow-xl.border.border-gray-100.mb-6');
        if (hospitalContainer) {
          hospitalContainer.innerHTML = `
            <div class="flex items-center gap-3">
              <label class="text-sm text-gray-600 whitespace-nowrap">ุงููุณุชุดูู:</label>
              <div class="h-10 min-w-[220px] rounded-xl border border-gray-200 px-3 bg-gray-50 flex items-center text-gray-700">
                ${hospitals[0].NameAr}
              </div>
            </div>
          `;
        }
        
        // ุชุนููู ุงููุณุชุดูู ุชููุงุฆูุงู
        sel.innerHTML = `<option value="${hospitals[0].HospitalID}" selected>${hospitals[0].NameAr}</option>`;
        
        // ููููุธููู ุงูุนุงุฏูููุ ุฃุฎูู ุฒุฑ ุงูุญูุธ
        if (currentUser.RoleID === 3) {
          const saveButton = document.getElementById('savePerm');
          if (saveButton) {
            saveButton.style.display = 'none';
          }
        }
        
        // ุชุญููู ุงููุณุชุฎุฏููู ูุจุงุดุฑุฉ
        loadUsersByHospital();
      } else {
        throw new Error('ุงููุณุชุดูู ุบูุฑ ููุฌูุฏ');
      }
    }

  } catch (err) {
    console.error('โ ูุดู ุชุญููู ุงููุณุชุดููุงุช:', err);
    alert('ุชุนุฐุฑ ุชุญููู ูุงุฆูุฉ ุงููุณุชุดููุงุช');
  }
}

async function loadUsersByHospital() {
  const hospitalSelect = document.getElementById("hospitalSelect");
  const usersList = document.getElementById("usersList");
  const usersEmpty = document.getElementById("usersEmpty");
  const usersCount = document.getElementById("usersCount");
  
  // ุงูุชุญูู ูู ูุฌูุฏ ุงูุนูุงุตุฑ ุงููุทููุจุฉ
  if (!usersList || !usersEmpty || !usersCount) {
    console.error('โ ุนูุงุตุฑ DOM ูุทููุจุฉ ุบูุฑ ููุฌูุฏุฉ');
    return;
  }
  
  // ุงูุญุตูู ุนูู ูุนุฑู ุงููุณุชุดูู
  let hid = hospitalSelect?.value;
  
  // ุฅุฐุง ูู ููู ููุงู ูููุฉ ูู ุงููุงุฆูุฉุ ุงุณุชุฎุฏู ูุนุฑู ุงููุณุชุดูู ูู ูุนูููุงุช ุงููุณุชุฎุฏู
  if (!hid && currentUser && currentUser.HospitalID) {
    hid = currentUser.HospitalID;
  }
  
  usersList.innerHTML = '';
  usersEmpty.classList.add('hidden');
  usersCount.textContent = '...';

  if (!hid) {
    usersCount.textContent = '0';
    usersEmpty.classList.remove('hidden');
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/api/permissions/users?hospitalId=${hid}`, {
      headers: {
        'Accept': 'application/json',
        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
      },
      credentials: 'include'
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    const data = Array.isArray(json) ? json : (json.data || []);
    usersCount.textContent = data.length;

    if (!data.length) {
      usersEmpty.classList.remove('hidden');
      return;
    }

    usersList.innerHTML = data.map(u => `
      <button class="w-full text-right py-2 px-2 hover:bg-gray-50 flex items-center gap-2 user-item" data-id="${u.UserID}">
        <span class="i-user w-6 h-6 rounded-full bg-gray-100 inline-flex items-center justify-center">๐ค</span>
        <span class="flex-1">
          <div class="text-sm font-medium text-[#002B5B]">${u.FullName || u.Username}</div>
          <div class="text-xs text-gray-500">${u.Username}</div>
        </span>
      </button>
    `).join('');

    // ุนูุฏ ุงูุถุบุท ุนูู ูุณุชุฎุฏู ูุนุฑุถ ุตูุงุญูุงุชู
    usersList.querySelectorAll('.user-item').forEach(btn=>{
      btn.addEventListener('click', async () => {
        usersList.querySelectorAll('.user-item').forEach(b=>b.classList.remove('bg-blue-50'));
        btn.classList.add('bg-blue-50');
        selectedUserId = btn.dataset.id;

        // ุงูุญุตูู ุนูู ูุนุฑู ุงููุณุชุดูู
        let hid = hospitalSelect?.value;
        if (!hid && currentUser && currentUser.HospitalID) {
          hid = currentUser.HospitalID;
        }
        
        console.log('ุชู ุงุฎุชูุงุฑ ุงููุณุชุฎุฏู:', selectedUserId);

        // ุชุญููู ุตูุงุญูุงุชู
        await loadUserPerms(hid, selectedUserId);
      });
    });

  } catch (err) {
    console.error('โ ูุดู ุชุญููู ุงููุณุชุฎุฏููู:', err);
    usersEmpty.textContent = 'ุชุนุฐูุฑ ุชุญููู ุงููุณุชุฎุฏููู.';
    usersEmpty.classList.remove('hidden');
    usersCount.textContent = '0';
  }
}

async function loadUserPerms(hid, userId){
  const permEmpty = $('#permEmpty');
  const permForm = $('#permForm');
  const selectedUserLabel = $('#selectedUserLabel');
  
  // ุงูุชุญูู ูู ูุฌูุฏ ุงูุนูุงุตุฑ ุงููุทููุจุฉ
  if (!permEmpty || !permForm || !selectedUserLabel) {
    console.error('โ ุนูุงุตุฑ DOM ูุทููุจุฉ ุบูุฑ ููุฌูุฏุฉ ูู loadUserPerms');
    return;
  }
  
  permEmpty.classList.add('hidden');
  permForm.classList.remove('hidden');
  
  // ุฅุฐุง ูู ููู ููุงู ูุนุฑู ูุณุชุดููุ ุงุณุชุฎุฏู ูุนุฑู ุงููุณุชุดูู ูู ูุนูููุงุช ุงููุณุชุฎุฏู
  if (!hid && currentUser && currentUser.HospitalID) {
    hid = currentUser.HospitalID;
  }
  
  selectedUserLabel.textContent = `ูุณุชุฎุฏู ุฑูู ${userId} โ ูุณุชุดูู ${hid}`;

  try {
    // ููููุธููู ุงูุนุงุฏูููุ ุงุณุชุฎุฏู endpoint ูุฎุชูู ูุฑุคูุฉ ุตูุงุญูุงุชูู ุงูุฎุงุตุฉ
    let endpoint = `${API_BASE}/api/permissions/users/${userId}?hospitalId=${hid}`;
    if (currentUser && currentUser.RoleID === 3 && userId === currentUser.UserID) {
      endpoint = `${API_BASE}/api/permissions/me`;
    }
    
    const res = await fetch(endpoint, {
      headers: {
        'Accept':'application/json',
        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
      },
      credentials:'include'
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    const p = json.data || {};

    // ุนุฑูุถู ุงูุญุงูุงุช
    $('#p_submit').checked  = !!p.submit;
    $('#p_view').checked    = !!p.view;
    $('#p_reply').checked   = !!p.reply;
    $('#p_transfer_dept').checked = !!p.transferDept;
    $('#p_transfer_user').checked = !!p.transferUser;
    $('#p_complaint_transfer_hospital').checked = !!p.complaintTransferHospital;
    $('#p_status').checked  = !!p.statusUpdate;
    $('#p_delete').checked  = !!p.remove;
    $('#p_admin_panel').checked = !!p.adminPanel;
    $('#p_admin_depts').checked = !!p.adminDepartments;
    $('#p_admin_hospital').checked = !!p.adminHospital;
    $('#p_admin_clusters').checked = !!p.adminClusters;
    $('#p_hospital_create').checked = !!p.hospitalCreate;
    // ุตูุงุญูุงุช ุฅุฏุงุฑุฉ ุงููุณุชุดูู (ุงูุฃููููุงุช ุงูุฃุฑุจุนุฉ)
    $('#p_hospital_trash').checked = !!p.hospitalTrash;
    $('#p_hospital_logs').checked = !!p.hospitalLogs;
    $('#p_hospital_permissions').checked = !!p.hospitalPermissions;
    $('#p_hospital_users').checked = !!p.hospitalUsers;
    $('#p_hospital_user_create').checked = !!p.hospitalUserCreate;
    $('#p_hospital_user_edit').checked = !!p.hospitalUserEdit;
    $('#p_hospital_user_delete').checked = !!p.hospitalUserDelete;
    // ุตูุงุญูุงุช ุงูุงุณุชูุฑุงุฏ
    $('#p_imports_page').checked = !!p.importsPage;
    $('#p_imports_depts').checked = !!p.importDepartments;
    $('#p_imports_mystery').checked = !!p.importMystery;
    $('#p_imports_937').checked = !!p.import937;
    // ุตูุงุญูุงุช ููุญุฉ ุงูุชุญูู
    $('#p_dash_page').checked = !!p.dashPage;
    $('#p_dash_card_totals').checked = !!p.dashCardTotals;
    $('#p_dash_card_open').checked = !!p.dashCardOpen;
    $('#p_dash_card_closed').checked = !!p.dashCardClosed;
    $('#p_dash_card_urgent').checked = !!p.dashCardUrgent;
    $('#p_dash_card_close_rate').checked = !!p.dashCardCloseRate;
    $('#p_dash_card_hosp_count').checked = !!p.dashCardHospCount;
    $('#p_dash_chart_mystery').checked = !!p.dashChartMystery;
    $('#p_dash_chart_classes').checked = !!p.dashChartClasses;
    $('#p_dash_chart_top_clinics').checked = !!p.dashChartTopClinics;
    $('#p_dash_chart_daily_trend').checked = !!p.dashChartDailyTrend;
    $('#p_dash_urgent_list').checked = !!p.dashUrgentList;
    // ุตูุงุญูุงุช ุงููุดุงุฑูุน ุงูุชุญุณูููุฉ
    $('#p_impr_module').checked = !!p.improvementsModule;
    $('#p_impr_view').checked = !!p.improvementView;
    $('#p_impr_create').checked = !!p.improvementCreate;
    $('#p_impr_edit').checked = !!p.improvementEdit;
    $('#p_impr_delete').checked = !!p.improvementDelete;
    $('#p_impr_report').checked = !!p.improvementReportView;
    
    // ุตูุงุญูุงุช ุงูุฒุงุฆุฑ ุงูุณุฑู
    $('#p_mys_module').checked = !!p.mysteryModule;
    $('#p_mys_view').checked = !!p.mysteryView;
    $('#p_mys_reply').checked = !!p.mysteryReplyAdd;
    $('#p_mys_status').checked = !!p.mysteryStatusUpdate;
    $('#p_mys_t_dept').checked = !!p.mysteryTransferDept;
    $('#p_mys_t_emp').checked = !!p.mysteryTransferEmp;
    $('#p_mys_del').checked = !!p.mysteryDelete;
    // ุตูุงุญูุงุช ุงูุชูุงุฑูุฑ
    $('#p_reports_page').checked               = !!p.reportsPage;
    $('#p_reports_card_totals').checked        = !!p.reportsCardTotals;
    $('#p_reports_card_open').checked          = !!p.reportsCardOpen;
    $('#p_reports_card_closed').checked        = !!p.reportsCardClosed;
    $('#p_reports_card_urgent').checked        = !!p.reportsCardUrgent;
    $('#p_reports_card_sla').checked           = !!p.reportsCardSLA;
    $('#p_reports_card_hospitals').checked     = !!p.reportsCardHospitals;
    $('#p_reports_chart_by_hosp_type').checked = !!p.reportsChartByHospitalType;
    $('#p_reports_chart_status_dist').checked  = !!p.reportsChartStatusDistribution;
    $('#p_reports_chart_trend6').checked       = !!p.reportsChartTrend6m;
    $('#p_reports_chart_urgent_pct').checked   = !!p.reportsChartUrgentPercent;
    $('#p_reports_chart_by_dept').checked      = !!p.reportsChartByDepartment;
    $('#p_reports_chart_top_employees').checked = !!p.reportsChartTopEmployees;
    $('#p_report_summary_export').checked = !!p.reportSummaryExport;
    $('#p_report_details_export').checked = !!p.reportDetailsExport;
    $('#p_report_departments_export').checked = !!p.reportDepartmentsExport;
    $('#p_report_employees_export').checked = !!p.reportEmployeesExport;
    $('#p_report_critical_export').checked = !!p.reportCriticalExport;
    // ุตูุงุญูุงุช ุจูุงุบุงุช ุฅุฏุงุฑุฉ ุงูุชุฌูุน
    $('#p_cluster_submit').checked  = !!p.clusterSubmit;
    $('#p_cluster_view').checked    = !!p.clusterView;
    $('#p_cluster_details').checked = !!p.clusterDetails;
    $('#p_cluster_reply').checked   = !!p.clusterReply;
    $('#p_cluster_status').checked  = !!p.clusterStatus;
    // ุตูุงุญูุงุช ุงูุฃุฑุดูู
    $('#p_archive_view').checked   = !!p.archiveView;
    $('#p_archive_upload').checked = !!p.archiveUpload;
    $('#p_scope').value     = p.historyScope || '';
    
    // ุชุนุทูู/ุชูุนูู ูุทุงู ุงูุณุฌู ุญุณุจ ุญุงูุฉ ูุชุงุจุนุฉ/ุนุฑุถ
    syncScopeState();

  } catch(err){
    console.error('ูุดู ุชุญููู ุตูุงุญูุงุช ุงููุณุชุฎุฏู:', err);
    alert('ุชุนุฐุฑ ุชุญููู ุตูุงุญูุงุช ุงููุณุชุฎุฏู');
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const hospitalSelect = document.getElementById("hospitalSelect");
  const usersList = document.getElementById("usersList");
  const usersEmpty = document.getElementById("usersEmpty");
  const usersCount = document.getElementById("usersCount");

  // ุชุญููู ุงููุณุชุดููุงุช ูู API
  loadHospitals();

  // ุฑุจุท ุชุบููุฑ ุงููุณุชุดูู ุจุชุญููู ุงููุณุชุฎุฏููู
  if (hospitalSelect) {
    hospitalSelect.addEventListener('change', loadUsersByHospital);
  }

  // ุฑุจุท ุชุบููุฑ checkbox ูุชุงุจุนุฉ/ุนุฑุถ ุจุชูุนูู/ุชุนุทูู ูุทุงู ุงูุณุฌู
  $('#p_view')?.addEventListener('change', syncScopeState);

  // ุญูุธ ุงูุตูุงุญูุงุช
  $('#savePerm').addEventListener('click', async ()=>{
    if (!selectedUserId) return;
    
    // ููููุธููู ุงูุนุงุฏูููุ ููุน ุงูุญูุธ
    if (currentUser && currentUser.RoleID === 3) {
      alert('ููุณ ูุฏูู ุตูุงุญูุฉ ูุชุนุฏูู ุงูุตูุงุญูุงุช');
      return;
    }
    
    // ุงูุญุตูู ุนูู ูุนุฑู ุงููุณุชุดูู
    let hid = hospitalSelect?.value;
    if (!hid && currentUser && currentUser.HospitalID) {
      hid = currentUser.HospitalID;
    }

    const payload = {
      hospitalId: Number(hid),
      submit:  $('#p_submit').checked,
      view:    $('#p_view').checked,
      historyScope: $('#p_view').checked ? ($('#p_scope').value || null) : null,
      reply:   $('#p_reply').checked,
      transferDept: $('#p_transfer_dept').checked,
      transferUser: $('#p_transfer_user').checked,
      complaintTransferHospital: $('#p_complaint_transfer_hospital').checked,
      statusUpdate: $('#p_status').checked,
      remove:  $('#p_delete').checked,
      adminPanel: $('#p_admin_panel').checked,
      adminDepartments: $('#p_admin_depts').checked,
      adminHospital: $('#p_admin_hospital').checked,
      adminClusters: $('#p_admin_clusters').checked,
      hospitalCreate: $('#p_hospital_create').checked,
      // ุตูุงุญูุงุช ุฅุฏุงุฑุฉ ุงููุณุชุดูู (ุงูุฃููููุงุช ุงูุฃุฑุจุนุฉ)
      hospitalTrash: $('#p_hospital_trash').checked,
      hospitalLogs: $('#p_hospital_logs').checked,
      hospitalPermissions: $('#p_hospital_permissions').checked,
      hospitalUsers: $('#p_hospital_users').checked,
      hospitalUserCreate: $('#p_hospital_user_create').checked,
      hospitalUserEdit: $('#p_hospital_user_edit').checked,
      hospitalUserDelete: $('#p_hospital_user_delete').checked,
      // ุตูุงุญูุงุช ุงูุงุณุชูุฑุงุฏ
      importsPage: $('#p_imports_page').checked,
      importDepartments: $('#p_imports_depts').checked,
      importMystery: $('#p_imports_mystery').checked,
      import937: $('#p_imports_937').checked,
      // ุตูุงุญูุงุช ููุญุฉ ุงูุชุญูู
      dashPage: $('#p_dash_page').checked,
      dashCardTotals: $('#p_dash_card_totals').checked,
      dashCardOpen: $('#p_dash_card_open').checked,
      dashCardClosed: $('#p_dash_card_closed').checked,
      dashCardUrgent: $('#p_dash_card_urgent').checked,
      dashCardCloseRate: $('#p_dash_card_close_rate').checked,
      dashCardHospCount: $('#p_dash_card_hosp_count').checked,
      dashChartMystery: $('#p_dash_chart_mystery').checked,
      dashChartClasses: $('#p_dash_chart_classes').checked,
      dashChartTopClinics: $('#p_dash_chart_top_clinics').checked,
      dashChartDailyTrend: $('#p_dash_chart_daily_trend').checked,
      dashUrgentList: $('#p_dash_urgent_list').checked,
      // ุตูุงุญูุงุช ุงููุดุงุฑูุน ุงูุชุญุณูููุฉ
      improvementsModule: $('#p_impr_module').checked,
      improvementView: $('#p_impr_view').checked,
      improvementCreate: $('#p_impr_create').checked,
      improvementEdit: $('#p_impr_edit').checked,
      improvementDelete: $('#p_impr_delete').checked,
      improvementReportView: $('#p_impr_report').checked,
      
      // ุตูุงุญูุงุช ุงูุฒุงุฆุฑ ุงูุณุฑู
      mysteryModule: $('#p_mys_module').checked,
      mysteryView: $('#p_mys_view').checked,
      mysteryReplyAdd: $('#p_mys_reply').checked,
      mysteryStatusUpdate: $('#p_mys_status').checked,
      mysteryTransferDept: $('#p_mys_t_dept').checked,
      mysteryTransferEmp: $('#p_mys_t_emp').checked,
      mysteryDelete: $('#p_mys_del').checked,
      // ุตูุงุญูุงุช ุงูุชูุงุฑูุฑ
      reportsPage: $('#p_reports_page').checked,
      reportsCardTotals: $('#p_reports_card_totals').checked,
      reportsCardOpen: $('#p_reports_card_open').checked,
      reportsCardClosed: $('#p_reports_card_closed').checked,
      reportsCardUrgent: $('#p_reports_card_urgent').checked,
      reportsCardSLA: $('#p_reports_card_sla').checked,
      reportsCardHospitals: $('#p_reports_card_hospitals').checked,
      reportsChartByHospitalType: $('#p_reports_chart_by_hosp_type').checked,
      reportsChartStatusDistribution: $('#p_reports_chart_status_dist').checked,
      reportsChartTrend6m: $('#p_reports_chart_trend6').checked,
      reportsChartUrgentPercent: $('#p_reports_chart_urgent_pct').checked,
      reportsChartByDepartment: $('#p_reports_chart_by_dept').checked,
      reportsChartTopEmployees: $('#p_reports_chart_top_employees').checked,
      reportSummaryExport: $('#p_report_summary_export').checked,
      reportDetailsExport: $('#p_report_details_export').checked,
      reportDepartmentsExport: $('#p_report_departments_export').checked,
      reportEmployeesExport: $('#p_report_employees_export').checked,
      reportCriticalExport: $('#p_report_critical_export').checked,
      // ุตูุงุญูุงุช ุจูุงุบุงุช ุฅุฏุงุฑุฉ ุงูุชุฌูุน
      clusterSubmit:  $('#p_cluster_submit').checked,
      clusterView:    $('#p_cluster_view').checked,
      clusterDetails: $('#p_cluster_details').checked,
      clusterReply:   $('#p_cluster_reply').checked,
      clusterStatus:  $('#p_cluster_status').checked,
      // ุตูุงุญูุงุช ุงูุฃุฑุดูู
      archiveView:   $('#p_archive_view').checked,
      archiveUpload: $('#p_archive_upload').checked
    };

    console.log('๐ค Payload being sent:', {
      archiveView: payload.archiveView,
      archiveUpload: payload.archiveUpload,
      hospitalId: payload.hospitalId
    });

    try {
      const res = await fetch(`${API_BASE}/api/permissions/users/${selectedUserId}`, {
        method:'PUT',
        headers:{
          'Content-Type':'application/json',
          ...(token ? { 'Authorization': `Bearer ${token}` } : {})
        },
        credentials:'include',
        body: JSON.stringify(payload)
      });
      const json = await res.json();
      console.log('๐ฅ Response from server:', json);
      if (!res.ok || !json.ok) {
        throw new Error(json.error || 'ูุดู ุญูุธ ุงูุตูุงุญูุงุช');
      }
      // Toast ุจุณูุท
      console.log('โ ุชู ุงูุญูุธ ุจูุฌุงุญ');
      alert('ุชู ุญูุธ ุงูุตูุงุญูุงุช ุจูุฌุงุญ');
      
      // ุฅุนุงุฏุฉ ุชุญููู ุตูุงุญูุงุช ุงููุณุชุฎุฏู ูุนุฑุถ ุงูููู ุงููุญููุธุฉ
      if (selectedUserId) {
        loadUserPerms(hid, selectedUserId);
      }
    } catch (err) {
      console.error('โ ูุดู ุญูุธ ุงูุตูุงุญูุงุช:', err);
      alert(`ุชุนุฐุฑ ุญูุธ ุงูุตูุงุญูุงุช: ${err.message}`);
    }
  });

  // ุชุฃุซูุฑ ุชุบููุฑ ููู ุงูููุฏุฑ ุนูุฏ ุงูุชูุฑูุฑ
  window.addEventListener("scroll", function () {
    const navbar = document.getElementById("navbar");
    if (window.scrollY > 50) {
      navbar.style.backgroundColor = "#ffffff";
      navbar.classList.add("shadow-md");
      navbar.querySelectorAll("a").forEach(link => {
        link.classList.remove("text-white", "hover:text-blue-200");
        link.classList.add("text-[#002B5B]", "hover:text-blue-700");
      });
    } else {
      navbar.style.backgroundColor = "#002B5B";
      navbar.classList.remove("shadow-md");
      navbar.querySelectorAll("a").forEach(link => {
        link.classList.add("text-white", "hover:text-blue-200");
        link.classList.remove("text-[#002B5B]", "hover:text-blue-700");
      });
    }
  });
});
</script>
</body>
</html>

