<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen flex flex-col bg-gray-50" style="font-family:'Tajawal',sans-serif">
  <!-- Header - Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
  <header id="navbar" class="fixed w-full top-0 z-50 navbar-scroll" style="background-color: #002B5B;">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <!-- Logo - Ø§Ù„Ø´Ø¹Ø§Ø± -->
        <div class="flex items-center">
          <img src="../assets/img/logo3.png" alt="Ø´Ø¹Ø§Ø± ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„ØµØ­ÙŠ" class="h-16 w-auto">
        </div>
        
        <!-- Navigation - Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ†Ù‚Ù„ -->
        <nav class="hidden md:flex items-center space-x-reverse space-x-8">
          <a href="../../index/index.html" id="nav-home" class="text-white hover:text-blue-200 transition-colors">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
          <a href="../../dashboard/dashboard.html" id="nav-dashboard" class="text-white hover:text-blue-200 transition-colors">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
          <a href="../../index/about-system.html" id="nav-about" class="text-white hover:text-blue-200 transition-colors">Ø­ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</a>
          <a href="../../index/help.html" id="nav-help" class="text-white hover:text-blue-200 transition-colors">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</a>
          <a href="../../index/contact.html" id="nav-contact" class="text-white hover:text-blue-200 transition-colors">Ø§ØªØµÙ„ Ø¨Ù†Ø§</a>
          <button id="languageToggle" class="text-white hover:text-blue-200 transition-colors flex items-center">
            ğŸŒ English
          </button>
        </nav>
        
        <!-- Mobile menu button - Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
        <button class="md:hidden text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 pt-24 pb-10 flex-1">
    <section class="text-center mb-8">
      <h1 class="text-3xl md:text-4xl font-extrabold text-[#002B5B] mb-2">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h1>
      <p class="text-gray-600">Ø£Ø¯ÙˆØ§Ø± ÙˆÙ…ÙŠØ²Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
    </section>


    <div class="bg-white rounded-2xl p-6 shadow-xl border border-gray-100 mb-6">
      <div class="flex items-center gap-3">
        <label for="hospitalSelect" class="text-sm text-gray-600 whitespace-nowrap">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰:</label>
        <select id="hospitalSelect"
                class="h-10 min-w-[220px] rounded-xl border border-gray-200 px-3 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-100">
          <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ â€”</option>
        </select>
      </div>
    </div>

    <section class="mt-4 grid grid-cols-12 gap-4">
      <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
      <aside class="col-span-12 lg:col-span-4">
        <div class="bg-white rounded-2xl shadow p-3 border" style="min-height: 360px;">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-bold text-[#002B5B] text-sm">Ù…Ø³ØªØ®Ø¯Ù…Ùˆ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</h3>
            <span id="usersCount" class="text-xs text-gray-500">0</span>
          </div>
          <div id="usersList" class="divide-y">
            <!-- ÙŠØªÙ… Ø§Ù„Ø­Ù‚Ù† Ù‡Ù†Ø§ -->
          </div>
          <div id="usersEmpty" class="text-center text-gray-400 py-8 hidden">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†.</div>
        </div>
      </aside>

      <!-- Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª -->
      <main class="col-span-12 lg:col-span-8">
        <div id="permEmpty" class="bg-white rounded-2xl shadow border min-h-72 flex items-center justify-center">
          <div class="text-gray-400 text-center">
            Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ù‹Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¹Ø±Ø¶ ØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡.
          </div>
        </div>

        <form id="permForm" class="hidden">
          <div class="bg-white rounded-2xl shadow border overflow-hidden">
            <!-- Ø±Ø£Ø³ Ø§Ù„ÙƒØ±Øª -->
            <div class="flex items-center justify-between px-5 py-4 bg-gray-50 border-b">
              <div class="text-sm text-gray-500">
                <span id="selectedUserLabel" class="font-medium text-[#002B5B]">Ù…Ø³ØªØ®Ø¯Ù… Ø±Ù‚Ù… â€” Ù…Ø³ØªØ´ÙÙ‰ â€”</span>
              </div>
              <button id="savePerm" type="button" class="px-4 py-2 rounded-xl bg-[#2d60ff] text-white text-sm hover:opacity-90">
                Ø­ÙØ¸
              </button>
            </div>

            <!-- Ø¬Ø³Ù… Ø§Ù„ÙƒØ±Øª -->
            <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-8">

              <!-- Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª -->
              <section class="space-y-4">
                <h4 class="text-sm font-semibold text-[#002B5B] flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-[#2d60ff]"></span> Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª
                </h4>

                <!-- Ù…ØªØ§Ø¨Ø¹Ø© + Ù†Ø·Ø§Ù‚Ù‡Ø§ ØªØ­ØªÙ‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© -->
                <div class="space-y-2">
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_view" class="w-4 h-4">
                    <span>Ù…ØªØ§Ø¨Ø¹Ø©/Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</span>
                  </label>

                  <div id="scopeRow" class="pl-7">
                    <label for="p_scope" class="block text-xs text-gray-600 mb-1">Ù†Ø·Ø§Ù‚ Ø³Ø¬Ù„ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª:</label>
                    <select id="p_scope" class="border rounded-lg px-3 py-2 w-full">
                      <option value="">â€” Ù„Ø§ Ù…Ø´Ø§Ù‡Ø¯Ø© â€”</option>
                      <option value="ASSIGNED">Ø§Ù„Ù…Ø³Ù†Ù‘Ø¯Ø© Ù„ÙŠ</option>
                      <option value="DEPARTMENT">Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù‚Ø³Ù…</option>
                      <option value="HOSPITAL">Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</option>
                    </select>
                    <p class="text-[11px] text-gray-400 mt-1">ÙŠØ·Ù‘Ø¨Ù‚ ÙÙ‚Ø· Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ "Ù…ØªØ§Ø¨Ø¹Ø©/Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª".</p>
                  </div>
                </div>

                <!-- ØªÙ‚Ø¯ÙŠÙ… Ø¨Ù„Ø§Øº -->
                <label class="flex items-center gap-3">
                  <input type="checkbox" id="p_submit" class="w-4 h-4">
                  <span>ØªÙ‚Ø¯ÙŠÙ… Ø¨Ù„Ø§Øº</span>
                </label>
              </section>

              <!-- Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù„Ø§Øº -->
              <section class="space-y-4">
                <h4 class="text-sm font-semibold text-[#002B5B] flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-emerald-500"></span> Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù„Ø§Øº
                </h4>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_reply" class="w-4 h-4">
                    <span>Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù„Ø§Øº</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_transfer_dept" class="w-4 h-4">
                    <span>ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_transfer_user" class="w-4 h-4">
                    <span>ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_status" class="w-4 h-4">
                    <span>ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_delete" class="w-4 h-4">
                    <span>Ø­Ø°Ù Ø§Ù„Ø¨Ù„Ø§Øº</span>
                  </label>
                </div>
              </section>

              <!-- ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¥Ø¯Ø§Ø±ÙŠØ© -->
              <section class="space-y-4">
                <h4 class="text-sm font-semibold text-[#002B5B] flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-purple-500"></span> ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¥Ø¯Ø§Ø±ÙŠØ©
                </h4>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_admin_panel" class="w-4 h-4">
                    <span>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_admin_depts" class="w-4 h-4">
                    <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_admin_hospital" class="w-4 h-4">
                    <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_admin_clusters" class="w-4 h-4">
                    <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª (Ø§Ù„ØªØ¬Ù…Ø¹)</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_hospital_create" class="w-4 h-4">
                    <span>Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ´ÙÙ‰ Ø¬Ø¯ÙŠØ¯</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_hospital_trash" class="w-4 h-4">
                    <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_hospital_logs" class="w-4 h-4">
                    <span>Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_hospital_permissions" class="w-4 h-4">
                    <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_hospital_users" class="w-4 h-4">
                    <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_hospital_user_create" class="w-4 h-4">
                    <span>Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_hospital_user_edit" class="w-4 h-4">
                    <span>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_hospital_user_delete" class="w-4 h-4">
                    <span>Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span>
                  </label>
                </div>
              </section>

              <!-- Ø¥Ø±ÙØ§Ù‚ Ø§Ù„Ø¥ÙƒØ³Ù„ -->
              <section class="space-y-4">
                <h4 class="text-sm font-semibold text-[#002B5B] flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-blue-500"></span> Ø¥Ø±ÙØ§Ù‚ Ø§Ù„Ø¥ÙƒØ³Ù„
                </h4>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_imports_page" class="w-4 h-4">
                    <span>Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø¥Ø±ÙØ§Ù‚ Ø§Ù„Ø¥ÙƒØ³Ù„</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_imports_depts" class="w-4 h-4">
                    <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_imports_mystery" class="w-4 h-4">
                    <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø²Ø§Ø¦Ø± Ø§Ù„Ø³Ø±ÙŠ</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_imports_937" class="w-4 h-4">
                    <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ 937</span>
                  </label>
                </div>
              </section>

              <!-- ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
              <section class="space-y-4">
                <h4 class="text-sm font-semibold text-[#002B5B] flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-orange-500"></span> ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                </h4>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_page" class="w-4 h-4">
                    <span>Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_card_totals" class="w-4 h-4">
                    <span>Ø¨Ø·Ø§Ù‚Ø© Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_card_open" class="w-4 h-4">
                    <span>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_card_closed" class="w-4 h-4">
                    <span>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…ØºÙ„Ù‚Ø©</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_card_urgent" class="w-4 h-4">
                    <span>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø­Ø±Ø¬Ø©</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_card_close_rate" class="w-4 h-4">
                    <span>Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_card_hosp_count" class="w-4 h-4">
                    <span>Ø¨Ø·Ø§Ù‚Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_chart_mystery" class="w-4 h-4">
                    <span>Ø±Ø³Ù… Ø§Ù„Ø²Ø§Ø¦Ø± Ø§Ù„Ø³Ø±ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_chart_classes" class="w-4 h-4">
                    <span>Ø±Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_chart_top_clinics" class="w-4 h-4">
                    <span>Ø±Ø³Ù… Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_chart_daily_trend" class="w-4 h-4">
                    <span>Ø±Ø³Ù… Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</span>
                  </label>

                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_dash_urgent_list" class="w-4 h-4">
                    <span>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø­Ù…Ø±Ø§Ø¡</span>
                  </label>
                </div>
              </section>

              <!-- Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„ØªØ­Ø³ÙŠÙ†ÙŠØ© -->
              <section class="space-y-4">
                <h4 class="text-sm font-semibold text-[#002B5B] flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-red-500"></span> Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„ØªØ­Ø³ÙŠÙ†ÙŠØ©
                </h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_impr_module" class="w-4 h-4">
                    <span>Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØµÙØ­Ø©</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_impr_view" class="w-4 h-4">
                    <span>Ø¹Ø±Ø¶ Ù…Ø´Ø±ÙˆØ¹</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_impr_create" class="w-4 h-4">
                    <span>Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_impr_edit" class="w-4 h-4">
                    <span>ØªØ¹Ø¯ÙŠÙ„ Ù…Ø´Ø±ÙˆØ¹</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_impr_delete" class="w-4 h-4">
                    <span>Ø­Ø°Ù Ù…Ø´Ø±ÙˆØ¹</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_impr_report" class="w-4 h-4">
                    <span>Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</span>
                  </label>
                </div>
              </section>

              <!-- Ø§Ù„Ø²Ø§Ø¦Ø± Ø§Ù„Ø³Ø±ÙŠ -->
              <section class="space-y-4">
                <h4 class="text-sm font-semibold text-[#002B5B] flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-purple-500"></span> Ø§Ù„Ø²Ø§Ø¦Ø± Ø§Ù„Ø³Ø±ÙŠ
                </h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_mys_module" class="w-4 h-4">
                    <span>Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØµÙØ­Ø©</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_mys_view" class="w-4 h-4">
                    <span>Ø¹Ø±Ø¶ ØªÙ‚ÙŠÙŠÙ…</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_mys_reply" class="w-4 h-4">
                    <span>Ø¥Ø¶Ø§ÙØ© Ø±Ø¯/ØªØ¹Ù„ÙŠÙ‚</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_mys_status" class="w-4 h-4">
                    <span>ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_mys_t_dept" class="w-4 h-4">
                    <span>ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_mys_t_emp" class="w-4 h-4">
                    <span>ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_mys_del" class="w-4 h-4">
                    <span>Ø­Ø°Ù ØªÙ‚ÙŠÙŠÙ…</span>
                  </label>
                </div>
              </section>

              <!-- ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
              <section class="space-y-4">
                <h4 class="text-sm font-semibold text-[#002B5B] flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-cyan-500"></span> ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                </h4>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_page" class="w-4 h-4"><span>Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span></label>

                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_card_totals" class="w-4 h-4"><span>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_card_open" class="w-4 h-4"><span>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø©</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_card_closed" class="w-4 h-4"><span>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…ØºÙ„Ù‚Ø©</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_card_urgent" class="w-4 h-4"><span>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­Ø±Ø¬Ø©</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_card_sla" class="w-4 h-4"><span>Ø¨Ø·Ø§Ù‚Ø© SLA</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_card_hospitals" class="w-4 h-4"><span>Ø¨Ø·Ø§Ù‚Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª</span></label>

                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_chart_by_hosp_type" class="w-4 h-4"><span>Ø±Ø³Ù… Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù„Ø§Øº/Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_chart_status_dist" class="w-4 h-4"><span>Ø±Ø³Ù… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø©</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_chart_trend6" class="w-4 h-4"><span>Ø±Ø³Ù… Ø§Ù„Ø§ØªØ¬Ø§Ù‡ (6 Ø£Ø´Ù‡Ø±)</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_chart_urgent_pct" class="w-4 h-4"><span>Ø±Ø³Ù… Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø±Ø¬Ø©</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_chart_by_dept" class="w-4 h-4"><span>Ø±Ø³Ù… Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ù„ÙƒÙ„ Ù‚Ø³Ù…</span></label>
                  <label class="flex items-center gap-3"><input type="checkbox" id="p_reports_chart_top_employees" class="w-4 h-4"><span>Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ† Ø§Ù„Ø£ÙƒØ«Ø± ØªÙƒØ±Ù‘Ø±Ù‹Ø§ ÙÙŠ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</span></label>
                </div>
              </section>

              <!-- Ø¨Ù„Ø§ØºØ§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¬Ù…Ø¹ -->
              <section class="space-y-4">
                <h4 class="text-sm font-semibold text-[#002B5B] flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-teal-500"></span> Ø¨Ù„Ø§ØºØ§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¬Ù…Ø¹
                </h4>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_cluster_submit" class="w-4 h-4">
                    <span>ØªÙ‚Ø¯ÙŠÙ… Ø¨Ù„Ø§Øº Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¬Ù…Ø¹</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_cluster_view" class="w-4 h-4">
                    <span>Ø¹Ø±Ø¶ Ø¨Ù„Ø§ØºØ§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¬Ù…Ø¹</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_cluster_details" class="w-4 h-4">
                    <span>Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§Øº</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_cluster_reply" class="w-4 h-4">
                    <span>Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù„Ø§Øº</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_cluster_status" class="w-4 h-4">
                    <span>ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ù„Ø§Øº</span>
                  </label>
                </div>
              </section>

              <!-- Ø§Ù„Ø£Ø±Ø´ÙŠÙ -->
              <section class="space-y-4">
                <h4 class="text-sm font-semibold text-[#002B5B] flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-amber-500"></span> Ø§Ù„Ø£Ø±Ø´ÙŠÙ
                </h4>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_archive_view" class="w-4 h-4">
                    <span>Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</span>
                  </label>
                  <label class="flex items-center gap-3">
                    <input type="checkbox" id="p_archive_upload" class="w-4 h-4">
                    <span>Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù„Ø£Ø±Ø´ÙŠÙ</span>
                  </label>
                </div>
              </section>
            </div>
          </div>
        </form>
      </main>
    </section>

  </main>

  <!-- Footer - Ø§Ù„ØªØ°ÙŠÙŠÙ„ -->
  <footer class="bg-gray-900 text-white py-14">
    <div class="container mx-auto px-4">
      <div class="grid md:grid-cols-3 gap-8">
        <!-- Column 1 - Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ -->
        <div>
          <div class="flex items-center space-x-reverse space-x-3 mb-4">
            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 2L2 7v10c0 5.55 3.84 9.74 9 11 5.16-1.26 9-5.45 9-11V7l-10-5z"/>
              </svg>
            </div>
            <div>
              <div class="font-bold">ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„ØµØ­ÙŠ</div>
              <div class="text-sm text-gray-300">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</div>
            </div>
          </div>
          <p class="text-gray-300 text-sm">Ù…Ù†ØµØ© Ø±Ø³Ù…ÙŠØ© Ù„ØªÙ‚Ø¯ÙŠÙ… ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</p>
        </div>

        <!-- Column 2 - Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ -->
        <div>
          <h3 class="font-bold mb-4">Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©</h3>
          <ul class="space-y-2 text-sm">
            <li><a href="../../index/index.html" class="text-gray-300 hover:text-white hover:underline transition-colors">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
            <li><a href="../complaints/submit/submit-complaint.html" class="text-gray-300 hover:text-white hover:underline transition-colors">ØªÙ‚Ø¯ÙŠÙ… Ø¨Ù„Ø§Øº</a></li>
            <li><a href="../complaints/track/track-complaint.html" class="text-gray-300 hover:text-white hover:underline transition-colors">Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ù„Ø§Øº</a></li>
            <li><a href="../../index/help.html" class="text-gray-300 hover:text-white hover:underline transition-colors">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©</a></li>
          </ul>
        </div>

        <!-- Column 3 - Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù„Ø« -->
        <div>
          <h3 class="font-bold mb-4">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</h3>
          <div class="space-y-2 text-sm text-gray-300">
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
              <span>Ø±Ù‚Ù… Ø§Ù„Ø¯Ø¹Ù…: 0559735137</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
              <span>support@makkahhealth.gov.sa</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„: 24/7</span>
            </div>
          </div>
        </div>
      </div>

      <div class="border-t border-gray-700 mt-8 pt-8 text-center text-sm text-gray-300">
        Â© 2025 ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„ØµØ­ÙŠ â€“ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©
      </div>
    </div>
  </footer>

  <script>
const API_BASE = window.API_BASE || 'http://localhost:3001'; // Ø¹Ø¯Ù‘Ù„ÙŠ Ø­Ø³Ø¨Ùƒ
const token = localStorage.getItem('token'); // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ JWT

const $  = (s,c=document)=>c.querySelector(s);
let selectedUserId = null;
let currentUser = null; // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ

// Ø¯Ø§Ù„Ø© Ù„ØªØ²Ø§Ù…Ù† Ø­Ø§Ù„Ø© Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¬Ù„ Ù…Ø¹ Ø®ÙŠØ§Ø± Ù…ØªØ§Ø¨Ø¹Ø©/Ø¹Ø±Ø¶
function syncScopeState(){
  const enabled = $('#p_view').checked;
  $('#p_scope').disabled = !enabled;
  $('#scopeRow').classList.toggle('opacity-50', !enabled);
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
async function getCurrentUser() {
  try {
    const res = await fetch(`${API_BASE}/api/auth/me-permissions`, {
      headers: {
        'Accept': 'application/json',
        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
      },
      credentials: 'include'
    });
    
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    
    if (json.ok && json.user) {
      currentUser = json.user;
      console.log('ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', currentUser);
      return currentUser;
    } else {
      throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
    }
  } catch (err) {
    console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', err);
    throw err;
  }
}

async function loadHospitals() {
  try {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (!currentUser) {
      await getCurrentUser();
    }

    const sel = $('#hospitalSelect');
    let hospitals = [];

    // Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ø¹ (RoleID = 1) - ÙŠØ±Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª
    if (currentUser.RoleID === 1 || currentUser.HospitalID === null) {
      console.log('ğŸ¥ Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ø¹ - ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª');
      
      const res = await fetch(`${API_BASE}/api/hospitals`, {
        headers: {
          'Accept': 'application/json',
          ...(token ? { 'Authorization': `Bearer ${token}` } : {})
        },
        credentials: 'include'
      });
      const json = await res.json();
      
      // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ÙŠÙ†: Array Ù…Ø¨Ø§Ø´Ø± Ø£Ùˆ { ok: true, data: [...] }
      if (Array.isArray(json)) {
        hospitals = json;
      } else if (json.ok && json.data) {
        hospitals = json.data;
      } else {
        throw new Error(json.error || 'ØªÙ†Ø³ÙŠÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­');
      }

      sel.innerHTML = `<option value="">â€“ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ â€“</option>` +
        hospitals.map(h => `<option value="${h.HospitalID}">${h.NameAr}</option>`).join('');
        
    } else {
      // Ù…Ø¯ÙŠØ± Ù…Ø³ØªØ´ÙÙ‰ Ø£Ùˆ Ù…ÙˆØ¸Ù - ÙŠØ±Ù‰ Ù…Ø³ØªØ´ÙØ§Ù‡ ÙÙ‚Ø·
      console.log('ğŸ¥ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³ØªØ´ÙÙ‰ - ØªØ­Ù…ÙŠÙ„ Ù…Ø³ØªØ´ÙÙ‰ ÙˆØ§Ø­Ø¯:', currentUser.HospitalID, 'RoleID:', currentUser.RoleID);
      
      const res = await fetch(`${API_BASE}/api/hospitals`, {
        headers: {
          'Accept': 'application/json',
          ...(token ? { 'Authorization': `Bearer ${token}` } : {})
        },
        credentials: 'include'
      });
      const json = await res.json();
      
      let allHospitals = [];
      if (Array.isArray(json)) {
        allHospitals = json;
      } else if (json.ok && json.data) {
        allHospitals = json.data;
      }

      // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª Ù„ÙŠØ¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø®Ø§Øµ ÙÙ‚Ø·
      hospitals = allHospitals.filter(h => h.HospitalID === currentUser.HospitalID);
      
      if (hospitals.length > 0) {
        // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ù…Ø¨Ø§Ø´Ø±Ø©
        const hospitalContainer = document.querySelector('.bg-white.rounded-2xl.p-6.shadow-xl.border.border-gray-100.mb-6');
        if (hospitalContainer) {
          hospitalContainer.innerHTML = `
            <div class="flex items-center gap-3">
              <label class="text-sm text-gray-600 whitespace-nowrap">Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰:</label>
              <div class="h-10 min-w-[220px] rounded-xl border border-gray-200 px-3 bg-gray-50 flex items-center text-gray-700">
                ${hospitals[0].NameAr}
              </div>
            </div>
          `;
        }
        
        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        sel.innerHTML = `<option value="${hospitals[0].HospitalID}" selected>${hospitals[0].NameAr}</option>`;
        
        // Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†ØŒ Ø£Ø®ÙÙŠ Ø²Ø± Ø§Ù„Ø­ÙØ¸
        if (currentUser.RoleID === 3) {
          const saveButton = document.getElementById('savePerm');
          if (saveButton) {
            saveButton.style.display = 'none';
          }
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¨Ø§Ø´Ø±Ø©
        loadUsersByHospital();
      } else {
        throw new Error('Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
      }
    }

  } catch (err) {
    console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª:', err);
    alert('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª');
  }
}

async function loadUsersByHospital() {
  const hospitalSelect = document.getElementById("hospitalSelect");
  const usersList = document.getElementById("usersList");
  const usersEmpty = document.getElementById("usersEmpty");
  const usersCount = document.getElementById("usersCount");
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
  if (!usersList || !usersEmpty || !usersCount) {
    console.error('âŒ Ø¹Ù†Ø§ØµØ± DOM Ù…Ø·Ù„ÙˆØ¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
    return;
  }
  
  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰
  let hid = hospitalSelect?.value;
  
  // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù‚ÙŠÙ…Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ù…Ù† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  if (!hid && currentUser && currentUser.HospitalID) {
    hid = currentUser.HospitalID;
  }
  
  usersList.innerHTML = '';
  usersEmpty.classList.add('hidden');
  usersCount.textContent = '...';

  if (!hid) {
    usersCount.textContent = '0';
    usersEmpty.classList.remove('hidden');
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/api/permissions/users?hospitalId=${hid}`, {
      headers: {
        'Accept': 'application/json',
        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
      },
      credentials: 'include'
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    const data = Array.isArray(json) ? json : (json.data || []);
    usersCount.textContent = data.length;

    if (!data.length) {
      usersEmpty.classList.remove('hidden');
      return;
    }

    usersList.innerHTML = data.map(u => `
      <button class="w-full text-right py-2 px-2 hover:bg-gray-50 flex items-center gap-2 user-item" data-id="${u.UserID}">
        <span class="i-user w-6 h-6 rounded-full bg-gray-100 inline-flex items-center justify-center">ğŸ‘¤</span>
        <span class="flex-1">
          <div class="text-sm font-medium text-[#002B5B]">${u.FullName || u.Username}</div>
          <div class="text-xs text-gray-500">${u.Username}</div>
        </span>
      </button>
    `).join('');

    // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø¹Ø±Ø¶ ØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡
    usersList.querySelectorAll('.user-item').forEach(btn=>{
      btn.addEventListener('click', async () => {
        usersList.querySelectorAll('.user-item').forEach(b=>b.classList.remove('bg-blue-50'));
        btn.classList.add('bg-blue-50');
        selectedUserId = btn.dataset.id;

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰
        let hid = hospitalSelect?.value;
        if (!hid && currentUser && currentUser.HospitalID) {
          hid = currentUser.HospitalID;
        }
        
        console.log('ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', selectedUserId);

        // ØªØ­Ù…ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡
        await loadUserPerms(hid, selectedUserId);
      });
    });

  } catch (err) {
    console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', err);
    usersEmpty.textContent = 'ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.';
    usersEmpty.classList.remove('hidden');
    usersCount.textContent = '0';
  }
}

async function loadUserPerms(hid, userId){
  const permEmpty = $('#permEmpty');
  const permForm = $('#permForm');
  const selectedUserLabel = $('#selectedUserLabel');
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
  if (!permEmpty || !permForm || !selectedUserLabel) {
    console.error('âŒ Ø¹Ù†Ø§ØµØ± DOM Ù…Ø·Ù„ÙˆØ¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ loadUserPerms');
    return;
  }
  
  permEmpty.classList.add('hidden');
  permForm.classList.remove('hidden');
  
  // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø¹Ø±Ù Ù…Ø³ØªØ´ÙÙ‰ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ù…Ù† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  if (!hid && currentUser && currentUser.HospitalID) {
    hid = currentUser.HospitalID;
  }
  
  selectedUserLabel.textContent = `Ù…Ø³ØªØ®Ø¯Ù… Ø±Ù‚Ù… ${userId} â€” Ù…Ø³ØªØ´ÙÙ‰ ${hid}`;

  try {
    // Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†ØŒ Ø§Ø³ØªØ®Ø¯Ù… endpoint Ù…Ø®ØªÙ„Ù Ù„Ø±Ø¤ÙŠØ© ØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡Ù… Ø§Ù„Ø®Ø§ØµØ©
    let endpoint = `${API_BASE}/api/permissions/users/${userId}?hospitalId=${hid}`;
    if (currentUser && currentUser.RoleID === 3 && userId === currentUser.UserID) {
      endpoint = `${API_BASE}/api/permissions/me`;
    }
    
    const res = await fetch(endpoint, {
      headers: {
        'Accept':'application/json',
        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
      },
      credentials:'include'
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    const p = json.data || {};

    // Ø¹Ø±Ù‘Ø¶ÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª
    $('#p_submit').checked  = !!p.submit;
    $('#p_view').checked    = !!p.view;
    $('#p_reply').checked   = !!p.reply;
    $('#p_transfer_dept').checked = !!p.transferDept;
    $('#p_transfer_user').checked = !!p.transferUser;
    $('#p_status').checked  = !!p.statusUpdate;
    $('#p_delete').checked  = !!p.remove;
    $('#p_admin_panel').checked = !!p.adminPanel;
    $('#p_admin_depts').checked = !!p.adminDepartments;
    $('#p_admin_hospital').checked = !!p.adminHospital;
    $('#p_admin_clusters').checked = !!p.adminClusters;
    $('#p_hospital_create').checked = !!p.hospitalCreate;
    // ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ (Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø£Ø±Ø¨Ø¹Ø©)
    $('#p_hospital_trash').checked = !!p.hospitalTrash;
    $('#p_hospital_logs').checked = !!p.hospitalLogs;
    $('#p_hospital_permissions').checked = !!p.hospitalPermissions;
    $('#p_hospital_users').checked = !!p.hospitalUsers;
    $('#p_hospital_user_create').checked = !!p.hospitalUserCreate;
    $('#p_hospital_user_edit').checked = !!p.hospitalUserEdit;
    $('#p_hospital_user_delete').checked = !!p.hospitalUserDelete;
    // ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
    $('#p_imports_page').checked = !!p.importsPage;
    $('#p_imports_depts').checked = !!p.importDepartments;
    $('#p_imports_mystery').checked = !!p.importMystery;
    $('#p_imports_937').checked = !!p.import937;
    // ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
    $('#p_dash_page').checked = !!p.dashPage;
    $('#p_dash_card_totals').checked = !!p.dashCardTotals;
    $('#p_dash_card_open').checked = !!p.dashCardOpen;
    $('#p_dash_card_closed').checked = !!p.dashCardClosed;
    $('#p_dash_card_urgent').checked = !!p.dashCardUrgent;
    $('#p_dash_card_close_rate').checked = !!p.dashCardCloseRate;
    $('#p_dash_card_hosp_count').checked = !!p.dashCardHospCount;
    $('#p_dash_chart_mystery').checked = !!p.dashChartMystery;
    $('#p_dash_chart_classes').checked = !!p.dashChartClasses;
    $('#p_dash_chart_top_clinics').checked = !!p.dashChartTopClinics;
    $('#p_dash_chart_daily_trend').checked = !!p.dashChartDailyTrend;
    $('#p_dash_urgent_list').checked = !!p.dashUrgentList;
    // ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„ØªØ­Ø³ÙŠÙ†ÙŠØ©
    $('#p_impr_module').checked = !!p.improvementsModule;
    $('#p_impr_view').checked = !!p.improvementView;
    $('#p_impr_create').checked = !!p.improvementCreate;
    $('#p_impr_edit').checked = !!p.improvementEdit;
    $('#p_impr_delete').checked = !!p.improvementDelete;
    $('#p_impr_report').checked = !!p.improvementReportView;
    
    // ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø± Ø§Ù„Ø³Ø±ÙŠ
    $('#p_mys_module').checked = !!p.mysteryModule;
    $('#p_mys_view').checked = !!p.mysteryView;
    $('#p_mys_reply').checked = !!p.mysteryReplyAdd;
    $('#p_mys_status').checked = !!p.mysteryStatusUpdate;
    $('#p_mys_t_dept').checked = !!p.mysteryTransferDept;
    $('#p_mys_t_emp').checked = !!p.mysteryTransferEmp;
    $('#p_mys_del').checked = !!p.mysteryDelete;
    // ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
    $('#p_reports_page').checked               = !!p.reportsPage;
    $('#p_reports_card_totals').checked        = !!p.reportsCardTotals;
    $('#p_reports_card_open').checked          = !!p.reportsCardOpen;
    $('#p_reports_card_closed').checked        = !!p.reportsCardClosed;
    $('#p_reports_card_urgent').checked        = !!p.reportsCardUrgent;
    $('#p_reports_card_sla').checked           = !!p.reportsCardSLA;
    $('#p_reports_card_hospitals').checked     = !!p.reportsCardHospitals;
    $('#p_reports_chart_by_hosp_type').checked = !!p.reportsChartByHospitalType;
    $('#p_reports_chart_status_dist').checked  = !!p.reportsChartStatusDistribution;
    $('#p_reports_chart_trend6').checked       = !!p.reportsChartTrend6m;
    $('#p_reports_chart_urgent_pct').checked   = !!p.reportsChartUrgentPercent;
    $('#p_reports_chart_by_dept').checked      = !!p.reportsChartByDepartment;
    $('#p_reports_chart_top_employees').checked = !!p.reportsChartTopEmployees;
    // ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¨Ù„Ø§ØºØ§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¬Ù…Ø¹
    $('#p_cluster_submit').checked  = !!p.clusterSubmit;
    $('#p_cluster_view').checked    = !!p.clusterView;
    $('#p_cluster_details').checked = !!p.clusterDetails;
    $('#p_cluster_reply').checked   = !!p.clusterReply;
    $('#p_cluster_status').checked  = !!p.clusterStatus;
    // ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø±Ø´ÙŠÙ
    $('#p_archive_view').checked   = !!p.archiveView;
    $('#p_archive_upload').checked = !!p.archiveUpload;
    $('#p_scope').value     = p.historyScope || '';
    
    // ØªØ¹Ø·ÙŠÙ„/ØªÙØ¹ÙŠÙ„ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¬Ù„ Ø­Ø³Ø¨ Ø­Ø§Ù„Ø© Ù…ØªØ§Ø¨Ø¹Ø©/Ø¹Ø±Ø¶
    syncScopeState();

  } catch(err){
    console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', err);
    alert('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const hospitalSelect = document.getElementById("hospitalSelect");
  const usersList = document.getElementById("usersList");
  const usersEmpty = document.getElementById("usersEmpty");
  const usersCount = document.getElementById("usersCount");

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª Ù…Ù† API
  loadHospitals();

  // Ø±Ø¨Ø· ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
  if (hospitalSelect) {
    hospitalSelect.addEventListener('change', loadUsersByHospital);
  }

  // Ø±Ø¨Ø· ØªØºÙŠÙŠØ± checkbox Ù…ØªØ§Ø¨Ø¹Ø©/Ø¹Ø±Ø¶ Ø¨ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¬Ù„
  $('#p_view')?.addEventListener('change', syncScopeState);

  // Ø­ÙØ¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
  $('#savePerm').addEventListener('click', async ()=>{
    if (!selectedUserId) return;
    
    // Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†ØŒ Ù…Ù†Ø¹ Ø§Ù„Ø­ÙØ¸
    if (currentUser && currentUser.RoleID === 3) {
      alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª');
      return;
    }
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰
    let hid = hospitalSelect?.value;
    if (!hid && currentUser && currentUser.HospitalID) {
      hid = currentUser.HospitalID;
    }

    const payload = {
      hospitalId: Number(hid),
      submit:  $('#p_submit').checked,
      view:    $('#p_view').checked,
      historyScope: $('#p_view').checked ? ($('#p_scope').value || null) : null,
      reply:   $('#p_reply').checked,
      transferDept: $('#p_transfer_dept').checked,
      transferUser: $('#p_transfer_user').checked,
      statusUpdate: $('#p_status').checked,
      remove:  $('#p_delete').checked,
      adminPanel: $('#p_admin_panel').checked,
      adminDepartments: $('#p_admin_depts').checked,
      adminHospital: $('#p_admin_hospital').checked,
      adminClusters: $('#p_admin_clusters').checked,
      hospitalCreate: $('#p_hospital_create').checked,
      // ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ (Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø£Ø±Ø¨Ø¹Ø©)
      hospitalTrash: $('#p_hospital_trash').checked,
      hospitalLogs: $('#p_hospital_logs').checked,
      hospitalPermissions: $('#p_hospital_permissions').checked,
      hospitalUsers: $('#p_hospital_users').checked,
      hospitalUserCreate: $('#p_hospital_user_create').checked,
      hospitalUserEdit: $('#p_hospital_user_edit').checked,
      hospitalUserDelete: $('#p_hospital_user_delete').checked,
      // ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
      importsPage: $('#p_imports_page').checked,
      importDepartments: $('#p_imports_depts').checked,
      importMystery: $('#p_imports_mystery').checked,
      import937: $('#p_imports_937').checked,
      // ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
      dashPage: $('#p_dash_page').checked,
      dashCardTotals: $('#p_dash_card_totals').checked,
      dashCardOpen: $('#p_dash_card_open').checked,
      dashCardClosed: $('#p_dash_card_closed').checked,
      dashCardUrgent: $('#p_dash_card_urgent').checked,
      dashCardCloseRate: $('#p_dash_card_close_rate').checked,
      dashCardHospCount: $('#p_dash_card_hosp_count').checked,
      dashChartMystery: $('#p_dash_chart_mystery').checked,
      dashChartClasses: $('#p_dash_chart_classes').checked,
      dashChartTopClinics: $('#p_dash_chart_top_clinics').checked,
      dashChartDailyTrend: $('#p_dash_chart_daily_trend').checked,
      dashUrgentList: $('#p_dash_urgent_list').checked,
      // ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„ØªØ­Ø³ÙŠÙ†ÙŠØ©
      improvementsModule: $('#p_impr_module').checked,
      improvementView: $('#p_impr_view').checked,
      improvementCreate: $('#p_impr_create').checked,
      improvementEdit: $('#p_impr_edit').checked,
      improvementDelete: $('#p_impr_delete').checked,
      improvementReportView: $('#p_impr_report').checked,
      
      // ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø± Ø§Ù„Ø³Ø±ÙŠ
      mysteryModule: $('#p_mys_module').checked,
      mysteryView: $('#p_mys_view').checked,
      mysteryReplyAdd: $('#p_mys_reply').checked,
      mysteryStatusUpdate: $('#p_mys_status').checked,
      mysteryTransferDept: $('#p_mys_t_dept').checked,
      mysteryTransferEmp: $('#p_mys_t_emp').checked,
      mysteryDelete: $('#p_mys_del').checked,
      // ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
      reportsPage: $('#p_reports_page').checked,
      reportsCardTotals: $('#p_reports_card_totals').checked,
      reportsCardOpen: $('#p_reports_card_open').checked,
      reportsCardClosed: $('#p_reports_card_closed').checked,
      reportsCardUrgent: $('#p_reports_card_urgent').checked,
      reportsCardSLA: $('#p_reports_card_sla').checked,
      reportsCardHospitals: $('#p_reports_card_hospitals').checked,
      reportsChartByHospitalType: $('#p_reports_chart_by_hosp_type').checked,
      reportsChartStatusDistribution: $('#p_reports_chart_status_dist').checked,
      reportsChartTrend6m: $('#p_reports_chart_trend6').checked,
      reportsChartUrgentPercent: $('#p_reports_chart_urgent_pct').checked,
      reportsChartByDepartment: $('#p_reports_chart_by_dept').checked,
      reportsChartTopEmployees: $('#p_reports_chart_top_employees').checked,
      // ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¨Ù„Ø§ØºØ§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¬Ù…Ø¹
      clusterSubmit:  $('#p_cluster_submit').checked,
      clusterView:    $('#p_cluster_view').checked,
      clusterDetails: $('#p_cluster_details').checked,
      clusterReply:   $('#p_cluster_reply').checked,
      clusterStatus:  $('#p_cluster_status').checked,
      // ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø±Ø´ÙŠÙ
      archiveView:   $('#p_archive_view').checked,
      archiveUpload: $('#p_archive_upload').checked
    };

    console.log('ğŸ“¤ Payload being sent:', {
      archiveView: payload.archiveView,
      archiveUpload: payload.archiveUpload,
      hospitalId: payload.hospitalId
    });

    try {
      const res = await fetch(`${API_BASE}/api/permissions/users/${selectedUserId}`, {
        method:'PUT',
        headers:{
          'Content-Type':'application/json',
          ...(token ? { 'Authorization': `Bearer ${token}` } : {})
        },
        credentials:'include',
        body: JSON.stringify(payload)
      });
      const json = await res.json();
      console.log('ğŸ“¥ Response from server:', json);
      if (!res.ok || !json.ok) {
        throw new Error(json.error || 'ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª');
      }
      // Toast Ø¨Ø³ÙŠØ·
      console.log('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­');
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­');
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
      if (selectedUserId) {
        loadUserPerms(hid, selectedUserId);
      }
    } catch (err) {
      console.error('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:', err);
      alert(`ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª: ${err.message}`);
    }
  });

  // ØªØ£Ø«ÙŠØ± ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ù‡ÙŠØ¯Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ±
  window.addEventListener("scroll", function () {
    const navbar = document.getElementById("navbar");
    if (window.scrollY > 50) {
      navbar.style.backgroundColor = "#ffffff";
      navbar.classList.add("shadow-md");
      navbar.querySelectorAll("a").forEach(link => {
        link.classList.remove("text-white", "hover:text-blue-200");
        link.classList.add("text-[#002B5B]", "hover:text-blue-700");
      });
    } else {
      navbar.style.backgroundColor = "#002B5B";
      navbar.classList.remove("shadow-md");
      navbar.querySelectorAll("a").forEach(link => {
        link.classList.add("text-white", "hover:text-blue-200");
        link.classList.remove("text-[#002B5B]", "hover:text-blue-700");
      });
    }
  });
});
</script>
</body>
</html>

