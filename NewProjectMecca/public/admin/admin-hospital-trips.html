<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>الرحلات العلاجية والنطاقات</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1B4wEXn0P4pX5nCkQJqk5GqlaNpIB5D0l9nX+Y73P6Z0Zqs6R0kB8d3j2dQ9C4Z1Bw==" crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <style>
    .styled-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      font-size: 16px;
      text-align: center;
    }
    .styled-table th,
    .styled-table td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    .styled-table th {
      background-color: #0a56b3;
      color: #fff;
    }
    .styled-table tr:nth-child(even) {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col bg-gray-50" style="font-family:'Tajawal',sans-serif">
  <!-- Header -->
  <header id="navbar" class="fixed w-full top-0 z-50 navbar-scroll" style="background-color: #002B5B;">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center">
          <img src="../assets/img/logo3.png" alt="شعار تجمع مكة المكرمة الصحي" class="h-16 w-auto">
        </div>
        <nav class="hidden md:flex items-center space-x-reverse space-x-8">
          <a href="../../index/index.html" class="text-white hover:text-blue-200 transition-colors">الرئيسية</a>
          <a href="../../dashboard/dashboard.html" class="text-white hover:text-blue-200 transition-colors">لوحة التحكم</a>
          <a href="admin-hospital.html" class="text-white hover:text-blue-200 transition-colors">إدارة المستشفى</a>
        </nav>
        <button class="md:hidden text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 pt-24 pb-10 flex-1">
    <section class="text-center mb-8">
      <h1 class="text-3xl font-extrabold text-[#002B5B] mb-2">الرحلات العلاجية والنطاقات</h1>
      <p class="text-gray-600">إدارة توفر الرحلات العلاجية والنطاقات لهذا المستشفى</p>
    </section>

    <section class="bg-white rounded-2xl p-6 shadow-xl border border-gray-100 mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <div class="text-sm text-gray-500">المستشفى الحالي</div>
          <div id="hospitalNameDisplay" class="text-xl font-bold text-[#002B5B]">—</div>
        </div>
        <div id="hospitalSelectWrapper" class="w-full md:w-72">
          <label class="block text-sm font-semibold text-[#002B5B] mb-2">اختر المستشفى</label>
          <select id="hospitalSelect" class="w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-right focus:outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-400">
            <option value="">اختر المستشفى...</option>
          </select>
        </div>
      </div>
    </section>

    <section class="bg-white rounded-2xl p-6 shadow-xl border border-gray-100 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-extrabold text-[#002B5B] flex items-center gap-2">
          <i class="fas fa-route text-emerald-500"></i>
          الرحلات العلاجية
        </h2>
        <button id="btnSaveTrips" class="px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition">حفظ</button>
      </div>
      <table id="tripsTable" class="styled-table">
        <thead>
          <tr>
            <th>الرحلة العلاجية</th>
            <th>متاحة</th>
          </tr>
        </thead>
        <tbody id="tripBody">
          <tr><td colspan="2">جارٍ التحميل...</td></tr>
        </tbody>
      </table>
    </section>

    <section class="bg-white rounded-2xl p-6 shadow-xl border border-gray-100">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-extrabold text-[#002B5B] flex items-center gap-2">
          <i class="fas fa-map-marked-alt text-indigo-500"></i>
          النطاقات
        </h2>
        <button id="btnSaveZones" class="px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition">حفظ</button>
      </div>
      <table id="zonesTable" class="styled-table">
        <thead>
          <tr>
            <th>النطاق</th>
            <th>متاح</th>
          </tr>
        </thead>
        <tbody id="zoneBody">
          <tr><td colspan="2">جارٍ التحميل...</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <footer class="bg-gray-900 text-white py-14">
    <div class="container mx-auto px-4">
      <div class="grid md:grid-cols-3 gap-8">
        <div>
          <div class="flex items-center space-x-reverse space-x-3 mb-4">
            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 2L2 7v10c0 5.55 3.84 9.74 9 11 5.16-1.26 9-5.45 9-11V7l-10-5z"/>
              </svg>
            </div>
            <div>
              <div class="font-bold">تجمع مكة الصحي</div>
              <div class="text-sm text-gray-300">نظام البلاغات</div>
            </div>
          </div>
          <p class="text-gray-300 text-sm">منصة رسمية لتقديم ومتابعة البلاغات</p>
        </div>

        <div>
          <h3 class="font-bold mb-4">روابط سريعة</h3>
          <ul class="space-y-2 text-sm">
            <li><a href="../../index/index.html" class="text-gray-300 hover:text-white hover:underline transition-colors">الرئيسية</a></li>
            <li><a href="../complaints/submit/submit-complaint.html" class="text-gray-300 hover:text-white hover:underline transition-colors">تقديم بلاغ</a></li>
            <li><a href="../complaints/track/track-complaint.html" class="text-gray-300 hover:text-white hover:underline transition-colors">متابعة بلاغ</a></li>
            <li><a href="../../index/help.html" class="text-gray-300 hover:text-white hover:underline transition-colors">الأسئلة الشائعة</a></li>
          </ul>
        </div>

        <div>
          <h3 class="font-bold mb-4">معلومات التواصل</h3>
          <div class="space-y-2 text-sm text-gray-300">
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
              <span>رقم الدعم: 0559735137</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
              <span>support@makkahhealth.gov.sa</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span>ساعات العمل: 24/7</span>
            </div>
          </div>
        </div>
      </div>
      <div class="border-t border-gray-700 mt-8 pt-8 text-center text-sm text-gray-300">
        © 2025 تجمع مكة المكرمة الصحي – جميع الحقوق محفوظة
      </div>
    </div>
  </footer>

  <script>
    const API_BASE =
      location.hostname === 'localhost' || location.hostname === '127.0.0.1'
        ? 'http://localhost:3001'
        : '';

    const els = {
      hospitalSelect: document.getElementById('hospitalSelect'),
      hospitalNameDisplay: document.getElementById('hospitalNameDisplay'),
      hospitalSelectWrapper: document.getElementById('hospitalSelectWrapper'),
      tripBody: document.getElementById('tripBody'),
      zoneBody: document.getElementById('zoneBody')
    };

    const hospitalsMap = new Map();
    let currentHospitalId = null;
    let selectedTrips = new Map();
    let selectedZones = new Map();
    const LOCAL_STORAGE_KEY = 'selectedHospitalTripsHospitalId';

    function authToken() {
      return localStorage.getItem('authToken') || localStorage.getItem('token') || sessionStorage.getItem('token');
    }

    async function fetchJSON(url, options = {}) {
      const token = authToken();
      const headers = {
        Accept: 'application/json',
        ...(token ? { Authorization: `Bearer ${token}` } : {}),
        ...options.headers
      };
      const res = await fetch(url, { ...options, headers });
      if (!res.ok) {
        const text = await res.text().catch(() => '');
        throw new Error(`HTTP ${res.status}: ${text || res.statusText}`);
      }
      return res.json();
    }

    function updateHospitalDisplay() {
      const name = currentHospitalId && hospitalsMap.has(Number(currentHospitalId))
        ? hospitalsMap.get(Number(currentHospitalId))
        : '—';
      if (els.hospitalNameDisplay) els.hospitalNameDisplay.textContent = name || '—';
      if (els.hospitalSelect) {
        els.hospitalSelect.value = currentHospitalId || '';
      }
    }

    async function loadHospitals() {
      const token = authToken();
      const userData = JSON.parse(localStorage.getItem('userData') || '{}');
      const isCentral = userData?.RoleID === 1 || userData?.IsClusterManager === true || userData?.scope === 'central';

      let hospitals = [];
      try {
        const res = await fetchJSON(`${API_BASE}/api/hospitals?active=1`);
        if (Array.isArray(res)) hospitals = res;
      } catch (err) {
        console.warn('⚠️ فشل جلب المستشفيات:', err.message);
      }

      hospitalsMap.clear();
      if (Array.isArray(hospitals)) {
        hospitals.forEach(h => {
          hospitalsMap.set(Number(h.HospitalID), h.NameAr || h.Name || `مستشفى ${h.HospitalID}`);
        });
      }

      if (els.hospitalSelect) {
        els.hospitalSelect.innerHTML = '<option value="">اختر المستشفى...</option>';
        hospitalsMap.forEach((name, id) => {
          const opt = document.createElement('option');
          opt.value = id;
          opt.textContent = name;
          els.hospitalSelect.appendChild(opt);
        });
      }

      if (!isCentral && els.hospitalSelectWrapper) {
        els.hospitalSelectWrapper.style.display = 'none';
      }

      const storedId = localStorage.getItem(LOCAL_STORAGE_KEY);
      if (storedId && hospitalsMap.has(Number(storedId))) {
        currentHospitalId = storedId;
      } else if (userData?.HospitalID) {
        currentHospitalId = String(userData.HospitalID);
      } else if (hospitalsMap.size === 1) {
        currentHospitalId = String(Array.from(hospitalsMap.keys())[0]);
      }

      updateHospitalDisplay();

      if (!currentHospitalId) {
        els.tripBody.innerHTML = '<tr><td colspan="2">يرجى اختيار المستشفى أولاً</td></tr>';
        els.zoneBody.innerHTML = '<tr><td colspan="2">يرجى اختيار المستشفى أولاً</td></tr>';
        return;
      }

      await loadData();
    }

    async function loadData() {
      try {
        if (!currentHospitalId) {
          els.tripBody.innerHTML = '<tr><td colspan="2">يرجى اختيار المستشفى أولاً</td></tr>';
          els.zoneBody.innerHTML = '<tr><td colspan="2">يرجى اختيار المستشفى أولاً</td></tr>';
          return;
        }

        const headers = { 'X-Hospital-Id': currentHospitalId };
        const query = `?hospitalId=${currentHospitalId}`;

        selectedTrips.clear();
        selectedZones.clear();

        const [trips, zones, hospitalTrips, hospitalZones] = await Promise.all([
          fetchJSON(`${API_BASE}/api/trips/list`),
          fetchJSON(`${API_BASE}/api/zones/list`),
          fetchJSON(`${API_BASE}/api/hospital/trips${query}`, { headers }),
          fetchJSON(`${API_BASE}/api/hospital/zones${query}`, { headers })
        ]);

        const tripRows = trips.map(t => {
          const name = t.TripName || t.tripName || '';
          const checked = hospitalTrips.some(x => (x.TripName || x.tripName) === name && (x.IsAvailable === 1 || x.IsAvailable === true));
          selectedTrips.set(name, checked);
          return `
            <tr>
              <td>${name}</td>
              <td><input type="checkbox" ${checked ? 'checked' : ''} onchange="toggleTrip('${name.replace(/'/g, "\\'")}', this.checked)"></td>
            </tr>`;
        }).join('');
        els.tripBody.innerHTML = tripRows || '<tr><td colspan="2">لا توجد رحلات</td></tr>';

        const zoneRows = zones.map(z => {
          const name = z.ZoneName || z.zoneName || '';
          const checked = hospitalZones.some(x => (x.ZoneName || x.zoneName) === name && (x.IsAvailable === 1 || x.IsAvailable === true));
          selectedZones.set(name, checked);
          return `
            <tr>
              <td>${name}</td>
              <td><input type="checkbox" ${checked ? 'checked' : ''} onchange="toggleZone('${name.replace(/'/g, "\\'")}', this.checked)"></td>
            </tr>`;
        }).join('');
        els.zoneBody.innerHTML = zoneRows || '<tr><td colspan="2">لا توجد نطاقات</td></tr>';

        updateHospitalDisplay();
      } catch (err) {
        console.error('❌ loadData error:', err);
        const errMsg = err.message || 'تعذر تحميل البيانات';
        els.tripBody.innerHTML = `<tr><td colspan="2">${errMsg}</td></tr>`;
        els.zoneBody.innerHTML = `<tr><td colspan="2">${errMsg}</td></tr>`;
      }
    }

    function toggleTrip(name, checked) {
      selectedTrips.set(name, checked);
    }

    function toggleZone(name, checked) {
      selectedZones.set(name, checked);
    }

    window.toggleTrip = toggleTrip;
    window.toggleZone = toggleZone;
    if (els.hospitalSelect) {
      els.hospitalSelect.addEventListener('change', async (e) => {
        currentHospitalId = e.target.value || null;
        if (currentHospitalId) {
          localStorage.setItem(LOCAL_STORAGE_KEY, currentHospitalId);
          await loadData();
        } else {
          localStorage.removeItem(LOCAL_STORAGE_KEY);
          updateHospitalDisplay();
          els.tripBody.innerHTML = '<tr><td colspan="2">يرجى اختيار المستشفى أولاً</td></tr>';
          els.zoneBody.innerHTML = '<tr><td colspan="2">يرجى اختيار المستشفى أولاً</td></tr>';
        }
      });
    }

    async function saveTrips() {
      if (!currentHospitalId) {
        alert('يرجى اختيار المستشفى أولاً');
        return;
      }
      try {
        await Promise.all(Array.from(selectedTrips.entries()).map(([name, checked]) =>
          fetchJSON(`${API_BASE}/api/hospital/trips/update`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Hospital-Id': currentHospitalId
            },
            body: JSON.stringify({ TripName: name, IsAvailable: checked })
          })
        ));
        alert('تم حفظ الرحلات بنجاح');
        await loadData();
      } catch (err) {
        console.error('❌ حفظ الرحلات:', err);
        alert('فشل حفظ الرحلات: ' + err.message);
      }
    }

    async function saveZones() {
      if (!currentHospitalId) {
        alert('يرجى اختيار المستشفى أولاً');
        return;
      }
      try {
        await Promise.all(Array.from(selectedZones.entries()).map(([name, checked]) =>
          fetchJSON(`${API_BASE}/api/hospital/zones/update`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Hospital-Id': currentHospitalId
            },
            body: JSON.stringify({ ZoneName: name, IsAvailable: checked })
          })
        ));
        alert('تم حفظ النطاقات بنجاح');
        await loadData();
      } catch (err) {
        console.error('❌ حفظ النطاقات:', err);
        alert('فشل حفظ النطاقات: ' + err.message);
      }
    }

    if (document.getElementById('btnSaveTrips')) {
      document.getElementById('btnSaveTrips').addEventListener('click', saveTrips);
    }
    if (document.getElementById('btnSaveZones')) {
      document.getElementById('btnSaveZones').addEventListener('click', saveZones);
    }

    loadHospitals();
  </script>
</body>
</html>

