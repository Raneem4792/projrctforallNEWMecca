<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <style>
    .act-btn{
      @apply inline-flex items-center gap-1 px-3 py-1.5 rounded-full text-sm font-medium
             shadow-sm transition hover:shadow ring-1 ring-inset;
    }
    .act-btn i{ @apply w-4 h-4; }
    .act-edit  { @apply bg-blue-50 text-blue-700 ring-blue-200 hover:bg-blue-100; }
    .act-delete{ @apply bg-rose-50 text-rose-700 ring-rose-200 hover:bg-rose-100; }
    .act-child { @apply bg-emerald-50 text-emerald-700 ring-emerald-200 hover:bg-emerald-100; }
    /* ØªÙƒØ¯ÙŠØ³ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
    @media (max-width: 640px){
      .act-btn span{ display:none }  /* Ù†Ø®ÙÙŠ Ø§Ù„Ù†Øµ ÙˆÙ†ØªØ±Ùƒ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
      .act-btn{ @apply p-2 rounded-lg }
    }
  </style>
</head>
<body class="min-h-screen flex flex-col bg-gray-50" style="font-family:'Tajawal',sans-serif">
  <!-- Header - Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
  <header id="navbar" class="fixed w-full top-0 z-50 navbar-scroll" style="background-color: #002B5B;">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <!-- Logo - Ø§Ù„Ø´Ø¹Ø§Ø± -->
        <div class="flex items-center">
          <img src="../assets/img/logo3.png" alt="Ø´Ø¹Ø§Ø± ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„ØµØ­ÙŠ" class="h-16 w-auto">
        </div>
        
        <!-- Navigation - Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ†Ù‚Ù„ -->
        <nav class="hidden md:flex items-center space-x-reverse space-x-8">
          <a href="../../index/index.html" id="nav-home" class="text-white hover:text-blue-200 transition-colors">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
          <a href="../../dashboard/dashboard.html" id="nav-dashboard" class="text-white hover:text-blue-200 transition-colors">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
          <a href="../../index/about-system.html" id="nav-about" class="text-white hover:text-blue-200 transition-colors">Ø­ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</a>
          <a href="../../index/help.html" id="nav-help" class="text-white hover:text-blue-200 transition-colors">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</a>
          <a href="../../index/contact.html" id="nav-contact" class="text-white hover:text-blue-200 transition-colors">Ø§ØªØµÙ„ Ø¨Ù†Ø§</a>
          <button id="languageToggle" class="text-white hover:text-blue-200 transition-colors flex items-center">
            ğŸŒ English
          </button>
        </nav>
        
        <!-- Mobile menu button - Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
        <button class="md:hidden text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 pt-24 pb-10 flex-1">
    <section class="text-center mb-8">
      <h1 class="text-3xl md:text-4xl font-extrabold text-[#002B5B] mb-2">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h1>
      <p class="text-gray-600">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ / ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
    </section>

    <!-- Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ù‘Ø¹) -->
    <div id="clusterBar" class="bg-white rounded-2xl p-6 shadow-xl border border-gray-100 mb-6 hidden">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <label for="hospitalSelect" class="text-sm text-gray-600 whitespace-nowrap">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰:</label>
          <select id="hospitalSelect"
                  class="h-10 min-w-[220px] rounded-xl border border-gray-200 px-3 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-100">
            <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ â€”</option>
          </select>
        </div>
        <div class="text-sm text-gray-500">
          <span id="hospitalHeader" class="hidden">Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ù…Ø­Ø¯Ø¯</span>
        </div>
      </div>
    </div>

    <div class="flex items-center justify-between mb-4">
      <div class="text-left flex gap-3">
        <button id="btnOpenAddUser"
                class="bg-[#002B5B] hover:bg-[#013b7a] text-white font-semibold px-6 py-2 rounded-xl shadow-md transition"
                style="display: none;">
          + Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
        </button>
      </div>

      <!-- Ø¨Ø­Ø« Ø¨Ø³ÙŠØ· -->
      <div class="w-full max-w-sm">
        <input id="searchInput" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…..."
               class="w-full rounded-xl border-gray-300 focus:border-[#002B5B] focus:ring-[#002B5B]">
      </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
    <div class="bg-white rounded-2xl p-6 shadow-xl border border-gray-100">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b border-gray-200">
              <th class="text-right py-3 px-4 font-semibold text-gray-700">#</th>
              <th class="text-right py-3 px-4 font-semibold text-gray-700">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th>
              <th class="text-right py-3 px-4 font-semibold text-gray-700">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
              <th class="text-right py-3 px-4 font-semibold text-gray-700">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
              <th class="text-right py-3 px-4 font-semibold text-gray-700">Ø§Ù„Ø¯ÙˆØ±</th>
              <th class="text-right py-3 px-4 font-semibold text-gray-700">Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th class="text-right py-3 px-4 font-semibold text-gray-700 w-56">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="usersTbody">
            <tr>
              <td colspan="7" class="p-6 text-center text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Footer - Ø§Ù„ØªØ°ÙŠÙŠÙ„ -->
  <footer class="bg-gray-900 text-white py-14">
    <div class="container mx-auto px-4">
      <div class="grid md:grid-cols-3 gap-8">
        <!-- Column 1 - Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ -->
        <div>
          <div class="flex items-center space-x-reverse space-x-3 mb-4">
            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 2L2 7v10c0 5.55 3.84 9.74 9 11 5.16-1.26 9-5.45 9-11V7l-10-5z"/>
              </svg>
            </div>
            <div>
              <div class="font-bold">ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„ØµØ­ÙŠ</div>
              <div class="text-sm text-gray-300">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</div>
            </div>
          </div>
          <p class="text-gray-300 text-sm">Ù…Ù†ØµØ© Ø±Ø³Ù…ÙŠØ© Ù„ØªÙ‚Ø¯ÙŠÙ… ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</p>
        </div>

        <!-- Column 2 - Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ -->
        <div>
          <h3 class="font-bold mb-4">Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©</h3>
          <ul class="space-y-2 text-sm">
            <li><a href="../../index/index.html" class="text-gray-300 hover:text-white hover:underline transition-colors">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
            <li><a href="../complaints/submit/submit-complaint.html" class="text-gray-300 hover:text-white hover:underline transition-colors">ØªÙ‚Ø¯ÙŠÙ… Ø¨Ù„Ø§Øº</a></li>
            <li><a href="../complaints/track/track-complaint.html" class="text-gray-300 hover:text-white hover:underline transition-colors">Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ù„Ø§Øº</a></li>
            <li><a href="../../index/help.html" class="text-gray-300 hover:text-white hover:underline transition-colors">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©</a></li>
          </ul>
        </div>

        <!-- Column 3 - Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù„Ø« -->
        <div>
          <h3 class="font-bold mb-4">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</h3>
          <div class="space-y-2 text-sm text-gray-300">
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
              <span>Ø±Ù‚Ù… Ø§Ù„Ø¯Ø¹Ù…: 0559735137</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
              <span>support@makkahhealth.gov.sa</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„: 24/7</span>
            </div>
          </div>
        </div>
      </div>

      <div class="border-t border-gray-700 mt-8 pt-8 text-center text-sm text-gray-300">
        Â© 2025 ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„ØµØ­ÙŠ â€“ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©
      </div>
    </div>
  </footer>

  <!-- Modal: ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… -->
  <div id="userEditModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40" onclick="closeUserEdit()"></div>

    <div class="absolute inset-x-0 top-16 mx-auto w-[min(760px,92vw)] rounded-2xl bg-white shadow-xl">
      <div class="flex items-center justify-between px-5 py-4 border-b">
        <h3 class="text-lg font-bold text-[#002B5B]">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
        <button class="text-gray-500 hover:text-gray-700" onclick="closeUserEdit()">âœ•</button>
      </div>

      <form id="userEditForm" class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4" onsubmit="saveUserEdit(event)">
        <input type="hidden" id="ue_UserID">
        <input type="hidden" id="ue_PasswordHash"><!-- Ù†Ù…Ø±Ù‘Ø± Ù†ÙØ³ Ø§Ù„Ù‡Ø§Ø´ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±Ù‡ -->

        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
          <input id="ue_FullName" class="w-full rounded-xl border px-3 py-2" required>
        </div>
        <div>
          <label class="block text-sm mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input id="ue_Username" class="w-full rounded-xl border px-3 py-2" required>
        </div>

        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="ue_Email" type="email" class="w-full rounded-xl border px-3 py-2">
        </div>
        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ø¬ÙˆØ§Ù„</label>
          <input id="ue_Mobile" class="w-full rounded-xl border px-3 py-2">
        </div>

        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆØ·Ù†ÙŠØ©</label>
          <input id="ue_NationalID" class="w-full rounded-xl border px-3 py-2">
        </div>
        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ø¯ÙˆØ±</label>
          <select id="ue_RoleID" class="w-full rounded-xl border px-3 py-2">
            <option value="1">Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù†</option>
            <option value="2">Ù…ÙˆØ¸Ù</option>
            <option value="3">Ù…Ø¯ÙŠØ± Ù‚Ø³Ù…</option>
            <option value="4">Ù…Ø¯ÙŠØ±</option>
          </select>
        </div>

        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</label>
          <select id="ue_HospitalID" class="w-full rounded-xl border px-3 py-2" required></select>
        </div>
        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ù‚Ø³Ù…</label>
          <select id="ue_DepartmentID" class="w-full rounded-xl border px-3 py-2">
            <option value="">â€” Ø¨Ø¯ÙˆÙ† Ù‚Ø³Ù… â€”</option>
          </select>
        </div>

        <div class="col-span-2 flex items-center gap-3 pt-1">
          <input id="ue_IsActive" type="checkbox" class="h-4 w-4">
          <label for="ue_IsActive" class="text-sm">Ù…ÙØ¹Ù‘Ù„</label>
        </div>

        <div class="col-span-2 flex justify-end gap-3 pt-2">
          <button type="button" class="px-4 py-2 rounded-xl border" onclick="closeUserEdit()">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="submit" class="px-4 py-2 rounded-xl bg-[#0ea5e9] text-white hover:bg-[#0284c7]">Ø­ÙØ¸</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… (Ù…ÙØ­Ø¯Ù‘Ø« Ù…Ø¹ Ø­Ù‚Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±) -->
  <div id="userAddModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40" onclick="closeUserAdd()"></div>
    <div class="absolute inset-x-0 top-16 mx-auto w-[min(760px,92vw)] rounded-2xl bg-white shadow-xl">
      <div class="flex items-center justify-between px-5 py-4 border-b">
        <h3 class="text-lg font-bold text-[#002B5B]">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h3>
        <button class="text-gray-500 hover:text-gray-700" onclick="closeUserAdd()">âœ•</button>
      </div>

      <form id="userAddForm" class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4" onsubmit="saveUserAdd(event)">
        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
          <input id="ua_FullName" class="w-full rounded-xl border px-3 py-2" required>
        </div>
        <div>
          <label class="block text-sm mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input id="ua_Username" class="w-full rounded-xl border px-3 py-2" required>
        </div>

        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="ua_Email" type="email" class="w-full rounded-xl border px-3 py-2">
        </div>
        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ø¬ÙˆØ§Ù„</label>
          <input id="ua_Mobile" class="w-full rounded-xl border px-3 py-2">
        </div>

        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆØ·Ù†ÙŠØ©</label>
          <input id="ua_NationalID" class="w-full rounded-xl border px-3 py-2">
        </div>
        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ø¯ÙˆØ±</label>
          <select id="ua_RoleID" class="w-full rounded-xl border px-3 py-2">
            <option value="1">Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù†</option>
            <option value="2" selected>Ù…ÙˆØ¸Ù</option>
            <option value="3">Ù…Ø¯ÙŠØ± Ù‚Ø³Ù…</option>
            <option value="4">Ù…Ø¯ÙŠØ±</option>
          </select>
        </div>

        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</label>
          <select id="ua_HospitalID" class="w-full rounded-xl border px-3 py-2" required></select>
        </div>
        <div>
          <label class="block text-sm mb-1">Ø§Ù„Ù‚Ø³Ù…</label>
          <select id="ua_DepartmentID" class="w-full rounded-xl border px-3 py-2">
            <option value="">â€” Ø¨Ø¯ÙˆÙ† Ù‚Ø³Ù… â€”</option>
          </select>
        </div>

        <!-- Ù‡Ù†Ø§ Ø­Ù‚ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± -->
        <div>
          <label class="block text-sm mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <input id="ua_Password" type="password" minlength="6" class="w-full rounded-xl border px-3 py-2" placeholder="Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)">
        </div>
        <div>
          <label class="block text-sm mb-1">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <input id="ua_PasswordConfirm" type="password" class="w-full rounded-xl border px-3 py-2" placeholder="Ø£Ø¹Ø¯ ÙƒØªØ§Ø¨Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
        </div>

        <div class="col-span-2 flex items-center gap-3 pt-1">
          <input id="ua_IsActive" type="checkbox" class="h-4 w-4" checked>
          <label for="ua_IsActive" class="text-sm">Ù…ÙØ¹Ù‘Ù„</label>
        </div>

        <div class="col-span-2 flex justify-end gap-3 pt-2">
          <button type="button" class="px-4 py-2 rounded-xl border" onclick="closeUserAdd()">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="submit" class="px-4 py-2 rounded-xl bg-[#0ea5e9] text-white hover:bg-[#0284c7]">Ø­ÙØ¸</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div id="uetoast" class="fixed bottom-6 left-1/2 -translate-x-1/2 hidden px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm shadow-lg z-[60]">
    ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
  </div>

  <script>
document.addEventListener("DOMContentLoaded", () => {
  const hospitalSelect = document.getElementById("hospitalSelect");
  const usersList      = document.getElementById("usersList");
  const searchInput    = document.getElementById("searchInput");

  // ØªØ­Ø¯ÙŠØ¯ Ø¹Ù†ÙˆØ§Ù† API Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†ÙØ°
  const API_BASE = (location.port === '3001') ? '' : 'http://localhost:3001';

  // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ ØªÙˆÙƒÙ†
  function authHeaders(){
    const token = localStorage.getItem('token') || sessionStorage.getItem('token');
    return token ? { Authorization: `Bearer ${token}`, 'Content-Type':'application/json' }
                 : { 'Content-Type':'application/json' };
  }

  // ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø±
  async function checkCreateUserPermission() {
    try {
      const res = await fetch(`${API_BASE}/api/auth/me-permissions`, {
        headers: authHeaders(),
        credentials: 'include'
      });
      
      if (!res.ok) {
        console.warn('ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª');
        return;
      }
      
      const data = await res.json();
      const canCreate = data?.canCreateUser === true;
      
      const btn = document.getElementById('btnOpenAddUser');
      if (btn && canCreate) {
        btn.style.display = 'inline-flex';
      }
      
      console.log('âœ… ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…:', canCreate);
    } catch (err) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:', err);
    }
  }

  // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙØ­Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
  checkCreateUserPermission();

  // ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  async function checkEditUserPermission() {
    try {
      const res = await fetch(`${API_BASE}/api/auth/me-permissions`, {
        headers: authHeaders(),
        credentials: 'include'
      });
      
      if (!res.ok) {
        console.warn('ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
        return;
      }
      
      const data = await res.json();
      const canEdit = data?.canEditHospitalUser === true;
      
      // Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      document.querySelectorAll('[data-action="edit"]').forEach(btn => {
        if (canEdit) {
          btn.style.display = '';
          btn.classList.remove('hidden');
          btn.disabled = false;
        } else {
          btn.style.display = 'none';
          btn.classList.add('hidden');
        }
      });
      
      console.log('âœ… ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…:', canEdit);
    } catch (err) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:', err);
    }
  }

  // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¨Ø¹Ø¯ ÙƒÙ„ ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø¬Ø¯ÙˆÙ„
  checkEditUserPermission();

  // ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ© Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø°Ù
  async function checkDeleteUserPermission() {
    try {
      const res = await fetch(`${API_BASE}/api/auth/me-permissions`, {
        headers: authHeaders(),
        credentials: 'include'
      });
      
      if (!res.ok) {
        console.warn('ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø­Ø°Ù');
        return;
      }
      
      const data = await res.json();
      const canDelete = data?.canDeleteHospitalUser === true;
      
      // Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø°Ù
      document.querySelectorAll('[data-action="del"]').forEach(btn => {
        if (canDelete) {
          btn.style.display = '';
          btn.classList.remove('hidden');
          btn.disabled = false;
        } else {
          btn.style.display = 'none';
          btn.classList.add('hidden');
        }
      });
      
      console.log('âœ… ØµÙ„Ø§Ø­ÙŠØ© Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…:', canDelete);
    } catch (err) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø­Ø°Ù:', err);
    }
  }

  // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø­Ø°Ù Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¨Ø¹Ø¯ ÙƒÙ„ ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø¬Ø¯ÙˆÙ„
  checkDeleteUserPermission();

  // 1) ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª (Ø§Ù„Ù…ÙØ¹Ù‘Ù„Ø© ÙÙ‚Ø·)
  async function loadHospitals(){
    try{
      console.log('ğŸ”„ Loading hospitals...');
      const res = await fetch(`${API_BASE}/api/hospitals?active=1`, { headers: authHeaders() });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const items = await res.json();
      
      console.log('ğŸ¥ Hospitals loaded:', items);

      hospitalSelect.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ â€”</option>' +
        items.map(h => `<option value="${h.HospitalID}">${h.NameAr}</option>`).join('');
      return items;
    }catch(err){
      console.error('âŒ loadHospitals error:', err);
      hospitalSelect.innerHTML = '<option value="">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª</option>';
      return [];
    }
  }

  // 2) ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ ÙˆØ§Ù„Ø¨Ø­Ø«
  async function loadUsers(){
    try{
      const hid = getActiveHospitalId();
      if (!hid) {
        console.log('â¸ï¸ No hospital selected, skipping load');
        const tbody = document.getElementById('usersTbody');
        if (tbody) {
          tbody.innerHTML = `<tr><td colspan="7" class="p-6 text-center text-gray-500">Ø§Ø®ØªØ± Ù…Ø³ØªØ´ÙÙ‰ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</td></tr>`;
        }
        return;
      }

      const params = new URLSearchParams();
      params.set('hospitalId', hid);
      const q = (searchInput.value || '').trim();
      if (q) params.set('search', q);

      const res = await fetch(`${API_BASE}/api/users?${params.toString()}`, { headers: authHeaders() });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      
      const { user } = getAuth();
      const userMode = getUserMode(user);
      const clusterMode = userMode === 'cluster' || userMode === 'central';
      
      renderUsers(data.items || [], clusterMode);
      
      // ØªØ­Ø¯ÙŠØ« ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù Ø¨Ø¹Ø¯ Ø±Ù†Ø¯Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„
      checkEditUserPermission();
      checkDeleteUserPermission();

    }catch(err){
      console.error('loadUsers', err);
      const tbody = document.getElementById('usersTbody');
      if (tbody) {
        tbody.innerHTML = `<tr><td colspan="7" class="p-6 text-center text-red-600">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${err.message}</td></tr>`;
      }
    }
  }

  // 3) Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
  function renderUsers(rows, clusterMode = false){
    const tbody = document.getElementById('usersTbody');
    if (!tbody) return;
    
    if (!rows || rows.length === 0){
      tbody.innerHTML = `<tr><td colspan="7" class="p-6 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</td></tr>`;
      return;
    }
    
    if (!clusterMode) {
      tbody.innerHTML = rows.map((u, i) => rowHtml(u, i + 1)).join('');
    } else {
      tbody.innerHTML = rows.map((u, i) => rowHtmlCluster(u, i + 1)).join('');
    }
    
    // ØªÙ‡ÙŠØ¦Ø© Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Lucide Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  }

  function rowHtml(u, idx){
    return `
    <tr class="border-b" data-id="${u.UserID}">
      <td class="p-3 text-center">${idx}</td>
      <td class="p-3">
        <div class="font-bold">${u.FullName || 'â€”'}</div>
        ${u.Mobile ? `<div class="text-xs text-gray-500">ğŸ“± ${u.Mobile}</div>` : ''}
        ${u.NationalID ? `<div class="text-xs text-gray-500">ğŸ†” ${u.NationalID}</div>` : ''}
      </td>
      <td class="p-3">
        <div class="font-mono text-sm">@${u.Username || 'â€”'}</div>
      </td>
      <td class="p-3">
        ${u.Email ? `<div class="text-sm">${u.Email}</div>` : 'â€”'}
      </td>
      <td class="p-3">
        <span class="px-2 py-1 rounded text-xs bg-blue-100 text-blue-700">
          ${roleName(u.RoleID)}
        </span>
      </td>
      <td class="p-3">
        <span class="px-2 py-1 rounded ${u.IsActive ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}">
          ${u.IsActive ? 'Ù…ÙØ¹Ù„' : 'Ù…ÙˆÙ‚Ù'}
        </span>
      </td>
      <td class="p-3 w-56">
        <div class="flex items-center gap-2 rtl:space-x-reverse">
          <button class="act-btn act-edit" data-action="edit" data-id="${u.UserID}" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <i data-lucide="pencil"></i><span>ØªØ¹Ø¯ÙŠÙ„</span>
          </button>
          <button class="act-btn act-delete" data-action="del" data-id="${u.UserID}" title="Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <i data-lucide="trash-2"></i><span>Ø­Ø°Ù</span>
          </button>
        </div>
      </td>
    </tr>`;
  }

  function rowHtmlCluster(u, idx){
    const name = u.FullName || 'â€”';
    const hosp = u.HospitalNameAr || `#${u.HospitalID}`;
    return `
    <tr class="border-b" data-id="${u.UserID}">
      <td class="p-3 text-center">${idx}</td>
      <td class="p-3">
        <div class="font-bold">${name}</div>
        <div class="text-xs opacity-70">Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰: ${hosp}</div>
        ${u.Mobile ? `<div class="text-xs text-gray-500">ğŸ“± ${u.Mobile}</div>` : ''}
      </td>
      <td class="p-3">
        <div class="font-mono text-sm">@${u.Username || 'â€”'}</div>
      </td>
      <td class="p-3">
        ${u.Email ? `<div class="text-sm">${u.Email}</div>` : 'â€”'}
      </td>
      <td class="p-3">
        <span class="px-2 py-1 rounded text-xs bg-blue-100 text-blue-700">
          ${roleName(u.RoleID)}
        </span>
      </td>
      <td class="p-3">
        <span class="px-2 py-1 rounded ${u.IsActive ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}">
          ${u.IsActive ? 'Ù…ÙØ¹Ù„' : 'Ù…ÙˆÙ‚Ù'}
        </span>
      </td>
      <td class="p-3 w-56">
        <div class="flex items-center gap-2 rtl:space-x-reverse">
          <button class="act-btn act-edit" data-action="edit" data-id="${u.UserID}" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <i data-lucide="pencil"></i><span>ØªØ¹Ø¯ÙŠÙ„</span>
          </button>
          <button class="act-btn act-delete" data-action="del" data-id="${u.UserID}" title="Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <i data-lucide="trash-2"></i><span>Ø­Ø°Ù</span>
          </button>
        </div>
      </td>
    </tr>`;
  }

  // Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€” ØºÙŠÙ‘Ø±ÙŠÙ‡ Ø­Ø³Ø¨ Ù†Ø¸Ø§Ù…Ùƒ)
  function roleName(roleId){
    if (roleId == 1) return 'Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù†';
    if (roleId == 3) return 'Ù…Ø¯ÙŠØ± Ù‚Ø³Ù…';
    if (roleId == 4) return 'Ù…Ø¯ÙŠØ±';
    return 'Ù…ÙˆØ¸Ù';
  }

  // 4) Event delegation Ù„Ù„Ø£Ø²Ø±Ø§Ø±
  function setupTableEventListeners() {
    const tbody = document.getElementById('usersTbody');
    if (!tbody) {
      console.error('âŒ usersTbody not found');
      return;
    }

    tbody.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-action]');
      if (!btn) return;

      const id = Number(btn.dataset.id);
      const action = btn.dataset.action;

      console.log(`ğŸ”˜ Button clicked: ${action} for user ${id}`);

      if (action === 'edit') {
        await openUserEdit(id);
      }

      if (action === 'del') {
        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return;
        try {
          const hid = getActiveHospitalId();
          if (!hid) return alert('Ø§Ø®ØªÙØ± Ù…Ø³ØªØ´ÙÙ‰ Ø£ÙˆÙ„Ø§Ù‹.');
          const url = `${API_BASE}/api/users/${id}?hospitalId=${hid}`;
          await fetch(url, { method: 'DELETE', headers: authHeaders() });
          alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
          await loadUsers();
        } catch (err) {
          alert('ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + err.message);
          console.error(err);
        }
      }
    });

    console.log('âœ… Table event listeners setup complete');
  }

  // Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…
  window.deleteUser = async function(id){
    if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return;
    
    const hid = getActiveHospitalId();
    if (!hid) return alert('Ø§Ø®ØªÙØ± Ù…Ø³ØªØ´ÙÙ‰ Ø£ÙˆÙ„Ø§Ù‹.');
    
    const res = await fetch(`${API_BASE}/api/users/${id}?hospitalId=${hid}`, { 
      method:'DELETE', 
      headers: authHeaders() 
    });
    if(!res.ok){ alert('ØªØ¹Ø°Ø± Ø§Ù„Ø­Ø°Ù'); return; }
    loadUsers();
  };


  // Ø£Ø­Ø¯Ø§Ø«
  hospitalSelect.addEventListener('change', () => {
    localStorage.setItem('adminUsers.hid', hospitalSelect.value || '');
    loadUsers();
  });
  searchInput.addEventListener('input', () => {
    clearTimeout(window.__t); window.__t = setTimeout(loadUsers, 300);
  });

  // ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
  (async function init(){
    console.log('ğŸš€ Initializing admin-users page...');
    
    const items = await loadHospitals();
    const { user } = getAuth();
    const userMode = getUserMode(user);
    const clusterMode = userMode === 'cluster' || userMode === 'central';
    const bar = document.getElementById('clusterBar');
    const hospitalHeader = document.getElementById('hospitalHeader');
    
    console.log('ğŸ‘¤ User info:', { 
      user, 
      userMode, 
      clusterMode, 
      itemsCount: items.length 
    });
    
    // Fallback: Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ØŒ Ø§Ø³ØªØ®Ø¯Ù… ÙˆØ¶Ø¹ Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ø¹
    const finalClusterMode = clusterMode || (!user?.RoleID && !user?.roleId && !user?.role_id);
    
    if (finalClusterMode) {
      console.log('ğŸ”§ Setting up cluster manager mode...');
      if (bar) bar.classList.remove('hidden');
      if (hospitalHeader) hospitalHeader.classList.remove('hidden');
      
      // Ù…Ø¯ÙŠØ± ØªØ¬Ù…Ø¹: Ø§Ø®ØªÙØ± Ø£ÙˆÙ„ Ù…Ø³ØªØ´ÙÙ‰ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ùˆ Ù…Ø§ ÙÙŠÙ‡ Ø§Ø®ØªÙŠØ§Ø±
      if (!hospitalSelect.value && items.length) {
        // Ø¬Ø±Ø¨ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¢Ø®Ø± Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­ÙÙˆØ¸
        const saved = localStorage.getItem('adminUsers.hid');
        if (saved && items.find(h => String(h.HospitalID) === saved)) {
          hospitalSelect.value = saved;
          console.log('ğŸ’¾ Restored saved hospital:', saved);
        } else {
          // Ø£Ùˆ Ø§Ø®ØªØ± Ø£ÙˆÙ„ Ù…Ø³ØªØ´ÙÙ‰
          hospitalSelect.value = String(items[0].HospitalID);
          console.log('ğŸ¯ Auto-selected first hospital:', items[0].HospitalID);
        }
      }
    } else {
      console.log('ğŸ¥ Setting up hospital employee mode...');
      // Ù…ÙˆØ¸Ù Ù…Ø³ØªØ´ÙÙ‰: Ø£Ø®ÙÙ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± ÙˆØ­Ù…Ù‘Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©
      if (bar) bar.classList.add('hidden');
      if (hospitalHeader) hospitalHeader.classList.add('hidden');
    }
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„
    setupTableEventListeners();
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø¹Ø¯ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰
    await loadUsers();
    
    console.log('âœ… Initialization complete');
  })();

  // ØªØ£Ø«ÙŠØ± Ø§Ù„Ù‡ÙŠØ¯Ø± ÙƒÙ…Ø§ Ù‡Ùˆ (Ù„Ù… ÙŠØªØºÙŠØ±)
  window.addEventListener("scroll", function () {
    const navbar = document.getElementById("navbar");
    if (window.scrollY > 50) {
      navbar.style.backgroundColor = "#ffffff";
      navbar.classList.add("shadow-md");
      navbar.querySelectorAll("a").forEach(link => {
        link.classList.remove("text-white", "hover:text-blue-200");
        link.classList.add("text-[#002B5B]", "hover:text-blue-700");
      });
    } else {
      navbar.style.backgroundColor = "#002B5B";
      navbar.classList.remove("shadow-md");
      navbar.querySelectorAll("a").forEach(link => {
        link.classList.add("text-white", "hover:text-blue-200");
        link.classList.remove("text-[#002B5B]", "hover:text-blue-700");
      });
    }
  });
});

// ======================= Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… =======================
// Ù„Ùˆ Ø§Ù„ØµÙØ­Ø© Ø¹Ù„Ù‰ 5500 ÙˆØ§Ù„Ù€ API Ø¹Ù„Ù‰ 3001 Ù†Ø¶Ø¨Ø· Ø§Ù„Ø£Ø³Ø§Ø³
const API_BASE = (location.port === '3001') ? '' : 'http://localhost:3001';

// Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†
function getAuth() {
  try {
    const token = localStorage.getItem('token') || sessionStorage.getItem('token');
    if (!token) {
      console.log('âŒ No token found');
      return { user: null, token: null };
    }
    
    console.log('ğŸ”‘ Token found:', token.substring(0, 50) + '...');
    
    const user = JSON.parse(atob(token.split('.')[1]));
    console.log('ğŸ‘¤ Decoded user:', user);
    
    return { user, token };
  } catch (e) {
    console.error('âŒ Error decoding token:', e);
    return { user: null, token: null };
  }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ù†Ø´Ø·
function getActiveHospitalId() {
  const { user } = getAuth();
  
  // Ø¯Ø¹Ù… Ø£Ø³Ù…Ø§Ø¡ Ø­Ù‚ÙˆÙ„ Ù…Ø®ØªÙ„ÙØ©
  const role = Number(user?.RoleID || user?.roleId || user?.role_id);
  const hospitalId = Number(user?.HospitalID || user?.hospitalId || user?.hospital_id);
  const isCluster = role === 1 || role === 4; // Ù…Ø¯ÙŠØ± ØªØ¬Ù…Ø¹ Ø£Ùˆ Ù…Ø±ÙƒØ²ÙŠ

  console.log('ğŸ” getActiveHospitalId:', { 
    user,
    role, 
    isCluster, 
    userHospitalID: hospitalId,
    rawRole: user?.RoleID,
    rawHospital: user?.HospitalID
  });

  if (isCluster) {
    const sel = document.getElementById('hospitalSelect');
    const val = Number(sel?.value);
    console.log('ğŸ” Cluster manager:', { 
      selExists: !!sel, 
      rawValue: sel?.value, 
      numericValue: val 
    });
    return Number.isFinite(val) && val > 0 ? val : 0;
  }
  
  console.log('âœ… Hospital employee hospital ID:', hospitalId);
  return hospitalId;
}

// Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ headers Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
function authHeaders() {
  const { token } = getAuth();
  return token ? { 'Authorization': `Bearer ${token}` } : {};
}

// Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
function isClusterManager(user) {
  const role = Number(user?.RoleID || user?.roleId || user?.role_id);
  return [1, 4].includes(role);
}

function getUserMode(user) {
  const role = Number(user?.RoleID || user?.roleId || user?.role_id);
  console.log('ğŸ” getUserMode:', { role, user });
  if (role === 1) return 'central';
  if (role === 4) return 'cluster';
  return 'hospital';
}

const userEditModal = document.getElementById('userEditModal');
const ueToast = document.getElementById('uetoast');

// Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
const ue_UserID      = document.getElementById('ue_UserID');
const ue_PasswordHash= document.getElementById('ue_PasswordHash');
const ue_FullName    = document.getElementById('ue_FullName');
const ue_Username    = document.getElementById('ue_Username');
const ue_Email       = document.getElementById('ue_Email');
const ue_Mobile      = document.getElementById('ue_Mobile');
const ue_NationalID  = document.getElementById('ue_NationalID');
const ue_RoleID      = document.getElementById('ue_RoleID');
const ue_HospitalID  = document.getElementById('ue_HospitalID');
const ue_DepartmentID= document.getElementById('ue_DepartmentID');
const ue_IsActive    = document.getElementById('ue_IsActive');

function showUeToast(msg='ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª'){
  ueToast.textContent = msg;
  ueToast.classList.remove('hidden');
  setTimeout(()=> ueToast.classList.add('hidden'), 1600);
}

function closeUserEdit(){ userEditModal.classList.add('hidden'); }
document.addEventListener('keydown', e => {
  if (e.key === 'Escape' && !userEditModal.classList.contains('hidden')) closeUserEdit();
});

// ØªØ¹Ø¨Ø¦Ø© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª
async function fillHospitalsSelect(){
  const res = await fetch(`${API_BASE}/api/hospitals?active=1`);
  const items = await res.json();
  ue_HospitalID.innerHTML = items.map(h => `<option value="${h.HospitalID}">${h.NameAr}</option>`).join('');
}

// ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ (Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø±Ø§ÙˆØªØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…)
async function fillDepartmentsSelect(hospitalId, selectedDeptId=null){
  ue_DepartmentID.innerHTML = `<option value="">â€” Ø¨Ø¯ÙˆÙ† Ù‚Ø³Ù… â€”</option>`;
  if (!hospitalId) return;
  try{
    console.log('ğŸ”„ Loading departments for hospital:', hospitalId);
    const res = await fetch(`${API_BASE}/api/departments?hospitalId=${hospitalId}`, {
      headers: authHeaders()
    });
    if(!res.ok) {
      console.error('âŒ Failed to load departments:', res.status, res.statusText);
      return;
    }
    const deps = await res.json();
    console.log('ğŸ¢ Departments loaded:', deps);
    ue_DepartmentID.innerHTML += deps.items?.map(d => `<option value="${d.DepartmentID}">${d.NameAr}</option>`).join('') || '';
    if (selectedDeptId) ue_DepartmentID.value = selectedDeptId;
  }catch(err){
    console.error('âŒ Error loading departments:', err);
  }
}

// Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØ¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
window.openUserEdit = async function(userId){
  const hid = getActiveHospitalId();
  if (!hid) return alert('Ø§Ø®ØªÙØ± Ù…Ø³ØªØ´ÙÙ‰ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰.');

  // Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ø´Ø§Ù† ØªØ­Ø³ÙŠ Ø£Ù†Ù‡ Ø§Ø³ØªØ¬Ø§Ø¨
  userEditModal.classList.remove('hidden');

  try{
    // 1) Ø­Ù…Ù‘Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const uRes = await fetch(`${API_BASE}/api/users/${userId}?hospitalId=${hid}`, { headers: authHeaders() });
    if(!uRes.ok) throw new Error('HTTP '+uRes.status);
    const data = await uRes.json();
    const u = data.data;

    // 2) Ø¹Ø¨Ø¦ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹
    await fillHospitalsSelect().catch(()=>{ ue_HospitalID.innerHTML = ''; });

    // 3) Ø¹Ø¨Ù‘ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„
    ue_UserID.value       = u.UserID;
    ue_PasswordHash.value = u.PasswordHash || '';
    ue_FullName.value     = u.FullName || '';
    ue_Username.value     = u.Username || '';
    ue_Email.value        = u.Email || '';
    ue_Mobile.value       = u.Mobile || '';
    ue_NationalID.value   = u.NationalID || '';
    ue_RoleID.value       = u.RoleID || 2;
    ue_HospitalID.value   = u.HospitalID || '';
    ue_IsActive.checked   = !!u.IsActive;

    // 4) Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø±Ø§ÙˆØªØ±Ù‡Ø§)
    await fillDepartmentsSelect(u.HospitalID, u.DepartmentID || null).catch(()=>{ /* ignore */ });

    setTimeout(()=> ue_FullName.focus(), 50);

  }catch(err){
    console.error('openUserEdit error', err);
    closeUserEdit();
    alert('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
  }
};

// Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ => Ø¹Ø¨Ù‘ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
ue_HospitalID.addEventListener('change', ()=>{
  fillDepartmentsSelect(ue_HospitalID.value, null);
});

// Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
window.saveUserEdit = async function(e){
  e.preventDefault();

  const hid = getActiveHospitalId();
  if (!hid) return alert('Ø§Ø®ØªÙØ± Ù…Ø³ØªØ´ÙÙ‰ Ø£ÙˆÙ„Ø§Ù‹.');

  const payload = {
    RoleID:       Number(ue_RoleID.value || 2),
    HospitalID:   hid,
    DepartmentID: ue_DepartmentID.value ? Number(ue_DepartmentID.value) : null,
    FullName:     ue_FullName.value.trim(),
    Username:     ue_Username.value.trim(),
    Email:        ue_Email.value.trim(),
    Mobile:       ue_Mobile.value.trim(),
    NationalID:   ue_NationalID.value.trim(),
    PasswordHash: ue_PasswordHash.value || null, // Ù„Ø§ Ù†ØºÙŠÙ‘Ø±Ù‡Ø§Ø› Ù†Ø¹ÙŠØ¯ Ù†ÙØ³ Ø§Ù„Ù‚ÙŠÙ…Ø©
    IsActive:     ue_IsActive.checked ? 1 : 0
  };

  if (!payload.FullName) return alert('Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø·Ù„ÙˆØ¨');
  if (!payload.Username) return alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø·Ù„ÙˆØ¨');
  
  // ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡
  if (payload.Email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(payload.Email)) {
    return alert('âŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­');
  }

  try{
    const res = await fetch(`${API_BASE}/api/users/${ue_UserID.value}?hospitalId=${hid}`, {
      method: 'PUT',
      headers: { 'Content-Type':'application/json', ...authHeaders() },
      body: JSON.stringify(payload)
    });
    
    const data = await res.json();
    
    if(!res.ok){
      console.error('saveUserEdit failed', res.status, data);
      
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ù…Ø­Ø¯Ø¯Ø©
      if (res.status === 409) {
        if (data.message === 'username exists') {
          const details = data.details || 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹';
          alert(`âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹.\n\n${details}\n\nÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±.`);
        } else if (data.message === 'email exists') {
          const details = data.details || 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹';
          alert(`âŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹.\n\n${details}\n\nÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¢Ø®Ø±.`);
        } else {
          alert('âŒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹: ' + (data.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø­Ø¯Ø¯'));
        }
      } else if (res.status === 400) {
        alert('âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©: ' + (data.message || 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©'));
      } else if (res.status === 403) {
        alert('âŒ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
      } else if (res.status === 404) {
        alert('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
      } else {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ' + (data.message || 'HTTP ' + res.status));
      }
      return;
    }

    closeUserEdit();
    showUeToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
    // Ø£Ø¹ÙŠØ¯ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (ØªØ£ÙƒØ¯ÙŠ Ø£Ù† Ù„Ø¯ÙŠÙƒ Ø¯Ø§Ù„Ø© loadUsers)
    if (typeof loadUsers === 'function') await loadUsers();

  }catch(err){
    console.error('saveUserEdit error', err);
    alert('âŒ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª: ' + err.message);
  }
};

// ======================= Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…ÙØ­Ø¯Ù‘Ø« Ù…Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±) =======================
// Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ (ØªØ£ÙƒØ¯ Ø£Ù†Ù‡Ø§ Ù„ÙŠØ³Øª Ù…ÙƒØ±Ø±Ø© ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ø®Ø±)
const userAddModal = document.getElementById('userAddModal');

const ua_FullName     = document.getElementById('ua_FullName');
const ua_Username     = document.getElementById('ua_Username');
const ua_Email        = document.getElementById('ua_Email');
const ua_Mobile       = document.getElementById('ua_Mobile');
const ua_NationalID   = document.getElementById('ua_NationalID');
const ua_RoleID       = document.getElementById('ua_RoleID');
const ua_HospitalID   = document.getElementById('ua_HospitalID');
const ua_DepartmentID = document.getElementById('ua_DepartmentID');
const ua_IsActive     = document.getElementById('ua_IsActive');
const ua_Password     = document.getElementById('ua_Password');
const ua_PasswordConfirm = document.getElementById('ua_PasswordConfirm');

// Ù…Ù„Ø¡ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª
async function fillAddSelects(){
  try{
    const res = await fetch(`${API_BASE}/api/hospitals?active=1`);
    if(!res.ok) return;
    const items = await res.json();
    ua_HospitalID.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ â€”</option>' + items.map(h => `<option value="${h.HospitalID}">${h.NameAr}</option>`).join('');
  }catch(e){ console.warn('fillAddSelects', e); }
}

async function fillAddDepartments(hid){
  ua_DepartmentID.innerHTML = `<option value="">â€” Ø¨Ø¯ÙˆÙ† Ù‚Ø³Ù… â€”</option>`;
  if(!hid) return;
  try{
    console.log('ğŸ”„ Loading departments for hospital (add mode):', hid);
    const res = await fetch(`${API_BASE}/api/departments?hospitalId=${hid}`, {
      headers: authHeaders()
    });
    if(!res.ok) {
      console.error('âŒ Failed to load departments (add mode):', res.status, res.statusText);
      return;
    }
    const deps = await res.json();
    console.log('ğŸ¢ Departments loaded (add mode):', deps);
    ua_DepartmentID.innerHTML += deps.items?.map(d => `<option value="${d.DepartmentID}">${d.NameAr}</option>`).join('') || '';
  }catch(e){ 
    console.error('âŒ Error loading departments (add mode):', e); 
  }
}

// ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
function openUserAdd(){
  const hid = getActiveHospitalId();
  if (!hid) return alert('Ø§Ø®ØªÙØ± Ù…Ø³ØªØ´ÙÙ‰ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰.');
  
  userAddModal.classList.remove('hidden');
  fillAddSelects();
}
function closeUserAdd(){
  userAddModal.classList.add('hidden');
  // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  ua_FullName.value = ua_Username.value = ua_Email.value = ua_Mobile.value = ua_NationalID.value = '';
  ua_Password.value = ua_PasswordConfirm.value = '';
  ua_RoleID.value = '2';
  ua_HospitalID.value = '';
  ua_DepartmentID.innerHTML = `<option value="">â€” Ø¨Ø¯ÙˆÙ† Ù‚Ø³Ù… â€”</option>`;
  ua_IsActive.checked = true;
}

// Ø¹Ù†Ø¯Ù…Ø§ ÙŠØªØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ù†Ø¹Ø¨ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
ua_HospitalID.addEventListener('change', ()=> fillAddDepartments(ua_HospitalID.value));

// ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø¯Ø§Ù„Ø© hashPasswordSHA256 - Ø§Ù„Ø³ÙŠØ±ÙØ± Ø³ÙŠØªÙˆÙ„Ù‰ ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¨Ù€ bcrypt

// Ø­ÙØ¸ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
async function saveUserAdd(e){
  e.preventDefault();

  const hid = getActiveHospitalId();
  if (!hid) return alert('Ø§Ø®ØªÙØ± Ù…Ø³ØªØ´ÙÙ‰ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰.');

  // ØªØ­Ù‚Ù‚ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  const fullName = ua_FullName.value.trim();
  const username = ua_Username.value.trim();

  if(!fullName || !username) return alert('ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….');
  
  // ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡
  const email = ua_Email.value.trim();
  if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    return alert('âŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­');
  }

  // ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠÙ‹Ø§ Ù…Ø¹ Ø§Ù„ØªØ£ÙƒØ¯)
  const pwd = ua_Password.value;
  const pwdConfirm = ua_PasswordConfirm.value;
  if (pwd || pwdConfirm){
    if (pwd.length < 6) return alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
    if (pwd !== pwdConfirm) return alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ÙˆØªØ£ÙƒÙŠØ¯Ù‡Ø§ ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ÙŠÙ†.');
  }

  const payload = {
    RoleID: Number(ua_RoleID.value || 2),
    HospitalID: hid,
    DepartmentID: ua_DepartmentID.value ? Number(ua_DepartmentID.value) : null,
    FullName: fullName,
    Username: username,
    Email: ua_Email.value.trim(),
    Mobile: ua_Mobile.value.trim(),
    NationalID: ua_NationalID.value.trim(),
    Password: pwd || undefined,
    IsActive: ua_IsActive.checked ? 1 : 0
  };

  try{
    const res = await fetch(`${API_BASE}/api/users?hospitalId=${hid}`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json', ...authHeaders() },
      body: JSON.stringify(payload)
    });
    
    const data = await res.json();
    
    if(!res.ok){
      console.error('saveUserAdd failed', res.status, data);
      
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ù…Ø­Ø¯Ø¯Ø©
      if (res.status === 409) {
        if (data.message === 'username exists') {
          const details = data.details || 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹';
          alert(`âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹.\n\n${details}\n\nÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±.`);
        } else if (data.message === 'email exists') {
          const details = data.details || 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹';
          alert(`âŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹.\n\n${details}\n\nÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¢Ø®Ø±.`);
        } else {
          alert('âŒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹: ' + (data.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø­Ø¯Ø¯'));
        }
      } else if (res.status === 400) {
        alert('âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©: ' + (data.message || 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©'));
      } else if (res.status === 403) {
        alert('âŒ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰');
      } else {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ' + (data.message || 'HTTP ' + res.status));
      }
      return;
    }
    
    // Ù†Ø¬Ø­ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
    closeUserAdd();
    alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­\n\n' + (data.centralSync || ''));
    if (typeof loadUsers === 'function') loadUsers();
    
  }catch(err){
    console.error('saveUserAdd error', err);
    alert('âŒ ØªØ¹Ø°Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + err.message);
  }
}

// Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„ÙˆÙŠ
const addBtn = document.getElementById('btnOpenAddUser');
if(addBtn){
  addBtn.addEventListener('click', e=>{
    e.preventDefault();
    openUserAdd();
  });
}

</script>
</body>
</html>

