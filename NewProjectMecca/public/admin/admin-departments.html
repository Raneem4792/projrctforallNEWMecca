<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <style>
    .act-btn{
      @apply inline-flex items-center gap-1 px-3 py-1.5 rounded-full text-sm font-medium
             shadow-sm transition hover:shadow ring-1 ring-inset;
    }
    .act-btn i{ @apply w-4 h-4; }
    .act-edit  { @apply bg-blue-50 text-blue-700 ring-blue-200 hover:bg-blue-100; }
    .act-delete{ @apply bg-rose-50 text-rose-700 ring-rose-200 hover:bg-rose-100; }
    .act-child { @apply bg-emerald-50 text-emerald-700 ring-emerald-200 hover:bg-emerald-100; }
    /* ØªÙƒØ¯ÙŠØ³ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
    @media (max-width: 640px){
      .act-btn span{ display:none }  /* Ù†Ø®ÙÙŠ Ø§Ù„Ù†Øµ ÙˆÙ†ØªØ±Ùƒ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
      .act-btn{ @apply p-2 rounded-lg }
    }
  </style>
</head>
<body class="min-h-screen flex flex-col bg-gray-50" style="font-family:'Tajawal',sans-serif">

  <!-- Ù‡ÙŠØ¯Ø± Ù…Ø¹ ØªØ£Ø«ÙŠØ± Ø§Ù„ØªÙ…Ø±ÙŠØ± (ÙŠØªØ­ÙˆÙ„ Ø£Ø¨ÙŠØ¶ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø²ÙˆÙ„) -->
  <header id="navbar" class="fixed w-full top-0 z-50 navbar-scroll" style="background-color:#002B5B;">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center">
          <img id="logoImg" src="../assets/img/logo3.png" class="h-16 w-auto" alt="Logo">
        </div>
        <nav class="hidden md:flex items-center space-x-reverse space-x-8">
          <a href="../../index/index.html" class="text-white hover:text-blue-200 transition-colors">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
          <a href="../../dashboard/dashboard.html" class="text-white hover:text-blue-200 transition-colors">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
          <a href="admin-hub.html" class="text-white hover:text-blue-200 transition-colors">Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
          <a href="admin-departments.html" class="text-white font-bold underline">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</a>
        </nav>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 pt-24 pb-10 flex-1">
    <section class="text-center mb-8">
      <h1 class="text-3xl md:text-4xl font-extrabold text-[#002B5B] mb-2">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h1>
      <p class="text-gray-600">Ø¥Ø¶Ø§ÙØ© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ (Ù‡ÙŠÙƒÙ„ Ù‡Ø±Ù…ÙŠ)</p>
    </section>

    <div class="flex items-center justify-between mb-4">
      <div class="text-left">
        <button id="btnOpenAddRoot"
                class="bg-[#002B5B] hover:bg-[#013b7a] text-white font-semibold px-6 py-2 rounded-xl shadow-md transition">
          + Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠ
        </button>
      </div>

      <!-- Ø¨Ø­Ø« Ø¨Ø³ÙŠØ· -->
      <div class="w-full max-w-sm">
        <input id="searchBox" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø³Ù…..."
               class="w-full rounded-xl border-gray-300 focus:border-[#002B5B] focus:ring-[#002B5B]">
      </div>
    </div>

    <!-- Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ù‘Ø¹) -->
    <div id="clusterBar" class="hidden mb-4 flex gap-2 items-center">
      <label class="text-sm">Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰:</label>
      <select id="hospitalSelect" class="border rounded px-3 py-2">
        <option value="">Ø§Ù„ÙƒÙ„</option>
      </select>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
    <div class="overflow-x-auto bg-white rounded-2xl shadow-lg border border-gray-100">
      <table class="min-w-full text-center" id="departmentsTable">
        <thead class="bg-gray-100 text-gray-700">
          <tr>
            <th class="py-3 px-4 w-16">#</th>
            <th class="py-3 px-4 text-right">Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…</th>
            <th id="hospitalHeader" class="py-3 px-4 hidden">Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</th>
            <th class="py-3 px-4">Ø§Ù„ÙˆØµÙ</th>
            <th class="py-3 px-4">Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th class="py-3 px-4 w-72">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody class="text-gray-700" id="departmentsTbody">
          <!-- ÙŠÙØ¨Ù†Ù‰ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
        </tbody>
      </table>
    </div>
  </main>

  <!-- Footer - Ø§Ù„ØªØ°ÙŠÙŠÙ„ -->
  <footer class="bg-gray-900 text-white py-14">
    <div class="container mx-auto px-4">
      <div class="grid md:grid-cols-3 gap-8">
        <!-- Column 1 - Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ -->
        <div>
          <div class="flex items-center space-x-reverse space-x-3 mb-4">
            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 2L2 7v10c0 5.55 3.84 9.74 9 11 5.16-1.26 9-5.45 9-11V7l-10-5z"/>
              </svg>
            </div>
            <div>
              <div class="font-bold">ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„ØµØ­ÙŠ</div>
              <div class="text-sm text-gray-300">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</div>
            </div>
          </div>
          <p class="text-gray-300 text-sm">Ù…Ù†ØµØ© Ø±Ø³Ù…ÙŠØ© Ù„ØªÙ‚Ø¯ÙŠÙ… ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</p>
        </div>

        <!-- Column 2 - Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ -->
        <div>
          <h3 class="font-bold mb-4">Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©</h3>
          <ul class="space-y-2 text-sm">
            <li><a href="../../index/index.html" class="text-gray-300 hover:text-white hover:underline transition-colors">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
            <li><a href="../complaints/submit/submit-complaint.html" class="text-gray-300 hover:text-white hover:underline transition-colors">ØªÙ‚Ø¯ÙŠÙ… Ø¨Ù„Ø§Øº</a></li>
            <li><a href="../complaints/track/track-complaint.html" class="text-gray-300 hover:text-white hover:underline transition-colors">Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ù„Ø§Øº</a></li>
            <li><a href="../../index/help.html" class="text-gray-300 hover:text-white hover:underline transition-colors">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©</a></li>
          </ul>
        </div>

        <!-- Column 3 - Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù„Ø« -->
        <div>
          <h3 class="font-bold mb-4">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</h3>
          <div class="space-y-2 text-sm text-gray-300">
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
              <span>Ø±Ù‚Ù… Ø§Ù„Ø¯Ø¹Ù…: 0559735137</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
              <span>support@makkahhealth.gov.sa</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„: 24/7</span>
            </div>
          </div>
        </div>
      </div>

      <div class="border-t border-gray-700 mt-8 pt-8 text-center text-sm text-gray-300">
        Â© 2025 ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„ØµØ­ÙŠ â€“ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©
      </div>
    </div>
  </footer>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ -->
  <div id="deptModal" class="fixed inset-0 z-[60] hidden" aria-hidden="true">
    <div id="deptModalBackdrop" class="absolute inset-0 bg-black/40"></div>
    <div class="relative min-h-full flex items-center justify-center p-4">
      <div class="w-full max-w-xl bg-white rounded-2xl shadow-2xl border border-gray-100 overflow-hidden">
        <div class="flex items-center justify-between px-6 py-4 border-b">
          <h3 id="deptModalTitle" class="text-xl font-extrabold text-[#002B5B]">Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…</h3>
          <button id="btnCloseModal" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
        </div>

        <form id="deptForm" class="px-6 py-5 space-y-4" novalidate>
          <input type="hidden" id="deptId" value="">
          <div>
            <label class="block mb-1 font-semibold text-gray-700">Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… <span class="text-red-500">*</span></label>
            <input id="deptName" type="text" required
                   class="w-full rounded-xl border-gray-300 focus:border-[#002B5B] focus:ring-[#002B5B]">
            <p id="deptNameErr" class="text-red-600 text-sm mt-1 hidden">Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ù…Ø·Ù„ÙˆØ¨</p>
          </div>

          <div>
            <label class="block mb-1 font-semibold text-gray-700">Ø§Ù„ÙˆØµÙ</label>
            <textarea id="deptDesc" rows="3"
                      class="w-full rounded-xl border-gray-300 focus:border-[#002B5B] focus:ring-[#002B5B]"></textarea>
          </div>

          <div>
            <label class="block mb-1 font-semibold text-gray-700">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£Ø¨</label>
            <select id="parentSelect"
                    class="w-full rounded-xl border-gray-300 focus:border-[#002B5B] focus:ring-[#002B5B]">
              <!-- ÙŠÙ…ØªÙ„Ø¦ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </select>
            <p class="text-xs text-gray-500 mt-1">Ø§ØªØ±ÙƒÙ‡ "Ø¨Ø¯ÙˆÙ† Ø£Ø¨" Ù„ÙŠÙƒÙˆÙ† Ø§Ù„Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠØ§Ù‹.</p>
          </div>

          <div class="flex items-center justify-end gap-3 pt-2">
            <button type="button" id="btnModalCancel"
                    class="px-4 py-2 rounded-xl border border-gray-300 hover:bg-gray-50">Ø¥Ù„ØºØ§Ø¡</button>
            <button type="submit" id="btnModalSave"
                    class="px-5 py-2 rounded-xl bg-[#002B5B] hover:bg-[#013b7a] text-white font-semibold">
              Ø­ÙØ¸
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // ØªØ­Ø¯ÙŠØ¯ Ø¹Ù†ÙˆØ§Ù† API Ø­Ø³Ø¨ Ø§Ù„Ø¨ÙŠØ¦Ø©
    const API_BASE = 
      location.hostname === 'localhost' || location.hostname === '127.0.0.1'
        ? 'http://localhost:3001'
        : '';

    // Ø§Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆÙƒÙ† ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†
    function getAuth() {
      let user=null, token=null;
      try { user = JSON.parse(localStorage.getItem('user')); } catch {}
      token = localStorage.getItem('token');
      return { user, token };
    }

    function ensureLoggedIn(){
      const { user, token } = getAuth();
      console.log('ğŸ” ensureLoggedIn check:', { 
        hasToken: !!token, 
        hasUser: !!user,
        user: user 
      });
      
      if(!token){
        console.log('âŒ No token found');
        alert('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©ØŒ ÙØ¶Ù„Ø§Ù‹ Ø³Ø¬Ù‘Ù„ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„.');
        location.href = '../auth/login.html';
        throw new Error('no token');
      }
      
      if(!user){
        console.log('âŒ No user found');
        alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙÙ‚ÙˆØ¯Ø©ØŒ ÙØ¶Ù„Ø§Ù‹ Ø³Ø¬Ù‘Ù„ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        location.href = '../auth/login.html';
        throw new Error('no user');
      }
    }

    // helpers
    function isClusterManager(user){
      const clusterRoles = new Set([1, 4]); // Ø¹Ø¯Ù‘Ù„ÙŠ Ù…Ø·Ø§Ø¨Ù‚Ù‹Ø§ Ù„Ù„Ø¨Ø§Ùƒ-Ø¥Ù†Ø¯
      return user && (clusterRoles.has(user.RoleID) || (user.Permissions||[]).includes('VIEW_ALL_HOSPITALS'));
    }

    // ØªØ­Ø¯ÙŠØ¯ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    function getUserMode(user) {
      if (!user) return 'guest';
      if (isClusterManager(user)) return 'cluster';
      if (user.HospitalID) return 'hospital';
      return 'central'; // Ù…Ø¯ÙŠØ± Ù…Ø±ÙƒØ²ÙŠ Ø¨Ø¯ÙˆÙ† Ù…Ø³ØªØ´ÙÙ‰ Ù…Ø­Ø¯Ø¯
    }

    async function fetchJSON(url, opts={}) {
      ensureLoggedIn();
      const { token } = getAuth();
      
      console.log('ğŸŒ Making request to:', url);
      console.log('ğŸ”‘ Using token:', token ? 'exists' : 'missing');
      
      const res = await fetch(url, {
        method: opts.method || 'GET',
        headers: {
          'Accept': 'application/json',
          'Authorization': `Bearer ${token}`,     // <â€” Ù…Ù‡Ù…
          ...(opts.headers||{})
        },
        cache: 'no-store',
        body: opts.body
      });
      
      console.log('ğŸ“¡ Response status:', res.status);
      
      let data=null; try{ data=await res.json(); }catch{}
      
      if(!res.ok) {
        console.error('âŒ Request failed:', { status: res.status, data });
        throw new Error(data?.message || `HTTP ${res.status}`);
      }
      
      console.log('âœ… Request successful:', data);
      return data;
    }

    function showSessionEnded(){
      console.log('ğŸ”´ Session ended - redirecting to login');
      const tbody = document.getElementById('departmentsTbody');
      if (tbody) {
        tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-600">
          <div class="text-lg font-bold mb-2">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©</div>
          <div class="text-sm">Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</div>
          <div class="mt-4">
            <a href="../auth/login.html" 
               class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
              ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            </a>
          </div>
        </td></tr>`;
      }
      // ÙˆØ¬Ù‘Ù‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ Ø«ÙˆØ§Ù†Ù
      setTimeout(()=> {
        console.log('ğŸ”„ Redirecting to login page...');
        location.href = '../auth/login.html';
      }, 2000);
    }

    async function loadHospitalsForCluster() {
      const arr = await fetchJSON(`${API_BASE}/api/hospitals`);
      const hospitals = Array.isArray(arr) ? arr : (arr?.hospitals || []);
      const sel = document.getElementById('hospitalSelect');
      if (sel) {
        sel.innerHTML = `<option value="">Ø§Ù„ÙƒÙ„</option>` + hospitals.map(h =>
          `<option value="${h.HospitalID}">${h.NameAr || h.NameEn}</option>`
        ).join('');
      }
    }

    async function renderDepartments(departments, clusterMode) {
      const tbody = document.getElementById('departmentsTbody');
      if (!departments || departments.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="p-6 text-center text-gray-600">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù…</td></tr>`;
        return;
      }
      
      // Ø¬Ù„Ø¨ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ù…Ø¹
      if (clusterMode) {
        await loadHospitalsMap();
        // Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª Ù„Ù„Ø£Ù‚Ø³Ø§Ù…
        departments = departments.map(d => ({
          ...d,
          HospitalNameAr: hospitalsMap.get(d.HospitalID)?.NameAr || `#${d.HospitalID}`,
          HospitalNameEn: hospitalsMap.get(d.HospitalID)?.NameEn || `#${d.HospitalID}`
        }));
      }
      
      if (!clusterMode) {
        tbody.innerHTML = departments.map((d,i)=>rowHtml(d, i+1)).join('');
      } else {
      // ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ÙƒÙ„ØŒ ÙŠØ¸Ù‡Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰
      tbody.innerHTML = departments.map((d,i)=>rowHtmlCluster(d, i+1)).join('');
    }
    
    // ØªÙ‡ÙŠØ¦Ø© Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Lucide Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  }

    function rowHtml(d, idx){
      return `
      <tr class="border-b" data-id="${d.DepartmentID}">
        <td class="p-3 text-center">${idx}</td>
        <td class="p-3">
          <div class="font-bold">${d.NameAr ?? d.NameEn ?? 'â€”'}</div>
          ${d.Code ? `<div class="text-xs text-gray-500">ÙƒÙˆØ¯: ${d.Code}</div>` : ''}
          ${d.HeadName ? `<div class="text-xs text-gray-500">Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…: ${d.HeadName}</div>` : ''}
        </td>
        <td class="p-3">
          ${d.DefaultEmail ? `<div class="text-sm">${d.DefaultEmail}</div>` : ''}
          ${d.HeadEmail ? `<div class="text-xs text-gray-500">${d.HeadEmail}</div>` : ''}
        </td>
        <td class="p-3">
          <span class="px-2 py-1 rounded ${d.IsActive ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}">
            ${d.IsActive ? 'Ù…ÙØ¹Ù„' : 'Ù…ÙˆÙ‚Ù‘Ù'}
          </span>
        </td>
        <td class="p-3 w-56">
          <div class="flex items-center gap-2 rtl:space-x-reverse">
            <button class="act-btn act-edit" data-action="edit" data-id="${d.DepartmentID}" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…">
              <i data-lucide="pencil"></i><span>ØªØ¹Ø¯ÙŠÙ„</span>
            </button>
            <button class="act-btn act-delete" data-action="del" data-id="${d.DepartmentID}" title="Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…">
              <i data-lucide="trash-2"></i><span>Ø­Ø°Ù</span>
            </button>
            <button class="act-btn act-child" data-action="child" data-id="${d.DepartmentID}" title="Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… ÙØ±Ø¹ÙŠ">
              <i data-lucide="plus"></i><span>Ù‚Ø³Ù… ÙØ±Ø¹ÙŠ</span>
            </button>
          </div>
        </td>
      </tr>`;
    }

    function rowHtmlCluster(d, idx){
      const name = d.NameAr ?? d.NameEn ?? 'â€”';
      const hosp = d.HospitalNameAr ?? d.HospitalNameEn ?? `#${d.HospitalID}`;
      return `
      <tr class="border-b" data-id="${d.DepartmentID}">
        <td class="p-3 text-center">${idx}</td>
        <td class="p-3">
          <div class="font-bold">${name}</div>
          ${d.Code ? `<div class="text-xs text-gray-500">ÙƒÙˆØ¯: ${d.Code}</div>` : ''}
          <div class="text-xs opacity-70">Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰: ${hosp}</div>
          ${d.HeadName ? `<div class="text-xs text-gray-500">Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…: ${d.HeadName}</div>` : ''}
        </td>
        <td class="p-3">
          ${d.DefaultEmail ? `<div class="text-sm">${d.DefaultEmail}</div>` : ''}
          ${d.HeadEmail ? `<div class="text-xs text-gray-500">${d.HeadEmail}</div>` : ''}
        </td>
        <td class="p-3">
          <span class="px-2 py-1 rounded ${d.IsActive ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}">
            ${d.IsActive ? 'Ù…ÙØ¹Ù„' : 'Ù…ÙˆÙ‚Ù‘Ù'}
          </span>
        </td>
        <td class="p-3 w-56">
          <div class="flex items-center gap-2 rtl:space-x-reverse">
            <button class="act-btn act-edit" data-action="edit" data-id="${d.DepartmentID}" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…">
              <i data-lucide="pencil"></i><span>ØªØ¹Ø¯ÙŠÙ„</span>
            </button>
            <button class="act-btn act-delete" data-action="del" data-id="${d.DepartmentID}" title="Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…">
              <i data-lucide="trash-2"></i><span>Ø­Ø°Ù</span>
            </button>
            <button class="act-btn act-child" data-action="child" data-id="${d.DepartmentID}" title="Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… ÙØ±Ø¹ÙŠ">
              <i data-lucide="plus"></i><span>Ù‚Ø³Ù… ÙØ±Ø¹ÙŠ</span>
            </button>
          </div>
        </td>
      </tr>`;
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
    async function init() {
      // 1) Ø§Ù‚Ø±Ø£ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†
      const { user, token } = getAuth();
      
      console.log('ğŸ” Auth Debug:', { user, token: token ? 'exists' : 'missing' });
      
      if (!token) {
        console.log('âŒ No token found, redirecting to login');
        showSessionEnded();
        return;
      }
      
      if (!user) {
        console.log('âŒ No user found, redirecting to login');
        showSessionEnded();
        return;
      }

      const userMode = getUserMode(user);
      const clusterMode = userMode === 'cluster' || userMode === 'central';
      const bar = document.getElementById('clusterBar');
      const hospitalHeader = document.getElementById('hospitalHeader');
      
      if (clusterMode) {
        if (bar) bar.classList.remove('hidden');
        if (hospitalHeader) hospitalHeader.classList.remove('hidden');
        await loadHospitalsForCluster();
      }

      // 2) Ø­Ù…Ù‘Ù„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
      await reloadDepartments();

      // 3) ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ù…Ø¹
      const sel = document.getElementById('hospitalSelect');
      if (sel) sel.addEventListener('change', reloadDepartments);

      async function reloadDepartments() {
        try {
          const base = `${API_BASE}/api/departments`;
          const selVal = document.getElementById('hospitalSelect')?.value || '';
          const { user } = getAuth();
          const userMode = getUserMode(user);
          
          console.log('ğŸ” Frontend Debug:', {
            user,
            userMode,
            selVal,
            hasHospitalID: !!user?.HospitalID,
            hasHospitalId: !!user?.hospitalId,
            HospitalID: user?.HospitalID,
            hospitalId: user?.hospitalId
          });
          
          let url = base;
          
          // Ø®Ø°ÙŠ HospitalID Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯ (ØªØµÙ„ÙŠØ­Ø© ÙÙˆØ±ÙŠØ©)
          if (user?.HospitalID) {
            url = `${base}?hospitalId=${encodeURIComponent(user.HospitalID)}`;
            console.log('âœ… Using HospitalID from token:', user.HospitalID);
          } else if (user?.hospitalId) {
            url = `${base}?hospitalId=${encodeURIComponent(user.hospitalId)}`;
            console.log('âœ… Using hospitalId from token:', user.hospitalId);
          } else if (selVal) {
            // Ù„Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† Ø§Ù„Ù…Ø±ÙƒØ²ÙŠÙŠÙ† - ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø±Ø¤ÙŠØ© ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª Ø£Ùˆ Ù…Ø³ØªØ´ÙÙ‰ Ù…Ø­Ø¯Ø¯
            url = `${base}?hospitalId=${encodeURIComponent(selVal)}`;
            console.log('âœ… Using selected hospital:', selVal);
          } else {
            console.log('âš ï¸ No hospital ID found, using base URL');
          }
          
          console.log('ğŸŒ Final URL:', url);
          const payload = await fetchJSON(url);
          await renderDepartments(payload.items || [], clusterMode);
        } catch (err) {
          console.error('load departments error:', err);
          document.getElementById('departmentsTbody').innerHTML =
            `<tr><td colspan="6" class="p-6 text-center text-red-600">ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: ${err.message}</td></tr>`;
        }
      }
    }

    // ØªØ£Ø«ÙŠØ± Ø§Ù„Ù‡ÙŠØ¯Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ±
    window.addEventListener("scroll", () => {
      const navbar = document.getElementById("navbar");
      const links = navbar.querySelectorAll("a");
      if (window.scrollY > 50) {
        navbar.style.backgroundColor = "#ffffff";
        navbar.classList.add("shadow-md");
        links.forEach(a => { a.classList.remove("text-white","hover:text-blue-200"); a.classList.add("text-[#002B5B]","hover:text-blue-700"); });
      } else {
        navbar.style.backgroundColor = "#002B5B";
        navbar.classList.remove("shadow-md");
        links.forEach(a => { a.classList.add("text-white","hover:text-blue-200"); a.classList.remove("text-[#002B5B]","hover:text-blue-700"); });
      }
    });

    // Ø§Ø±Ø¬Ø¹ÙŠ Ø¢ÙŠ Ø¯ÙŠ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ø­Ø³Ø¨ Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    function getActiveHospitalId() {
      const { user } = getAuth();
      const role = Number(user?.RoleID);
      const isCluster = role === 1 || role === 4; // Ù…Ø¯ÙŠØ± ØªØ¬Ù…Ø¹ Ø£Ùˆ Ù…Ø±ÙƒØ²ÙŠ

      if (isCluster) {
        const sel = document.getElementById('hospitalSelect');
        const val = Number(sel?.value);
        return Number.isFinite(val) && val > 0 ? val : 0;
      }
      return Number(user?.HospitalID) || 0;
    }

    // Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª Ù„Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
    let hospitalsMap = new Map();

    // Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
    async function loadHospitalsMap() {
      if (hospitalsMap.size > 0) return hospitalsMap;
      
      try {
        const url = `${API_BASE}/api/hospitals`;
        const data = await fetchJSON(url);
        hospitalsMap = new Map((data.items || []).map(h => [h.HospitalID, h]));
        console.log('âœ… Hospitals map loaded:', hospitalsMap.size, 'hospitals');
        return hospitalsMap;
      } catch (err) {
        console.error('âŒ Error loading hospitals map:', err);
        return new Map();
      }
    }

    // Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙŠ ÙƒØ§Ù† ÙŠÙ†Ø§Ø¯ÙŠÙ‡Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
    async function reloadDepartments() {
      const hid = getActiveHospitalId();
      if (!hid) {
        console.log('â¸ï¸ No hospital selected, skipping reload');
        // Ù„Ù„Ù…Ø¯ÙŠØ±: Ù„Ø§ ØªØ­Ù…Ù‘Ù„ Ø´ÙŠØ¡ Ù‚Ø¨Ù„ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªØ´ÙÙ‰
        const { user } = getAuth();
        const role = Number(user?.RoleID);
        const isCluster = role === 1 || role === 4;
        if (isCluster) {
          document.getElementById('departmentsTbody').innerHTML =
            `<tr><td colspan="6" class="p-6 text-center text-gray-500">Ø§Ø®ØªØ± Ù…Ø³ØªØ´ÙÙ‰ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</td></tr>`;
        }
        return;
      }
      
      try {
        const base = `${API_BASE}/api/departments`;
        const url = `${base}?hospitalId=${encodeURIComponent(hid)}`;
        console.log('ğŸ”„ Reloading departments from:', url);
        
        const payload = await fetchJSON(url);
        const { user } = getAuth();
        const userMode = getUserMode(user);
        const clusterMode = userMode === 'cluster' || userMode === 'central';
        
        renderDepartments(payload.items || [], clusterMode);
        console.log('âœ… Departments reloaded successfully');
      } catch (err) {
        console.error('âŒ Error reloading departments:', err);
        document.getElementById('departmentsTbody').innerHTML =
          `<tr><td colspan="6" class="p-6 text-center text-red-600">ØªØ¹Ø°Ù‘Ø± Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: ${err.message}</td></tr>`;
      }
    }

    // Event delegation Ø¹Ù„Ù‰ Ø¬Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
    function setupTableEventListeners() {
      const tbody = document.getElementById('departmentsTbody');
      if (!tbody) {
        console.error('âŒ departmentsTbody not found');
        return;
      }

      tbody.addEventListener('click', async (e) => {
        const btn = e.target.closest('[data-action]');
        if (!btn) return;

        const id = Number(btn.dataset.id);
        const action = btn.dataset.action;

        console.log(`ğŸ”˜ Button clicked: ${action} for department ${id}`);

        if (action === 'edit') {
          // Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØ­Ù…Ù‘Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø³Ù…
          await openModal('edit', id);
        }

        if (action === 'child') {
          // Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø­Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ø¨ Ù…Ù†ØªØ®Ø¨ Ù…Ø³Ø¨Ù‚Ù‹Ø§
          await openModal('add', null);
          const parentSelect = document.getElementById('parentSelect');
          if (parentSelect) parentSelect.value = String(id);
        }

        if (action === 'del') {
          if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…ØŸ (Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø·ÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø±ØªØ¨Ø·Ù‹Ø§)')) return;
          try {
            const hid = getActiveHospitalId();
            if (!hid) return alert('Ø§Ø®ØªÙØ± Ù…Ø³ØªØ´ÙÙ‰ Ø£ÙˆÙ„Ø§Ù‹.');
            const url = `${API_BASE}/api/admin/departments/${id}?hospitalId=${hid}`;
            await fetchJSON(url, { method: 'DELETE' });
            alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­');
            await reloadDepartments();
          } catch (err) {
            alert('ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…: ' + err.message);
            console.error(err);
          }
        }
      });

      console.log('âœ… Table event listeners setup complete');
    }

    // Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    function setupModalHandlers() {
      const modal = document.getElementById('deptModal');
      const btnOpenAddRoot = document.getElementById('btnOpenAddRoot');
      const btnCloseModal = document.getElementById('btnCloseModal');
      const btnModalCancel = document.getElementById('btnModalCancel');
      const btnModalSave = document.getElementById('btnModalSave');
      const deptForm = document.getElementById('deptForm');

      // ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù„Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠ
      if (btnOpenAddRoot) {
        btnOpenAddRoot.addEventListener('click', () => {
          openModal('add', null);
        });
      }

      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      if (btnCloseModal) {
        btnCloseModal.addEventListener('click', closeModal);
      }
      if (btnModalCancel) {
        btnModalCancel.addEventListener('click', closeModal);
      }
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal || e.target.id === 'deptModalBackdrop') {
            closeModal();
          }
        });
      }

      // Ø­ÙØ¸ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
      if (deptForm) {
        deptForm.addEventListener('submit', handleFormSubmit);
      }
    }

    async function openModal(mode, departmentId) {
      const hid = getActiveHospitalId();
      if (!hid) return alert('Ø§Ø®ØªÙØ± Ù…Ø³ØªØ´ÙÙ‰ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰.');

      const modal = document.getElementById('deptModal');
      const modalTitle = document.getElementById('deptModalTitle');
      const deptId = document.getElementById('deptId');
      const deptName = document.getElementById('deptName');
      const deptDesc = document.getElementById('deptDesc');
      const parentSelect = document.getElementById('parentSelect');

      // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
      if (modalTitle) {
        modalTitle.textContent = mode === 'add' ? 'Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯' : 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…';
      }

      // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
      if (deptId) deptId.value = '';
      if (deptName) deptName.value = '';
      if (deptDesc) deptDesc.value = '';

      // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù„Ù„Ù‚Ø³Ù… Ø§Ù„Ø£Ø¨
      await loadParentDepartments();

      // Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ¹Ø¯ÙŠÙ„ØŒ Ø­Ù…Ù‘Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø³Ù…
      if (mode === 'edit' && departmentId) {
        await loadDepartmentForEdit(departmentId);
      }

      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      if (modal) {
        modal.classList.remove('hidden');
      }
    }

    function closeModal() {
      const modal = document.getElementById('deptModal');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    // Ø§Ø³Ù… Ø¨Ø¯ÙŠÙ„ Ù„Ù„ØªÙˆØ§ÙÙ‚
    function closeDeptModal() {
      closeModal();
    }

    async function loadParentDepartments() {
      const parentSelect = document.getElementById('parentSelect');
      if (!parentSelect) return;

      try {
        const hospitalId = getActiveHospitalId();

        if (!hospitalId) {
          parentSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø£ÙˆÙ„Ø§Ù‹</option>';
          return;
        }

        const url = `${API_BASE}/api/departments?hospitalId=${hospitalId}`;
        const data = await fetchJSON(url);
        
        parentSelect.innerHTML = '<option value="">Ø¨Ø¯ÙˆÙ† Ø£Ø¨ (Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠ)</option>' +
          (data.items || []).map(d => 
            `<option value="${d.DepartmentID}">${d.NameAr || d.NameEn}</option>`
          ).join('');
      } catch (err) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:', err);
        parentSelect.innerHTML = '<option value="">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</option>';
      }
    }

    async function loadDepartmentForEdit(departmentId) {
      try {
        const hid = getActiveHospitalId();
        if (!hid) return alert('Ø§Ø®ØªÙØ± Ù…Ø³ØªØ´ÙÙ‰ Ø£ÙˆÙ„Ø§Ù‹.');
        const url = `${API_BASE}/api/admin/departments/${departmentId}?hospitalId=${hid}`;
        const data = await fetchJSON(url);
        
        if (data.success && data.data) {
          const dept = data.data;
          const deptId = document.getElementById('deptId');
          const deptName = document.getElementById('deptName');
          const deptDesc = document.getElementById('deptDesc');
          const parentSelect = document.getElementById('parentSelect');

          if (deptId) deptId.value = dept.DepartmentID;
          if (deptName) deptName.value = dept.NameAr || '';
          if (deptDesc) deptDesc.value = dept.Description || '';
          if (parentSelect) parentSelect.value = dept.ParentDepartmentID || '';
        }
      } catch (err) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø³Ù…:', err);
        alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø³Ù…');
      }
    }

    async function handleFormSubmit(e) {
      e.preventDefault();
      
      const { user } = getAuth();
      const isCluster = isClusterManager(user);
      
      // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰
      const hospitalId = isCluster 
        ? Number(document.getElementById('hospitalSelect')?.value)
        : Number(user?.HospitalID);

      if (!hospitalId) {
        alert('Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }

      // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const deptId = document.getElementById('deptId')?.value;
      const payload = {
        HospitalID: hospitalId,
        NameAr: document.getElementById('deptName')?.value?.trim(),
        NameEn: '', // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ø§Ø­Ù‚Ø§Ù‹
        ParentDepartmentID: Number(document.getElementById('parentSelect')?.value || 0) || null,
        SortOrder: 100
      };

      if (!payload.NameAr) {
        alert('Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ù…Ø·Ù„ÙˆØ¨');
        return;
      }

      try {
        const hid = getActiveHospitalId();
        if (!hid) return alert('Ø§Ø®ØªÙØ± Ù…Ø³ØªØ´ÙÙ‰ Ø£ÙˆÙ„Ø§Ù‹.');
        
        const url = `${API_BASE}/api/admin/departments`;
        const method = deptId ? 'PUT' : 'POST';
        const finalUrl = deptId ? `${url}/${deptId}?hospitalId=${hid}` : `${url}?hospitalId=${hid}`;

        const res = await fetchJSON(finalUrl, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...payload, HospitalID: hid })
        });

        if (res.success) {
          // Ù†Ø¬Ø§Ø­:
          alert(res.message || 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­ âœ…');
          closeModal();
          await reloadDepartments();
        } else {
          throw new Error(res.message || 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù…');
        }
      } catch (err) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù…:', err);
        alert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù…: ' + err.message);
      }
    }

    // ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© init Ù„ØªØ´Ù…Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    async function init() {
      // 1) Ø§Ù‚Ø±Ø£ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†
      const { user, token } = getAuth();
      
      console.log('ğŸ” Auth Debug:', { user, token: token ? 'exists' : 'missing' });
      
      if (!token) {
        console.log('âŒ No token found, redirecting to login');
        showSessionEnded();
        return;
      }
      
      if (!user) {
        console.log('âŒ No user found, redirecting to login');
        showSessionEnded();
        return;
      }

      const userMode = getUserMode(user);
      const clusterMode = userMode === 'cluster' || userMode === 'central';
      const bar = document.getElementById('clusterBar');
      const hospitalHeader = document.getElementById('hospitalHeader');
      
      if (clusterMode) {
        if (bar) bar.classList.remove('hidden');
        if (hospitalHeader) hospitalHeader.classList.remove('hidden');
        await loadHospitalsForCluster();
      }

      // 2) Ø­Ù…Ù‘Ù„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
      await reloadDepartments();

      // 3) ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ù…Ø¹
      const sel = document.getElementById('hospitalSelect');
      if (sel) sel.addEventListener('change', reloadDepartments);

      // 4) Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      setupModalHandlers();

      // 5) Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„
      setupTableEventListeners();

      // 6) ØªÙ‡ÙŠØ¦Ø© Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Lucide
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }

      async function reloadDepartments() {
        try {
          const hid = getActiveHospitalId();
          if (!hid) {
            console.log('â¸ï¸ No hospital selected, skipping reload');
            document.getElementById('departmentsTbody').innerHTML =
              `<tr><td colspan="6" class="p-6 text-center text-gray-500">Ø§Ø®ØªØ± Ù…Ø³ØªØ´ÙÙ‰ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</td></tr>`;
            return;
          }

          const base = `${API_BASE}/api/departments`;
          const url = `${base}?hospitalId=${encodeURIComponent(hid)}`;
          console.log('ğŸ”„ Reloading departments from:', url);
          
          const payload = await fetchJSON(url);
          await renderDepartments(payload.items || [], clusterMode);
        } catch (err) {
          console.error('load departments error:', err);
          document.getElementById('departmentsTbody').innerHTML =
            `<tr><td colspan="6" class="p-6 text-center text-red-600">ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: ${err.message}</td></tr>`;
        }
      }
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>