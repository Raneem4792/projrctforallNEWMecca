<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§Ø®ØªØ¨Ø§Ø± Ø¥ØµÙ„Ø§Ø­Ø§Øª ØµÙØ­Ø© Ø§Ù„ØªØªØ¨Ø¹</title>
  <!-- Theme controller -->
  <script src="../../assets/js/theme.js"></script>

<script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Tajawal', sans-serif; }
    .test-section { @apply bg-white p-6 rounded-lg shadow-md mb-4; }
    .pass { @apply text-green-600 font-bold; }
    .fail { @apply text-red-600 font-bold; }
    .badge { @apply inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold; }
  </style>

  <link rel="stylesheet" href="../../assets/css/styles.css" />
</head>
<body class="bg-gray-50 p-8">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-[#002B5B] mb-6">ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø¥ØµÙ„Ø§Ø­Ø§Øª ØµÙØ­Ø© Ø§Ù„ØªØªØ¨Ø¹</h1>

    <!-- Ø§Ø®ØªØ¨Ø§Ø± 1: Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµÙÙŠØ© -->
    <div class="test-section">
      <h2 class="text-xl font-bold mb-4">1ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ù‚ÙŠÙ… Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµÙÙŠØ©</h2>
      <div id="test1-result" class="mb-3"></div>
      <div class="flex flex-wrap gap-2">
        <button class="badge bg-blue-100 text-blue-800" data-status="all">Ø§Ù„ÙƒÙ„ (all)</button>
        <button class="badge bg-blue-100 text-blue-800" data-status="open">Ù…ÙØªÙˆØ­Ø© (open)</button>
        <button class="badge bg-blue-100 text-blue-800" data-status="in_progress">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© (in_progress)</button>
        <button class="badge bg-blue-100 text-blue-800" data-status="on_hold">Ù…Ø¹Ù„Ù‚Ø© (on_hold) - Ø¬Ø¯ÙŠØ¯!</button>
        <button class="badge bg-blue-100 text-blue-800" data-status="closed">Ù…ØºÙ„Ù‚Ø© (closed)</button>
      </div>
    </div>

    <!-- Ø§Ø®ØªØ¨Ø§Ø± 2: Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© -->
    <div class="test-section">
      <h2 class="text-xl font-bold mb-4">2ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© (Ø¹Ø±Ø¨ÙŠ)</h2>
      <div id="test2-result" class="mb-3"></div>
      <div class="flex flex-wrap gap-2" id="status-badges"></div>
    </div>

    <!-- Ø§Ø®ØªØ¨Ø§Ø± 3: Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© -->
    <div class="test-section">
      <h2 class="text-xl font-bold mb-4">3ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© (Ø¹Ø±Ø¨ÙŠ)</h2>
      <div id="test3-result" class="mb-3"></div>
      <div class="flex flex-wrap gap-2" id="priority-badges"></div>
    </div>

    <!-- Ø§Ø®ØªØ¨Ø§Ø± 4: API Connection -->
    <div class="test-section">
      <h2 class="text-xl font-bold mb-4">4ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ API</h2>
      <div id="test4-result" class="mb-3"></div>
      <button onclick="testAPI()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¢Ù†
      </button>
      <div id="api-response" class="mt-4"></div>
    </div>

    <!-- Ø§Ø®ØªØ¨Ø§Ø± 5: Timeline API -->
    <div class="test-section">
      <h2 class="text-xl font-bold mb-4">5ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Timeline API</h2>
      <div id="test5-result" class="mb-3"></div>
      <input type="text" id="ticket-input" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨Ù„Ø§Øº" 
             class="border border-gray-300 rounded px-3 py-2 w-64 ml-2">
      <button onclick="testTimeline()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
        Ø§Ø®ØªØ¨Ø§Ø± Timeline
      </button>
      <div id="timeline-response" class="mt-4"></div>
    </div>

    <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª -->
    <div class="test-section bg-blue-50">
      <h2 class="text-xl font-bold mb-4">ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h2>
      <div id="summary"></div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3001/api';
    let testResults = { passed: 0, failed: 0 };

    // Ø§Ø®ØªØ¨Ø§Ø± 1: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙŠÙ… Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµÙÙŠØ©
    function test1() {
      const buttons = document.querySelectorAll('[data-status]');
      const expectedValues = ['all', 'open', 'in_progress', 'on_hold', 'closed'];
      const actualValues = Array.from(buttons).map(btn => btn.dataset.status);
      
      const allMatch = expectedValues.every(val => actualValues.includes(val));
      const result = document.getElementById('test1-result');
      
      if (allMatch && actualValues.length === expectedValues.length) {
        result.innerHTML = '<span class="pass">âœ… Ø¬Ù…ÙŠØ¹ Ù‚ÙŠÙ… Ø§Ù„Ø£Ø²Ø±Ø§Ø± ØµØ­ÙŠØ­Ø© (lowercase)</span>';
        testResults.passed++;
      } else {
        result.innerHTML = '<span class="fail">âŒ Ø¨Ø¹Ø¶ Ù‚ÙŠÙ… Ø§Ù„Ø£Ø²Ø±Ø§Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©</span>';
        testResults.failed++;
      }
    }

    // Ø§Ø®ØªØ¨Ø§Ø± 2: Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©
    function test2() {
      const statuses = [
        { code: 'open', label: 'Ù…ÙØªÙˆØ­Ø©' },
        { code: 'in_progress', label: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©' },
        { code: 'on_hold', label: 'Ù…Ø¹Ù„Ù‚Ø©' },
        { code: 'closed', label: 'Ù…ØºÙ„Ù‚Ø©' },
        { code: 'critical', label: 'Ø­Ø±Ø¬Ø©' }
      ];
      
      const container = document.getElementById('status-badges');
      const result = document.getElementById('test2-result');
      let allArabic = true;
      
      statuses.forEach(status => {
        const badge = badgeForStatus(status.code, '');
        container.innerHTML += badge;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù†Øµ Ø¹Ø±Ø¨ÙŠ
        if (!badge.includes(status.label)) {
          allArabic = false;
        }
      });
      
      if (allArabic) {
        result.innerHTML = '<span class="pass">âœ… Ø¬Ù…ÙŠØ¹ Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© ØªØ¸Ù‡Ø± Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</span>';
        testResults.passed++;
      } else {
        result.innerHTML = '<span class="fail">âŒ Ø¨Ø¹Ø¶ Ø§Ù„Ø´Ø§Ø±Ø§Øª Ù„Ø§ ØªØ¸Ù‡Ø± Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</span>';
        testResults.failed++;
      }
    }

    // Ø§Ø®ØªØ¨Ø§Ø± 3: Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
    function test3() {
      const priorities = [
        { code: 'URGENT', label: 'Ø¹Ø§Ø¬Ù„Ø©' },
        { code: 'HIGH', label: 'Ø¹Ø§Ù„ÙŠØ©' },
        { code: 'MEDIUM', label: 'Ù…ØªÙˆØ³Ø·Ø©' },
        { code: 'LOW', label: 'Ù…Ù†Ø®ÙØ¶Ø©' }
      ];
      
      const container = document.getElementById('priority-badges');
      const result = document.getElementById('test3-result');
      let allArabic = true;
      
      priorities.forEach(priority => {
        const badge = badgeForPriority(priority.code, '');
        container.innerHTML += badge;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù†Øµ Ø¹Ø±Ø¨ÙŠ
        if (!badge.includes(priority.label)) {
          allArabic = false;
        }
      });
      
      if (allArabic) {
        result.innerHTML = '<span class="pass">âœ… Ø¬Ù…ÙŠØ¹ Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© ØªØ¸Ù‡Ø± Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (MEDIUM Ø£Ø¶ÙŠÙ!)</span>';
        testResults.passed++;
      } else {
        result.innerHTML = '<span class="fail">âŒ Ø¨Ø¹Ø¶ Ø§Ù„Ø´Ø§Ø±Ø§Øª Ù„Ø§ ØªØ¸Ù‡Ø± Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</span>';
        testResults.failed++;
      }
    }

    // Ø§Ø®ØªØ¨Ø§Ø± 4: API Connection
    async function testAPI() {
      const result = document.getElementById('test4-result');
      const response = document.getElementById('api-response');
      
      result.innerHTML = '<span class="text-gray-600">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...</span>';
      
      try {
        const res = await fetch(`${API_BASE}/complaints/track`);
        const data = await res.json();
        
        if (data.ok && data.items) {
          result.innerHTML = '<span class="pass">âœ… API ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­</span>';
          
          let html = `<div class="bg-green-50 border border-green-200 rounded p-4">`;
          html += `<p class="font-bold mb-2">Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª: ${data.count}</p>`;
          
          if (data.items.length > 0) {
            const first = data.items[0];
            html += `<p class="text-sm mb-1">Ù…Ø«Ø§Ù„ - Ø£ÙˆÙ„ Ø¨Ù„Ø§Øº:</p>`;
            html += `<ul class="text-sm list-disc pr-5">`;
            html += `<li>Ø±Ù‚Ù… Ø§Ù„Ø¨Ù„Ø§Øº: ${first.ticket}</li>`;
            html += `<li>Ø§Ù„Ø­Ø§Ù„Ø©: ${first.status} ${first.statusLabelAr ? 'â†’ ' + first.statusLabelAr : ''}</li>`;
            html += `<li>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: ${first.priority} ${first.priorityLabelAr ? 'â†’ ' + first.priorityLabelAr : ''}</li>`;
            html += `</ul>`;
            
            if (first.statusLabelAr && first.priorityLabelAr) {
              html += `<p class="text-green-600 font-bold mt-2">âœ… Ø§Ù„ØªØ³Ù…ÙŠØ§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ØªØ¹Ù…Ù„!</p>`;
            } else {
              html += `<p class="text-orange-600 font-bold mt-2">âš ï¸ Ø§Ù„ØªØ³Ù…ÙŠØ§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</p>`;
            }
          }
          
          html += `</div>`;
          response.innerHTML = html;
          testResults.passed++;
        } else {
          throw new Error('Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ù…Ù† API');
        }
      } catch (error) {
        result.innerHTML = '<span class="fail">âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ API</span>';
        response.innerHTML = `<div class="bg-red-50 border border-red-200 rounded p-4 text-red-700">
          <p class="font-bold">Ø®Ø·Ø£: ${error.message}</p>
          <p class="text-sm mt-2">ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù… Ø¹Ù„Ù‰ http://localhost:3001</p>
        </div>`;
        testResults.failed++;
      }
      
      updateSummary();
    }

    // Ø§Ø®ØªØ¨Ø§Ø± 5: Timeline API
    async function testTimeline() {
      const ticketInput = document.getElementById('ticket-input');
      const ticket = ticketInput.value.trim();
      const result = document.getElementById('test5-result');
      const response = document.getElementById('timeline-response');
      
      if (!ticket) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨Ù„Ø§Øº');
        return;
      }
      
      result.innerHTML = '<span class="text-gray-600">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...</span>';
      
      try {
        const res = await fetch(`${API_BASE}/complaints/${encodeURIComponent(ticket)}/timeline`);
        const data = await res.json();
        
        if (data.ok && data.items) {
          result.innerHTML = '<span class="pass">âœ… Timeline API ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­</span>';
          
          let html = `<div class="bg-green-50 border border-green-200 rounded p-4">`;
          html += `<p class="font-bold mb-2">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«: ${data.items.length}</p>`;
          
          if (data.items.length > 0) {
            html += `<div class="space-y-2 mt-3">`;
            data.items.forEach((item, i) => {
              const icon = getTimelineIcon(item.kind);
              html += `<div class="border-r-2 border-blue-300 pr-3">`;
              html += `<p class="font-bold">${icon} ${item.title || 'Ø­Ø¯Ø«'}</p>`;
              html += `<p class="text-sm text-gray-600">${item.detail || ''}</p>`;
              html += `<p class="text-xs text-gray-500">${formatDate(item.at)}</p>`;
              html += `</div>`;
            });
            html += `</div>`;
            
            html += `<a href="../history/complaint-timeline.html?ticket=${encodeURIComponent(ticket)}" 
                       target="_blank" 
                       class="inline-block mt-3 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                       Ø¹Ø±Ø¶ Timeline ÙƒØ§Ù…Ù„
                    </a>`;
          } else {
            html += `<p class="text-gray-600 mt-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø« Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù„Ø§Øº</p>`;
          }
          
          html += `</div>`;
          response.innerHTML = html;
          testResults.passed++;
        } else {
          throw new Error(data.message || 'Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
        }
      } catch (error) {
        result.innerHTML = '<span class="fail">âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Timeline API</span>';
        response.innerHTML = `<div class="bg-red-50 border border-red-200 rounded p-4 text-red-700">
          <p class="font-bold">Ø®Ø·Ø£: ${error.message}</p>
          <p class="text-sm mt-2">ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø±Ù‚Ù… Ø§Ù„Ø¨Ù„Ø§Øº</p>
        </div>`;
        testResults.failed++;
      }
      
      updateSummary();
    }

    // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù…Ù† track-complaint.js
    function badgeForStatus(code, labelAr='') {
      const c = (code || '').toLowerCase();
      const map = {
        'open':        { text:'Ù…ÙØªÙˆØ­Ø©',      bg:'#F3F4F6', ring:'#e5e7eb', dot:'#2563EB' },
        'in_progress': { text:'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©', bg:'#F3F4F6', ring:'#e5e7eb', dot:'#F59E0B' },
        'on_hold':     { text:'Ù…Ø¹Ù„Ù‚Ø©',       bg:'#F3F4F6', ring:'#e5e7eb', dot:'#6B7280' },
        'closed':      { text:'Ù…ØºÙ„Ù‚Ø©',       bg:'#ECFDF5', ring:'#D1FAE5', dot:'#10B981' },
        'critical':    { text:'Ø­Ø±Ø¬Ø©',        bg:'#FEF2F2', ring:'#FECACA', dot:'#EF4444' }
      }[c] || { text: labelAr || code, bg:'#F3F4F6', ring:'#e5e7eb', dot:'#6B7280' };

      return `
        <span style="background:${map.bg};border:1px solid ${map.ring};" class="badge">
          <span style="display:inline-block;width:8px;height:8px;border-radius:9999px;background:${map.dot}"></span>
          ${labelAr || map.text}
        </span>
      `;
    }

    function badgeForPriority(code, labelAr='') {
      const p = (code || '').toUpperCase();
      const map = {
        'URGENT': { text:'Ø¹Ø§Ø¬Ù„Ø©',   bg:'#FEF2F2', ring:'#FECACA', dot:'#EF4444' },
        'HIGH':   { text:'Ø¹Ø§Ù„ÙŠØ©',   bg:'#FFF7ED', ring:'#FFEDD5', dot:'#F97316' },
        'MEDIUM': { text:'Ù…ØªÙˆØ³Ø·Ø©',  bg:'#EFF6FF', ring:'#DBEAFE', dot:'#3B82F6' },
        'LOW':    { text:'Ù…Ù†Ø®ÙØ¶Ø©',  bg:'#F3F4F6', ring:'#E5E7EB', dot:'#6B7280' }
      }[p] || { text: labelAr || code, bg:'#F3F4F6', ring:'#E5E7EB', dot:'#6B7280' };

      return `
        <span style="background:${map.bg};border:1px solid ${map.ring};" class="badge">
          <span style="display:inline-block;width:8px;height:8px;border-radius:9999px;background:${map.dot}"></span>
          ${labelAr || map.text}
        </span>
      `;
    }

    function getTimelineIcon(kind) {
      const icons = {
        'created': 'ğŸŸ¢',
        'status_change': 'ğŸŸ ',
        'reply': 'ğŸ”µ',
        'transfer': 'ğŸŸ£'
      };
      return icons[kind] || 'âšª';
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleString('ar-SA', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function updateSummary() {
      const summary = document.getElementById('summary');
      const total = testResults.passed + testResults.failed;
      const percentage = total > 0 ? Math.round((testResults.passed / total) * 100) : 0;
      
      summary.innerHTML = `
        <div class="flex items-center gap-4">
          <div class="text-3xl font-bold ${percentage === 100 ? 'text-green-600' : 'text-orange-600'}">
            ${percentage}%
          </div>
          <div>
            <p class="pass">âœ… Ù†Ø¬Ø­: ${testResults.passed}</p>
            <p class="fail">âŒ ÙØ´Ù„: ${testResults.failed}</p>
          </div>
        </div>
        ${percentage === 100 ? '<p class="text-green-600 font-bold mt-2">ğŸ‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø¬Ø­Øª!</p>' : ''}
      `;
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    window.addEventListener('DOMContentLoaded', () => {
      test1();
      test2();
      test3();
      updateSummary();
    });
  </script>
</body>
</html>

