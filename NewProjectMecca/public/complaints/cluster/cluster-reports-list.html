<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Ø¨Ù„Ø§ØºØ§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¬Ù…Ø¹</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
  <!-- Theme controller -->
  <script src="../../assets/js/theme.js"></script>

<script src="https://cdn.tailwindcss.com"></script>

  <!-- Ù†Ø¹ÙŠØ¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ -->
    <link rel="stylesheet" href="../../assets/css/styles.css" />
<link rel="stylesheet" href="../submit/submit-complaint.css">

  <style>
    /* Ù†Ø¨Ø¶ Ø®ÙÙŠÙ Ù„Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© (Ø£ØµÙØ±) */
    @keyframes pulse-yellow {
      0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.45); }
      70% { box-shadow: 0 0 0 8px rgba(245, 158, 11, 0); }
      100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
    }
    .prio-pulse { position: relative; }
    .prio-pulse .dot {
      display:inline-block;width:8px;height:8px;border-radius:9999px;
    }
    .prio-pulse--med .dot { background:#F59E0B; animation: pulse-yellow 1.6s infinite; }
  </style>
</head>
<body class="bg-gray-50" style="font-family:'Tajawal',sans-serif">
  <!-- Header - Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
  <header id="navbar" class="fixed w-full top-0 z-50 navbar-scroll" style="background-color: #002B5B;">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <!-- Logo - Ø§Ù„Ø´Ø¹Ø§Ø± -->
        <div class="flex items-center">
          <img src="../../assets/img/logo3.png" alt="Ø´Ø¹Ø§Ø± ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„ØµØ­ÙŠ" class="h-16 w-auto">
        </div>
        
        <!-- Navigation - Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ†Ù‚Ù„ -->
        <nav class="hidden md:flex items-center space-x-reverse space-x-8">
          <a href="../../../index/index.html" id="nav-home" class="text-white hover:text-blue-200 transition-colors">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
          <a href="../../../dashboard/dashboard.html" id="nav-dashboard" class="text-white hover:text-blue-200 transition-colors">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
          <a href="../../../index/about-system.html" id="nav-about" class="text-white hover:text-blue-200 transition-colors">Ø­ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</a>
          <a href="../../../index/help.html" id="nav-help" class="text-white hover:text-blue-200 transition-colors">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</a>
          <a href="../../../index/contact.html" id="nav-contact" class="text-white hover:text-blue-200 transition-colors">Ø§ØªØµÙ„ Ø¨Ù†Ø§</a>
          <button id="languageToggle" class="text-white hover:text-blue-200 transition-colors flex items-center">
            ğŸŒ English
          </button>
        </nav>
        
        <!-- Mobile menu button - Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
        <button class="md:hidden text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 pt-16 pb-10">
    <section class="text-center mb-4">
      <div class="mx-auto w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center mb-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 3v18h18"/><rect x="6" y="13" width="3" height="5" rx="1" fill="currentColor"/><rect x="11" y="9" width="3" height="9" rx="1" fill="currentColor"/><rect x="16" y="5" width="3" height="13" rx="1" fill="currentColor"/>
        </svg>
      </div>
      <h1 id="page-title" class="text-2xl md:text-3xl font-extrabold text-[#002B5B] text-center">ğŸ“‹ Ø¨Ù„Ø§ØºØ§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¬Ù…Ø¹</h1>
      <p id="page-subtitle" class="text-gray-600 mt-1 text-sm md:text-base text-center">Ø¹Ø±Ø¶ ÙˆÙÙ„ØªØ±Ø© Ø¨Ù„Ø§ØºØ§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¬Ù…Ø¹</p>
    </section>

    <!-- Ø²Ø± Ø§Ù„Ø·ÙŠ (Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„) -->
    <button id="toggleFilters" class="md:hidden text-xs text-gray-600 mb-2 underline"><span id="toggle-filters-text">Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØµÙÙŠØ©</span></button>

    <!-- Ø´Ø±ÙŠØ· Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ø¹ (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ø¹) -->
    <div id="clusterBar" class="hidden mb-4 flex gap-2 items-center bg-blue-50 rounded-xl p-3 border border-blue-200">
      <label class="text-sm font-semibold text-blue-800">Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰:</label>
      <select id="hospitalSelect" class="border rounded px-3 py-2 bg-white">
        <option value="">Ø§Ù„ÙƒÙ„</option>
      </select>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„Ø§ØªØ± -->
    <section id="filtersCard" class="bg-white rounded-2xl p-3 md:p-4 shadow-xl border border-gray-100 mb-3 hidden md:block">
      <!-- ØµÙ Ø¹Ù„ÙˆÙŠ ÙÙŠÙ‡ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† + Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-base md:text-lg font-bold text-[#002B5B] flex items-center gap-2">
          <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-blue-50 text-blue-600">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="11" cy="11" r="7" stroke-width="2"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65" stroke-width="2" stroke-linecap="round"></line>
            </svg>
          </span>
          <span id="filter-title">Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©</span>
        </h3>

        <div class="flex gap-2">
          <button id="btnSearch" class="h-9 px-4 rounded-xl bg-[#0FA47A] text-white text-sm hover:bg-[#0c8f68] transition" type="button">Ø¨Ø­Ø«</button>
          <button id="btnReset" class="h-9 px-4 rounded-xl bg-gray-100 text-gray-700 text-sm hover:bg-gray-200 transition" type="button">ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
        </div>
      </div>

      <!-- Ø§Ù„Ø­Ù‚ÙˆÙ„ -->
      <div class="grid xl:grid-cols-6 lg:grid-cols-4 md:grid-cols-3 sm:grid-cols-2 gap-2">
        <div>
          <label id="search-title-label" class="block text-[11px] text-gray-500 mb-1">Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
          <input id="qTitle" type="text" placeholder="Ù…Ø«Ø§Ù„: Ù…Ù„Ø§Ø­Ø¸Ø© Ø¹Ù„Ù‰..." 
                 data-placeholder-ar="Ù…Ø«Ø§Ù„: Ù…Ù„Ø§Ø­Ø¸Ø© Ø¹Ù„Ù‰..." data-placeholder-en="Example: Note about..."
                 class="w-full h-10 rounded-xl border border-gray-200 px-3 text-sm focus:ring-2 focus:ring-blue-200">
        </div>
        <div class="flex gap-3 items-end">
          <div class="flex-1">
            <label id="status-label" class="block text-[11px] text-gray-500 mb-1">Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select id="filterStatus" class="w-full h-10 rounded-xl border border-gray-200 px-3 text-sm focus:ring-2 focus:ring-blue-200">
              <option value="" id="status-all">Ø§Ù„ÙƒÙ„</option>
              <option value="OPEN" id="status-open">Ù…ÙØªÙˆØ­</option>
              <option value="IN_PROGRESS" id="status-in-progress">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
              <option value="RESOLVED" id="status-resolved">ØªÙ… Ø§Ù„Ø­Ù„</option>
              <option value="CLOSED" id="status-closed">Ù…ØºÙ„Ù‚</option>
              <option value="CANCELLED" id="status-cancelled">Ù…Ù„ØºÙŠ</option>
            </select>
          </div>
        </div>
        <div>
          <label id="priority-label" class="block text-[11px] text-gray-500 mb-1">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</label>
          <select id="filterPriority" class="w-full h-10 rounded-xl border border-gray-200 px-3 text-sm focus:ring-2 focus:ring-blue-200">
            <option value="" id="priority-all">ÙƒÙ„ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª</option>
            <option value="LOW" id="priority-low">Ù…Ù†Ø®ÙØ¶Ø©</option>
            <option value="MEDIUM" id="priority-medium">Ù…ØªÙˆØ³Ø·Ø©</option>
            <option value="HIGH" id="priority-high">Ù…Ø±ØªÙØ¹Ø©</option>
            <option value="CRITICAL" id="priority-critical">Ø­Ø±Ø¬Ø©</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Ø¹Ø¯Ù‘Ø§Ø¯ Ù…Ø®ØªØµØ± -->
    <section class="grid sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-3">
      <div class="card !py-4 text-center"><div id="total-results-label" class="text-sm text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</div><div id="kpiTotal" class="text-2xl font-extrabold text-[#002B5B]">0</div></div>
      <div class="card !py-4 text-center"><div id="open-label" class="text-sm text-gray-500">Ù…ÙØªÙˆØ­Ø©</div><div id="kpiOpen" class="text-2xl font-extrabold text-blue-600">0</div></div>
      <div class="card !py-4 text-center"><div id="closed-label" class="text-sm text-gray-500">Ù…ØºÙ„Ù‚Ø©</div><div id="kpiClosed" class="text-2xl font-extrabold text-emerald-600">0</div></div>
      <div class="card !py-4 text-center"><div id="critical-label" class="text-sm text-gray-500">Ø­Ø±Ø¬Ø©</div><div id="kpiCritical" class="text-2xl font-extrabold text-red-600">0</div></div>
    </section>

    <!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (ÙƒØ±ÙˆØª) -->
    <section class="card">
      <div class="section-title">
        <span class="icon">ğŸ“‹</span><h2 id="results-title">Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h2>
      </div>
      <div id="results" class="grid md:grid-cols-2 xl:grid-cols-3 gap-4"></div>

      <div id="noResults" class="hidden text-center py-10 text-gray-600">
        <span id="no-results-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ø¨Ø­Ø«.</span>
      </div>

      <!-- ØªØ±Ù‚ÙŠÙ… ØµÙØ­Ø§Øª Ø¨Ø³ÙŠØ· -->
      <div id="pager" class="mt-6 flex items-center justify-center gap-2">
        <button id="pPrev" class="btn-secondary" type="button">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
        <div id="pInfo" class="text-sm text-gray-600">ØµÙØ­Ø© 1/1</div>
        <button id="pNext" class="btn-secondary" type="button">Ø§Ù„ØªØ§Ù„ÙŠ</button>
      </div>
    </section>
  </main>

  <!-- Footer - Ø§Ù„ØªØ°ÙŠÙŠÙ„ -->
  <footer class="bg-gray-900 text-white py-14">
    <div class="container mx-auto px-4">
      <div class="grid md:grid-cols-3 gap-8">
        <!-- Column 1 - Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ -->
        <div>
          <div class="flex items-center space-x-reverse space-x-3 mb-4">
            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 2L2 7v10c0 5.55 3.84 9.74 9 11 5.16-1.26 9-5.45 9-11V7l-10-5z"/>
              </svg>
            </div>
            <div>
              <div id="footer-org-name" class="font-bold">ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„ØµØ­ÙŠ</div>
              <div id="footer-system-name" class="text-sm text-gray-300">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</div>
            </div>
          </div>
          <p id="footer-description" class="text-gray-300 text-sm">Ù…Ù†ØµØ© Ø±Ø³Ù…ÙŠØ© Ù„ØªÙ‚Ø¯ÙŠÙ… ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</p>
        </div>

        <!-- Column 2 - Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ -->
        <div>
          <h3 id="footer-links-title" class="font-bold mb-4">Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©</h3>
          <ul class="space-y-2 text-sm">
            <li><a href="../../../index/index.html" id="footer-link-home" class="text-gray-300 hover:text-white hover:underline transition-colors">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
            <li><a href="../cluster/cluster-report-create.html" id="footer-link-create" class="text-gray-300 hover:text-white hover:underline transition-colors">Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ù„Ø§Øº</a></li>
            <li><a href="cluster-reports-list.html" id="footer-link-list" class="text-gray-300 hover:text-white hover:underline transition-colors">Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a></li>
            <li><a href="../../../index/help.html" id="footer-link-faq" class="text-gray-300 hover:text-white hover:underline transition-colors">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©</a></li>
          </ul>
        </div>

        <!-- Column 3 - Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù„Ø« -->
        <div>
          <h3 id="footer-contact-title" class="font-bold mb-4">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</h3>
          <div class="space-y-2 text-sm text-gray-300">
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
              <span id="footer-support-number">Ø±Ù‚Ù… Ø§Ù„Ø¯Ø¹Ù…: 0559735137</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
              <span id="footer-support-email">support@makkahhealth.gov.sa</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span id="footer-working-hours">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„: 24/7</span>
            </div>
          </div>
        </div>
      </div>

      <div class="border-t border-gray-700 mt-8 pt-8 text-center text-sm text-gray-300">
        <span id="footer-copyright">Â© 2025 ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„ØµØ­ÙŠ â€“ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</span>
      </div>
    </div>
  </footer>

  <script>
    const API_BASE = window.API_BASE || 'http://localhost:3001';
    const token = localStorage.getItem('authToken') || localStorage.getItem('token') || '';
    window.__HID = null;
    let page = 1;
    const PAGE_SIZE = 9;

    function qs(k) {
      return new URLSearchParams(location.search).get(k);
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¯ÙŠØ± ØªØ¬Ù…Ø¹
    function isClusterManager(user) {
      if (!user) return false;
      return user.RoleID === 1 || 
             user.isClusterManager === true || 
             user.scope === 'central' || 
             (user.HospitalID == null && user.hospitalId == null);
    }

    async function resolveHID() {
      const u = JSON.parse(localStorage.getItem('userData') || '{}');
      const qsH = Number(qs('hospitalId') || 0);
      const hid = u?.HospitalID || u?.hospitalId || qsH;

      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¸Ù Ø¹Ø§Ø¯ÙŠ (Ù„ÙŠØ³ Ù…Ø¯ÙŠØ± ØªØ¬Ù…Ø¹)ØŒ ÙØ±Ø¶ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø³ØªØ´ÙØ§Ù‡ ÙÙ‚Ø·
      if (!isClusterManager(u)) {
        if (hid) {
          window.__HID = hid;
          // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª Ù„Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¹Ø§Ø¯ÙŠ
          const wrap = document.getElementById('clusterBar');
          if (wrap) wrap.classList.add('hidden');
          return hid;
        } else {
          // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ø¯ÙŠÙ‡ Ù…Ø³ØªØ´ÙÙ‰ØŒ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
          document.getElementById('results').innerHTML = '<div class="text-center text-red-500 py-10">Ø®Ø·Ø£: Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</div>';
          const wrap = document.getElementById('clusterBar');
          if (wrap) wrap.classList.add('hidden');
          return null;
        }
      }

      // Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ø¹: Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª
      if (hid) {
        window.__HID = hid;
        return hid;
      }

      // Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ø¹ Ø¨Ø¯ÙˆÙ† Ù…Ø³ØªØ´ÙÙ‰ Ù…Ø­Ø¯Ø¯: Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª
      const wrap = document.getElementById('clusterBar');
      const sel = document.getElementById('hospitalSelect');
      if (wrap && sel) {
        wrap.classList.remove('hidden');
        sel.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';

        try {
          const res = await fetch(`${API_BASE}/api/hospitals`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          const data = await res.json();
          const hospitals = data?.items || data?.data || data || [];

          hospitals.forEach(h => {
            const opt = document.createElement('option');
            opt.value = h.HospitalID || h.id;
            opt.textContent = h.NameAr || h.NameEn || ('Hospital ' + (h.HospitalID || h.id));
            sel.appendChild(opt);
          });

          // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "Ø§Ù„ÙƒÙ„" Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ØŒ ÙŠÙƒÙˆÙ† window.__HID = null
          window.__HID = null;

          sel.addEventListener('change', () => {
            // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "Ø§Ù„ÙƒÙ„" ÙŠÙƒÙˆÙ† value = "" ÙÙŠØµØ¨Ø­ null
            window.__HID = sel.value ? Number(sel.value) : null;
            page = 1;
            loadReports();
          });

          return null; // ÙŠØ¹ÙˆØ¯ null Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª
        } catch (e) {
          console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª:', e);
          alert('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª');
          return null;
        }
      }

      return null;
    }

    function updateKPIs(data) {
      const kpis = {
        total: data.total || 0,
        open: data.data?.filter(r => r.StatusCode === 'OPEN').length || 0,
        closed: data.data?.filter(r => r.StatusCode === 'CLOSED' || r.StatusCode === 'RESOLVED').length || 0,
        critical: data.data?.filter(r => r.PriorityCode === 'CRITICAL').length || 0
      };
      
      document.getElementById('kpiTotal').textContent = kpis.total;
      document.getElementById('kpiOpen').textContent = kpis.open;
      document.getElementById('kpiClosed').textContent = kpis.closed;
      document.getElementById('kpiCritical').textContent = kpis.critical;
    }

    function renderCards(reports) {
      const container = document.getElementById('results');
      if (!reports || reports.length === 0) {
        container.innerHTML = '';
        document.getElementById('noResults').classList.remove('hidden');
        return;
      }

      document.getElementById('noResults').classList.add('hidden');

      const statusLabels = {
        'OPEN': { text: 'Ù…ÙØªÙˆØ­', color: 'bg-blue-100 text-blue-700' },
        'IN_PROGRESS': { text: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©', color: 'bg-yellow-100 text-yellow-700' },
        'RESOLVED': { text: 'ØªÙ… Ø§Ù„Ø­Ù„', color: 'bg-green-100 text-green-700' },
        'CLOSED': { text: 'Ù…ØºÙ„Ù‚', color: 'bg-gray-100 text-gray-700' },
        'CANCELLED': { text: 'Ù…Ù„ØºÙŠ', color: 'bg-red-100 text-red-700' }
      };

      const priorityLabels = {
        'LOW': { text: 'Ù…Ù†Ø®ÙØ¶Ø©', color: 'bg-gray-100 text-gray-700' },
        'MEDIUM': { text: 'Ù…ØªÙˆØ³Ø·Ø©', color: 'bg-yellow-100 text-yellow-700' },
        'HIGH': { text: 'Ù…Ø±ØªÙØ¹Ø©', color: 'bg-orange-100 text-orange-700' },
        'CRITICAL': { text: 'Ø­Ø±Ø¬Ø©', color: 'bg-red-100 text-red-700' }
      };

      container.innerHTML = reports.map(r => {
        const status = statusLabels[r.StatusCode] || { text: r.StatusCode, color: 'bg-gray-100 text-gray-700' };
        const priority = priorityLabels[r.PriorityCode] || { text: r.PriorityCode, color: 'bg-gray-100 text-gray-700' };
        const date = new Date(r.CreatedAt).toLocaleDateString('ar-SA');
        const hospitalId = r.HospitalID || window.__HID || 0;
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª
        const hospitalInfo = r.HospitalID && !window.__HID ? `<div class="text-xs text-blue-600 mb-2">ğŸ¥ Ù…Ø³ØªØ´ÙÙ‰ #${r.HospitalID}</div>` : '';
        
        return `
          <div class="card hover:shadow-lg transition cursor-pointer" onclick="viewReport(${r.ReportID}, ${hospitalId})">
            ${hospitalInfo}
            <div class="flex items-start justify-between mb-2">
              <h3 class="font-bold text-lg text-gray-900 flex-1">${r.Title}</h3>
              <span class="px-2 py-1 rounded-full text-xs font-medium ${status.color}">${status.text}</span>
            </div>
            <p class="text-gray-600 text-sm mb-3 line-clamp-2">${(r.Description || '').substring(0, 100)}${(r.Description || '').length > 100 ? '...' : ''}</p>
            <div class="flex items-center justify-between text-xs text-gray-500">
              <span class="px-2 py-1 rounded-full ${priority.color}">${priority.text}</span>
              <span>${date}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    async function loadReports() {
      // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "Ø§Ù„ÙƒÙ„" ÙŠÙƒÙˆÙ† window.__HID = null
      const hid = window.__HID;

      const status = document.getElementById('filterStatus')?.value || '';
      const priority = document.getElementById('filterPriority')?.value || '';
      const q = document.getElementById('qTitle')?.value.trim() || '';

      // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù€ URL - Ø¥Ø°Ø§ ÙƒØ§Ù† hid nullØŒ Ù„Ø§ Ù†Ø¶ÙŠÙ hospitalId (Ù„Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª)
      let url = `${API_BASE}/api/cluster-reports?page=${page}&pageSize=${PAGE_SIZE}`;
      if (hid) url += `&hospitalId=${hid}`;
      if (status) url += `&status=${status}`;
      if (priority) url += `&priority=${priority}`;
      if (q) url += `&q=${encodeURIComponent(q)}`;

      const resultsEl = document.getElementById('results');
      resultsEl.innerHTML = '<div class="text-center text-gray-500 py-10">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

      try {
        const res = await fetch(url, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const payload = await res.json();

        if (!payload.data) {
          resultsEl.innerHTML = '<div class="text-center text-red-500 py-10">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>';
          return;
        }

        updateKPIs(payload);
        renderCards(payload.data);
        
        // Pagination
        const totalPages = Math.ceil((payload.total || 0) / PAGE_SIZE);
        document.getElementById('pInfo').textContent = `ØµÙØ­Ø© ${page}/${totalPages || 1}`;
        document.getElementById('pPrev').disabled = page <= 1;
        document.getElementById('pNext').disabled = page >= totalPages;
      } catch (e) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª:', e);
        resultsEl.innerHTML = '<div class="text-center text-red-500 py-10">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>';
      }
    }

    function goCreate() {
      const hid = window.__HID || 0;
      if (hid) {
        location.href = `../cluster/cluster-report-create.html?hospitalId=${hid}`;
      } else {
        location.href = `../cluster/cluster-report-create.html`;
      }
    }

    function viewReport(id, hospitalId) {
      location.href = `cluster-report-details.html?id=${id}&hospitalId=${hospitalId}`;
    }

    window.viewReport = viewReport;
    window.goCreate = goCreate;

    // Event listeners
    document.getElementById('btnSearch')?.addEventListener('click', () => {
      page = 1;
      loadReports();
    });

    document.getElementById('btnReset')?.addEventListener('click', () => {
      document.getElementById('qTitle').value = '';
      document.getElementById('filterStatus').value = '';
      document.getElementById('filterPriority').value = '';
      page = 1;
      loadReports();
    });

    document.getElementById('pPrev')?.addEventListener('click', () => {
      if (page > 1) {
        page--;
        loadReports();
      }
    });

    document.getElementById('pNext')?.addEventListener('click', () => {
      page++;
      loadReports();
    });

    document.getElementById('toggleFilters')?.addEventListener('click', () => {
      document.getElementById('filtersCard').classList.toggle('hidden');
    });

    // Add create button
    const headerSection = document.querySelector('section.text-center');
    if (headerSection) {
      const createBtn = document.createElement('button');
      createBtn.className = 'mt-4 bg-blue-700 text-white px-6 py-2 rounded-xl hover:bg-blue-800 transition';
      createBtn.textContent = 'Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯';
      createBtn.onclick = goCreate;
      headerSection.appendChild(createBtn);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Ø¬Ù„Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ localStorage
      let perms = JSON.parse(localStorage.getItem('permissions') || '{}');
      
      if (!perms.clusterView) {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ù† API
        try {
          const API_BASE = window.API_BASE || 'http://localhost:3001';
          const token = localStorage.getItem('token') || localStorage.getItem('authToken');
          const userData = JSON.parse(localStorage.getItem('userData') || '{}');
          
          const params = new URLSearchParams();
          if (userData?.HospitalID) {
            params.set('hospitalId', userData.HospitalID);
          }
          
          const permsRes = await fetch(`${API_BASE}/api/permissions/me${params.toString() ? '?' + params.toString() : ''}`, {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Accept': 'application/json'
            },
            credentials: 'include'
          });
          
          if (permsRes.ok) {
            const permsData = await permsRes.json();
            if (permsData.ok && permsData.data) {
              perms = permsData.data;
              localStorage.setItem('permissions', JSON.stringify(perms));
              console.log('âœ… ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† API');
            }
          }
        } catch (error) {
          console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:', error);
        }
      }
      
      // ÙØ­Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø¨Ø¹Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¬Ù„Ø¨
      if (!perms.clusterView) {
        alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¹Ø±Ø¶ Ø¨Ù„Ø§ØºØ§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¬Ù…Ø¹');
        location.href = '../../../index/index.html';
        return;
      }
      
      await resolveHID();
      loadReports();
    });
  </script>

  <!-- Ù†Ø¸Ø§Ù… Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø§Øª -->
  <script src="../../assets/js/auth-check.js"></script>
</body>
</html>
