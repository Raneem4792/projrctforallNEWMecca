<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ูููู ุงูุดุฎุตู - ุชุฌูุน ููุฉ ุงูููุฑูุฉ ุงูุตุญู</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/public/assets/css/styles.css" />
  <style>
    body { font-family: 'Tajawal', sans-serif; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

  <!-- Header - ุดุฑูุท ุงูุชููู ุงูุนููู -->
  <header id="navbar" class="fixed w-full top-0 z-50 navbar-scroll" style="background-color: #002B5B;">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <!-- Logo - ุงูุดุนุงุฑ -->
        <div class="flex items-center">
          <a href="/index/index.html">
            <img src="/public/assets/img/logo3.png" alt="ุดุนุงุฑ ุชุฌูุน ููุฉ ุงูููุฑูุฉ ุงูุตุญู" class="h-16 w-auto">
          </a>
        </div>
        
        <!-- Navigation - ูุงุฆูุฉ ุงูุชููู -->
        <nav class="hidden md:flex items-center space-x-reverse space-x-8">
          <a href="/index/index.html" class="text-white hover:text-blue-200 transition-colors">ุงูุฑุฆูุณูุฉ</a>
          <a href="/dashboard/dashboard.html" class="text-white hover:text-blue-200 transition-colors">ููุญุฉ ุงูุชุญูู</a>
          <a href="/dashboard/hospitals.html" class="text-white hover:text-blue-200 transition-colors">ุงููุณุชุดููุงุช</a>
          <a href="/dashboard/reports.html" class="text-white hover:text-blue-200 transition-colors">ุงูุชูุงุฑูุฑ ูุงูุฅุญุตุงุฆูุงุช</a>
          <a href="/public/complaints/submit/submit-complaint.html" class="text-white hover:text-blue-200 transition-colors">ุชูุฏูู ุจูุงุบ</a>
          <a href="/public/complaints/track/track-complaint.html" class="text-white hover:text-blue-200 transition-colors">ูุชุงุจุนุฉ ุจูุงุบ</a>
          <a href="/public/profile.html" class="text-white hover:text-blue-200 transition-colors font-bold underline">ูููู ุงูุดุฎุตู</a>
          <a href="/index/about-system.html" class="text-white hover:text-blue-200 transition-colors">ุญูู ุงููุธุงู</a>
          <a href="/index/help.html" class="text-white hover:text-blue-200 transition-colors">ุงููุณุงุนุฏุฉ</a>
          <a href="/index/contact.html" class="text-white hover:text-blue-200 transition-colors">ุงุชุตู ุจูุง</a>
          <button id="logoutBtn" class="text-white hover:text-red-300 transition-colors">ุชุณุฌูู ุงูุฎุฑูุฌ</button>
        </nav>
        
        <!-- Mobile menu button - ุฒุฑ ุงููุงุฆูุฉ ููููุจุงูู -->
        <button class="md:hidden text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <main class="pt-20 max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8 text-center" style="color: #002B5B;">ูููู ุงูุดุฎุตู</h1>

    <!-- ุจุทุงูุฉ ุงููุนูููุงุช -->
    <section class="bg-white rounded-2xl shadow-lg p-8 mb-8">
      <h2 class="text-xl font-semibold mb-6 text-gray-800">ุจูุงูุงุช ุงูุญุณุงุจ</h2>
      <form id="profileForm" class="grid md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium mb-2 text-gray-700">ุงูุงุณู ุงููุงูู</label>
          <input id="fullName" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-2 text-gray-700">ุงุณู ุงููุณุชุฎุฏู</label>
          <input id="username" class="w-full border border-gray-300 rounded-lg p-3 bg-gray-100" disabled />
        </div>
        <div>
          <label class="block text-sm font-medium mb-2 text-gray-700">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
          <input id="email" type="email" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-2 text-gray-700">ุงูุฌูุงู</label>
          <input id="mobile" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
        </div>

        <!-- ููุนุฑุถ ููุท -->
        <div>
          <label class="block text-sm font-medium mb-2 text-gray-700">ุงููุณุชุดูู</label>
          <input id="hospitalName" class="w-full border border-gray-300 rounded-lg p-3 bg-gray-100" disabled />
        </div>
        <div>
          <label class="block text-sm font-medium mb-2 text-gray-700">ุงููุณู</label>
          <input id="departmentName" class="w-full border border-gray-300 rounded-lg p-3 bg-gray-100" disabled />
        </div>

        <div class="md:col-span-2 mt-6 flex gap-4 items-center">
          <button type="submit" class="px-6 py-3 rounded-xl text-white font-medium hover:opacity-90 transition-opacity" style="background: linear-gradient(135deg, #002B5B, #004A9F);">
            ุญูุธ ุงูุชุบููุฑุงุช
          </button>
          <span id="saveMsg" class="text-sm font-medium"></span>
        </div>
      </form>
    </section>

    <!-- ุชุบููุฑ ูููุฉ ุงููุฑูุฑ -->
    <section class="bg-white rounded-2xl shadow-lg p-8">
      <h2 class="text-xl font-semibold mb-6 text-gray-800">ุชุบููุฑ ูููุฉ ุงููุฑูุฑ</h2>
      <form id="passwordForm" class="grid md:grid-cols-3 gap-6">
        <div>
          <label class="block text-sm font-medium mb-2 text-gray-700">ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ</label>
          <input id="oldPassword" type="password" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-2 text-gray-700">ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ</label>
          <input id="newPassword" type="password" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-2 text-gray-700">ุชุฃููุฏ ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ</label>
          <input id="newPassword2" type="password" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
        </div>
        <div class="md:col-span-3 mt-4 flex gap-4 items-center">
          <button type="submit" class="px-6 py-3 rounded-xl bg-gray-800 text-white font-medium hover:bg-gray-900 transition-colors">
            ุชุญุฏูุซ ูููุฉ ุงููุฑูุฑ
          </button>
          <span id="pwdMsg" class="text-sm font-medium"></span>
        </div>
      </form>
    </section>
  </main>

  <script>
    const API_BASE_URL = '';

    // ุญุงุฑุณ ุงูุตูุญุฉ - ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู
    async function requireAuth() {
      try {
        const token = localStorage.getItem('authToken') || localStorage.getItem('token');
        if (!token) {
          location.href = '/public/auth/login.html';
          return null;
        }

        const res = await fetch(`${API_BASE_URL}/api/auth/me`, { 
          credentials: 'include',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!res.ok) {
          localStorage.clear();
          location.href = '/public/auth/login.html';
          return null;
        }
        
        const me = await res.json();
        if (!me?.authenticated && !me?.UserID) {
          localStorage.clear();
          location.href = '/public/auth/login.html';
          return null;
        }
        
        return me;
      } catch (error) {
        console.error('Auth check failed:', error);
        localStorage.clear();
        location.href = '/NewProjectMecca/public/auth/login.html';
        return null;
      }
    }

    // ุฏุงูุฉ ุนุฑุถ ุงูุฑุณุงุฆู
    function setMsg(el, text, ok = true) {
      el.textContent = text;
      el.className = ok ? 'text-green-700' : 'text-red-700';
      setTimeout(() => { el.textContent = ''; }, 5000);
    }

    // ุฌูุจ ุจูุงูุงุช ุงูููู ุงูุดุฎุตู
    async function loadProfile() {
      try {
        const me = await requireAuth();
        if (!me) return;

        // ูุญุงููุฉ ุฌูุจ ุงูุจูุงูุงุช ูู /api/users/me ุฃููุงู
        let userData = me;
        try {
          const res = await fetch(`${API_BASE_URL}/api/users/me`, { 
            credentials: 'include',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('authToken') || localStorage.getItem('token')}`,
              'Content-Type': 'application/json'
            }
          });
          if (res.ok) {
            const data = await res.json();
            userData = data.data || data;
          }
        } catch (error) {
          console.log('Using fallback data from /api/auth/me');
        }

        // ุชุนุจุฆุฉ ุงูุญููู
        document.getElementById('fullName').value = userData.FullName || userData.fullName || '';
        document.getElementById('username').value = userData.Username || userData.username || '';
        document.getElementById('email').value = userData.Email || userData.email || '';
        document.getElementById('mobile').value = userData.Mobile || userData.mobile || '';
        document.getElementById('hospitalName').value = userData.HospitalName || userData.hospitalName || (userData.HospitalID ? `#${userData.HospitalID}` : '');
        // ุนุฑุถ ุงุณู ุงููุณู ุจุฏูู ุฅุธูุงุฑ ุฑูู ุงููุณู
        const departmentName =
          userData.DepartmentName ||
          userData.DepartmentNameAr ||
          userData.DepartmentNameEn ||
          userData.departmentName ||
          userData.departmentNameAr ||
          userData.departmentNameEn ||
          'ุบูุฑ ูุญุฏุฏ';
        document.getElementById('departmentName').value = departmentName;
        
        // Fallback ุฐูู: ุฅุฐุง ูู ูุฌุฏ ุงุณู ุงููุณูุ ูุฌุฑุจู ูู API ุขุฎุฑ
        if (!departmentName || departmentName === 'ุบูุฑ ูุญุฏุฏ') {
          const uid = userData.UserID || userData.userId || userData.id;
          if (uid) {
            try {
              const token = localStorage.getItem('authToken') || localStorage.getItem('token');
              if (token) {
                const r = await fetch(`${API_BASE_URL}/api/users/${uid}/details`, {
                  headers: { 'Authorization': `Bearer ${token}` }
                });
                if (r.ok) {
                  const j = await r.json();
                  const n = j?.user?.DepartmentName || j?.user?.DepartmentNameAr || j?.user?.DepartmentNameEn;
                  if (n) {
                    document.getElementById('departmentName').value = n;
                    console.log('โ ุชู ุฌูุจ ุงุณู ุงููุณู ูู API ุงุญุชูุงุทู:', n);
                  }
                }
              }
            } catch (error) {
              console.log('โ๏ธ ูุดู ูู ุฌูุจ ุงุณู ุงููุณู ูู API ุงุญุชูุงุทู:', error.message);
            }
          }
        }
        
        console.log('โ ุชู ุชุญููู ุจูุงูุงุช ุงูููู ุงูุดุฎุตู');
        console.log('๐ ุจูุงูุงุช ุงููุณู ุงููุณุชููุฉ:', {
          DepartmentID: userData.DepartmentID,
          DepartmentName: userData.DepartmentName,
          DepartmentNameAr: userData.DepartmentNameAr,
          DepartmentNameEn: userData.DepartmentNameEn,
          departmentName: userData.departmentName,
          departmentNameAr: userData.departmentNameAr,
          departmentNameEn: userData.departmentNameEn
        });
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุฌูุจ ุจูุงูุงุช ุงูููู ุงูุดุฎุตู:', error);
        setMsg(document.getElementById('saveMsg'), 'ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช', false);
      }
    }

    // ุชุญุฏูุซ ุจูุงูุงุช ุงูููู ุงูุดุฎุตู
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = document.getElementById('saveMsg');
      
      try {
        const payload = {
          FullName: document.getElementById('fullName').value.trim(),
          Email: document.getElementById('email').value.trim(),
          Mobile: document.getElementById('mobile').value.trim(),
        };

        const token = localStorage.getItem('authToken') || localStorage.getItem('token');
        const res = await fetch(`${API_BASE_URL}/api/users/me`, {
          method: 'PUT',
          credentials: 'include',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.message || 'ูุดู ูู ุชุญุฏูุซ ุงูุจูุงูุงุช');
        }

        setMsg(msg, 'ุชู ุญูุธ ุงูุชุบููุฑุงุช ุจูุฌุงุญ โ', true);
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุจูุงูุงุช:', error);
        setMsg(msg, 'ุชุนุฐูุฑ ุงูุญูุธ: ' + error.message, false);
      }
    });

    // ุชุบููุฑ ูููุฉ ุงููุฑูุฑ
    document.getElementById('passwordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const newPassword2 = document.getElementById('newPassword2').value;
      const msg = document.getElementById('pwdMsg');

      if (newPassword.length < 8) {
        return setMsg(msg, 'ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ ูุฌุจ ุฃู ุชููู 8 ุฃุญุฑู ุนูู ุงูุฃูู', false);
      }
      if (newPassword !== newPassword2) {
        return setMsg(msg, 'ุชุฃููุฏ ูููุฉ ุงููุฑูุฑ ุบูุฑ ูุทุงุจู', false);
      }

      try {
        const token = localStorage.getItem('authToken') || localStorage.getItem('token');
        const res = await fetch(`${API_BASE_URL}/api/users/me/password`, {
          method: 'PUT',
          credentials: 'include',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ oldPassword, newPassword })
        });

        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.message || 'ูุดู ูู ุชุญุฏูุซ ูููุฉ ุงููุฑูุฑ');
        }

        setMsg(msg, 'ุชู ุชุญุฏูุซ ูููุฉ ุงููุฑูุฑ ุจูุฌุงุญ โ', true);
        document.getElementById('oldPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('newPassword2').value = '';
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุชุญุฏูุซ ูููุฉ ุงููุฑูุฑ:', error);
        setMsg(msg, 'ุชุนุฐูุฑ ุงูุชุญุฏูุซ: ' + error.message, false);
      }
    });

    // ุชุณุฌูู ุงูุฎุฑูุฌ
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.clear();
      location.href = '/NewProjectMecca/public/auth/login.html';
    });

    // ุชุญููู ุงูุจูุงูุงุช ุนูุฏ ูุชุญ ุงูุตูุญุฉ
    loadProfile();
  </script>
</body>
</html>
