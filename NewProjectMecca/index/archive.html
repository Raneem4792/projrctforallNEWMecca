<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª - Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</title>

  <!-- Ø®Ø·ÙˆØ· Ùˆ Tailwind (Ù†ÙØ³ ØµÙØ­Ø© imports.html) -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Ù†ÙØ³ Ù…Ù„ÙØ§ØªÙƒ Ø¨Ø§Ù„Ø¶Ø¨Ø· -->
  <link rel="stylesheet" href="../public/assets/css/styles.css" />
  <link rel="stylesheet" href="index.css" />
  
  <!-- Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø±Ø´ÙŠÙ -->
  <style>
    .form-input,.form-select{border:1px solid #e5e7eb;border-radius:.5rem;padding:.5rem .75rem}
    .btn{border-radius:.5rem;padding:.5rem .9rem}
    .btn-primary{background:#0ea5e9;color:#fff}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .prog{height:8px;background:#e5e7eb;border-radius:9999px;overflow:hidden}
    .prog>span{display:block;height:100%;background:#0ea5e9;width:0%}
  </style>
</head>
<body class="font-[Tajawal] bg-gray-50 text-gray-800">

  <!-- Header - Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
  <header id="navbar" class="fixed w-full top-0 z-50 navbar-scroll" style="background-color: #002B5B;">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <!-- Logo - Ø§Ù„Ø´Ø¹Ø§Ø± -->
        <div class="flex items-center">
          <img src="../public/assets/img/logo3.png" alt="Ø´Ø¹Ø§Ø± ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„ØµØ­ÙŠ" class="h-16 w-auto">
        </div>
        
        <!-- Navigation - Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ†Ù‚Ù„ -->
        <nav class="hidden md:flex items-center space-x-reverse space-x-8">
          <a href="index.html" id="nav-home" class="text-white hover:text-blue-200 transition-colors">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
          <a href="../dashboard/dashboard.html" id="nav-dashboard" class="text-white hover:text-blue-200 transition-colors">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
          <a href="about-system.html" id="nav-about" class="text-white hover:text-blue-200 transition-colors">Ø­ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</a>
          <a href="help.html" id="nav-help" class="text-white hover:text-blue-200 transition-colors">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</a>
          <a href="contact.html" id="nav-contact" class="text-white hover:text-blue-200 transition-colors">Ø§ØªØµÙ„ Ø¨Ù†Ø§</a>
          <button id="languageToggle" class="text-white hover:text-blue-200 transition-colors flex items-center">
            ğŸŒ English
          </button>
        </nav>
        
        <!-- Mobile menu button - Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
        <button class="md:hidden text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- ===== Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© ===== -->
  <main class="max-w-7xl mx-auto px-4 py-10 pt-24">
    <h1 id="page-title" class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</h1>
    <p id="page-subtitle" class="text-gray-600 mb-8">Ø£Ø±ÙÙ‚ÙŠ Ø£ÙŠ Ù†ÙˆØ¹ Ù…Ù„Ù (ØµÙˆØ±ØŒ PDFØŒ ExcelØŒ Wordâ€¦)ØŒ ÙˆØ³ÙŠØªÙ… Ø­ÙØ¸Ù‡ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ.</p>

    <!-- Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª -->
    <div class="bg-white rounded-xl shadow p-6 mt-6">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-sky-50 text-sky-600">ğŸ“¦</span>
          <div>
            <h3 class="text-lg font-bold">Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</h3>
            <p class="text-sm text-gray-500">Ø£Ø±ÙÙ‚ÙŠ Ø£ÙŠ Ù†ÙˆØ¹ Ù…Ù„Ù (ØµÙˆØ±ØŒ PDFØŒ ExcelØŒ Wordâ€¦)ØŒ ÙˆØ³ÙŠØªÙ… Ø­ÙØ¸Ù‡ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ.</p>
          </div>
        </div>
        <!-- Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ø¹ ÙŠØ¸Ù‡Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ -->
        <div id="archive-hosp-wrapper" class="w-64 hidden">
          <label class="block text-sm text-gray-600 mb-1">Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</label>
          <select id="archiveHospitalId" class="form-select w-full">
            <option value="">â€” Ø§Ø®ØªØ± Ù…Ø³ØªØ´ÙÙ‰ â€”</option>
          </select>
        </div>
      </div>

      <div id="archiveDrop" class="border-2 border-dashed rounded-lg p-5 text-center hover:bg-gray-50 cursor-pointer">
        <p class="mb-2 font-medium">Ø§Ø³Ø­Ø¨ÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ·ÙŠ Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</p>
        <input id="archiveFiles" type="file" class="hidden" multiple>
        <p class="text-xs text-gray-500">Ù…Ø³Ù…ÙˆØ­ Ø¨ÙƒÙ„ Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯Ø§Øª â€¢ Ø­Ø¯ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ 50MB Ù„ÙƒÙ„ Ù…Ù„Ù</p>
      </div>

      <div id="archiveQueue" class="mt-4 space-y-2 hidden"></div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-3">
        <!-- Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù -->
        <div>
          <label class="block text-sm text-gray-600 mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù</label>
          <input id="archiveFileName" type="text" class="form-input w-full" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙŠØ¯ÙˆÙŠØ§Ù‹">
        </div>

        <!-- Ø§Ù„Ù…ØµØ¯Ø± -->
        <div>
          <label class="block text-sm text-gray-600 mb-1">Ø§Ù„Ù…ØµØ¯Ø±</label>
          <input id="archiveSourceModule" type="text" class="form-input w-full" placeholder="Ø§ÙƒØªØ¨ Ù…ØµØ¯Ø± Ø§Ù„Ù…Ù„Ù">
        </div>

        <!-- Ø¬Ù‡Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù -->
        <div>
          <label class="block text-sm text-gray-600 mb-1">Ø¬Ù‡Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù</label>
          <input id="archiveSourceName" type="text" class="form-input w-full bg-gray-100" readonly>
        </div>

        <!-- Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
        <div>
          <label class="block text-sm text-gray-600 mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
          <input id="archiveNotes" type="text" class="form-input w-full" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
        </div>
      </div>

      <div class="mt-4 text-left">
        <button id="btnArchiveUpload" class="btn btn-primary" disabled>ğŸ“¤ Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</button>
      </div>

      <div id="archiveResult" class="mt-4 text-sm"></div>
    </div>

    <!-- Ù‚Ø³Ù… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© -->
    <div class="bg-white rounded-xl shadow p-6 mt-6">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
          <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-blue-50 text-blue-600">ğŸ“‹</span>
          <div>
            <h3 class="text-lg font-bold">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h3>
            <p class="text-sm text-gray-500">Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <!-- Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« -->
          <input 
            id="searchArchiveInput"
            type="text"
            class="form-input w-64"
            placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø£Ùˆ Ø§Ù„Ù…ØµØ¯Ø±..."
            oninput="filterArchiveTable()">
          <button id="btnRefreshFiles" class="btn btn-primary">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
        </div>
      </div>

      <!-- ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ (Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ø¹) -->
      <div id="filterHospitalWrapper" class="mb-4 hidden">
        <label class="block text-sm text-gray-600 mb-1">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</label>
        <select id="filterHospitalId" class="form-select w-64">
          <option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª</option>
        </select>
      </div>

      <!-- Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
      <div id="filesLoading" class="text-center py-8 text-gray-500 hidden">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        <p class="mt-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª...</p>
      </div>

      <!-- Ø±Ø³Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ù„ÙØ§Øª -->
      <div id="filesEmpty" class="text-center py-8 text-gray-500 hidden">
        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</p>
      </div>

      <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª -->
      <div id="filesTable" class="overflow-x-auto hidden">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ù…Ù„Ù</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ø­Ø¬Ù…</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ù…ØµØ¯Ø±</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø±ÙØ¹ Ø¨ÙˆØ§Ø³Ø·Ø©</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±ÙØ¹</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="filesTableBody" class="bg-white divide-y divide-gray-200">
            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
          </tbody>
        </table>

        <!-- Pagination -->
        <div id="filesPagination" class="mt-4 flex items-center justify-between">
          <div class="text-sm text-gray-700">
            <span id="filesPaginationInfo"></span>
          </div>
          <div class="flex gap-2">
            <button id="btnPrevPage" class="btn" disabled>Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
            <button id="btnNextPage" class="btn">Ø§Ù„ØªØ§Ù„ÙŠ</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ===== Ø§Ù„ÙÙˆØªØ± Ù†ÙØ³Ù‡ (Ù…Ù† imports.html) ===== -->
  <footer class="bg-gray-900 text-white py-14">
    <div class="container mx-auto px-4">
      <div class="grid md:grid-cols-3 gap-8">
        <!-- Column 1 - Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ -->
        <div>
          <div class="flex items-center space-x-reverse space-x-3 mb-4">
            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 2L2 7v10c0 5.55 3.84 9.74 9 11 5.16-1.26 9-5.45 9-11V7l-10-5z"/>
              </svg>
            </div>
            <div>
              <div id="footer-org-name" class="font-bold">ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„ØµØ­ÙŠ</div>
              <div id="footer-system-name" class="text-sm text-gray-300">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</div>
            </div>
          </div>
          <p id="footer-description" class="text-gray-300 text-sm">Ù…Ù†ØµØ© Ø±Ø³Ù…ÙŠØ© Ù„ØªÙ‚Ø¯ÙŠÙ… ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</p>
        </div>

        <!-- Column 2 - Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ -->
        <div>
          <h3 id="footer-links-title" class="font-bold mb-4">Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©</h3>
          <ul class="space-y-2 text-sm">
            <li><a href="index.html" id="footer-link-home" class="text-gray-300 hover:text-white hover:underline transition-colors">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
            <li><a href="../public/complaints/submit/submit-complaint.html" id="footer-link-submit" class="text-gray-300 hover:text-white hover:underline transition-colors">ØªÙ‚Ø¯ÙŠÙ… Ø¨Ù„Ø§Øº</a></li>
            <li><a href="../public/complaints/track/track-complaint.html" id="footer-link-track" class="text-gray-300 hover:text-white hover:underline transition-colors">Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ù„Ø§Øº</a></li>
            <li><a href="help.html" id="footer-link-faq" class="text-gray-300 hover:text-white hover:underline transition-colors">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©</a></li>
          </ul>
        </div>

        <!-- Column 3 - Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù„Ø« -->
        <div>
          <h3 id="footer-contact-title" class="font-bold mb-4">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</h3>
          <div class="space-y-2 text-sm text-gray-300">
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
              <span id="footer-support-number">Ø±Ù‚Ù… Ø§Ù„Ø¯Ø¹Ù…: 0559735137</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
              <span id="footer-support-number-2">Ø±Ù‚Ù… Ø§Ù„Ø¯Ø¹Ù…: 0542282550</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
              <span id="footer-support-email">support@makkahhealth.gov.sa</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span id="footer-working-hours">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„: 24/7</span>
            </div>
          </div>
        </div>
      </div>

      <div class="border-t border-gray-700 mt-8 pt-8 text-center text-sm text-gray-300">
        <span id="footer-copyright">Â© 2025 ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„ØµØ­ÙŠ â€“ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</span>
      </div>
    </div>
  </footer>

  <!-- Ù†ÙØ³ Ø³ÙƒØ±Ø¨ØªØ§ØªÙƒ -->
  <script src="index.js"></script>
  
  <!-- Ø³ÙƒØ±Ø¨Øª Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª -->
  <script>
    // âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª API - Ø­Ø¯Ø¯ÙŠ Ù…Ù†ÙØ° Ø§Ù„Ù€ backend Ø§Ù„ØµØ­ÙŠØ­
    const API_BASE = (location.hostname==='localhost'||location.hostname==='127.0.0.1') 
      ? 'http://localhost:3001'  // Ù„Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ø­Ù„ÙŠ
      : location.origin;            // Ù„Ù„Ø¥Ù†ØªØ§Ø¬ (Ù†ÙØ³ Ø§Ù„Ø³ÙŠØ±ÙØ±)
    
    console.log('[Archive] API_BASE:', API_BASE);
    
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø©
    const ARCHIVE_MAX_MB = 50; // Ø­Ø¯ Ø§Ù„Ø­Ø¬Ù… Ù„ÙƒÙ„ Ù…Ù„Ù
    
    // Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    let isClusterManager = false;
    let userHospitalId = null;
    
    // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    async function loadArchiveUserInfo() {
      try {
        const token = localStorage.getItem('token') || localStorage.getItem('authToken');
        
        if (!token) return;
        
        const res = await fetch(`${API_BASE}/api/auth/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!res.ok) return;
        
        const user = await res.json();
        window.currentUser = user;
        isClusterManager = user?.RoleID === 1 || user?.isClusterManager === true;
        userHospitalId = user?.HospitalID || user?.hospitalId || null;
        
        // ØªØ­Ø¯ÙŠØ¯ Ø¬Ù‡Ø© Ø§Ù„Ø±ÙØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
        const sourceInput = document.getElementById('archiveSourceName');
        if (sourceInput) {
          if (isClusterManager) {
            sourceInput.value = 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¬Ù…Ø¹';
          } else {
            const hospName = localStorage.getItem('hospitalNameAr') || 'Ù…Ø³ØªØ´ÙÙ‰ ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            sourceInput.value = hospName;
          }
        }
        
        // ØªÙØ¹ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ø¹
        const hospWrap = document.getElementById('archive-hosp-wrapper');
        const hospSelect = document.getElementById('archiveHospitalId');
        
        if (isClusterManager && hospWrap && hospSelect) {
          hospWrap.classList.remove('hidden');
          
          // Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª
          try {
            const hospRes = await fetch(`${API_BASE}/api/central/hospitals?active=1`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (hospRes.ok) {
              const hospitals = await hospRes.json();
              (hospitals || []).forEach(h => {
                const opt = document.createElement('option');
                opt.value = h.HospitalID || h.hospitalId || h.id;
                opt.textContent = h.NameAr || h.nameAr || h.name;
                hospSelect.appendChild(opt);
              });
            }
          } catch (err) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª:', err);
          }
        }
      } catch (err) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', err);
      }
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£Ø±Ø´ÙŠÙ
    const inp = document.getElementById('archiveFiles');
    const drop = document.getElementById('archiveDrop');
    const queue = document.getElementById('archiveQueue');
    const btnUpload = document.getElementById('btnArchiveUpload');
    const notes = document.getElementById('archiveNotes');
    const resultBox = document.getElementById('archiveResult');

    let filesToUpload = [];

    // ÙØªØ­ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø³Ø­Ø¨
    if (drop) {
      drop.addEventListener('click', () => inp?.click());
    }

    // Ø¯Ø¹Ù… Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
    if (drop) {
      ['dragenter','dragover'].forEach(evt => {
        drop.addEventListener(evt, e => {
          e.preventDefault();
          drop.classList.add('bg-gray-50');
        });
      });
      
      ['dragleave','drop'].forEach(evt => {
        drop.addEventListener(evt, e => {
          e.preventDefault();
          drop.classList.remove('bg-gray-50');
        });
      });

      drop.addEventListener('drop', e => {
        const files = Array.from(e.dataTransfer.files || []);
        handleAdd(files);
      });
    }

    if (inp) {
      inp.addEventListener('change', e => {
        const files = Array.from(e.target.files || []);
        handleAdd(files);
      });
    }

    function handleAdd(files) {
      const maxBytes = ARCHIVE_MAX_MB * 1024 * 1024;
      const valid = [];
      const rejected = [];
      
      files.forEach(f => {
        if (f.size <= maxBytes) {
          valid.push(f);
        } else {
          rejected.push({ name: f.name, reason: 'ÙŠØªØ¬Ø§ÙˆØ² ' + ARCHIVE_MAX_MB + 'MB' });
        }
      });
      
      filesToUpload = filesToUpload.concat(valid);
      renderQueue();
      
      if (rejected.length && resultBox) {
        resultBox.innerHTML = `<span class="text-red-600">ØªÙ… Ø±ÙØ¶ ${rejected.length} Ù…Ù„Ù(Ø§Øª) Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¬Ù….</span>`;
      }
    }

    function renderQueue() {
      if (!queue) return;
      
      queue.innerHTML = '';
      
      if (filesToUpload.length === 0) {
        queue.classList.add('hidden');
        if (btnUpload) btnUpload.disabled = true;
        return;
      }
      
      queue.classList.remove('hidden');
      if (btnUpload) btnUpload.disabled = false;

      filesToUpload.forEach((f, idx) => {
        const row = document.createElement('div');
        row.className = 'border rounded-lg p-3 flex items-center gap-3';
        row.innerHTML = `
          <div class="w-10 text-center">ğŸ“„</div>
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <div><strong>${f.name}</strong> <span class="text-xs text-gray-500">(${(f.size/1024/1024).toFixed(2)} MB)</span></div>
              <button class="text-red-600 text-sm" data-remove="${idx}">Ø­Ø°Ù</button>
            </div>
            <div class="prog mt-2"><span id="prog-${idx}"></span></div>
          </div>
        `;
        queue.appendChild(row);
      });

      // Ø­Ø°Ù Ø¹Ù†ØµØ± Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±ÙØ¹
      queue.querySelectorAll('[data-remove]').forEach(btn => {
        btn.addEventListener('click', e => {
          const i = +e.currentTarget.dataset.remove;
          filesToUpload.splice(i, 1);
          renderQueue();
        });
      });
    }

    if (btnUpload) {
      btnUpload.addEventListener('click', async () => {
        if (!resultBox) return;
        
        // ğŸ”’ ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±ÙØ¹ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        const uploadPerms = JSON.parse(localStorage.getItem('permissions') || '{}');
        if (!uploadPerms.archiveUpload) {
          alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù„Ø£Ø±Ø´ÙŠÙ');
          return;
        }
        
        resultBox.textContent = '';
        btnUpload.disabled = true;

        const token = localStorage.getItem('token') || localStorage.getItem('authToken');
        const chosenHospitalId = isClusterManager 
          ? (document.getElementById('archiveHospitalId')?.value || '') 
          : (userHospitalId || '');

        // Ù…Ù†Ø¹ "all" Ø£Ùˆ Ø§Ù„ÙØ§Ø±Øº
        if (!chosenHospitalId || String(chosenHospitalId).toLowerCase() === 'all') {
          resultBox.innerHTML = `<span class="text-red-600">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªØ´ÙÙ‰ Ù…Ø­Ø¯Ø¯ Ù‚Ø¨Ù„ Ø§Ù„Ø±ÙØ¹.</span>`;
          btnUpload.disabled = false;
          return;
        }

        // Ù†Ø±ÙØ¹ Ù…Ù„ÙÙ‹Ø§ Ù…Ù„ÙÙ‹Ø§ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙ‚Ø¯Ù… Ù„ÙƒÙ„ ÙˆØ§Ø­Ø¯
        const uploadResults = { success: 0, failed: 0, errors: [] };
        
        const customFileName = document.getElementById('archiveFileName')?.value || '';
        const sourceName = document.getElementById('archiveSourceName')?.value || '';
        const sourceModule = document.getElementById('archiveSourceModule')?.value || '';
        
        for (let i = 0; i < filesToUpload.length; i++) {
          try {
            await uploadSingleFile(filesToUpload[i], i, chosenHospitalId, notes?.value || '', API_BASE, token, customFileName, sourceName, sourceModule);
            uploadResults.success++;
          } catch (error) {
            uploadResults.failed++;
            uploadResults.errors.push({ file: filesToUpload[i].name, error: error.message });
            console.error(`[Archive] ÙØ´Ù„ Ø±ÙØ¹ ${filesToUpload[i].name}:`, error);
          }
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        if (uploadResults.failed === 0 && uploadResults.success > 0) {
          // Ù†Ø¬Ø§Ø­ ÙƒØ§Ù…Ù„
          resultBox.innerHTML = `<span class="text-green-600">ØªÙ… Ø±ÙØ¹ ${uploadResults.success} Ù…Ù„Ù(Ø§Øª) Ø¨Ù†Ø¬Ø§Ø­.</span>`;
          
          // ØªÙØ±ÙŠØº Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
          filesToUpload = [];
          renderQueue();
          
          // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø¹Ø¯ Ø±ÙØ¹ Ù†Ø§Ø¬Ø­
          setTimeout(() => {
            loadFilesList();
          }, 1000);
        } else if (uploadResults.success > 0 && uploadResults.failed > 0) {
          // Ù†Ø¬Ø§Ø­ Ø¬Ø²Ø¦ÙŠ
          const errorList = uploadResults.errors.map(e => `â€¢ ${e.file}: ${e.error}`).join('<br>');
          resultBox.innerHTML = `<span class="text-yellow-600">ØªÙ… Ø±ÙØ¹ ${uploadResults.success} Ù…Ù„Ù(Ø§Øª) Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙØ´Ù„ ${uploadResults.failed} Ù…Ù„Ù(Ø§Øª):</span><br><span class="text-red-600 text-sm">${errorList}</span>`;
        } else {
          // ÙØ´Ù„ ÙƒØ§Ù…Ù„
          const errorList = uploadResults.errors.map(e => `â€¢ ${e.file}: ${e.error}`).join('<br>');
          resultBox.innerHTML = `<span class="text-red-600">ÙØ´Ù„ Ø±ÙØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª:</span><br><span class="text-red-600 text-sm">${errorList}</span>`;
        }
        
        btnUpload.disabled = false;
      });
    }

    function uploadSingleFile(file, idx, hospitalId, notesText, API_BASE, token, customFileName = '', sourceName = '', sourceModule = '') {
      return new Promise((resolve, reject) => {
        const form = new FormData();
        
        // ğŸ‘ˆ Ù…Ù‡Ù…: Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†ØµÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ (Ù‚Ø¨Ù„ Ø§Ù„Ù…Ù„Ù)
        form.append('hospitalId', String(hospitalId));
        form.append('notes', notesText || '');
        form.append('source', 'archive'); // Ù…ØµØ¯Ø± Ø§Ù„Ø±ÙØ¹ (ØµÙØ­Ø© Ø§Ù„Ø£Ø±Ø´ÙŠÙ)
        form.append('fileName', customFileName || ''); // Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØµØµ
        form.append('sourceName', sourceName || ''); // Ø¬Ù‡Ø© Ø§Ù„Ø±ÙØ¹
        form.append('sourceModule', sourceModule || ''); // Ø§Ù„Ù…ØµØ¯Ø± (ÙŠØ¯Ø®Ù„Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
        
        // Ø«Ù… Ø§Ù„Ù…Ù„Ù
        form.append('file', file);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', `${API_BASE}/api/archive/upload`, true);
        
        if (token) {
          xhr.setRequestHeader('Authorization', `Bearer ${token}`);
        }
        
        xhr.upload.addEventListener('progress', (e) => {
          if (e.lengthComputable) {
            const pct = Math.round((e.loaded / e.total) * 100);
            const bar = document.getElementById(`prog-${idx}`);
            if (bar) bar.style.width = pct + '%';
          }
        });
        
        xhr.onload = () => {
          if (xhr.status >= 200 && xhr.status < 300) {
            // Ù†Ø¬Ø§Ø­
            const bar = document.getElementById(`prog-${idx}`);
            if (bar) bar.style.background = '#10b981'; // Ø£Ø®Ø¶Ø±
            try {
              const response = JSON.parse(xhr.responseText);
              if (response.ok) {
                resolve();
              } else {
                reject(new Error(response.message || response.error || 'ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹'));
              }
            } catch {
              resolve(); // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± JSON ØµØ­ÙŠØ­Ø©ØŒ Ù†Ø¹ØªØ¨Ø±Ù‡Ø§ Ù†Ø¬Ø§Ø­
            }
          } else {
            // ÙØ´Ù„
            const bar = document.getElementById(`prog-${idx}`);
            if (bar) bar.style.background = '#ef4444'; // Ø£Ø­Ù…Ø±
            let errorMessage = `HTTP ${xhr.status}`;
            try {
              const errorResponse = JSON.parse(xhr.responseText);
              errorMessage = errorResponse.message || errorResponse.error || errorMessage;
            } catch {
              errorMessage = xhr.responseText || errorMessage;
            }
            reject(new Error(`${file.name}: ${errorMessage}`));
          }
        };
        
        xhr.onerror = () => {
          reject(new Error('Network error'));
        };
        
        xhr.send(form);
      });
    }

    // ===== Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª =====
    let currentPage = 1;
    let currentHospitalId = null;

    // Ø¹Ù†Ø§ØµØ± Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª
    const filesLoading = document.getElementById('filesLoading');
    const filesEmpty = document.getElementById('filesEmpty');
    const filesTable = document.getElementById('filesTable');
    const filesTableBody = document.getElementById('filesTableBody');
    const btnRefreshFiles = document.getElementById('btnRefreshFiles');
    const filterHospitalId = document.getElementById('filterHospitalId');
    const filterHospitalWrapper = document.getElementById('filterHospitalWrapper');
    const btnPrevPage = document.getElementById('btnPrevPage');
    const btnNextPage = document.getElementById('btnNextPage');
    const filesPaginationInfo = document.getElementById('filesPaginationInfo');

    // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª
    async function loadFilesList() {
      if (!filesTable) return;

      filesLoading?.classList.remove('hidden');
      filesTable.classList.add('hidden');
      filesEmpty?.classList.add('hidden');

      try {
        const token = localStorage.getItem('token') || localStorage.getItem('authToken');
        
        if (!token) {
          filesLoading?.classList.add('hidden');
          return;
        }

        const params = new URLSearchParams({
          page: currentPage.toString(),
          pageSize: '20'
        });

        // Ø¥Ø±Ø³Ø§Ù„ hospitalId Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (isClusterManager) {
          // Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ø¹: ÙŠØ±Ø³Ù„ "all" Ø£Ùˆ hospitalId Ù…Ø­Ø¯Ø¯
          const hospValue = (currentHospitalId === null || currentHospitalId === '') ? 'all' : currentHospitalId;
          params.append('hospitalId', hospValue);
        }
        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ: Ù„Ø§ Ù†Ø±Ø³Ù„ hospitalId (Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ£Ø®Ø°Ù‡ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)

        const url = `${API_BASE}/api/archive/list?${params}`;
        console.log('[Archive] Loading files from:', url);
        
        const res = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) {
          const errorText = await res.text();
          console.error('[Archive] Failed to load files:', {
            status: res.status,
            statusText: res.statusText,
            error: errorText
          });
          throw new Error(`HTTP ${res.status}: ${errorText || res.statusText}`);
        }

        const data = await res.json();
        
        filesLoading?.classList.add('hidden');

        if (!data.files || data.files.length === 0) {
          filesEmpty?.classList.remove('hidden');
          return;
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        filesTable.classList.remove('hidden');
        renderFilesTable(data.files);
        updatePagination(data.pagination);

      } catch (err) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª:', err);
        filesLoading?.classList.add('hidden');
        filesEmpty?.classList.remove('hidden');
        if (filesEmpty) {
          filesEmpty.innerHTML = '<p class="text-red-600">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª</p>';
        }
      }
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    function renderFilesTable(files) {
      if (!filesTableBody) return;

      filesTableBody.innerHTML = files.map((f, i) => {
        const uploadDate = new Date(f.uploadedAt).toLocaleString('ar-SA', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        return `
          <tr class="border-b hover:bg-gray-50 cursor-pointer main-row"
              data-filename="${f.fileName || ''}"
              data-source="${f.source || ''}"
              data-index="${i}"
              onclick="toggleDetails(${i})">
            <td class="px-4 py-3 text-sm">${f.fileName}</td>
            <td class="px-4 py-3 text-sm">${f.sizeMB} MB</td>
            <td class="px-4 py-3 text-sm">${f.hospitalName}</td>
            <td class="px-4 py-3 text-sm">${f.source}</td>
            <td class="px-4 py-3 text-sm">${f.uploadedBy}</td>
            <td class="px-4 py-3 text-sm">${uploadDate}</td>
            <td class="px-4 py-3 text-sm text-center">
              <a href="${f.downloadUrl}" 
                 data-file-id="${f.fileId}"
                 data-file-name="${f.fileName}"
                 data-hospital-id="${f.hospitalId}"
                 class="download-link text-blue-600 hover:underline" 
                 onclick="event.stopPropagation()">ØªÙ†Ø²ÙŠÙ„</a>
            </td>
          </tr>
          <tr id="details-${i}" class="hidden bg-gray-50">
            <td colspan="7" class="p-4 text-sm text-gray-600">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù:</strong> ${f.fileName}</div>
                <div><strong>Ø§Ù„Ù…ØµØ¯Ø±:</strong> ${f.source}</div>
                <div><strong>Ø¬Ù‡Ø© Ø§Ù„Ø±ÙØ¹:</strong> ${f.sourceName}</div>
                <div><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${f.notes || 'â€”'}</div>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªÙ†Ø²ÙŠÙ„
      filesTableBody.querySelectorAll('.download-link').forEach(link => {
        link.addEventListener('click', async (e) => {
          e.preventDefault();
          const fileId = e.target.dataset.fileId;
          const fileName = e.target.dataset.fileName;
          const hospitalId = e.target.dataset.hospitalId;
          const token = localStorage.getItem('token') || localStorage.getItem('authToken');
          
          try {
            // Ø¥Ø±Ø³Ø§Ù„ hospitalId ÙÙŠ query string
            const downloadUrl = `${API_BASE}/api/archive/download/${fileId}?hospitalId=${hospitalId || userHospitalId || ''}`;
            const res = await fetch(downloadUrl, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            
            const blob = await res.blob();
            const blobUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = blobUrl;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(blobUrl);
          } catch (err) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù:', err);
            alert('ÙØ´Ù„ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ' + err.message);
          }
        });
      });
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØµÙ (ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…)
    window.toggleDetails = function(i) {
      const row = document.getElementById(`details-${i}`);
      if (row) {
        row.classList.toggle('hidden');
      }
    };

    // Ø¯Ø§Ù„Ø© ÙÙ„ØªØ±Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø­Ø« (Ù…Ø¹ debounce)
    let searchTimeout;
    window.filterArchiveTable = function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        const query = document.getElementById('searchArchiveInput')?.value.toLowerCase() || '';
        const rows = document.querySelectorAll('#filesTableBody tr.main-row');
        
        rows.forEach(row => {
          const fileName = (row.dataset.filename || '').toLowerCase();
          const source = (row.dataset.source || '').toLowerCase();
          
          const match = fileName.includes(query) || source.includes(query);
          row.style.display = match ? '' : 'none';
          
          // Ø¥Ø®ÙØ§Ø¡ ØµÙ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØµÙ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù…Ø®ÙÙŠ
          const index = row.dataset.index;
          const details = document.getElementById(`details-${index}`);
          if (details) {
            details.style.display = match ? '' : 'none';
          }
        });
      }, 200);
    };

    // ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ù„Ù Ø­Ø³Ø¨ Ù†ÙˆØ¹Ù‡
    function getFileIcon(mimeType) {
      if (!mimeType) return 'ğŸ“„';
      
      if (mimeType.startsWith('image/')) return 'ğŸ–¼ï¸';
      if (mimeType.includes('pdf')) return 'ğŸ“•';
      if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'ğŸ“Š';
      if (mimeType.includes('word') || mimeType.includes('document')) return 'ğŸ“';
      if (mimeType.includes('zip') || mimeType.includes('rar')) return 'ğŸ“¦';
      if (mimeType.includes('video')) return 'ğŸ¥';
      if (mimeType.includes('audio')) return 'ğŸµ';
      
      return 'ğŸ“„';
    }

    // ØªØ­Ø¯ÙŠØ« Pagination
    function updatePagination(pagination) {
      if (!pagination) return;

      if (filesPaginationInfo) {
        const start = (pagination.page - 1) * pagination.pageSize + 1;
        const end = Math.min(pagination.page * pagination.pageSize, pagination.total);
        filesPaginationInfo.textContent = `Ø¹Ø±Ø¶ ${start}-${end} Ù…Ù† ${pagination.total}`;
      }

      if (btnPrevPage) {
        btnPrevPage.disabled = pagination.page <= 1;
      }
      if (btnNextPage) {
        btnNextPage.disabled = pagination.page >= pagination.totalPages;
      }
    }

    // Ø£Ø­Ø¯Ø§Ø«
    if (btnRefreshFiles) {
      btnRefreshFiles.addEventListener('click', () => {
        currentPage = 1;
        loadFilesList();
      });
    }

    if (filterHospitalId) {
      filterHospitalId.addEventListener('change', (e) => {
        const value = e.target.value;
        currentHospitalId = (value === '' || value === 'all') ? 'all' : value;
        currentPage = 1;
        loadFilesList();
      });
    }

    if (btnPrevPage) {
      btnPrevPage.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          loadFilesList();
        }
      });
    }

    if (btnNextPage) {
      btnNextPage.addEventListener('click', () => {
        currentPage++;
        loadFilesList();
      });
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', async () => {
      // ğŸ”’ ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø±Ø´ÙŠÙ
      let perms = JSON.parse(localStorage.getItem('permissions') || '{}');
      
      // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø¬Ø±Ù‘Ø¨ Ø¬Ù„Ø¨Ù‡Ø§ Ù…Ù† API
      if (!perms.archiveView) {
        try {
          const API_BASE = window.API_BASE || 'http://localhost:3001';
          const token = localStorage.getItem('token') || localStorage.getItem('authToken');
          const userData = JSON.parse(localStorage.getItem('userData') || '{}');
          
          const params = new URLSearchParams();
          if (userData?.HospitalID) params.set('hospitalId', userData.HospitalID);
          
          const permsRes = await fetch(`${API_BASE}/api/permissions/me${params.toString() ? '?' + params.toString() : ''}`, {
            headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' },
            credentials: 'include'
          });
          
          if (permsRes.ok) {
            const permsData = await permsRes.json();
            if (permsData.ok && permsData.data) {
              perms = permsData.data;
              localStorage.setItem('permissions', JSON.stringify(perms));
            }
          }
        } catch (error) {
          console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:', error);
        }
      }
      
      // ğŸ”’ Ù„Ùˆ Ù…Ø§ Ø¹Ù†Ø¯Ù‡ ØµÙ„Ø§Ø­ÙŠØ© Ø¹Ø±Ø¶ØŒ Ø±Ø¬Ù‘Ø¹ÙŠÙ‡ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      if (!perms.archiveView) {
        alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø´ÙŠÙ');
        window.location.href = 'index.html';
        return;
      }
      
      // ğŸ”’ Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø±ÙØ¹ Ø¥Ù† Ù…Ø§ Ø¹Ù†Ø¯Ù‡ ØµÙ„Ø§Ø­ÙŠØ©
      if (!perms.archiveUpload) {
        const btnArchiveUpload = document.getElementById('btnArchiveUpload');
        const archiveDrop = document.getElementById('archiveDrop');
        const archiveFiles = document.getElementById('archiveFiles');
        const archiveNotes = document.getElementById('archiveNotes');
        
        if (btnArchiveUpload) btnArchiveUpload.classList.add('hidden');
        if (archiveDrop) archiveDrop.classList.add('hidden');
        if (archiveFiles) archiveFiles.style.display = 'none';
        if (archiveNotes) archiveNotes.parentElement?.classList.add('hidden');
      }
      
      // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ API Ø£ÙˆÙ„Ø§Ù‹
      try {
        const testRes = await fetch(`${API_BASE}/api/archive/test`);
        if (testRes.ok) {
          const testData = await testRes.json();
          console.log('[Archive] âœ… API connection test passed:', testData);
        } else {
          console.warn('[Archive] âš ï¸ API test failed:', testRes.status);
        }
      } catch (err) {
        console.error('[Archive] âŒ Cannot connect to API:', err);
        if (filesEmpty) {
          filesEmpty.innerHTML = `<p class="text-red-600">âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ÙŠ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¹Ù„Ù‰ ${API_BASE}</p>`;
          filesEmpty.classList.remove('hidden');
        }
      }
      
      await loadArchiveUserInfo();
      
      // Ø¥Ø¹Ø¯Ø§Ø¯ ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ø¹
      if (isClusterManager && filterHospitalWrapper && filterHospitalId) {
        filterHospitalWrapper.classList.remove('hidden');
        
        try {
          const token = localStorage.getItem('token') || localStorage.getItem('authToken');
          
          const hospRes = await fetch(`${API_BASE}/api/central/hospitals?active=1`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (hospRes.ok) {
            const hospitals = await hospRes.json();
            (hospitals || []).forEach(h => {
              const opt = document.createElement('option');
              opt.value = h.HospitalID || h.hospitalId || h.id;
              opt.textContent = h.NameAr || h.nameAr || h.name;
              filterHospitalId.appendChild(opt);
            });
          }
        } catch (err) {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª Ù„Ù„ÙÙ„ØªØ±Ø©:', err);
        }
      } else {
        // Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø³ØªØ´ÙØ§Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        currentHospitalId = userHospitalId || null;
      }
      
      // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰
      if (isClusterManager && filterHospitalId) {
        currentHospitalId = 'all'; // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ø¹
      }
      
      // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª
      loadFilesList();
    });

  </script>

  <!-- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ±Ø¬Ù…Ø© -->
  <script>
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ±Ø¬Ù…Ø©
    const translations = {
      ar: {
        // Ø§Ù„Ù‡ÙŠØ¯Ø±
        'nav-home': 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
        'nav-dashboard': 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…',
        'nav-about': 'Ø­ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…',
        'nav-help': 'Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©',
        'nav-contact': 'Ø§ØªØµÙ„ Ø¨Ù†Ø§',
        'language-button': 'ğŸŒ English',
        
        // Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø©
        'page-title': 'Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª',
        'page-subtitle': 'Ø£Ø±ÙÙ‚ÙŠ Ø£ÙŠ Ù†ÙˆØ¹ Ù…Ù„Ù (ØµÙˆØ±ØŒ PDFØŒ ExcelØŒ Wordâ€¦)ØŒ ÙˆØ³ÙŠØªÙ… Ø­ÙØ¸Ù‡ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ.',
        
        // Ø§Ù„ÙÙˆØªÙŠØ±
        'footer-org-name': 'ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„ØµØ­ÙŠ',
        'footer-system-name': 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª',
        'footer-description': 'Ù…Ù†ØµØ© Ø±Ø³Ù…ÙŠØ© Ù„ØªÙ‚Ø¯ÙŠÙ… ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª',
        'footer-links-title': 'Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©',
        'footer-link-home': 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
        'footer-link-submit': 'ØªÙ‚Ø¯ÙŠÙ… Ø¨Ù„Ø§Øº',
        'footer-link-track': 'Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ù„Ø§Øº',
        'footer-link-faq': 'Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©',
        'footer-contact-title': 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„',
        'footer-support-number': 'Ø±Ù‚Ù… Ø§Ù„Ø¯Ø¹Ù…: 0559735137',
        'footer-support-number-2': 'Ø±Ù‚Ù… Ø§Ù„Ø¯Ø¹Ù…: 0542282550',
        'footer-support-email': 'support@makkahhealth.gov.sa',
        'footer-working-hours': 'Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„: 24/7',
        'footer-copyright': 'Â© 2025 ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„ØµØ­ÙŠ â€“ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©'
      },
      en: {
        // Ø§Ù„Ù‡ÙŠØ¯Ø±
        'nav-home': 'Home',
        'nav-dashboard': 'Dashboard',
        'nav-about': 'About System',
        'nav-help': 'Help',
        'nav-contact': 'Contact Us',
        'language-button': 'ğŸŒ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
        
        // Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø©
        'page-title': 'File Archive',
        'page-subtitle': 'Upload any type of file (images, PDF, Excel, Wordâ€¦), and it will be saved in the archive.',
        
        // Ø§Ù„ÙÙˆØªÙŠØ±
        'footer-org-name': 'Makkah Health Cluster',
        'footer-system-name': 'Complaint System',
        'footer-description': 'Official platform for filing and tracking complaints',
        'footer-links-title': 'Quick Links',
        'footer-link-home': 'Home',
        'footer-link-submit': 'Submit Complaint',
        'footer-link-track': 'Track Complaint',
        'footer-link-faq': 'FAQ',
        'footer-contact-title': 'Contact Information',
        'footer-support-number': 'Support Number: 0559735137',
        'footer-support-number-2': 'Support Number: 0542282550',
        'footer-support-email': 'support@makkahhealth.gov.sa',
        'footer-working-hours': 'Working Hours: 24/7',
        'footer-copyright': 'Â© 2025 Makkah Health Cluster â€“ All Rights Reserved'
      }
    };

    // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„ØºØ©
    let currentLanguage = 'ar';

    // Ø¯Ø§Ù„Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±Ø¬Ù…Ø©
    function applyTranslation(lang) {
      const elements = translations[lang];
      if (!elements) return;

      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
      Object.keys(elements).forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = elements[id];
        }
      });
      
      // ØªØºÙŠÙŠØ± Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù†Øµ
      if (lang === 'en') {
        document.documentElement.setAttribute('dir', 'ltr');
        document.documentElement.setAttribute('lang', 'en');
      } else {
        document.documentElement.setAttribute('dir', 'rtl');
        document.documentElement.setAttribute('lang', 'ar');
      }

      currentLanguage = lang;
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', function() {
      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø£Ùˆ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
      const savedLanguage = localStorage.getItem('selectedLanguage') || 'ar';
      applyTranslation(savedLanguage);
      
      // Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ù„ØºØ©
      const languageToggle = document.getElementById('languageToggle');
      if (languageToggle) {
        languageToggle.addEventListener('click', function() {
          const newLang = currentLanguage === 'ar' ? 'en' : 'ar';
          applyTranslation(newLang);
          localStorage.setItem('selectedLanguage', newLang);
        });
      }
    });
  </script>

  <!-- Ù†Ø¸Ø§Ù… Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø§Øª -->
  <script src="../public/assets/js/auth-check.js"></script>
</body>
</html>

