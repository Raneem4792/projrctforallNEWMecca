<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø¥Ø±ÙØ§Ù‚ Ø§Ù„Ø¥ÙƒØ³Ù„ - Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</title>

  <!-- Ø®Ø·ÙˆØ· Ùˆ Tailwind (Ù†ÙØ³ ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©) -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Ù†ÙØ³ Ù…Ù„ÙØ§ØªÙƒ Ø¨Ø§Ù„Ø¶Ø¨Ø· -->
  <link rel="stylesheet" href="../public/assets/css/styles.css" />
  <link rel="stylesheet" href="index.css" />
</head>
<body class="font-[Tajawal] bg-gray-50 text-gray-800">

  <!-- Header - Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
  <header id="navbar" class="fixed w-full top-0 z-50 navbar-scroll" style="background-color: #002B5B;">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <!-- Logo - Ø§Ù„Ø´Ø¹Ø§Ø± -->
        <div class="flex items-center">
          <img src="../public/assets/img/logo3.png" alt="Ø´Ø¹Ø§Ø± ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„ØµØ­ÙŠ" class="h-16 w-auto">
        </div>
        
        <!-- Navigation - Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ†Ù‚Ù„ -->
        <nav class="hidden md:flex items-center space-x-reverse space-x-8">
          <a href="index.html" id="nav-home" class="text-white hover:text-blue-200 transition-colors">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
          <a href="../dashboard/dashboard.html" id="nav-dashboard" class="text-white hover:text-blue-200 transition-colors">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
          <a href="about-system.html" id="nav-about" class="text-white hover:text-blue-200 transition-colors">Ø­ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</a>
          <a href="help.html" id="nav-help" class="text-white hover:text-blue-200 transition-colors">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</a>
          <a href="contact.html" id="nav-contact" class="text-white hover:text-blue-200 transition-colors">Ø§ØªØµÙ„ Ø¨Ù†Ø§</a>
          <button id="languageToggle" class="text-white hover:text-blue-200 transition-colors flex items-center">
            ğŸŒ English
          </button>
        </nav>
        
        <!-- Mobile menu button - Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
        <button class="md:hidden text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- ===== Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© ===== -->
  <main class="max-w-7xl mx-auto px-4 py-10 pt-24">
    <h1 id="page-title" class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">Ø¥Ø±ÙØ§Ù‚ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥ÙƒØ³Ù„</h1>
    <p id="page-subtitle" class="text-gray-600 mb-8">Ø§Ø®ØªÙØ± Ø§Ù„Ù†ÙˆØ¹ Ø«Ù… Ø§Ø±ÙØ¹ Ù…Ù„Ù Excel (XLSX/XLS/CSV). Ø§Ù„ØµÙØ­Ø© Ø¨Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Ø¸Ø§Ù….</p>

    <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-3">

      <!-- Ø§Ù„Ø²Ø§Ø¦Ø± Ø§Ù„Ø³Ø±ÙŠ -->
      <section class="card-hover bg-white rounded-xl shadow-lg border border-gray-100 p-6 animate-fade-in-up">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-5 5-5-5h5V7a5 5 0 10-10 0v5"/>
            </svg>
          </div>
          <h2 id="section2-title" class="text-lg font-semibold">Ø¥ÙƒØ³Ù„ Ø§Ù„Ø²Ø§Ø¦Ø± Ø§Ù„Ø³Ø±ÙŠ</h2>
        </div>

        <div class="space-y-4">
          <a href="./templates/import-mystery.xlsx" id="template2-link" class="text-blue-600 hover:underline text-sm">ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨</a>
          
          <!-- Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹: Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø© + Ø§Ù„ÙØªØ±Ø© -->
          <div class="grid md:grid-cols-3 gap-3 mt-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø©</label>
              <input id="mysteryTicket" type="text" placeholder="Ù…Ø«Ø§Ù„: MS-2025-001"
                     class="w-full border rounded-lg px-3 py-2" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
              <input id="mysteryFrom" type="date" class="w-full border rounded-lg px-3 py-2" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
              <input id="mysteryTo" type="date" class="w-full border rounded-lg px-3 py-2" />
            </div>
          </div>

          <!-- Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ø¹ ÙÙ‚Ø·: Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ -->
          <div id="mysteryExtra" class="mt-3" style="display:none;">
            <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</label>
            <select id="mysteryHospitalId" class="w-full border rounded-lg px-3 py-2" style="display:none;">
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰â€¦</option>
            </select>
            <small id="mysteryHospitalNote" class="text-gray-500" style="display:none;">ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ø¹</small>
          </div>
          

          <!-- Ø­Ù‚ÙˆÙ„ Ø¥Ù„Ø²Ø§Ù…ÙŠØ© Ù„Ù„Ø­ÙØ¸ -->
          <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label for="mysteryTicket" class="block text-sm font-medium text-gray-700 mb-1">Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø© *</label>
              <input type="text" id="mysteryTicket" placeholder="Ù…Ø«Ø§Ù„: TKT-2025-001" 
                     class="w-full border rounded-lg px-3 py-2 text-sm" required>
            </div>
            <div>
              <label for="mysteryFrom" class="block text-sm font-medium text-gray-700 mb-1">Ù…Ù† ØªØ§Ø±ÙŠØ® *</label>
              <input type="date" id="mysteryFrom" 
                     class="w-full border rounded-lg px-3 py-2 text-sm" required>
            </div>
            <div>
              <label for="mysteryTo" class="block text-sm font-medium text-gray-700 mb-1">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® *</label>
              <input type="date" id="mysteryTo" 
                     class="w-full border rounded-lg px-3 py-2 text-sm" required>
            </div>
          </div>
          
          <!-- Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø²Ø§Ø¦Ø± Ø§Ù„Ø³Ø±ÙŠ ÙˆØªØ­Ù„ÙŠÙ„Ù‡ -->
          <div class="mt-4 p-4 rounded-lg bg-gray-50 border border-gray-200">
            <div class="flex items-center justify-between mb-2">
              <label for="mysteryRawText" class="block text-sm font-medium text-gray-700">
                Ù„ØµÙ‚ Ù†Øµ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø²Ø§Ø¦Ø± Ø§Ù„Ø³Ø±ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
              </label>
              <div class="space-x-2 space-x-reverse">
                <button type="button" id="btnAnalyzeMysteryText"
                        class="text-sm px-3 py-1.5 rounded-lg text-white" style="background:#0a56b3">
                  ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ
                </button>
                <button type="button" id="btnSaveMysterySummary"
                        class="text-sm px-3 py-1.5 rounded-lg text-white opacity-80 cursor-not-allowed"
                        style="background:#0b1b30" disabled>
                  Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø®Øµ
                </button>
              </div>
            </div>

            <textarea id="mysteryRawText" rows="6" placeholder="Ø§Ù„ØµÙ‚ Ù‡Ù†Ø§ Ø§Ù„ÙÙ‚Ø±Ø© Ù…Ø«Ù„ Ø§Ù„Ù…Ø«Ø§Ù„ ÙÙŠ Ø±Ø³Ø§Ù„ØªÙƒØŒ Ø«Ù… Ø§Ø¶ØºØ· (ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ)"
                      class="w-full border rounded-lg px-3 py-2 text-sm"></textarea>

            <!-- Ù†ÙØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-3">
              <div class="rounded-lg bg-white border p-3">
                <div class="text-xs text-gray-500">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø·Ø¨Ù‚Ø©</div>
                <div class="text-2xl font-bold text-red-600" id="mysteryUnappliedCount">0</div>
              </div>
              <div class="rounded-lg bg-white border p-3">
                <div class="text-xs text-gray-500">Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…ÙØ¯Ø±Ø¬Ø© Ø¨Ø§Ù„Ø³Ø±Ø¯</div>
                <div class="text-2xl font-bold text-gray-800" id="mysteryItemsCount">0</div>
              </div>
              <div class="rounded-lg bg-white border p-3">
                <div class="text-xs text-gray-500">Ù…Ø¬Ù…ÙˆØ¹ (Ø¹Ø¯Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±)</div>
                <div class="text-2xl font-bold text-gray-800" id="mysteryRepetitionSum">0</div>
              </div>
            </div>
          </div>
          
          <!-- Ø£Ø³ÙÙ„ Ø§Ù„ÙƒØ±ÙˆØª Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ Ø£Ø¶Ù Ø³Ø·Ø± Ø­Ø§Ù„Ø© ØµØºÙŠØ± -->
          <p id="mysterySaveStatus" class="mt-2 text-sm"></p>
          
          <form id="formMystery" class="space-y-3">
            <input type="file" name="file" accept=".xlsx,.xls,.csv" required
                   class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            <div class="flex items-center gap-3">
              <button type="submit" id="upload2-btn" class="px-4 py-2 rounded-lg text-white" style="background:#002B5B">Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù</button>
              <span id="statusMystery" class="text-sm text-gray-500"></span>
            </div>
          </form>
        </div>
      </section>

      <!-- Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
      <section class="card-hover bg-white rounded-xl shadow-lg border border-gray-100 p-6 animate-fade-in-up">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M3 7h18M3 12h18M3 17h18"/>
            </svg>
          </div>
          <h2 id="section3-title" class="text-lg font-semibold">Ø¥ÙƒØ³Ù„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h2>
        </div>

        <div class="space-y-4">
          <a href="./templates/import-departments-template-utf8.csv" id="template3-link" class="text-blue-600 hover:underline text-sm">ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨ (UTF-8)</a>
          
          <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ø¹ -->
          <div id="clusterHospitalWrap" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</label>
            <select id="clusterHospitalSelect" class="w-full border rounded-lg px-3 py-2">
              <option value="">â€” Ø§Ø®ØªØ± Ù…Ø³ØªØ´ÙÙ‰ â€”</option>
            </select>
            <small class="text-gray-500">ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ø¹</small>
          </div>
          
          <form id="formDepts" class="space-y-3">
            <input type="file" name="file" accept=".xlsx,.xls,.csv" required
                   class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            <div class="flex items-center gap-3">
              <button type="submit" id="upload3-btn" class="px-4 py-2 rounded-lg text-white" style="background:#002B5B">Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù</button>
              <span id="statusDepts" class="text-sm text-gray-500"></span>
            </div>
          </form>
          <!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ -->
          <div id="importDeptsResults" class="hidden mt-4 p-4 rounded-lg bg-gray-50 border border-gray-200">
            <h3 class="text-sm font-semibold text-gray-900 mb-2">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:</h3>
            <div class="space-y-1 text-xs text-gray-700">
              <div class="flex justify-between">
                <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙÙˆÙ:</span>
                <span id="resultDeptsTotal" class="font-semibold">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-green-600">âœ“ ØªÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„:</span>
                <span id="resultDeptsInserted" class="font-semibold text-green-600">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-blue-600">ğŸ”„ ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«:</span>
                <span id="resultDeptsUpdated" class="font-semibold text-blue-600">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-yellow-600">âŠ˜ ØªÙ… Ø§Ù„ØªØ®Ø·ÙŠ:</span>
                <span id="resultDeptsSkipped" class="font-semibold text-yellow-600">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-red-600">âœ— Ø£Ø®Ø·Ø§Ø¡:</span>
                <span id="resultDeptsErrors" class="font-semibold text-red-600">0</span>
              </div>
            </div>
            <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ -->
            <div id="resultDeptsDetails" class="mt-3 max-h-40 overflow-y-auto"></div>
          </div>
        </div>
      </section>

      <!-- Ø¨Ù„Ø§ØºØ§Øª 937 -->
      <section class="card-hover bg-white rounded-xl shadow-lg border border-gray-100 p-6 animate-fade-in-up">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 rounded-full bg-green-50 flex items-center justify-center">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
          </div>
          <h2 id="section4-title" class="text-lg font-semibold">Ø¥ÙƒØ³Ù„ Ø¨Ù„Ø§ØºØ§Øª 937</h2>
        </div>

        <div class="space-y-4">
          <a href="./templates/import-937.xlsx" id="template4-link" class="text-blue-600 hover:underline text-sm">ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨</a>
          <form id="form937" class="space-y-3">
            <input type="file" name="file" accept=".xlsx,.xls,.csv" required
                   class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
            <div class="flex items-center gap-3">
              <button type="submit" id="upload4-btn" class="px-4 py-2 rounded-lg text-white" style="background:#059669">Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù</button>
              <span id="status937" class="text-sm text-gray-500"></span>
            </div>
          </form>
          <!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ -->
          <div id="import937Results" class="hidden mt-4 p-4 rounded-lg bg-gray-50 border border-gray-200">
            <h3 class="text-sm font-semibold text-gray-900 mb-2">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:</h3>
            <div class="space-y-1 text-xs text-gray-700">
              <div class="flex justify-between">
                <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙÙˆÙ:</span>
                <span id="result937Total" class="font-semibold">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-green-600">âœ“ ØªÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„:</span>
                <span id="result937Inserted" class="font-semibold text-green-600">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-yellow-600">âŠ˜ ØªÙ… Ø§Ù„ØªØ¹Ø¯Ù‘ÙŠ:</span>
                <span id="result937Skipped" class="font-semibold text-yellow-600">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-purple-600">ğŸ¥ <span id="result-skipped-no-hospital-text">Ø¨Ø¯ÙˆÙ† Ù…Ù†Ø´Ø£Ø©</span>:</span>
                <span id="result937SkippedNoHospital" class="font-semibold text-purple-600">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-orange-600">âš  Ù…ÙƒØ±Ø±:</span>
                <span id="result937Duplicates" class="font-semibold text-orange-600">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-red-600">âœ— Ø£Ø®Ø·Ø§Ø¡:</span>
                <span id="result937Errors" class="font-semibold text-red-600">0</span>
              </div>
            </div>
            <!-- ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© -->
            <div id="result937Details" class="mt-3 max-h-40 overflow-y-auto"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- ===== Ø§Ù„ÙÙˆØªØ± Ù†ÙØ³Ù‡ (Ù…Ù† index.html) ===== -->
  <footer class="bg-gray-900 text-white py-14">
    <div class="container mx-auto px-4">
      <div class="grid md:grid-cols-3 gap-8">
        <!-- Column 1 - Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ -->
        <div>
          <div class="flex items-center space-x-reverse space-x-3 mb-4">
            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 2L2 7v10c0 5.55 3.84 9.74 9 11 5.16-1.26 9-5.45 9-11V7l-10-5z"/>
              </svg>
            </div>
            <div>
              <div id="footer-org-name" class="font-bold">ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„ØµØ­ÙŠ</div>
              <div id="footer-system-name" class="text-sm text-gray-300">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</div>
            </div>
          </div>
          <p id="footer-description" class="text-gray-300 text-sm">Ù…Ù†ØµØ© Ø±Ø³Ù…ÙŠØ© Ù„ØªÙ‚Ø¯ÙŠÙ… ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</p>
        </div>

        <!-- Column 2 - Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ -->
        <div>
          <h3 id="footer-links-title" class="font-bold mb-4">Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©</h3>
          <ul class="space-y-2 text-sm">
            <li><a href="index.html" id="footer-link-home" class="text-gray-300 hover:text-white hover:underline transition-colors">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
            <li><a href="../public/complaints/submit/submit-complaint.html" id="footer-link-submit" class="text-gray-300 hover:text-white hover:underline transition-colors">ØªÙ‚Ø¯ÙŠÙ… Ø¨Ù„Ø§Øº</a></li>
            <li><a href="../public/complaints/track/track-complaint.html" id="footer-link-track" class="text-gray-300 hover:text-white hover:underline transition-colors">Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ù„Ø§Øº</a></li>
            <li><a href="help.html" id="footer-link-faq" class="text-gray-300 hover:text-white hover:underline transition-colors">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©</a></li>
          </ul>
        </div>

        <!-- Column 3 - Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù„Ø« -->
        <div>
          <h3 id="footer-contact-title" class="font-bold mb-4">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</h3>
          <div class="space-y-2 text-sm text-gray-300">
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
              <span id="footer-support-number">Ø±Ù‚Ù… Ø§Ù„Ø¯Ø¹Ù…: 0559735137</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
              <span id="footer-support-number-2">Ø±Ù‚Ù… Ø§Ù„Ø¯Ø¹Ù…: 0542282550</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
              <span id="footer-support-email">support@makkahhealth.gov.sa</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span id="footer-working-hours">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„: 24/7</span>
            </div>
          </div>
        </div>
      </div>

      <div class="border-t border-gray-700 mt-8 pt-8 text-center text-sm text-gray-300">
        <span id="footer-copyright">Â© 2025 ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„ØµØ­ÙŠ â€“ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</span>
      </div>
    </div>
  </footer>

  <!-- Ù†ÙØ³ Ø³ÙƒØ±Ø¨ØªØ§ØªÙƒ -->
  <script src="index.js"></script>
  <script>
    // Ø±Ø¨Ø· Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø¨Ø§Ù„Ù†Ù‡Ø§ÙŠØ§Øª
    const API_BASE = (location.hostname==='localhost'||location.hostname==='127.0.0.1') ? 'http://localhost:3001' : '';
    const token = localStorage.getItem('token') || localStorage.getItem('authToken');

    // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¯ÙŠØ± ØªØ¬Ù…Ø¹
    function isClusterManager() {
      try {
        const u = JSON.parse(localStorage.getItem('userData') || '{}');
        return u.RoleID === 1 || u.IsClusterManager === true; // Ø¹Ø¯Ù‘Ù„ Ø­Ø³Ø¨ Ù†Ø¸Ø§Ù…Ùƒ
      } catch { return false; }
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø®Ø§Ù†Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    async function initMysteryHospitalField() {
      const hospitalSelect = document.getElementById('mysteryHospitalId');
      const hospitalNote = document.getElementById('mysteryHospitalNote');
      const mysteryExtra = document.getElementById('mysteryExtra');
      
      if (!hospitalSelect || !mysteryExtra) return;

      try {
        // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const token = localStorage.getItem('token') || localStorage.getItem('authToken');
        const res = await fetch(`${API_BASE}/api/auth/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!res.ok) {
          console.warn('[initMysteryHospitalField] API response not OK:', res.status);
          return;
        }
        
        const user = await res.json();
        console.log('[initMysteryHospitalField] User data:', user);
        
        const isCM = user?.RoleID === 1 || user?.isClusterManager === true || user?.role?.isClusterManager === true;
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ HospitalID Ù…Ù† Ù…ØµØ§Ø¯Ø± Ù…ØªØ¹Ø¯Ø¯Ø©
        let userHospitalId = user?.HospitalID || user?.hospitalId || user?.Hospital?.id || null;
        
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ APIØŒ Ø¬Ø±Ø¨ localStorage
        if (!userHospitalId) {
          try {
            const userDataStr = localStorage.getItem('userData');
            if (userDataStr) {
              const userData = JSON.parse(userDataStr);
              userHospitalId = userData?.HospitalID || userData?.hospitalId || null;
            }
          } catch (e) {
            console.warn('[initMysteryHospitalField] Failed to parse userData from localStorage:', e);
          }
        }
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®ÙŠØ±Ø©: Ù…Ù† localStorage Ù…Ø¨Ø§Ø´Ø±Ø©
        if (!userHospitalId) {
          const storedHospitalId = localStorage.getItem('hospitalId');
          if (storedHospitalId) {
            userHospitalId = parseInt(storedHospitalId, 10);
          }
        }
        
        console.log('[initMysteryHospitalField] Final hospitalId:', userHospitalId, 'isCM:', isCM);

        if (isCM) {
          // Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ø¹: Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
          mysteryExtra.style.display = 'block';
          hospitalSelect.style.display = 'block';
          if (hospitalNote) hospitalNote.style.display = 'block';
          
          // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª
          await loadHospitalsForMysterySelect();
        } else {
          // Ù…ÙˆØ¸Ù Ù…Ø³ØªØ´ÙÙ‰: Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰
          mysteryExtra.style.display = 'block';
          hospitalSelect.style.display = 'none';
          if (hospitalNote) hospitalNote.style.display = 'none';
          
          // Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰
          const hospitalName = localStorage.getItem('hospitalNameAr') || 'Ù…Ø³ØªØ´ÙÙ‰ ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
          
          // Ø¥Ù†Ø´Ø§Ø¡ label Ù„Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰
          const autoLabel = document.createElement('div');
          autoLabel.className = 'text-gray-700 mt-2 font-semibold';
          autoLabel.innerHTML = `ğŸ“ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰: <span class="text-blue-600">${hospitalName}</span>`;
          
          // Ø¥Ø¯Ø±Ø§Ø¬ Label Ù‚Ø¨Ù„ select
          if (hospitalSelect.parentNode) {
            hospitalSelect.parentNode.insertBefore(autoLabel, hospitalSelect);
          }
          
          // Ø­ÙØ¸ HospitalID ÙÙŠ Ù…ØªØºÙŠØ± Ø¹Ø§Ù…
          window.currentMysteryHospitalId = userHospitalId;
          
          console.log('[initMysteryHospitalField] Saved hospitalId for employee:', window.currentMysteryHospitalId);
          
          // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ HospitalIDØŒ Ø£Ø¸Ù‡Ø± ØªØ­Ø°ÙŠØ±
          if (!userHospitalId) {
            console.error('[initMysteryHospitalField] âš ï¸ HospitalID is null for non-cluster manager user!');
            autoLabel.innerHTML += ' <span class="text-red-600 text-xs">âš ï¸ ØªØ­Ø°ÙŠØ±: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</span>';
          }
        }
      } catch (err) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø­Ù‚Ù„ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰:', err);
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ø¹
    async function loadHospitalsForMysterySelect() {
      const sel = document.getElementById('mysteryHospitalId');
      if (!sel) return;

      const token = localStorage.getItem('token') || localStorage.getItem('authToken');
      try {
        const res = await fetch(`${API_BASE}/api/central/hospitals?active=1`, {
          headers: { 'Authorization': `Bearer ${token || ''}` }
        });
        if (!res.ok) return;

        const list = await res.json();
        sel.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ù…Ø³ØªØ´ÙÙ‰ â€”</option>';
        
        list
          .sort((a, b) => (a?.NameAr || '').localeCompare(b?.NameAr || '', 'ar'))
          .forEach(h => {
            const opt = document.createElement('option');
            opt.value = h.HospitalID;
            opt.textContent = `${h.NameAr || h.NameEn} ${h.Code ? '('+h.Code+')' : ''}`;
            sel.appendChild(opt);
          });
      } catch (error) {
        console.error('Error loading hospitals:', error);
      }
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', async () => {
      await initMysteryHospitalField();
    });

    function wireForm(formId, statusId, endpoint){
      const form = document.getElementById(formId);
      const status = document.getElementById(statusId);
      if(!form) return;

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const file = form.querySelector('input[type=file]').files[0];
        if(!file){ status.textContent='Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù.'; status.className='text-red-600 text-sm'; return; }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ© Ù„Ù„Ø²Ø§Ø¦Ø± Ø§Ù„Ø³Ø±ÙŠ
        if(endpoint.includes('/imports/mystery')) {
          const ticket = document.getElementById('mysteryTicket')?.value?.trim();
          const dateFrom = document.getElementById('mysteryFrom')?.value;
          const dateTo = document.getElementById('mysteryTo')?.value;
          if (!ticket || !dateFrom || !dateTo) {
            status.textContent='Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø© ÙˆØ§Ù„ÙØªØ±Ø© (Ù…Ù†/Ø¥Ù„Ù‰).';
            status.className='text-red-600 text-sm';
            return;
          }
          
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰
        let selectedHospitalId;
        if (isClusterManager()) {
          selectedHospitalId = document.getElementById('mysteryHospitalId')?.value;
          if (!selectedHospitalId) {
            status.textContent='Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ (Ù„Ø£Ù†Ùƒ Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ø¹).';
            status.className='text-red-600 text-sm';
            return;
          }
        } else {
          selectedHospitalId = window.currentMysteryHospitalId;
          if (!selectedHospitalId) {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®ÙŠØ±Ø©: Ø¬Ù„Ø¨ Ù…Ù† localStorage
            try {
              const userDataStr = localStorage.getItem('userData');
              if (userDataStr) {
                const userData = JSON.parse(userDataStr);
                selectedHospitalId = userData?.HospitalID || userData?.hospitalId || null;
              }
            } catch (e) {
              console.warn('Failed to get hospitalId from localStorage:', e);
            }
            
            if (!selectedHospitalId) {
              const storedHospId = localStorage.getItem('hospitalId');
              if (storedHospId) {
                selectedHospitalId = parseInt(storedHospId, 10);
              }
            }
            
            if (!selectedHospitalId) {
              status.textContent='Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¯Ø¹Ù….';
              status.className='text-red-600 text-sm';
              console.error('[wireForm] HospitalID is missing for employee user');
              return;
            }
          }
        }
        }
        
        status.textContent='Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...'; status.className='text-gray-500 text-sm';

        const fd = new FormData(); fd.append('file', file);
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø²Ø§Ø¦Ø± Ø§Ù„Ø³Ø±ÙŠ
        if(endpoint.includes('/imports/mystery')) {
          const ticket = document.getElementById('mysteryTicket')?.value?.trim();
          const dateFrom = document.getElementById('mysteryFrom')?.value;
          const dateTo = document.getElementById('mysteryTo')?.value;
          
          fd.append('ticketNumber', ticket);
          fd.append('dateFrom', dateFrom);
          fd.append('dateTo', dateTo);
          
          // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰
          let selectedHospitalId;
          if (isClusterManager()) {
            selectedHospitalId = document.getElementById('mysteryHospitalId')?.value;
          } else {
            selectedHospitalId = window.currentMysteryHospitalId;
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®ÙŠØ±Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if (!selectedHospitalId) {
              try {
                const userDataStr = localStorage.getItem('userData');
                if (userDataStr) {
                  const userData = JSON.parse(userDataStr);
                  selectedHospitalId = userData?.HospitalID || userData?.hospitalId || null;
                }
              } catch (e) {
                console.warn('Failed to get hospitalId from localStorage in FormData:', e);
              }
              
              if (!selectedHospitalId) {
                const storedHospId = localStorage.getItem('hospitalId');
                if (storedHospId) {
                  selectedHospitalId = parseInt(storedHospId, 10);
                }
              }
            }
          }
          
          if (selectedHospitalId) {
            fd.append('hospitalId', selectedHospitalId);
            console.log('[wireForm] Sending hospitalId:', selectedHospitalId);
          } else {
            console.error('[wireForm] âš ï¸ No hospitalId to send!');
          }
        }
        
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        
        try{
          const res = await fetch(`${API_BASE}${endpoint}`, {
            method:'POST',
            headers,
            body: fd
          });
          const data = await res.json().catch(()=>({}));
          if(!res.ok) throw new Error(data?.message || `HTTP ${res.status}`);
          
          // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø§ØµØ© Ù„Ù€ mystery imports
          if(endpoint.includes('/imports/mystery') && data.inserted !== undefined) {
            status.textContent = `ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${data.inserted} Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­.`;
            if(data.skipped > 0) status.textContent += ` ØªÙ… ØªØ®Ø·ÙŠ ${data.skipped} Ø³Ø·Ø±.`;
            status.className='text-green-600 text-sm';
          } else {
            status.textContent = 'ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙˆØ³ÙŠØªÙ… Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©.'; 
            status.className='text-green-600 text-sm';
          }
        }catch(err){
          status.textContent = 'ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: ' + err.message; status.className='text-red-600 text-sm';
        }
      });
    }

    wireForm('formMystery', 'statusMystery', '/api/imports/mystery');

    // === helpers ===
    function getToken() {
      const t = localStorage.getItem('token');
      return t && t.startsWith('Bearer ') ? t : `Bearer ${t || ''}`;
    }
    
    function isClusterManager(me) {
      return me?.RoleKey === 'CLUSTER_MANAGER' || me?.RoleID === 1 || me?.IsClusterManager === 1;
    }
    
    async function getMe() {
      const res = await fetch(`${API_BASE}/api/auth/me`, { 
        headers: { Authorization: getToken() } 
      });
      if (!res.ok) throw new Error(`auth/me ${res.status}`);
      return res.json();
    }
    
    async function fetchHospitalsActive() {
      const res = await fetch(`${API_BASE}/api/hospitals?active=1`, { 
        headers: { Authorization: getToken() } 
      });
      if (!res.ok) throw new Error(`hospitals ${res.status}`);
      // Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø¬Ø³Ù… Array Ø£Ùˆ {data:[...]} Ø£Ùˆ {results:[...]}
      const body = await res.json().catch(() => ({}));
      const list = Array.isArray(body)
        ? body
        : Array.isArray(body.data)
          ? body.data
          : Array.isArray(body.results)
            ? body.results
            : [];
      return list;
    }

    // === UI init ===
    async function initHospitalSelectForCluster() {
      const me = await getMe().catch(e => {
        console.warn('getMe failed:', e);
        return null;
      });
      if (!isClusterManager(me)) return; // Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ: Ù„Ø§ Ø´ÙŠØ¡

      const wrap = document.getElementById('clusterHospitalWrap');
      const sel = document.getElementById('clusterHospitalSelect');
      const hint = document.getElementById('clusterHospitalHint');
      if (!wrap || !sel) return;

      wrap.classList.remove('hidden');
      sel.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ù…Ø³ØªØ´ÙÙ‰ â€”</option>';

      try {
        const hospitals = await fetchHospitalsActive(); // <= Ù‡Ù†Ø§ Ù…Ø§ Ø¹Ø§Ø¯ Ù†Ø³ØªØ®Ø¯Ù… body.data Ù…Ø¨Ø§Ø´Ø±Ø©
        // Ù„Ùˆ Ø±Ø¬Ø¹ ÙØ§Ø¶ÙŠØŒ Ø£Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ÙˆÙ„Ø§ ØªÙ†ÙØ° sort Ø¹Ù„Ù‰ undefined
        if (!Array.isArray(hospitals) || hospitals.length === 0) {
          hint.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªØ´ÙÙŠØ§Øª Ù…ÙØ¹Ù‘Ù„Ø© Ø£Ùˆ Ù„Ø§ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¹Ø±Ø¶Ù‡Ø§.';
          return;
        }

        hospitals
          .sort((a, b) => (a?.NameAr || '').localeCompare(b?.NameAr || '', 'ar'))
          .forEach(h => {
            const opt = document.createElement('option');
            opt.value = h.HospitalID;
            opt.textContent = h.NameAr || h.NameEn || `Hospital #${h.HospitalID}`;
            sel.appendChild(opt);
          });
      } catch (err) {
        console.error('init hospitals error:', err);
        hint.textContent = 'ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª (ØªØ­Ù‚Ù‚ÙŠ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ†/Ø§Ù„Ø§ØªØµØ§Ù„).';
      }
    }

    // === Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³Ø§Ø± Ø§Ù„Ø±ÙØ¹ ===
    function getDepartmentsImportUrl() {
      const sel = document.getElementById('clusterHospitalSelect');
      // Ù„Ùˆ Ø§Ù„Ø¸Ø§Ù‡Ø± ÙˆÙ…Ø®ØªØ§Ø± Ù‚ÙŠÙ…Ø©ØŒ Ø£Ù„Ø­Ù‚ÙŠ ?hospitalId=
      if (sel && !sel.classList.contains('hidden') && sel.value) {
        return `/api/imports/departments?hospitalId=${encodeURIComponent(sel.value)}`;
      }
      return '/api/imports/departments'; // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ: Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ£Ø®Ø° Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ†
    }

    // Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…Ø¹ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
    const formDepts = document.getElementById('formDepts');
    const statusDepts = document.getElementById('statusDepts');
    const resultsDepts = document.getElementById('importDeptsResults');
    
    if (formDepts) {
      formDepts.addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = formDepts.querySelector('input[type=file]').files[0];
        if (!file) {
          statusDepts.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù.';
          statusDepts.className = 'text-red-600 text-sm';
          return;
        }
        
        statusDepts.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
        statusDepts.className = 'text-gray-500 text-sm';
        resultsDepts.classList.add('hidden');

        const fd = new FormData();
        fd.append('file', file);
        
        try {
          const url = getDepartmentsImportUrl();
          const res = await fetch(`${API_BASE}${url}`, {
            method: 'POST',
            headers: token ? { 'Authorization': `Bearer ${token}` } : {},
            body: fd
          });
          
          const data = await res.json();
          
          if (!res.ok) {
            throw new Error(data?.message || `HTTP ${res.status}`);
          }
          
          // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
          statusDepts.textContent = 'Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯!';
          statusDepts.className = 'text-green-600 text-sm';
          
          // Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          document.getElementById('resultDeptsTotal').textContent = (data.inserted || 0) + (data.updated || 0);
          document.getElementById('resultDeptsInserted').textContent = data.inserted || 0;
          document.getElementById('resultDeptsUpdated').textContent = data.updated || 0;
          document.getElementById('resultDeptsSkipped').textContent = data.skipped || 0;
          document.getElementById('resultDeptsErrors').textContent = data.errors || 0;
          
          // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
          const detailsDiv = document.getElementById('resultDeptsDetails');
          detailsDiv.innerHTML = '';
          
          if (data.errorDetails && data.errorDetails.length > 0) {
            const errorsHtml = '<div class="mt-2"><p class="text-xs font-semibold text-red-700 mb-1">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:</p><ul class="text-xs text-gray-600 space-y-1">' +
              data.errorDetails.map(e => `<li>â€¢ ${e}</li>`).join('') +
              '</ul></div>';
            detailsDiv.innerHTML += errorsHtml;
          }
          
          resultsDepts.classList.remove('hidden');
          
        } catch (err) {
          statusDepts.textContent = 'ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: ' + err.message;
          statusDepts.className = 'text-red-600 text-sm';
        }
      });
    }

    // === bootstrap ===
    async function init() {
      await initHospitalSelectForCluster();
      // Ù…Ù‡Ù…: Ù…Ø±Ù‘Ø±ÙŠ "Ø¯Ø§Ù„Ø©" ØªØ±Ø¬Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ø­Ø¸Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
      // wireForm('formDepts', 'statusDepts', getDepartmentsImportUrl);
    }
    
    init().catch(console.error);

    // ØªØ´Ø®ÙŠØµ Ø³Ø±ÙŠØ¹ Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    window.debugDepartmentsImport = async () => {
      try {
        const me = await getMe();
        console.log('me =', me);
        const sel = document.getElementById('clusterHospitalSelect');
        console.log('selected hospitalId =', sel ? sel.value : null);
        console.log('isClusterManager =', isClusterManager(me));
        console.log('import URL =', getDepartmentsImportUrl());
        
        // Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª
        try {
          const hospitals = await fetchHospitalsActive();
          console.log('hospitals loaded =', hospitals.length, hospitals);
        } catch (err) {
          console.error('hospitals fetch failed:', err);
        }
      } catch (error) {
        console.error('Debug error:', error);
      }
    };

    // Ù†Ù…ÙˆØ°Ø¬ 937 Ù…Ø¹ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
    const form937 = document.getElementById('form937');
    const status937 = document.getElementById('status937');
    const results937 = document.getElementById('import937Results');
    
    if (form937) {
      form937.addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = form937.querySelector('input[type=file]').files[0];
        if (!file) {
          status937.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù.';
          status937.className = 'text-red-600 text-sm';
          return;
        }
        
        status937.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
        status937.className = 'text-gray-500 text-sm';
        results937.classList.add('hidden');

        const fd = new FormData();
        fd.append('file', file);
        
        try {
          const res = await fetch(`${API_BASE}/api/imports/937`, {
            method: 'POST',
            headers: token ? { 'Authorization': `Bearer ${token}` } : {},
            body: fd
          });
          
          const data = await res.json();
          
          if (!res.ok) {
            throw new Error(data?.message || `HTTP ${res.status}`);
          }
          
          // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
          status937.textContent = 'Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯!';
          status937.className = 'text-green-600 text-sm';
          
          // Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          document.getElementById('result937Total').textContent = data.total || 0;
          document.getElementById('result937Inserted').textContent = data.inserted || 0;
          document.getElementById('result937Skipped').textContent = data.skipped || 0;
          document.getElementById('result937SkippedNoHospital').textContent = data.skippedNoHospital || 0;
          document.getElementById('result937Duplicates').textContent = data.duplicates || 0;
          document.getElementById('result937Errors').textContent = data.errors || 0;
          
          // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…ØªØ¹Ø¯Ù‘Ù‰ Ø¹Ù„ÙŠÙ‡Ø§ ÙˆØ§Ù„Ø£Ø®Ø·Ø§Ø¡
          const detailsDiv = document.getElementById('result937Details');
          detailsDiv.innerHTML = '';
          
          if (data.skippedRows && data.skippedRows.length > 0) {
            const skippedHtml = '<div class="mt-2"><p class="text-xs font-semibold text-yellow-700 mb-1">ØµÙÙˆÙ Ù…ØªØ¹Ø¯Ù‘Ù‰ Ø¹Ù„ÙŠÙ‡Ø§:</p><ul class="text-xs text-gray-600 space-y-1">' +
              data.skippedRows.slice(0, 10).map(s => 
                `<li>â€¢ ØµÙ ${s.rowNumber}: ${s.reason} ${s.hospitalName ? `(${s.hospitalName})` : ''}</li>`
              ).join('') +
              (data.skippedRows.length > 10 ? `<li class="text-gray-400">... Ùˆ ${data.skippedRows.length - 10} Ø£Ø®Ø±Ù‰</li>` : '') +
              '</ul></div>';
            detailsDiv.innerHTML += skippedHtml;
          }
          
          if (data.errorRows && data.errorRows.length > 0) {
            const errorsHtml = '<div class="mt-2"><p class="text-xs font-semibold text-red-700 mb-1">Ø£Ø®Ø·Ø§Ø¡:</p><ul class="text-xs text-gray-600 space-y-1">' +
              data.errorRows.slice(0, 10).map(e => 
                `<li>â€¢ ØµÙ ${e.rowNumber}: ${e.reason}</li>`
              ).join('') +
              (data.errorRows.length > 10 ? `<li class="text-gray-400">... Ùˆ ${data.errorRows.length - 10} Ø£Ø®Ø±Ù‰</li>` : '') +
              '</ul></div>';
            detailsDiv.innerHTML += errorsHtml;
          }
          
          results937.classList.remove('hidden');
          
        } catch (err) {
          status937.textContent = 'ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: ' + err.message;
          status937.className = 'text-red-600 text-sm';
        }
      });
    }
  </script>

  <!-- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ±Ø¬Ù…Ø© -->
  <script>
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ±Ø¬Ù…Ø©
    const translations = {
      ar: {
        // Ø§Ù„Ù‡ÙŠØ¯Ø±
        'nav-home': 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
        'nav-dashboard': 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…',
        'nav-profile': 'Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ',
        'nav-about': 'Ø­ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…',
        'nav-help': 'Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©',
        'nav-contact': 'Ø§ØªØµÙ„ Ø¨Ù†Ø§',
        'language-button': 'ğŸŒ English',
        
        // Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø©
        'page-title': 'Ø¥Ø±ÙØ§Ù‚ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥ÙƒØ³Ù„',
        'page-subtitle': 'Ø§Ø®ØªÙØ± Ø§Ù„Ù†ÙˆØ¹ Ø«Ù… Ø§Ø±ÙØ¹ Ù…Ù„Ù Excel (XLSX/XLS/CSV). Ø§Ù„ØµÙØ­Ø© Ø¨Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Ø¸Ø§Ù….',
        'section2-title': 'Ø¥ÙƒØ³Ù„ Ø§Ù„Ø²Ø§Ø¦Ø± Ø§Ù„Ø³Ø±ÙŠ',
        'section3-title': 'Ø¥ÙƒØ³Ù„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…',
        'section4-title': 'Ø¥ÙƒØ³Ù„ Ø¨Ù„Ø§ØºØ§Øª 937',
        'template2-link': 'ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨',
        'template3-link': 'ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨',
        'template4-link': 'ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨',
        'upload2-btn': 'Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù',
        'upload3-btn': 'Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù',
        'upload4-btn': 'Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù',
        
        // Ø§Ù„ÙÙˆØªÙŠØ±
        'footer-org-name': 'ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„ØµØ­ÙŠ',
        'footer-system-name': 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª',
        'footer-description': 'Ù…Ù†ØµØ© Ø±Ø³Ù…ÙŠØ© Ù„ØªÙ‚Ø¯ÙŠÙ… ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª',
        'footer-links-title': 'Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©',
        'footer-link-home': 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
        'footer-link-submit': 'ØªÙ‚Ø¯ÙŠÙ… Ø¨Ù„Ø§Øº',
        'footer-link-track': 'Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ù„Ø§Øº',
        'footer-link-faq': 'Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©',
        'footer-contact-title': 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„',
        'footer-support-number': 'Ø±Ù‚Ù… Ø§Ù„Ø¯Ø¹Ù…: 0559735137',
        'footer-support-number-2': 'Ø±Ù‚Ù… Ø§Ù„Ø¯Ø¹Ù…: 0542282550',
        'footer-support-email': 'support@makkahhealth.gov.sa',
        'footer-working-hours': 'Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„: 24/7',
        'footer-copyright': 'Â© 2025 ØªØ¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„ØµØ­ÙŠ â€“ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©',
        
        // Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
        'result-skipped-no-hospital': 'Ø¨Ø¯ÙˆÙ† Ù…Ù†Ø´Ø£Ø©',
        'result-depts-total': 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙÙˆÙ',
        'result-depts-inserted': 'ØªÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„',
        'result-depts-updated': 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«',
        'result-depts-skipped': 'ØªÙ… Ø§Ù„ØªØ®Ø·ÙŠ',
        'result-depts-errors': 'Ø£Ø®Ø·Ø§Ø¡',
        'result-depts-details': 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡'
      },
      en: {
        // Ø§Ù„Ù‡ÙŠØ¯Ø±
        'nav-home': 'Home',
        'nav-dashboard': 'Dashboard',
        'nav-profile': 'My Profile',
        'nav-about': 'About System',
        'nav-help': 'Help',
        'nav-contact': 'Contact Us',
        'language-button': 'ğŸŒ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
        
        // Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø©
        'page-title': 'Excel File Upload',
        'page-subtitle': 'Choose the type then upload Excel file (XLSX/XLS/CSV). Page uses same system format.',
        'section2-title': 'Mystery Shopper Excel',
        'section3-title': 'Departments Excel',
        'section4-title': '937 Complaints Excel',
        'template2-link': 'Download Template',
        'template3-link': 'Download Template',
        'template4-link': 'Download Template',
        'upload2-btn': 'Upload File',
        'upload3-btn': 'Upload File',
        'upload4-btn': 'Upload File',
        
        // Ø§Ù„ÙÙˆØªÙŠØ±
        'footer-org-name': 'Makkah Health Cluster',
        'footer-system-name': 'Complaint System',
        'footer-description': 'Official platform for filing and tracking complaints',
        'footer-links-title': 'Quick Links',
        'footer-link-home': 'Home',
        'footer-link-submit': 'Submit Complaint',
        'footer-link-track': 'Track Complaint',
        'footer-link-faq': 'FAQ',
        'footer-contact-title': 'Contact Information',
        'footer-support-number': 'Support Number: 0559735137',
        'footer-support-number-2': 'Support Number: 0542282550',
        'footer-support-email': 'support@makkahhealth.gov.sa',
        'footer-working-hours': 'Working Hours: 24/7',
        'footer-copyright': 'Â© 2025 Makkah Health Cluster â€“ All Rights Reserved',
        
        // Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
        'result-skipped-no-hospital': 'No Facility',
        'result-depts-total': 'Total Rows',
        'result-depts-inserted': 'Inserted',
        'result-depts-updated': 'Updated',
        'result-depts-skipped': 'Skipped',
        'result-depts-errors': 'Errors',
        'result-depts-details': 'Error Details'
      }
    };

    // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„ØºØ©
    let currentLanguage = 'ar';

    // Ø¯Ø§Ù„Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±Ø¬Ù…Ø©
    function applyTranslation(lang) {
      const elements = translations[lang];
      if (!elements) return;

      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
      Object.keys(elements).forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = elements[id];
        }
      });
      
      // ØªØ·Ø¨ÙŠÙ‚ ØªØ±Ø¬Ù…Ø© Ø®Ø§ØµØ© Ù„Ù„Ù†Øµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¹Ù†ØµØ±
      const skippedNoHospitalText = document.getElementById('result-skipped-no-hospital-text');
      if (skippedNoHospitalText && elements['result-skipped-no-hospital']) {
        skippedNoHospitalText.textContent = elements['result-skipped-no-hospital'];
      }

      // ØªØºÙŠÙŠØ± Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù†Øµ
      if (lang === 'en') {
        document.documentElement.setAttribute('dir', 'ltr');
        document.documentElement.setAttribute('lang', 'en');
        // ØªØºÙŠÙŠØ± Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ù†ØµÙˆØµ Ù„Ù„Ø¹Ø±Ø¨ÙŠØ©
        document.querySelectorAll('[id^="page"], [id^="section"]').forEach(el => {
          el.classList.remove('text-right', 'lg:text-right');
          el.classList.add('text-left', 'lg:text-left');
        });
      } else {
        document.documentElement.setAttribute('dir', 'rtl');
        document.documentElement.setAttribute('lang', 'ar');
        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ù†ØµÙˆØµ Ù„Ù„Ø¹Ø±Ø¨ÙŠØ©
        document.querySelectorAll('[id^="page"], [id^="section"]').forEach(el => {
          el.classList.remove('text-left', 'lg:text-left');
          el.classList.add('text-right', 'lg:text-right');
        });
      }

      currentLanguage = lang;
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', function() {
      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø£Ùˆ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
      const savedLanguage = localStorage.getItem('selectedLanguage') || 'ar';
      applyTranslation(savedLanguage);
      
      // Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ù„ØºØ©
      const languageToggle = document.getElementById('languageToggle');
      if (languageToggle) {
        languageToggle.addEventListener('click', function() {
          const newLang = currentLanguage === 'ar' ? 'en' : 'ar';
          applyTranslation(newLang);
          localStorage.setItem('selectedLanguage', newLang);
        });
      }
    });
  </script>


  <!-- ØªØ­Ù„ÙŠÙ„ Ù†Øµ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø²Ø§Ø¦Ø± Ø§Ù„Ø³Ø±ÙŠ -->
  <script>
    // â€”â€”â€”â€”â€” ØªØ­Ù„ÙŠÙ„ Ù†Øµ Ø§Ù„Ø²Ø§Ø¦Ø± Ø§Ù„Ø³Ø±ÙŠ â€”â€”â€”â€”â€”
    function parseMysteryText(raw) {
      if (!raw) return { unappliedCount: 0, itemCount: 0, repetitionSum: 0 };

      const text = raw.replace(/\r/g, '').trim();

      // 1) Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙ‚Ø§Ø· Ø±Ù‚Ù… ÙÙŠ Ø³Ø·Ø± Ù…Ø³ØªÙ‚Ù„ Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
      // Ù…Ø«Ø§Ù„Ùƒ ÙŠØ­ØªÙˆÙŠ "29" ÙÙŠ Ø³Ø·Ø± Ù…Ù†ÙØµÙ„ Ù‚Ø¨Ù„ Ø³Ø·Ø± "Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØºÙŠØ± Ù…Ø·Ø¨Ù‚Ø©..."
      let unappliedCount = 0;
      const lines = text.split('\n').map(l => l.trim()).filter(Boolean);

      // Ø§Ù„ØªÙ‚Ø· Ø£ÙˆÙ„ Ø±Ù‚Ù… ÙŠØ¸Ù‡Ø± ÙÙŠ Ø³Ø·Ø± Ù…Ø³ØªÙ‚Ù„
      for (let i = 0; i < Math.min(5, lines.length); i++) {
        const m = lines[i].match(/^\s*(\d+)\s*$/);
        if (m) { unappliedCount = parseInt(m[1], 10); break; }
        // Ø£Ùˆ Ø±Ù‚Ù… Ø¯Ø§Ø®Ù„ Ø³Ø·Ø± Ø¹Ù†ÙˆØ§Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ø¨Ø§Ø±Ø© "Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØºÙŠØ± Ù…Ø·Ø¨Ù‚Ø©"
        if (/Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª\s+Ø§Ù„ØºÙŠØ±\s+Ù…Ø·Ø¨Ù‚Ø©/i.test(lines[i])) {
          const m2 = lines[i].match(/(\d+)/);
          if (m2) { unappliedCount = parseInt(m2[1], 10); break; }
        }
      }

      // 2) Ø¹Ø¯Ù‘ Ø§Ù„Ø¨Ù†ÙˆØ¯ (Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø°ÙŠ ÙŠØ¨Ø¯Ø£ Ø¨Ù€ "ÙÙŠ ")
      const itemLines = lines.filter(l => /^ÙÙŠ\s/.test(l));
      const itemCount = itemLines.length;

      // 3) Ù…Ø¬Ù…ÙˆØ¹ "Ø¹Ø¯Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø± = n"
      let repetitionSum = 0;
      const repRegex = /Ø¹Ø¯Ø¯\s*Ø§Ù„ØªÙƒØ±Ø§Ø±\s*=\s*(\d+)/g;
      let m;
      while ((m = repRegex.exec(text)) !== null) {
        repetitionSum += parseInt(m[1], 10);
      }

      // ÙÙŠ Ø­Ø§Ù„ Ù…Ø§ Ù‚Ø¯Ø± ÙŠÙ„ØªÙ‚Ø· Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØŒ Ù†Ø­Ø· Ø¨Ø¯ÙŠÙ„ Ù…Ù†Ø·Ù‚ÙŠ
      if (!unappliedCount) {
        // Ø¨Ø¯ÙŠÙ„: Ø§Ø¹ØªØ¨Ø± Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù‡Ùˆ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø£Ø¶Ø¹Ù Ø§Ù„Ø¥ÙŠÙ…Ø§Ù†)
        unappliedCount = itemCount;
      }

      return { unappliedCount, itemCount, repetitionSum };
    }

    function renderMysteryStats(stats) {
      const c1 = document.getElementById('mysteryUnappliedCount');
      const c2 = document.getElementById('mysteryItemsCount');
      const c3 = document.getElementById('mysteryRepetitionSum');
      if (c1) c1.textContent = stats.unappliedCount || 0;
      if (c2) c2.textContent = stats.itemCount || 0;
      if (c3) c3.textContent = stats.repetitionSum || 0;
    }

    // Ø²Ø± "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ"
    document.getElementById('btnAnalyzeMysteryText')?.addEventListener('click', () => {
      const raw = document.getElementById('mysteryRawText')?.value || '';
      const stats = parseMysteryText(raw);
      renderMysteryStats(stats);
    });

    // ØªØ­Ø¯ÙŠØ« Ù…Ø¨Ø§Ø´Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    document.getElementById('mysteryRawText')?.addEventListener('input', (e) => {
      const stats = parseMysteryText(e.target.value);
      renderMysteryStats(stats);
    });

    // â€”â€”â€” Ø¯Ù…Ø¬ Ø§Ù„Ù‚ÙŠÙ… Ù…Ø¹ Ø±ÙØ¹ Ø¥ÙƒØ³Ù„ Ø§Ù„Ø²Ø§Ø¦Ø± Ø§Ù„Ø³Ø±ÙŠ â€”â€”â€”
    // Ù†ÙØ¹Ø¯Ù‘ÙÙ„ wireForm Ø¨Ø­ÙŠØ« Ø¥Ø°Ø§ ÙƒØ§Ù† endpoint mystery Ù†Ø¶ÙŠÙ Ø§Ù„Ù†Øµ ÙˆØ§Ù„Ù‚ÙŠÙ…
    (function patchWireFormForMystery() {
      const _origWireForm = wireForm;
      window.wireForm = function(formId, statusId, endpoint) {
        _origWireForm(formId, statusId, endpoint);

        // Ù†Ù„ÙÙ‘ Ø¹Ù„Ù‰ submit Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Mystery
        const form = document.getElementById(formId);
        if (!form || !endpoint.includes('/imports/mystery')) return;

        // Ù†Ø­ØªØ§Ø¬ Ø§Ø¹ØªØ±Ø§Ø¶ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: Ù†Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù€ listener Ø§Ù„Ù…Ø¶Ø§Ù Ø³Ø§Ø¨Ù‚Ø§Ù‹ØŸ
        // Ø£Ø¨Ø³Ø· Ø­Ù„: Ù†Ø¶ÙŠÙ Listener Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„ÙŠØ­Ù‚Ù† Ø­Ù‚ÙˆÙ„ Ø¥Ø¶Ø§ÙÙŠØ© ÙÙŠ Ø§Ù„Ù€ FormData
        // Ù„Ø°Ù„Ùƒ Ø³Ù†Ø³ØªØ®Ø¯Ù… "submit" Ø¨Ø§Ù„ØªÙ‚Ø§Ø· (capture) Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø³Ù„Ø³Ù„Ø©:
        form.addEventListener('submit', function onSubmitInject(ev) {
          // Ù†Ø­Ù‚Ù† Ø¹Ø¨Ø± "requestIdleCallback" Ø¨Ø¹Ø¯ Ø£Ù† ÙŠÙØ¬Ù‡Ù‘Ø² Ø§Ù„Ù€ FormData ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£ØµÙ„ÙŠ.
          requestIdleCallback(() => {
            const raw = document.getElementById('mysteryRawText')?.value || '';
            const stats = parseMysteryText(raw);

            // Ù„Ø£Ù†Ù†Ø§ Ù„Ø§ Ù†Ù…Ù„Ùƒ Ø§Ù„Ù€ FormData Ø§Ù„Ø£ØµÙ„ÙŠ Ù‡Ù†Ø§ØŒ Ø³Ù†Ø±Ø³Ù„Ù‡Ø§ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¯Ø§Ø®Ù„ wireForm Ø§Ù„Ø£ØµÙ„ÙŠ ÙƒÙ†Ø§ Ù†ÙØ¹Ù„ append.
            // Ø§Ù„Ø­Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠ: Ù†Ø®Ø²Ù‘Ù† Ø§Ù„Ù‚ÙŠÙ… Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¹Ù„Ù‰ window ÙˆÙŠÙ‚Ø±Ø£Ù‡Ø§ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£ØµÙ„ÙŠ Ù‚Ø¨Ù„ fetch.
            window.__mysteryExtraPayload__ = {
              rawText: raw,
              unappliedCount: stats.unappliedCount,
              itemCount: stats.itemCount,
              repetitionSum: stats.repetitionSum,
            };
          }, { timeout: 0 });
        }, true);
      };

      // Ù†Ø¹Ø¯Ù‘Ù„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ wireForm Ø§Ù„Ø£ØµÙ„ÙŠ Ø£Ø¯Ù†Ø§Ù‡ Ù„ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙŠÙ… Ù‚Ø¨Ù„ fetch
      const origFetch = window.fetch;
      window.fetch = async function(input, init) {
        try {
          if (typeof input === 'string'
              && input.includes('/api/imports/mystery')
              && init && init.body instanceof FormData) {

            const extra = window.__mysteryExtraPayload__;
            if (extra) {
              init.body.append('mysteryRawText', extra.rawText || '');
              init.body.append('unappliedCount', String(extra.unappliedCount || 0));
              init.body.append('mysteryItemCount', String(extra.itemCount || 0));
              init.body.append('mysteryRepetitionSum', String(extra.repetitionSum || 0));
              // ØªØ®Ù„Ù‘Øµ Ù…Ù† Ø§Ù„Ø­Ù…ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
              delete window.__mysteryExtraPayload__;
            }
          }
        } catch(e) { /* Ù†ØªØ±Ùƒ Ø§Ù„Ùetch ÙŠÙƒÙ…Ù„ Ø¹Ø§Ø¯ÙŠ */ }
        return origFetch.apply(this, arguments);
      };
    })();

    // â€”â€”â€”â€”â€” Ø¯ÙˆØ§Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø®Øµ â€”â€”â€”â€”â€”
    // Ù…Ø³Ø§Ø¹Ø¯ Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
    function qs(sel, root=document){ return root.querySelector(sel); }

    // ÙØ¹Ù‘Ù„ Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø¥Ø°Ø§ Ø¸Ù‡Ø±Øª Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ø§Ù„ØªØ­Ù„ÙŠÙ„
    function updateSaveButtonEnabled() {
      const count = parseInt(qs('#mysteryUnappliedCount')?.textContent || '0', 10);
      const btn = qs('#btnSaveMysterySummary');
      if (!btn) return;
      if (count > 0 || (qs('#mysteryRawText')?.value || '').trim().length > 0) {
        btn.disabled = false;
        btn.classList.remove('cursor-not-allowed','opacity-80');
      } else {
        btn.disabled = true;
        btn.classList.add('cursor-not-allowed','opacity-80');
      }
    }

    // Ø§Ø³ØªØ¯Ø¹Ù Ù‡Ø°Ø§ Ø¨Ø¹Ø¯ ÙƒÙ„ ØªØ­Ù„ÙŠÙ„ ÙˆØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ù†Øµ
    const _renderMysteryStats = renderMysteryStats;
    window.renderMysteryStats = function(stats){
      _renderMysteryStats(stats);
      updateSaveButtonEnabled();
    };
    document.getElementById('mysteryRawText')?.addEventListener('input', updateSaveButtonEnabled);

    // ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙØ¸
    async function saveMysterySummary() {
      const statusEl = qs('#mysterySaveStatus');
      const rawText = (qs('#mysteryRawText')?.value || '').trim();

      // Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©
      const ticket = qs('#mysteryTicket')?.value?.trim();
      const dateFrom = qs('#mysteryFrom')?.value;
      const dateTo = qs('#mysteryTo')?.value;

      // Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰: Ø¥Ù† ÙƒÙ†ØªÙ Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ø¹ Ù†Ù‚Ø±Ø£Ù‡ Ù…Ù† Ø§Ù„Ø³Ù„ÙƒØªØŒ ØºÙŠØ± Ø°Ù„Ùƒ Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…
      let hospitalId;
      if (isClusterManager()) {
        hospitalId = qs('#mysteryHospitalId')?.value;
      } else {
        hospitalId = window.currentMysteryHospitalId;
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®ÙŠØ±Ø©: Ø¬Ù„Ø¨ Ù…Ù† localStorage
        if (!hospitalId) {
          try {
            const userDataStr = localStorage.getItem('userData');
            if (userDataStr) {
              const userData = JSON.parse(userDataStr);
              hospitalId = userData?.HospitalID || userData?.hospitalId || null;
            }
          } catch (e) {
            console.warn('[saveMysterySummary] Failed to get hospitalId from localStorage:', e);
          }
          
          if (!hospitalId) {
            const storedHospId = localStorage.getItem('hospitalId');
            if (storedHospId) {
              hospitalId = parseInt(storedHospId, 10);
            }
          }
        }
      }

      if (!ticket || !dateFrom || !dateTo) {
        statusEl.textContent = 'Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø© Ùˆ(Ù…Ù†/Ø¥Ù„Ù‰) Ø¥Ù„Ø²Ø§Ù…ÙŠØ©.';
        statusEl.className = 'mt-2 text-sm text-red-600';
        return;
      }
      if (isClusterManager() && !hospitalId) {
        statusEl.textContent = 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ (Ù„Ø£Ù†Ùƒ Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¬Ù…Ø¹).';
        statusEl.className = 'mt-2 text-sm text-red-600';
        return;
      }
      if (!isClusterManager() && !hospitalId) {
        statusEl.textContent = 'Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¯Ø¹Ù….';
        statusEl.className = 'mt-2 text-sm text-red-600';
        console.error('[saveMysterySummary] HospitalID is missing for employee user');
        return;
      }
      if (!rawText) {
        statusEl.textContent = 'Ø§Ù„ØµÙ‚ÙŠ Ø§Ù„Ù†Øµ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.';
        statusEl.className = 'mt-2 text-sm text-red-600';
        return;
      }

      const API_BASE = localStorage.getItem('apiBaseUrl') || 'http://localhost:3001';

      const payload = {
        HospitalID: hospitalId ? Number(hospitalId) : undefined,
        TicketNumber: ticket,
        PeriodFrom: dateFrom,
        PeriodTo: dateTo,
        RawText: rawText
      };

      try {
        statusEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ ÙƒØ³Ø¬Ù„Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©...';
        statusEl.className = 'mt-2 text-sm text-gray-600';

        const token = localStorage.getItem('token') || localStorage.getItem('authToken') || '';
        const resp = await fetch(`${API_BASE}/api/mystery-complaints/bulk-from-text`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(token ? { 'Authorization': `Bearer ${token}` } : {})
          },
          body: JSON.stringify(payload)
        });

        const data = await resp.json().catch(()=> ({}));
        if (!resp.ok) throw new Error(data?.message || `HTTP ${resp.status}`);

        statusEl.textContent = `ØªÙ… Ø­ÙØ¸ ${data.inserted || 0} Ø³Ø·Ø± ÙƒØ³Ø¬Ù„Ø§Øª Ù…Ù†ÙØµÙ„Ø©.`;
        statusEl.className = 'mt-2 text-sm text-green-600';
      } catch (err) {
        statusEl.textContent = 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + (err.message || err);
        statusEl.className = 'mt-2 text-sm text-red-600';
      }
    }

    // Ø­Ø¯Ø« Ø²Ø± Ø§Ù„Ø­ÙØ¸
    document.getElementById('btnSaveMysterySummary')?.addEventListener('click', saveMysterySummary);
  </script>

  <!-- Ù†Ø¸Ø§Ù… Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø§Øª -->
  <script src="../public/assets/js/auth-check.js"></script>

  <!-- Ù†Ø¸Ø§Ù… Ø­ÙˆÙƒÙ…Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª -->
  <script>
    (async function applyImportsPermissions(){
      const API_BASE = (location.hostname==='localhost'||location.hostname==='127.0.0.1') ? 'http://localhost:3001' : '';
      const token = localStorage.getItem('token') || localStorage.getItem('authToken') || '';

      const res = await fetch(`${API_BASE}/api/auth/me-permissions`, {
        headers: { 'Accept':'application/json', ...(token?{Authorization:`Bearer ${token}`}:{}) },
        credentials: 'include'
      }).catch(()=>null);

      if (!res || !res.ok) return; // Ù„Ùˆ Ù…Ø§ Ù‚Ø¯Ø± ÙŠØ¬ÙŠØ¨ Ù†Ø®Ù„ÙŠÙ‡Ø§ ØªØ¸Ù‡Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ (Ø£Ùˆ ØªØ®ÙÙŠ)

      const me = await res.json();
      const imp = me.imports || {};

      // Ø³ÙƒØ§Ø´Ù† Ø§Ù„ØµÙØ­Ø© (Ø­Ø³Ø¨ Ù‡ÙŠÙƒÙ„ imports.html)
      const secMystery = document.querySelector('section h2#section2-title')?.closest('section');
      const secDepts   = document.querySelector('section h2#section3-title')?.closest('section');
      const sec937     = document.querySelector('section h2#section4-title')?.closest('section');

      // 1) Ø¥Ù† Ù„Ù… ÙŠÙ…Ù„Ùƒ IMPORTS_PAGE Ø£Ø®ÙÙŠ Ø§Ù„ØµÙØ­Ø© ÙƒÙ„Ù‡Ø§
      if (!imp.importsPage) {
        document.querySelector('main')?.classList.add('opacity-50', 'pointer-events-none');
        // Ø£Ùˆ redirect:
        // location.href = 'index.html';
      }

      // 2) ÙƒÙ„ Ø³ÙƒØ´Ù† Ù„ÙˆØ­Ø¯Ù‡
      if (secMystery) {
        secMystery.style.display = imp.importMystery ? '' : 'none';
        // ØªØ£Ù…ÙŠÙ†Ø§Ù‹: Ø¹Ø·Ù‘Ù„ÙŠ ÙÙˆØ±Ù… Ø§Ù„Ø±ÙØ¹ Ø¥Ù† Ù…Ø§ Ø¹Ù†Ø¯Ù‡ Ø¥Ø°Ù†
        secMystery.querySelectorAll('form input, form button').forEach(el=> el.disabled = !imp.importMystery);
      }

      if (secDepts) {
        secDepts.style.display = imp.importDepartments ? '' : 'none';
        secDepts.querySelectorAll('form input, form button').forEach(el=> el.disabled = !imp.importDepartments);
      }

      if (sec937) {
        sec937.style.display = imp.import937 ? '' : 'none';
        sec937.querySelectorAll('form input, form button').forEach(el=> el.disabled = !imp.import937);
      }
    })();
  </script>
</body>
</html>
