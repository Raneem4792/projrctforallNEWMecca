<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ุฅุฑูุงู ุงูุฅูุณู - ูุธุงู ุงูุจูุงุบุงุช</title>

  <!-- ุฎุทูุท ู Tailwind (ููุณ ุตูุญุฉ ุงูุฑุฆูุณูุฉ) -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ููุณ ูููุงุชู ุจุงูุถุจุท -->
  <link rel="stylesheet" href="../public/assets/css/styles.css" />
  <link rel="stylesheet" href="index.css" />
</head>
<body class="font-[Tajawal] bg-gray-50 text-gray-800">

  <!-- ===== ุงูููุฏุฑ ููุณู (ูู index.html) ===== -->
  <header id="navbar" class="fixed w-full top-0 z-50 navbar-scroll" style="background-color: #002B5B;">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <!-- ุงูุดุนุงุฑ -->
        <div class="flex items-center">
          <img src="../public/assets/img/logo3.png" alt="ุดุนุงุฑ ุชุฌูุน ููุฉ ุงูููุฑูุฉ ุงูุตุญู" class="h-16 w-auto">
        </div>

        <!-- ุงููุงุฆูุฉ (ููุณ ุงูุฑูุงุจุท) -->
        <nav class="hidden md:flex items-center space-x-reverse space-x-8">
          <a href="index.html" id="nav-home" class="text-white hover:text-blue-200 transition-colors">ุงูุฑุฆูุณูุฉ</a>
          <a href="../dashboard/dashboard.html" id="nav-dashboard" class="text-white hover:text-blue-200 transition-colors">ููุญุฉ ุงูุชุญูู</a>
          <a href="../public/profile.html" id="nav-profile" class="text-white hover:text-blue-200 transition-colors hidden">ูููู ุงูุดุฎุตู</a>
          <a href="about-system.html" id="nav-about" class="text-white hover:text-blue-200 transition-colors">ุญูู ุงููุธุงู</a>
          <a href="help.html" id="nav-help" class="text-white hover:text-blue-200 transition-colors">ุงููุณุงุนุฏุฉ</a>
          <a href="contact.html" id="nav-contact" class="text-white hover:text-blue-200 transition-colors">ุงุชุตู ุจูุง</a>
          <button id="languageToggle" class="text-white hover:text-blue-200 transition-colors flex items-center">
            ๐ English
          </button>
        </nav>
        
        <!-- Mobile menu button - ุฒุฑ ุงููุงุฆูุฉ ููููุจุงูู -->
        <button class="md:hidden text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- ===== ูุญุชูู ุงูุตูุญุฉ ===== -->
  <main class="max-w-7xl mx-auto px-4 py-10 pt-24">
    <h1 id="page-title" class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">ุฅุฑูุงู ูููุงุช ุงูุฅูุณู</h1>
    <p id="page-subtitle" class="text-gray-600 mb-8">ุงุฎุชูุฑ ุงูููุน ุซู ุงุฑูุน ููู Excel (XLSX/XLS/CSV). ุงูุตูุญุฉ ุจููุณ ุชูุณูู ุงููุธุงู.</p>

    <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-3">

      <!-- ุงูุฒุงุฆุฑ ุงูุณุฑู -->
      <section class="card-hover bg-white rounded-xl shadow-lg border border-gray-100 p-6 animate-fade-in-up">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-5 5-5-5h5V7a5 5 0 10-10 0v5"/>
            </svg>
          </div>
          <h2 id="section2-title" class="text-lg font-semibold">ุฅูุณู ุงูุฒุงุฆุฑ ุงูุณุฑู</h2>
        </div>

        <div class="space-y-4">
          <a href="./templates/import-mystery.xlsx" id="template2-link" class="text-blue-600 hover:underline text-sm">ุชูุฒูู ุงููุงูุจ</a>
          
          <!-- ุงูุญููู ุงููุทููุจุฉ ููุฌููุน: ุฑูู ุงูุชุฐูุฑุฉ + ุงููุชุฑุฉ -->
          <div class="grid md:grid-cols-3 gap-3 mt-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ุฑูู ุงูุชุฐูุฑุฉ</label>
              <input id="mysteryTicket" type="text" placeholder="ูุซุงู: MS-2025-001"
                     class="w-full border rounded-lg px-3 py-2" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ูู ุชุงุฑูุฎ</label>
              <input id="mysteryFrom" type="date" class="w-full border rounded-lg px-3 py-2" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ุฅูู ุชุงุฑูุฎ</label>
              <input id="mysteryTo" type="date" class="w-full border rounded-lg px-3 py-2" />
            </div>
          </div>

          <!-- ููุฏูุฑ ุงูุชุฌูุน ููุท: ุงููุณุชุดูู -->
          <div id="mysteryExtra" class="mt-3 hidden">
            <label class="block text-sm font-medium text-gray-700 mb-1">ุงููุณุชุดูู</label>
            <select id="mysteryHospitalId" class="w-full border rounded-lg px-3 py-2">
              <option value="">ุงุฎุชุฑ ุงููุณุชุดููโฆ</option>
            </select>
            <small class="text-gray-500">ูุธูุฑ ููุท ููุฏูุฑ ุงูุชุฌูุน</small>
          </div>
          

          <!-- ุญููู ุฅูุฒุงููุฉ ููุญูุธ -->
          <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label for="mysteryTicket" class="block text-sm font-medium text-gray-700 mb-1">ุฑูู ุงูุชุฐูุฑุฉ *</label>
              <input type="text" id="mysteryTicket" placeholder="ูุซุงู: TKT-2025-001" 
                     class="w-full border rounded-lg px-3 py-2 text-sm" required>
            </div>
            <div>
              <label for="mysteryFrom" class="block text-sm font-medium text-gray-700 mb-1">ูู ุชุงุฑูุฎ *</label>
              <input type="date" id="mysteryFrom" 
                     class="w-full border rounded-lg px-3 py-2 text-sm" required>
            </div>
            <div>
              <label for="mysteryTo" class="block text-sm font-medium text-gray-700 mb-1">ุฅูู ุชุงุฑูุฎ *</label>
              <input type="date" id="mysteryTo" 
                     class="w-full border rounded-lg px-3 py-2 text-sm" required>
            </div>
          </div>
          
          <!-- ุฅุฏุฎุงู ูุต ุชูุฑูุฑ ุงูุฒุงุฆุฑ ุงูุณุฑู ูุชุญูููู -->
          <div class="mt-4 p-4 rounded-lg bg-gray-50 border border-gray-200">
            <div class="flex items-center justify-between mb-2">
              <label for="mysteryRawText" class="block text-sm font-medium text-gray-700">
                ูุตู ูุต ุชูุฑูุฑ ุงูุฒุงุฆุฑ ุงูุณุฑู (ุงุฎุชูุงุฑู)
              </label>
              <div class="space-x-2 space-x-reverse">
                <button type="button" id="btnAnalyzeMysteryText"
                        class="text-sm px-3 py-1.5 rounded-lg text-white" style="background:#0a56b3">
                  ุชุญููู ุงููุต
                </button>
                <button type="button" id="btnSaveMysterySummary"
                        class="text-sm px-3 py-1.5 rounded-lg text-white opacity-80 cursor-not-allowed"
                        style="background:#0b1b30" disabled>
                  ุญูุธ ุงูููุฎุต
                </button>
              </div>
            </div>

            <textarea id="mysteryRawText" rows="6" placeholder="ุงูุตู ููุง ุงูููุฑุฉ ูุซู ุงููุซุงู ูู ุฑุณุงูุชูุ ุซู ุงุถุบุท (ุชุญููู ุงููุต)"
                      class="w-full border rounded-lg px-3 py-2 text-sm"></textarea>

            <!-- ููุชุงุฆุฌ ุงูุชุญููู ุงูุณุฑูุน -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-3">
              <div class="rounded-lg bg-white border p-3">
                <div class="text-xs text-gray-500">ุนุฏุฏ ุงูููุงุญุธุงุช ุบูุฑ ุงููุทุจูุฉ</div>
                <div class="text-2xl font-bold text-red-600" id="mysteryUnappliedCount">0</div>
              </div>
              <div class="rounded-lg bg-white border p-3">
                <div class="text-xs text-gray-500">ุนุฏุฏ ุงูุจููุฏ ุงูููุฏุฑุฌุฉ ุจุงูุณุฑุฏ</div>
                <div class="text-2xl font-bold text-gray-800" id="mysteryItemsCount">0</div>
              </div>
              <div class="rounded-lg bg-white border p-3">
                <div class="text-xs text-gray-500">ูุฌููุน (ุนุฏุฏ ุงูุชูุฑุงุฑ)</div>
                <div class="text-2xl font-bold text-gray-800" id="mysteryRepetitionSum">0</div>
              </div>
            </div>
          </div>
          
          <!-- ุฃุณูู ุงููุฑูุช ูุจุงุดุฑุฉู ุฃุถู ุณุทุฑ ุญุงูุฉ ุตุบูุฑ -->
          <p id="mysterySaveStatus" class="mt-2 text-sm"></p>
          
          <form id="formMystery" class="space-y-3">
            <input type="file" name="file" accept=".xlsx,.xls,.csv" required
                   class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            <div class="flex items-center gap-3">
              <button type="submit" id="upload2-btn" class="px-4 py-2 rounded-lg text-white" style="background:#002B5B">ุฑูุน ุงูููู</button>
              <span id="statusMystery" class="text-sm text-gray-500"></span>
            </div>
          </form>
        </div>
      </section>

      <!-- ุงูุฃูุณุงู -->
      <section class="card-hover bg-white rounded-xl shadow-lg border border-gray-100 p-6 animate-fade-in-up">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M3 7h18M3 12h18M3 17h18"/>
            </svg>
          </div>
          <h2 id="section3-title" class="text-lg font-semibold">ุฅูุณู ุงูุฃูุณุงู</h2>
        </div>

        <div class="space-y-4">
          <a href="./templates/import-departments-template-utf8.csv" id="template3-link" class="text-blue-600 hover:underline text-sm">ุชูุฒูู ุงููุงูุจ (UTF-8)</a>
          
          <!-- ุงุฎุชูุงุฑ ุงููุณุชุดูู ููุฏูุฑ ุงูุชุฌูุน -->
          <div id="clusterHospitalWrap" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-1">ุงููุณุชุดูู</label>
            <select id="clusterHospitalSelect" class="w-full border rounded-lg px-3 py-2">
              <option value="">โ ุงุฎุชุฑ ูุณุชุดูู โ</option>
            </select>
            <small class="text-gray-500">ูุธูุฑ ููุท ููุฏูุฑ ุงูุชุฌูุน</small>
          </div>
          
          <form id="formDepts" class="space-y-3">
            <input type="file" name="file" accept=".xlsx,.xls,.csv" required
                   class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            <div class="flex items-center gap-3">
              <button type="submit" id="upload3-btn" class="px-4 py-2 rounded-lg text-white" style="background:#002B5B">ุฑูุน ุงูููู</button>
              <span id="statusDepts" class="text-sm text-gray-500"></span>
            </div>
          </form>
          <!-- ูุชุงุฆุฌ ุงูุงุณุชูุฑุงุฏ -->
          <div id="importDeptsResults" class="hidden mt-4 p-4 rounded-lg bg-gray-50 border border-gray-200">
            <h3 class="text-sm font-semibold text-gray-900 mb-2">ูุชุงุฆุฌ ุงูุงุณุชูุฑุงุฏ:</h3>
            <div class="space-y-1 text-xs text-gray-700">
              <div class="flex justify-between">
                <span>ุฅุฌูุงูู ุงูุตููู:</span>
                <span id="resultDeptsTotal" class="font-semibold">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-green-600">โ ุชู ุงูุฅุฏุฎุงู:</span>
                <span id="resultDeptsInserted" class="font-semibold text-green-600">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-blue-600">๐ ุชู ุงูุชุญุฏูุซ:</span>
                <span id="resultDeptsUpdated" class="font-semibold text-blue-600">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-yellow-600">โ ุชู ุงูุชุฎุทู:</span>
                <span id="resultDeptsSkipped" class="font-semibold text-yellow-600">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-red-600">โ ุฃุฎุทุงุก:</span>
                <span id="resultDeptsErrors" class="font-semibold text-red-600">0</span>
              </div>
            </div>
            <!-- ุชูุงุตูู ุงูุฃุฎุทุงุก -->
            <div id="resultDeptsDetails" class="mt-3 max-h-40 overflow-y-auto"></div>
          </div>
        </div>
      </section>

      <!-- ุจูุงุบุงุช 937 -->
      <section class="card-hover bg-white rounded-xl shadow-lg border border-gray-100 p-6 animate-fade-in-up">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 rounded-full bg-green-50 flex items-center justify-center">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
          </div>
          <h2 id="section4-title" class="text-lg font-semibold">ุฅูุณู ุจูุงุบุงุช 937</h2>
        </div>

        <div class="space-y-4">
          <a href="./templates/import-937.xlsx" id="template4-link" class="text-blue-600 hover:underline text-sm">ุชูุฒูู ุงููุงูุจ</a>
          <form id="form937" class="space-y-3">
            <input type="file" name="file" accept=".xlsx,.xls,.csv" required
                   class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
            <div class="flex items-center gap-3">
              <button type="submit" id="upload4-btn" class="px-4 py-2 rounded-lg text-white" style="background:#059669">ุฑูุน ุงูููู</button>
              <span id="status937" class="text-sm text-gray-500"></span>
            </div>
          </form>
          <!-- ูุชุงุฆุฌ ุงูุงุณุชูุฑุงุฏ -->
          <div id="import937Results" class="hidden mt-4 p-4 rounded-lg bg-gray-50 border border-gray-200">
            <h3 class="text-sm font-semibold text-gray-900 mb-2">ูุชุงุฆุฌ ุงูุงุณุชูุฑุงุฏ:</h3>
            <div class="space-y-1 text-xs text-gray-700">
              <div class="flex justify-between">
                <span>ุฅุฌูุงูู ุงูุตููู:</span>
                <span id="result937Total" class="font-semibold">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-green-600">โ ุชู ุงูุฅุฏุฎุงู:</span>
                <span id="result937Inserted" class="font-semibold text-green-600">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-yellow-600">โ ุชู ุงูุชุนุฏูู:</span>
                <span id="result937Skipped" class="font-semibold text-yellow-600">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-purple-600">๐ฅ <span id="result-skipped-no-hospital-text">ุจุฏูู ููุดุฃุฉ</span>:</span>
                <span id="result937SkippedNoHospital" class="font-semibold text-purple-600">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-orange-600">โ ููุฑุฑ:</span>
                <span id="result937Duplicates" class="font-semibold text-orange-600">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-red-600">โ ุฃุฎุทุงุก:</span>
                <span id="result937Errors" class="font-semibold text-red-600">0</span>
              </div>
            </div>
            <!-- ุชูุงุตูู ุฅุถุงููุฉ -->
            <div id="result937Details" class="mt-3 max-h-40 overflow-y-auto"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- ===== ุงูููุชุฑ ููุณู (ูู index.html) ===== -->
  <footer class="bg-gray-900 text-white py-14">
    <div class="container mx-auto px-4">
      <div class="grid md:grid-cols-3 gap-8">
        <!-- Column 1 - ุงูุนููุฏ ุงูุฃูู -->
        <div>
          <div class="flex items-center space-x-reverse space-x-3 mb-4">
            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 2L2 7v10c0 5.55 3.84 9.74 9 11 5.16-1.26 9-5.45 9-11V7l-10-5z"/>
              </svg>
            </div>
            <div>
              <div id="footer-org-name" class="font-bold">ุชุฌูุน ููุฉ ุงูุตุญู</div>
              <div id="footer-system-name" class="text-sm text-gray-300">ูุธุงู ุงูุจูุงุบุงุช</div>
            </div>
          </div>
          <p id="footer-description" class="text-gray-300 text-sm">ููุตุฉ ุฑุณููุฉ ูุชูุฏูู ููุชุงุจุนุฉ ุงูุจูุงุบุงุช</p>
        </div>

        <!-- Column 2 - ุงูุนููุฏ ุงูุซุงูู -->
        <div>
          <h3 id="footer-links-title" class="font-bold mb-4">ุฑูุงุจุท ุณุฑูุนุฉ</h3>
          <ul class="space-y-2 text-sm">
            <li><a href="index.html" id="footer-link-home" class="text-gray-300 hover:text-white hover:underline transition-colors">ุงูุฑุฆูุณูุฉ</a></li>
            <li><a href="../public/complaints/submit/submit-complaint.html" id="footer-link-submit" class="text-gray-300 hover:text-white hover:underline transition-colors">ุชูุฏูู ุจูุงุบ</a></li>
            <li><a href="../public/complaints/track/track-complaint.html" id="footer-link-track" class="text-gray-300 hover:text-white hover:underline transition-colors">ูุชุงุจุนุฉ ุจูุงุบ</a></li>
            <li><a href="help.html" id="footer-link-faq" class="text-gray-300 hover:text-white hover:underline transition-colors">ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ</a></li>
          </ul>
        </div>

        <!-- Column 3 - ุงูุนููุฏ ุงูุซุงูุซ -->
        <div>
          <h3 id="footer-contact-title" class="font-bold mb-4">ูุนูููุงุช ุงูุชูุงุตู</h3>
          <div class="space-y-2 text-sm text-gray-300">
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
              <span id="footer-support-number">ุฑูู ุงูุฏุนู: 0559735137</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
              <span id="footer-support-number-2">ุฑูู ุงูุฏุนู: 0542282550</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
              <span id="footer-support-email">support@makkahhealth.gov.sa</span>
            </div>
            <div class="flex items-baseline">
              <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span id="footer-working-hours">ุณุงุนุงุช ุงูุนูู: 24/7</span>
            </div>
          </div>
        </div>
      </div>

      <div class="border-t border-gray-700 mt-8 pt-8 text-center text-sm text-gray-300">
        <span id="footer-copyright">ยฉ 2025 ุชุฌูุน ููุฉ ุงูููุฑูุฉ ุงูุตุญู โ ุฌููุน ุงูุญููู ูุญููุธุฉ</span>
      </div>
    </div>
  </footer>

  <!-- ููุณ ุณูุฑุจุชุงุชู -->
  <script src="index.js"></script>
  <script>
    // ุฑุจุท ุงูููุงุฐุฌ ุจุงูููุงูุงุช
    const API_BASE = (location.hostname==='localhost'||location.hostname==='127.0.0.1') ? 'http://localhost:3001' : '';
    const token = localStorage.getItem('token') || localStorage.getItem('authToken');

    // ูุญุต ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุฏูุฑ ุชุฌูุน
    function isClusterManager() {
      try {
        const u = JSON.parse(localStorage.getItem('userData') || '{}');
        return u.RoleID === 1 || u.IsClusterManager === true; // ุนุฏูู ุญุณุจ ูุธุงูู
      } catch { return false; }
    }

    // ุฅุธูุงุฑ ุฎุงูุฉ ุงููุณุชุดูู ููุฏูุฑ ุงูุชุฌูุน
    document.addEventListener('DOMContentLoaded', () => {
      const extra = document.getElementById('mysteryExtra');
      if (extra && isClusterManager()) extra.classList.remove('hidden');
    });

    function wireForm(formId, statusId, endpoint){
      const form = document.getElementById(formId);
      const status = document.getElementById(statusId);
      if(!form) return;

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const file = form.querySelector('input[type=file]').files[0];
        if(!file){ status.textContent='ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ููู.'; status.className='text-red-600 text-sm'; return; }
        
        // ุงูุชุญูู ูู ุงูุญููู ุงูุฅูุฒุงููุฉ ููุฒุงุฆุฑ ุงูุณุฑู
        if(endpoint.includes('/imports/mystery')) {
          const ticket = document.getElementById('mysteryTicket')?.value?.trim();
          const dateFrom = document.getElementById('mysteryFrom')?.value;
          const dateTo = document.getElementById('mysteryTo')?.value;
          if (!ticket || !dateFrom || !dateTo) {
            status.textContent='ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฑูู ุงูุชุฐูุฑุฉ ูุงููุชุฑุฉ (ูู/ุฅูู).';
            status.className='text-red-600 text-sm';
            return;
          }
          
        // ุงูุชุญูู ูู ุงููุณุชุดูู ููุฏูุฑ ุงูุชุฌูุน
        if (isClusterManager()) {
          const hospitalId = document.getElementById('mysteryHospitalId')?.value;
          if (!hospitalId) {
            status.textContent='ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงููุณุชุดูู (ูุฃูู ูุฏูุฑ ุงูุชุฌูุน).';
            status.className='text-red-600 text-sm';
            return;
          }
        }
        }
        
        status.textContent='ุฌุงุฑู ุงูุฑูุน...'; status.className='text-gray-500 text-sm';

        const fd = new FormData(); fd.append('file', file);
        
        // ุฅุถุงูุฉ ุงูุญููู ุงูุฌุฏูุฏุฉ ููุฒุงุฆุฑ ุงูุณุฑู
        if(endpoint.includes('/imports/mystery')) {
          const ticket = document.getElementById('mysteryTicket')?.value?.trim();
          const dateFrom = document.getElementById('mysteryFrom')?.value;
          const dateTo = document.getElementById('mysteryTo')?.value;
          
          fd.append('ticketNumber', ticket);
          fd.append('dateFrom', dateFrom);
          fd.append('dateTo', dateTo);
          
          // ุฅุถุงูุฉ ูุนุฑู ุงููุณุชุดูู ููุฏูุฑ ุงูุชุฌูุน
          if (isClusterManager()) {
            const hospitalId = document.getElementById('mysteryHospitalId')?.value;
            fd.append('hospitalId', hospitalId);
          }
        }
        
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        
        try{
          const res = await fetch(`${API_BASE}${endpoint}`, {
            method:'POST',
            headers,
            body: fd
          });
          const data = await res.json().catch(()=>({}));
          if(!res.ok) throw new Error(data?.message || `HTTP ${res.status}`);
          
          // ูุนุงูุฌุฉ ุฎุงุตุฉ ูู mystery imports
          if(endpoint.includes('/imports/mystery') && data.inserted !== undefined) {
            status.textContent = `ุชู ุงุณุชูุฑุงุฏ ${data.inserted} ุณุฌู ุจูุฌุงุญ.`;
            if(data.skipped > 0) status.textContent += ` ุชู ุชุฎุทู ${data.skipped} ุณุทุฑ.`;
            status.className='text-green-600 text-sm';
          } else {
            status.textContent = 'ุชู ุงูุงุณุชูุงู ูุณูุชู ุงููุนุงูุฌุฉ.'; 
            status.className='text-green-600 text-sm';
          }
        }catch(err){
          status.textContent = 'ูุดู ุงูุฑูุน: ' + err.message; status.className='text-red-600 text-sm';
        }
      });
    }

    wireForm('formMystery', 'statusMystery', '/api/imports/mystery');

    // === helpers ===
    function getToken() {
      const t = localStorage.getItem('token');
      return t && t.startsWith('Bearer ') ? t : `Bearer ${t || ''}`;
    }
    
    function isClusterManager(me) {
      return me?.RoleKey === 'CLUSTER_MANAGER' || me?.RoleID === 1 || me?.IsClusterManager === 1;
    }
    
    async function getMe() {
      const res = await fetch(`${API_BASE}/api/auth/me`, { 
        headers: { Authorization: getToken() } 
      });
      if (!res.ok) throw new Error(`auth/me ${res.status}`);
      return res.json();
    }
    
    async function fetchHospitalsActive() {
      const res = await fetch(`${API_BASE}/api/hospitals?active=1`, { 
        headers: { Authorization: getToken() } 
      });
      if (!res.ok) throw new Error(`hospitals ${res.status}`);
      // ูุฏ ูููู ุงูุฌุณู Array ุฃู {data:[...]} ุฃู {results:[...]}
      const body = await res.json().catch(() => ({}));
      const list = Array.isArray(body)
        ? body
        : Array.isArray(body.data)
          ? body.data
          : Array.isArray(body.results)
            ? body.results
            : [];
      return list;
    }

    // === UI init ===
    async function initHospitalSelectForCluster() {
      const me = await getMe().catch(e => {
        console.warn('getMe failed:', e);
        return null;
      });
      if (!isClusterManager(me)) return; // ูุณุชุฎุฏู ุนุงุฏู: ูุง ุดูุก

      const wrap = document.getElementById('clusterHospitalWrap');
      const sel = document.getElementById('clusterHospitalSelect');
      const hint = document.getElementById('clusterHospitalHint');
      if (!wrap || !sel) return;

      wrap.classList.remove('hidden');
      sel.innerHTML = '<option value="">โ ุงุฎุชุฑ ูุณุชุดูู โ</option>';

      try {
        const hospitals = await fetchHospitalsActive(); // <= ููุง ูุง ุนุงุฏ ูุณุชุฎุฏู body.data ูุจุงุดุฑุฉ
        // ูู ุฑุฌุน ูุงุถูุ ุฃุนุฑุถ ุฑุณุงูุฉ ููุง ุชููุฐ sort ุนูู undefined
        if (!Array.isArray(hospitals) || hospitals.length === 0) {
          hint.textContent = 'ูุง ุชูุฌุฏ ูุณุชุดููุงุช ููุนููุฉ ุฃู ูุง ุตูุงุญูุฉ ูุนุฑุถูุง.';
          return;
        }

        hospitals
          .sort((a, b) => (a?.NameAr || '').localeCompare(b?.NameAr || '', 'ar'))
          .forEach(h => {
            const opt = document.createElement('option');
            opt.value = h.HospitalID;
            opt.textContent = h.NameAr || h.NameEn || `Hospital #${h.HospitalID}`;
            sel.appendChild(opt);
          });
      } catch (err) {
        console.error('init hospitals error:', err);
        hint.textContent = 'ุชุนุฐูุฑ ุชุญููู ูุงุฆูุฉ ุงููุณุชุดููุงุช (ุชุญููู ูู ุงูุชููู/ุงูุงุชุตุงู).';
      }
    }

    // === ุงุฎุชูุงุฑ ูุณุงุฑ ุงูุฑูุน ===
    function getDepartmentsImportUrl() {
      const sel = document.getElementById('clusterHospitalSelect');
      // ูู ุงูุธุงูุฑ ููุฎุชุงุฑ ูููุฉุ ุฃูุญูู ?hospitalId=
      if (sel && !sel.classList.contains('hidden') && sel.value) {
        return `/api/imports/departments?hospitalId=${encodeURIComponent(sel.value)}`;
      }
      return '/api/imports/departments'; // ุงููุณุชุฎุฏู ุงูุนุงุฏู: ุงูุณูุฑูุฑ ูุฃุฎุฐ ูู ุงูุชููู
    }

    // ูููุฐุฌ ุงูุฃูุณุงู ูุน ุนุฑุถ ุงูุชูุงุตูู
    const formDepts = document.getElementById('formDepts');
    const statusDepts = document.getElementById('statusDepts');
    const resultsDepts = document.getElementById('importDeptsResults');
    
    if (formDepts) {
      formDepts.addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = formDepts.querySelector('input[type=file]').files[0];
        if (!file) {
          statusDepts.textContent = 'ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ููู.';
          statusDepts.className = 'text-red-600 text-sm';
          return;
        }
        
        statusDepts.textContent = 'ุฌุงุฑู ุงูุฑูุน ูุงููุนุงูุฌุฉ...';
        statusDepts.className = 'text-gray-500 text-sm';
        resultsDepts.classList.add('hidden');

        const fd = new FormData();
        fd.append('file', file);
        
        try {
          const url = getDepartmentsImportUrl();
          const res = await fetch(`${API_BASE}${url}`, {
            method: 'POST',
            headers: token ? { 'Authorization': `Bearer ${token}` } : {},
            body: fd
          });
          
          const data = await res.json();
          
          if (!res.ok) {
            throw new Error(data?.message || `HTTP ${res.status}`);
          }
          
          // ุนุฑุถ ุงููุชุงุฆุฌ
          statusDepts.textContent = 'ุงูุชูู ุงูุงุณุชูุฑุงุฏ!';
          statusDepts.className = 'text-green-600 text-sm';
          
          // ููุก ุงูุจูุงูุงุช
          document.getElementById('resultDeptsTotal').textContent = (data.inserted || 0) + (data.updated || 0);
          document.getElementById('resultDeptsInserted').textContent = data.inserted || 0;
          document.getElementById('resultDeptsUpdated').textContent = data.updated || 0;
          document.getElementById('resultDeptsSkipped').textContent = data.skipped || 0;
          document.getElementById('resultDeptsErrors').textContent = data.errors || 0;
          
          // ุนุฑุถ ุชูุงุตูู ุงูุฃุฎุทุงุก
          const detailsDiv = document.getElementById('resultDeptsDetails');
          detailsDiv.innerHTML = '';
          
          if (data.errorDetails && data.errorDetails.length > 0) {
            const errorsHtml = '<div class="mt-2"><p class="text-xs font-semibold text-red-700 mb-1">ุชูุงุตูู ุงูุฃุฎุทุงุก:</p><ul class="text-xs text-gray-600 space-y-1">' +
              data.errorDetails.map(e => `<li>โข ${e}</li>`).join('') +
              '</ul></div>';
            detailsDiv.innerHTML += errorsHtml;
          }
          
          resultsDepts.classList.remove('hidden');
          
        } catch (err) {
          statusDepts.textContent = 'ูุดู ุงูุฑูุน: ' + err.message;
          statusDepts.className = 'text-red-600 text-sm';
        }
      });
    }

    // === bootstrap ===
    async function init() {
      await initHospitalSelectForCluster();
      // ููู: ูุฑูุฑู "ุฏุงูุฉ" ุชุฑุฌุน ุงูุฑุงุจุท ููุญุธุฉ ุงูุฅุฑุณุงู
      // wireForm('formDepts', 'statusDepts', getDepartmentsImportUrl);
    }
    
    init().catch(console.error);

    // ุชุดุฎูุต ุณุฑูุน ูู ุงููุงุฌูุฉ
    window.debugDepartmentsImport = async () => {
      try {
        const me = await getMe();
        console.log('me =', me);
        const sel = document.getElementById('clusterHospitalSelect');
        console.log('selected hospitalId =', sel ? sel.value : null);
        console.log('isClusterManager =', isClusterManager(me));
        console.log('import URL =', getDepartmentsImportUrl());
        
        // ุงุฎุชุจุงุฑ ุชุญููู ุงููุณุชุดููุงุช
        try {
          const hospitals = await fetchHospitalsActive();
          console.log('hospitals loaded =', hospitals.length, hospitals);
        } catch (err) {
          console.error('hospitals fetch failed:', err);
        }
      } catch (error) {
        console.error('Debug error:', error);
      }
    };

    // ูููุฐุฌ 937 ูุน ุนุฑุถ ุงูุชูุงุตูู
    const form937 = document.getElementById('form937');
    const status937 = document.getElementById('status937');
    const results937 = document.getElementById('import937Results');
    
    if (form937) {
      form937.addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = form937.querySelector('input[type=file]').files[0];
        if (!file) {
          status937.textContent = 'ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ููู.';
          status937.className = 'text-red-600 text-sm';
          return;
        }
        
        status937.textContent = 'ุฌุงุฑู ุงูุฑูุน ูุงููุนุงูุฌุฉ...';
        status937.className = 'text-gray-500 text-sm';
        results937.classList.add('hidden');

        const fd = new FormData();
        fd.append('file', file);
        
        try {
          const res = await fetch(`${API_BASE}/api/imports/937`, {
            method: 'POST',
            headers: token ? { 'Authorization': `Bearer ${token}` } : {},
            body: fd
          });
          
          const data = await res.json();
          
          if (!res.ok) {
            throw new Error(data?.message || `HTTP ${res.status}`);
          }
          
          // ุนุฑุถ ุงููุชุงุฆุฌ
          status937.textContent = 'ุงูุชูู ุงูุงุณุชูุฑุงุฏ!';
          status937.className = 'text-green-600 text-sm';
          
          // ููุก ุงูุจูุงูุงุช
          document.getElementById('result937Total').textContent = data.total || 0;
          document.getElementById('result937Inserted').textContent = data.inserted || 0;
          document.getElementById('result937Skipped').textContent = data.skipped || 0;
          document.getElementById('result937SkippedNoHospital').textContent = data.skippedNoHospital || 0;
          document.getElementById('result937Duplicates').textContent = data.duplicates || 0;
          document.getElementById('result937Errors').textContent = data.errors || 0;
          
          // ุนุฑุถ ุชูุงุตูู ุงูุตููู ุงููุชุนุฏูู ุนูููุง ูุงูุฃุฎุทุงุก
          const detailsDiv = document.getElementById('result937Details');
          detailsDiv.innerHTML = '';
          
          if (data.skippedRows && data.skippedRows.length > 0) {
            const skippedHtml = '<div class="mt-2"><p class="text-xs font-semibold text-yellow-700 mb-1">ุตููู ูุชุนุฏูู ุนูููุง:</p><ul class="text-xs text-gray-600 space-y-1">' +
              data.skippedRows.slice(0, 10).map(s => 
                `<li>โข ุตู ${s.rowNumber}: ${s.reason} ${s.hospitalName ? `(${s.hospitalName})` : ''}</li>`
              ).join('') +
              (data.skippedRows.length > 10 ? `<li class="text-gray-400">... ู ${data.skippedRows.length - 10} ุฃุฎุฑู</li>` : '') +
              '</ul></div>';
            detailsDiv.innerHTML += skippedHtml;
          }
          
          if (data.errorRows && data.errorRows.length > 0) {
            const errorsHtml = '<div class="mt-2"><p class="text-xs font-semibold text-red-700 mb-1">ุฃุฎุทุงุก:</p><ul class="text-xs text-gray-600 space-y-1">' +
              data.errorRows.slice(0, 10).map(e => 
                `<li>โข ุตู ${e.rowNumber}: ${e.reason}</li>`
              ).join('') +
              (data.errorRows.length > 10 ? `<li class="text-gray-400">... ู ${data.errorRows.length - 10} ุฃุฎุฑู</li>` : '') +
              '</ul></div>';
            detailsDiv.innerHTML += errorsHtml;
          }
          
          results937.classList.remove('hidden');
          
        } catch (err) {
          status937.textContent = 'ูุดู ุงูุฑูุน: ' + err.message;
          status937.className = 'text-red-600 text-sm';
        }
      });
    }
  </script>

  <!-- ูุธุงู ุงูุชุฑุฌูุฉ -->
  <script>
    // ุจูุงูุงุช ุงูุชุฑุฌูุฉ
    const translations = {
      ar: {
        // ุงูููุฏุฑ
        'nav-home': 'ุงูุฑุฆูุณูุฉ',
        'nav-dashboard': 'ููุญุฉ ุงูุชุญูู',
        'nav-profile': 'ูููู ุงูุดุฎุตู',
        'nav-about': 'ุญูู ุงููุธุงู',
        'nav-help': 'ุงููุณุงุนุฏุฉ',
        'nav-contact': 'ุงุชุตู ุจูุง',
        'language-button': '๐ English',
        
        // ูุญุชูู ุงูุตูุญุฉ
        'page-title': 'ุฅุฑูุงู ูููุงุช ุงูุฅูุณู',
        'page-subtitle': 'ุงุฎุชูุฑ ุงูููุน ุซู ุงุฑูุน ููู Excel (XLSX/XLS/CSV). ุงูุตูุญุฉ ุจููุณ ุชูุณูู ุงููุธุงู.',
        'section2-title': 'ุฅูุณู ุงูุฒุงุฆุฑ ุงูุณุฑู',
        'section3-title': 'ุฅูุณู ุงูุฃูุณุงู',
        'section4-title': 'ุฅูุณู ุจูุงุบุงุช 937',
        'template2-link': 'ุชูุฒูู ุงููุงูุจ',
        'template3-link': 'ุชูุฒูู ุงููุงูุจ',
        'template4-link': 'ุชูุฒูู ุงููุงูุจ',
        'upload2-btn': 'ุฑูุน ุงูููู',
        'upload3-btn': 'ุฑูุน ุงูููู',
        'upload4-btn': 'ุฑูุน ุงูููู',
        
        // ุงูููุชูุฑ
        'footer-org-name': 'ุชุฌูุน ููุฉ ุงูุตุญู',
        'footer-system-name': 'ูุธุงู ุงูุจูุงุบุงุช',
        'footer-description': 'ููุตุฉ ุฑุณููุฉ ูุชูุฏูู ููุชุงุจุนุฉ ุงูุจูุงุบุงุช',
        'footer-links-title': 'ุฑูุงุจุท ุณุฑูุนุฉ',
        'footer-link-home': 'ุงูุฑุฆูุณูุฉ',
        'footer-link-submit': 'ุชูุฏูู ุจูุงุบ',
        'footer-link-track': 'ูุชุงุจุนุฉ ุจูุงุบ',
        'footer-link-faq': 'ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ',
        'footer-contact-title': 'ูุนูููุงุช ุงูุชูุงุตู',
        'footer-support-number': 'ุฑูู ุงูุฏุนู: 0559735137',
        'footer-support-number-2': 'ุฑูู ุงูุฏุนู: 0542282550',
        'footer-support-email': 'support@makkahhealth.gov.sa',
        'footer-working-hours': 'ุณุงุนุงุช ุงูุนูู: 24/7',
        'footer-copyright': 'ยฉ 2025 ุชุฌูุน ููุฉ ุงูููุฑูุฉ ุงูุตุญู โ ุฌููุน ุงูุญููู ูุญููุธุฉ',
        
        // ูุชุงุฆุฌ ุงูุงุณุชูุฑุงุฏ
        'result-skipped-no-hospital': 'ุจุฏูู ููุดุฃุฉ',
        'result-depts-total': 'ุฅุฌูุงูู ุงูุตููู',
        'result-depts-inserted': 'ุชู ุงูุฅุฏุฎุงู',
        'result-depts-updated': 'ุชู ุงูุชุญุฏูุซ',
        'result-depts-skipped': 'ุชู ุงูุชุฎุทู',
        'result-depts-errors': 'ุฃุฎุทุงุก',
        'result-depts-details': 'ุชูุงุตูู ุงูุฃุฎุทุงุก'
      },
      en: {
        // ุงูููุฏุฑ
        'nav-home': 'Home',
        'nav-dashboard': 'Dashboard',
        'nav-profile': 'My Profile',
        'nav-about': 'About System',
        'nav-help': 'Help',
        'nav-contact': 'Contact Us',
        'language-button': '๐ ุงูุนุฑุจูุฉ',
        
        // ูุญุชูู ุงูุตูุญุฉ
        'page-title': 'Excel File Upload',
        'page-subtitle': 'Choose the type then upload Excel file (XLSX/XLS/CSV). Page uses same system format.',
        'section2-title': 'Mystery Shopper Excel',
        'section3-title': 'Departments Excel',
        'section4-title': '937 Complaints Excel',
        'template2-link': 'Download Template',
        'template3-link': 'Download Template',
        'template4-link': 'Download Template',
        'upload2-btn': 'Upload File',
        'upload3-btn': 'Upload File',
        'upload4-btn': 'Upload File',
        
        // ุงูููุชูุฑ
        'footer-org-name': 'Makkah Health Cluster',
        'footer-system-name': 'Complaint System',
        'footer-description': 'Official platform for filing and tracking complaints',
        'footer-links-title': 'Quick Links',
        'footer-link-home': 'Home',
        'footer-link-submit': 'Submit Complaint',
        'footer-link-track': 'Track Complaint',
        'footer-link-faq': 'FAQ',
        'footer-contact-title': 'Contact Information',
        'footer-support-number': 'Support Number: 0559735137',
        'footer-support-number-2': 'Support Number: 0542282550',
        'footer-support-email': 'support@makkahhealth.gov.sa',
        'footer-working-hours': 'Working Hours: 24/7',
        'footer-copyright': 'ยฉ 2025 Makkah Health Cluster โ All Rights Reserved',
        
        // ูุชุงุฆุฌ ุงูุงุณุชูุฑุงุฏ
        'result-skipped-no-hospital': 'No Facility',
        'result-depts-total': 'Total Rows',
        'result-depts-inserted': 'Inserted',
        'result-depts-updated': 'Updated',
        'result-depts-skipped': 'Skipped',
        'result-depts-errors': 'Errors',
        'result-depts-details': 'Error Details'
      }
    };

    // ุงูุญุงูุฉ ุงูุญุงููุฉ ููุบุฉ
    let currentLanguage = 'ar';

    // ุฏุงูุฉ ุชุทุจูู ุงูุชุฑุฌูุฉ
    function applyTranslation(lang) {
      const elements = translations[lang];
      if (!elements) return;

      // ุชุทุจูู ุงูุชุฑุฌูุฉ ุนูู ุฌููุน ุงูุนูุงุตุฑ
      Object.keys(elements).forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = elements[id];
        }
      });
      
      // ุชุทุจูู ุชุฑุฌูุฉ ุฎุงุตุฉ ูููุต ุฏุงุฎู ุงูุนูุตุฑ
      const skippedNoHospitalText = document.getElementById('result-skipped-no-hospital-text');
      if (skippedNoHospitalText && elements['result-skipped-no-hospital']) {
        skippedNoHospitalText.textContent = elements['result-skipped-no-hospital'];
      }

      // ุชุบููุฑ ุงุชุฌุงู ุงููุต
      if (lang === 'en') {
        document.documentElement.setAttribute('dir', 'ltr');
        document.documentElement.setAttribute('lang', 'en');
        // ุชุบููุฑ ูุญุงุฐุงุฉ ุงููุตูุต ููุนุฑุจูุฉ
        document.querySelectorAll('[id^="page"], [id^="section"]').forEach(el => {
          el.classList.remove('text-right', 'lg:text-right');
          el.classList.add('text-left', 'lg:text-left');
        });
      } else {
        document.documentElement.setAttribute('dir', 'rtl');
        document.documentElement.setAttribute('lang', 'ar');
        // ุงุณุชุนุงุฏุฉ ูุญุงุฐุงุฉ ุงููุตูุต ููุนุฑุจูุฉ
        document.querySelectorAll('[id^="page"], [id^="section"]').forEach(el => {
          el.classList.remove('text-left', 'lg:text-left');
          el.classList.add('text-right', 'lg:text-right');
        });
      }

      currentLanguage = lang;
    }

    // ุชููุฆุฉ ุงููุธุงู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
    document.addEventListener('DOMContentLoaded', function() {
      // ุชุทุจูู ุงููุบุฉ ุงููุญููุธุฉ ุฃู ุงูุงูุชุฑุงุถูุฉ
      const savedLanguage = localStorage.getItem('selectedLanguage') || 'ar';
      applyTranslation(savedLanguage);
      
      // ุฑุจุท ุฒุฑ ุงููุบุฉ
      const languageToggle = document.getElementById('languageToggle');
      if (languageToggle) {
        languageToggle.addEventListener('click', function() {
          const newLang = currentLanguage === 'ar' ? 'en' : 'ar';
          applyTranslation(newLang);
          localStorage.setItem('selectedLanguage', newLang);
        });
      }
    });
  </script>

  <!-- ุชุญููู ูุงุฆูุฉ ุงููุณุชุดููุงุช ููุฏูุฑ ุงูุชุฌูุน -->
  <script>
    async function loadHospitalsForSelect(){
      if (!isClusterManager()) return;
      const sel = document.getElementById('mysteryHospitalId');
      if (!sel) return;

      const token = localStorage.getItem('token') || localStorage.getItem('authToken');
      try {
        const res = await fetch('http://localhost:3001/api/central/hospitals?active=1', {
          headers: { 'Authorization': `Bearer ${token||''}` }
        });
        if (!res.ok) return; // ูู ุตุงุฑ ุฎุทุฃุ ูุชุฑููุง ูุงุถูุฉ

        const list = await res.json(); // [{HospitalID,NameAr,NameEn,Code}]
        const frag = document.createDocumentFragment();
        list.sort((a,b)=> (a.SortOrder??999)-(b.SortOrder??999) || a.NameAr.localeCompare(b.NameAr,'ar'));
        for (const h of list){
          const opt = document.createElement('option');
          opt.value = h.HospitalID;
          opt.textContent = `${h.NameAr || h.NameEn} ${h.Code ? '('+h.Code+')' : ''}`;
          frag.appendChild(opt);
        }
        sel.appendChild(frag);
      } catch (error) {
        console.error('Error loading hospitals:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      if (isClusterManager()) {
        document.getElementById('mysteryExtra')?.classList.remove('hidden');
        loadHospitalsForSelect();
      }
    });
  </script>

  <!-- ุชุญููู ูุต ุชูุฑูุฑ ุงูุฒุงุฆุฑ ุงูุณุฑู -->
  <script>
    // โโโโโ ุชุญููู ูุต ุงูุฒุงุฆุฑ ุงูุณุฑู โโโโโ
    function parseMysteryText(raw) {
      if (!raw) return { unappliedCount: 0, itemCount: 0, repetitionSum: 0 };

      const text = raw.replace(/\r/g, '').trim();

      // 1) ูุญุงููุฉ ุงูุชูุงุท ุฑูู ูู ุณุทุฑ ูุณุชูู ูุจู ุงูุนููุงู
      // ูุซุงูู ูุญุชูู "29" ูู ุณุทุฑ ูููุตู ูุจู ุณุทุฑ "ุงูููุงุญุธุงุช ุงูุบูุฑ ูุทุจูุฉ..."
      let unappliedCount = 0;
      const lines = text.split('\n').map(l => l.trim()).filter(Boolean);

      // ุงูุชูุท ุฃูู ุฑูู ูุธูุฑ ูู ุณุทุฑ ูุณุชูู
      for (let i = 0; i < Math.min(5, lines.length); i++) {
        const m = lines[i].match(/^\s*(\d+)\s*$/);
        if (m) { unappliedCount = parseInt(m[1], 10); break; }
        // ุฃู ุฑูู ุฏุงุฎู ุณุทุฑ ุนููุงู ูุญุชูู ุนุจุงุฑุฉ "ุงูููุงุญุธุงุช ุงูุบูุฑ ูุทุจูุฉ"
        if (/ุงูููุงุญุธุงุช\s+ุงูุบูุฑ\s+ูุทุจูุฉ/i.test(lines[i])) {
          const m2 = lines[i].match(/(\d+)/);
          if (m2) { unappliedCount = parseInt(m2[1], 10); break; }
        }
      }

      // 2) ุนุฏู ุงูุจููุฏ (ุงูุณุทุฑ ุงูุฐู ูุจุฏุฃ ุจู "ูู ")
      const itemLines = lines.filter(l => /^ูู\s/.test(l));
      const itemCount = itemLines.length;

      // 3) ูุฌููุน "ุนุฏุฏ ุงูุชูุฑุงุฑ = n"
      let repetitionSum = 0;
      const repRegex = /ุนุฏุฏ\s*ุงูุชูุฑุงุฑ\s*=\s*(\d+)/g;
      let m;
      while ((m = repRegex.exec(text)) !== null) {
        repetitionSum += parseInt(m[1], 10);
      }

      // ูู ุญุงู ูุง ูุฏุฑ ููุชูุท ุงูุฑูู ุงูุฑุฆูุณูุ ูุญุท ุจุฏูู ููุทูู
      if (!unappliedCount) {
        // ุจุฏูู: ุงุนุชุจุฑ ุนุฏุฏ ุงูุจููุฏ ูู ุนุฏุฏ ุงูููุงุญุธุงุช (ุฃุถุนู ุงูุฅููุงู)
        unappliedCount = itemCount;
      }

      return { unappliedCount, itemCount, repetitionSum };
    }

    function renderMysteryStats(stats) {
      const c1 = document.getElementById('mysteryUnappliedCount');
      const c2 = document.getElementById('mysteryItemsCount');
      const c3 = document.getElementById('mysteryRepetitionSum');
      if (c1) c1.textContent = stats.unappliedCount || 0;
      if (c2) c2.textContent = stats.itemCount || 0;
      if (c3) c3.textContent = stats.repetitionSum || 0;
    }

    // ุฒุฑ "ุชุญููู ุงููุต"
    document.getElementById('btnAnalyzeMysteryText')?.addEventListener('click', () => {
      const raw = document.getElementById('mysteryRawText')?.value || '';
      const stats = parseMysteryText(raw);
      renderMysteryStats(stats);
    });

    // ุชุญุฏูุซ ูุจุงุดุฑ ุฃุซูุงุก ุงููุชุงุจุฉ (ุงุฎุชูุงุฑู)
    document.getElementById('mysteryRawText')?.addEventListener('input', (e) => {
      const stats = parseMysteryText(e.target.value);
      renderMysteryStats(stats);
    });

    // โโโ ุฏูุฌ ุงูููู ูุน ุฑูุน ุฅูุณู ุงูุฒุงุฆุฑ ุงูุณุฑู โโโ
    // ููุนุฏููู wireForm ุจุญูุซ ุฅุฐุง ูุงู endpoint mystery ูุถูู ุงููุต ูุงูููู
    (function patchWireFormForMystery() {
      const _origWireForm = wireForm;
      window.wireForm = function(formId, statusId, endpoint) {
        _origWireForm(formId, statusId, endpoint);

        // ูููู ุนูู submit ูุฑุฉ ุซุงููุฉ ูุฅุถุงูุฉ ุงูุญููู ุฅุฐุง ูุงู Mystery
        const form = document.getElementById(formId);
        if (!form || !endpoint.includes('/imports/mystery')) return;

        // ูุญุชุงุฌ ุงุนุชุฑุงุถ ุงูุฅุฑุณุงู: ูุจุญุซ ุนู ุงูู listener ุงููุถุงู ุณุงุจูุงูุ
        // ุฃุจุณุท ุญู: ูุถูู Listener ูุจู ุงูุฅุฑุณุงู ููุญูู ุญููู ุฅุถุงููุฉ ูู ุงูู FormData
        // ูุฐูู ุณูุณุชุฎุฏู "submit" ุจุงูุชูุงุท (capture) ุฃุนูู ุงูุณูุณูุฉ:
        form.addEventListener('submit', function onSubmitInject(ev) {
          // ูุญูู ุนุจุฑ "requestIdleCallback" ุจุนุฏ ุฃู ููุฌููุฒ ุงูู FormData ูู ุงููุนุงูุฌ ุงูุฃุตูู.
          requestIdleCallback(() => {
            const raw = document.getElementById('mysteryRawText')?.value || '';
            const stats = parseMysteryText(raw);

            // ูุฃููุง ูุง ูููู ุงูู FormData ุงูุฃุตูู ููุงุ ุณูุฑุณููุง ูุฑุฉ ุฃุฎุฑู ุฏุงุฎู wireForm ุงูุฃุตูู ููุง ููุนู append.
            // ุงูุญู ุงูุนููู: ูุฎุฒูู ุงูููู ูุคูุชุงู ุนูู window ูููุฑุฃูุง ุงููุนุงูุฌ ุงูุฃุตูู ูุจู fetch.
            window.__mysteryExtraPayload__ = {
              rawText: raw,
              unappliedCount: stats.unappliedCount,
              itemCount: stats.itemCount,
              repetitionSum: stats.repetitionSum,
            };
          }, { timeout: 0 });
        }, true);
      };

      // ูุนุฏูู ุงุณุชุฏุนุงุก wireForm ุงูุฃุตูู ุฃุฏูุงู ูุชุฌููุน ุงูููู ูุจู fetch
      const origFetch = window.fetch;
      window.fetch = async function(input, init) {
        try {
          if (typeof input === 'string'
              && input.includes('/api/imports/mystery')
              && init && init.body instanceof FormData) {

            const extra = window.__mysteryExtraPayload__;
            if (extra) {
              init.body.append('mysteryRawText', extra.rawText || '');
              init.body.append('unappliedCount', String(extra.unappliedCount || 0));
              init.body.append('mysteryItemCount', String(extra.itemCount || 0));
              init.body.append('mysteryRepetitionSum', String(extra.repetitionSum || 0));
              // ุชุฎููุต ูู ุงูุญูููุฉ ุจุนุฏ ุงูุงุณุชุฎุฏุงู
              delete window.__mysteryExtraPayload__;
            }
          }
        } catch(e) { /* ูุชุฑู ุงููetch ูููู ุนุงุฏู */ }
        return origFetch.apply(this, arguments);
      };
    })();

    // โโโโโ ุฏูุงู ุญูุธ ุงูููุฎุต โโโโโ
    // ูุณุงุนุฏ ููุฑุงุกุฉ ุนูุงุตุฑ ุงูุตูุญุฉ
    function qs(sel, root=document){ return root.querySelector(sel); }

    // ูุนูู ุฒุฑ ุงูุญูุธ ุฅุฐุง ุธูุฑุช ุฃุฑูุงู ูู ุงูุชุญููู
    function updateSaveButtonEnabled() {
      const count = parseInt(qs('#mysteryUnappliedCount')?.textContent || '0', 10);
      const btn = qs('#btnSaveMysterySummary');
      if (!btn) return;
      if (count > 0 || (qs('#mysteryRawText')?.value || '').trim().length > 0) {
        btn.disabled = false;
        btn.classList.remove('cursor-not-allowed','opacity-80');
      } else {
        btn.disabled = true;
        btn.classList.add('cursor-not-allowed','opacity-80');
      }
    }

    // ุงุณุชุฏุนู ูุฐุง ุจุนุฏ ูู ุชุญููู ูุชุบููุฑ ูู ุงููุต
    const _renderMysteryStats = renderMysteryStats;
    window.renderMysteryStats = function(stats){
      _renderMysteryStats(stats);
      updateSaveButtonEnabled();
    };
    document.getElementById('mysteryRawText')?.addEventListener('input', updateSaveButtonEnabled);

    // ุชุฌููุฒ ุจูุงูุงุช ุงูุญูุธ
    async function saveMysterySummary() {
      const statusEl = qs('#mysterySaveStatus');
      const rawText = (qs('#mysteryRawText')?.value || '').trim();

      // ุงูููู ุงูุฅูุฒุงููุฉ
      const ticket = qs('#mysteryTicket')?.value?.trim();
      const dateFrom = qs('#mysteryFrom')?.value;
      const dateTo = qs('#mysteryTo')?.value;

      // ุงููุณุชุดูู: ุฅู ููุชู ูุฏูุฑ ุงูุชุฌูุน ููุฑุฃู ูู ุงูุณููุชุ ุบูุฑ ุฐูู ูู ุงูุชููู/ุงูุณูุฑูุฑ
      const hospitalId = (isClusterManager() ? qs('#mysteryHospitalId')?.value : null);

      if (!ticket || !dateFrom || !dateTo) {
        statusEl.textContent = 'ุฑูู ุงูุชุฐูุฑุฉ ู(ูู/ุฅูู) ุฅูุฒุงููุฉ.';
        statusEl.className = 'mt-2 text-sm text-red-600';
        return;
      }
      if (isClusterManager() && !hospitalId) {
        statusEl.textContent = 'ุงุฎุชุฑ ุงููุณุชุดูู (ูุฃูู ูุฏูุฑ ุงูุชุฌูุน).';
        statusEl.className = 'mt-2 text-sm text-red-600';
        return;
      }
      if (!rawText) {
        statusEl.textContent = 'ุงูุตูู ุงููุต ูุจู ุงูุญูุธ.';
        statusEl.className = 'mt-2 text-sm text-red-600';
        return;
      }

      const API_BASE = localStorage.getItem('apiBaseUrl') || 'http://localhost:3001';

      const payload = {
        HospitalID: hospitalId ? Number(hospitalId) : undefined,
        TicketNumber: ticket,
        PeriodFrom: dateFrom,
        PeriodTo: dateTo,
        RawText: rawText
      };

      try {
        statusEl.textContent = 'ุฌุงุฑู ุงูุญูุธ ูุณุฌูุงุช ูุชุนุฏุฏุฉ...';
        statusEl.className = 'mt-2 text-sm text-gray-600';

        const token = localStorage.getItem('token') || localStorage.getItem('authToken') || '';
        const resp = await fetch(`${API_BASE}/api/mystery-complaints/bulk-from-text`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(token ? { 'Authorization': `Bearer ${token}` } : {})
          },
          body: JSON.stringify(payload)
        });

        const data = await resp.json().catch(()=> ({}));
        if (!resp.ok) throw new Error(data?.message || `HTTP ${resp.status}`);

        statusEl.textContent = `ุชู ุญูุธ ${data.inserted || 0} ุณุทุฑ ูุณุฌูุงุช ูููุตูุฉ.`;
        statusEl.className = 'mt-2 text-sm text-green-600';
      } catch (err) {
        statusEl.textContent = 'ูุดู ุงูุญูุธ: ' + (err.message || err);
        statusEl.className = 'mt-2 text-sm text-red-600';
      }
    }

    // ุญุฏุซ ุฒุฑ ุงูุญูุธ
    document.getElementById('btnSaveMysterySummary')?.addEventListener('click', saveMysterySummary);
  </script>

  <!-- ูุธุงู ุญูุงูุฉ ุงูุตูุญุงุช -->
  <script src="../public/assets/js/auth-check.js"></script>

  <!-- ูุธุงู ุญูููุฉ ุงูุตูุงุญูุงุช -->
  <script>
    (async function applyImportsPermissions(){
      const API_BASE = (location.hostname==='localhost'||location.hostname==='127.0.0.1') ? 'http://localhost:3001' : '';
      const token = localStorage.getItem('token') || localStorage.getItem('authToken') || '';

      const res = await fetch(`${API_BASE}/api/auth/me-permissions`, {
        headers: { 'Accept':'application/json', ...(token?{Authorization:`Bearer ${token}`}:{}) },
        credentials: 'include'
      }).catch(()=>null);

      if (!res || !res.ok) return; // ูู ูุง ูุฏุฑ ูุฌูุจ ูุฎูููุง ุชุธูุฑ ุงูุชุฑุงุถูุงู (ุฃู ุชุฎูู)

      const me = await res.json();
      const imp = me.imports || {};

      // ุณูุงุดู ุงูุตูุญุฉ (ุญุณุจ ูููู imports.html)
      const secMystery = document.querySelector('section h2#section2-title')?.closest('section');
      const secDepts   = document.querySelector('section h2#section3-title')?.closest('section');
      const sec937     = document.querySelector('section h2#section4-title')?.closest('section');

      // 1) ุฅู ูู ูููู IMPORTS_PAGE ุฃุฎูู ุงูุตูุญุฉ ูููุง
      if (!imp.importsPage) {
        document.querySelector('main')?.classList.add('opacity-50', 'pointer-events-none');
        // ุฃู redirect:
        // location.href = 'index.html';
      }

      // 2) ูู ุณูุดู ููุญุฏู
      if (secMystery) {
        secMystery.style.display = imp.importMystery ? '' : 'none';
        // ุชุฃูููุงู: ุนุทููู ููุฑู ุงูุฑูุน ุฅู ูุง ุนูุฏู ุฅุฐู
        secMystery.querySelectorAll('form input, form button').forEach(el=> el.disabled = !imp.importMystery);
      }

      if (secDepts) {
        secDepts.style.display = imp.importDepartments ? '' : 'none';
        secDepts.querySelectorAll('form input, form button').forEach(el=> el.disabled = !imp.importDepartments);
      }

      if (sec937) {
        sec937.style.display = imp.import937 ? '' : 'none';
        sec937.querySelectorAll('form input, form button').forEach(el=> el.disabled = !imp.import937);
      }
    })();
  </script>
</body>
</html>
