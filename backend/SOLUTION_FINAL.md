# ุงูุญู ุงูููุงุฆู ููุดููุฉ ุงููุงุนุฏุฉ ุงููุฑูุฒูุฉ

## ๐ฏ ุงููุดููุฉ ุงูุญููููุฉ

ูู ุฑุณุงุฆู console:
```javascript
RoleID: 1  // โ ูุฏูุฑ ุชุฌูุน (SUPER_ADMIN)
isClusterManager: true
```

### **ุงูุณุจุจ:**
ุนูุฏูุง ูููู ุงููุณุชุฎุฏู **ูุฏูุฑ ุชุฌูุน** (`RoleID = 1` ุฃู `4`)ุ ุฏุงูุฉ `getContextualPool` ุชุฑุฌุน **ุงููุงุนุฏุฉ ุงููุฑูุฒูุฉ** ุจุฏูุงู ูู ูุงุนุฏุฉ ุงููุณุชุดูู!

```javascript
// ูู config/db.js
const ADMIN_ROLES = [1, 4];

if (ADMIN_ROLES.includes(roleId)) {  // โ roleId = 1
  const requestedHospitalId = req?.query?.hospitalId;
  if (requestedHospitalId) {
    return await getHospitalPool(requestedHospitalId);
  }
  // โ ููุง ุงููุดููุฉ - ูุฑุฌุน ุงููุงุนุฏุฉ ุงููุฑูุฒูุฉ
  return centralDb;  
}
```

### **ุงููุดููุฉ ุงูุซุงููุฉ:**
ุงููุฑููุช ุฅูุฏ **ูุง ูุฑุณู** `hospitalId` ูู URL:
```javascript
// โ ุงูุทูุจ ุงูุญุงูู
http://localhost:3001/api/complaints/history?page=1&pageSize=9&scope=department

// โ ุงูููุฑูุถ ูููู
http://localhost:3001/api/complaints/history?page=1&pageSize=9&scope=department&hospitalId=11
```

## โ ุงูุญู ุงููุทุจู

### **1. ูู `routes/complaints.js`:**

**ูุจู ุงูุฅุตูุงุญ:**
```javascript
const hospitalPool = await getContextualPool(req.user);  // โ ูุฑุฌุน centralDb
```

**ุจุนุฏ ุงูุฅุตูุงุญ:**
```javascript
// ูุณุชุฎุฏู HospitalID ูู ุงููุณุชุฎุฏู ูุจุงุดุฑุฉ
const hospitalId = req.user.HospitalID;
const hospitalPool = await getHospitalPool(hospitalId);  // โ ูุฑุฌุน hosp_aaaa
```

### **2. Import ุงููุทููุจ:**
```javascript
import { centralDb, getContextualPool, getHospitalPool } from '../config/db.js';
```

## ๐งช ุงูุงุฎุชุจุงุฑ

### **1. ุฃุนุฏ ุชุดุบูู ุงูุจุงู-ุฅูุฏ:**
```bash
cd backend
npm start
```

### **2. ุงูุชุญ ุณุฌู ุงูุจูุงุบุงุช:**
- ุณุฌู ุฏุฎูู ููุณุชุฎุฏู 20 (RoleID: 1)
- ุงูุชุญ ุณุฌู ุงูุจูุงุบุงุช

### **3. ุงูุฑุณุงุฆู ุงููุชููุนุฉ:**
```
โ [getHospitalPool] ุชู ุฅูุดุงุก ุงุชุตุงู ููุงุนุฏุฉ: hosp_aaaa
๐ [HISTORY] ุงููุณุชุฎุฏู: { UserID: 20, HospitalID: 11, RoleID: 1 }
๐ [HISTORY] ูุงุนุฏุฉ ุงูุจูุงูุงุช: hosp_aaaa
๐ [HISTORY] ูุนุฑู ุงููุณุชุดูู: 11
๐ [HISTORY] ุงูุตูุงุญูุงุช ุงูููุฌูุฏุฉ: [{...}, ...]
๐ [HISTORY] ูุทุงู ุงูุตูุงุญูุฉ: DEPARTMENT
๐ข [HISTORY] ุชุทุจูู ููุชุฑ ุงููุณู: 2
```

### **4. ุงููุชูุฌุฉ:**
- โ ูุง ููุฌุฏ ุฎุทุฃ `hospitals_mecca3.user_permissions`
- โ ุงููุธุงู ููุฑุฃ ูู `hosp_aaaa.user_permissions`
- โ ููุชุฑ ุงููุณู ูุนูู ุจุดูู ุตุญูุญ
- โ ุงููุณุชุฎุฏู ูุฑู ุจูุงุบุงุช ุงููุณู 2 ููุท

## ๐ ููุฎุต ุงูุชุบููุฑุงุช

### **ุงููููุงุช ุงููุนุฏูุฉ:**
1. โ `backend/routes/complaints.js`:
   - ุฅุถุงูุฉ import ูู `getHospitalPool`
   - ุงุณุชุฎุฏุงู `getHospitalPool(req.user.HospitalID)` ุจุฏูุงู ูู `getContextualPool`

2. โ `backend/config/db.js`:
   - ุฅุถุงูุฉ `_dbName` ู `_hospitalId` ููุชุดุฎูุต
   - ุฑุณุงุฆู console ููุชุดุฎูุต

### **ููุงุฐุง ูุฐุง ุงูุญู ุฃูุถู:**
1. โ **ุจุณูุท**: ูุง ูุญุชุงุฌ ุชุบููุฑ ุงููุฑููุช ุฅูุฏ
2. โ **ูุจุงุดุฑ**: ูุณุชุฎุฏู `HospitalID` ูู ุงูุชููู ูุจุงุดุฑุฉ
3. โ **ุขูู**: ูุทุจู ุงูุตูุงุญูุงุช ูู ูุงุนุฏุฉ ุงููุณุชุดูู ุงูุตุญูุญุฉ
4. โ **ูุนูู ููุฌููุน**: ูุฏูุฑูู ูููุธููู ุนุงุฏููู

## ๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

ุงูุขู:
- โ **ุงููุฏูุฑูู** ููุฑุคูู ุงูุตูุงุญูุงุช ูู ูุงุนุฏุฉ ูุณุชุดูุงูู
- โ **ุงูููุธููู ุงูุนุงุฏููู** ููุฑุคูู ุงูุตูุงุญูุงุช ูู ูุงุนุฏุฉ ูุณุชุดูุงูู
- โ **ููุชุฑ ุงููุณู** ูุนูู ููุฌููุน
- โ **ุงููุธุงู ุขูู ููุญูู**

## โ๏ธ ููุงุญุธุฉ ูููุฉ

ุฅุฐุง ุฃุฑุงุฏ ุงููุฏูุฑ ุฑุคูุฉ ุจูุงุบุงุช **ุฌููุน ุงููุณุชุดููุงุช**ุ ูุญุชุงุฌ ุงููุฑููุช ุฅูุฏ ูุฅุฑุณุงู `?hospitalId=` ูู URLุ ุฃู ุญุฐู ุดุฑุท ุงูุตูุงุญูุงุช ูููุฏูุฑูู.

ููู ุงูุญู ุงูุญุงูู ูุฌุนู ุงููุฏูุฑูู ูุฑูู ุจูุงุบุงุช ูุณุชุดูุงูู ููุท (ูุน ุชุทุจูู ุตูุงุญูุงุชูู).
