# ุฅุตูุงุญ ุนูููุงุช ุณูุฉ ุงููุญุฐููุงุช

## ๐ **ุงููุดููุฉ**
ูุงูุช ุนูููุงุช ุงูุงุณุชุฑุฌุงุน (Restore) ูุงูุญุฐู ุงูููุงุฆู (Purge) ูุง ุชุนูู ุจุดูู ุตุญูุญ:

1. **ุงูุงุณุชุฑุฌุงุน:** ูุงู ูุญุงูู ุชุญุฏูุซ ุฌุฏูู `complaints` ูู ุงููุงุนุฏุฉ ุงููุฑูุฒูุฉ ุจุฏูุงู ูู ูุงุนุฏุฉ ุงููุณุชุดูู
2. **ุงูุญุฐู ุงูููุงุฆู:** ูุงู ูุญุฐู ูู `trash_bin` ููุท ุฏูู ุญุฐู ุงูุจูุงุบ ูุนููุงู ูู ูุงุนุฏุฉ ุงููุณุชุดูู
3. **ุนุฏู ุชุญุฏูุซ ุงูุญููู:** ูู ุชูู ุงูุญููู `IsDeleted`, `DeletedAt`, `DeletedByUserID`, `DeleteReason` ุชูุญุฏุซ ุจุดูู ุตุญูุญ

## ๐ง **ุงูุญู ุงููุทุจู**

### 1๏ธโฃ **ุฅุตูุงุญ ููุทู ุงูุงุณุชุฑุฌุงุน (Restore)**

#### **ุงููุดููุฉ ุงูุณุงุจูุฉ:**
```javascript
// ูุงู ูุญุงูู ุชุญุฏูุซ ุงููุงุนุฏุฉ ุงููุฑูุฒูุฉ
await central.query(
  `UPDATE ${table} 
   SET IsDeleted = 0, 
       DeletedAt = NULL, 
       DeletedByUserID = NULL, 
       DeleteReason = NULL 
   WHERE ${primaryKey} = ?`,
  [item.EntityID]
);
```

#### **ุงูุญู ุงูุฌุฏูุฏ:**
```javascript
// โ ุงูุจูุงุบุงุช ููุฌูุฏุฉ ูู ูุงุนุฏุฉ ุงููุณุชุดููุ ููุณ ุงููุงุนุฏุฉ ุงููุฑูุฒูุฉ
if (table === 'complaints') {
  // ุฌูุจ ุงุชุตุงู ูุงุนุฏุฉ ุงููุณุชุดูู
  const { getHospitalPool } = await import('../config/db.js');
  const hospitalPool = await getHospitalPool(item.HospitalID);
  
  // ุงุณุชุฑุฌุงุน ุงูุจูุงุบ ูู ูุงุนุฏุฉ ุงููุณุชุดูู
  await hospitalPool.query(
    `UPDATE complaints 
     SET IsDeleted = 0, 
         DeletedAt = NULL, 
         DeletedByUserID = NULL, 
         DeleteReason = NULL 
     WHERE ComplaintID = ?`,
    [item.EntityID]
  );
  
  console.log(`โ [RESTORE] ุชู ุงุณุชุฑุฌุงุน ุงูุจูุงุบ ${item.EntityID} ูู ูุงุนุฏุฉ ุงููุณุชุดูู ${item.HospitalID}`);
}
```

### 2๏ธโฃ **ุฅุตูุงุญ ููุทู ุงูุญุฐู ุงูููุงุฆู (Purge)**

#### **ุงููุดููุฉ ุงูุณุงุจูุฉ:**
```javascript
// ูุงู ูุญุฐู ูู trash_bin ููุท
await central.query(`DELETE FROM trash_bin WHERE TrashID=?`, [trashId]);
```

#### **ุงูุญู ุงูุฌุฏูุฏ:**
```javascript
// ุญุฐู ููุงุฆู ููุนูุตุฑ ุญุณุจ ููุนู
if (table === 'complaints') {
  // โ ุงูุจูุงุบุงุช ููุฌูุฏุฉ ูู ูุงุนุฏุฉ ุงููุณุชุดูู
  const { getHospitalPool } = await import('../config/db.js');
  const hospitalPool = await getHospitalPool(item.HospitalID);
  
  // ุญุฐู ุงูุจูุงุบ ููุงุฆูุงู ูู ูุงุนุฏุฉ ุงููุณุชุดูู
  await hospitalPool.query(
    `DELETE FROM complaints WHERE ComplaintID = ?`,
    [item.EntityID]
  );
  
  // ุญุฐู ุงููุฑููุงุช ูุงูุฑุฏูุฏ ุงูุชุงุจุนุฉ (ุงุฎุชูุงุฑู)
  try {
    await hospitalPool.query(
      `DELETE FROM complaint_responses WHERE ComplaintID = ?`,
      [item.EntityID]
    );
    console.log(`๐๏ธ [PURGE] ุชู ุญุฐู ุฑุฏูุฏ ุงูุจูุงุบ ${item.EntityID}`);
  } catch (e) {
    console.log(`โ๏ธ [PURGE] ูู ูุชู ุญุฐู ุฑุฏูุฏ ุงูุจูุงุบ: ${e.message}`);
  }
  
  try {
    await hospitalPool.query(
      `DELETE FROM attachments WHERE ComplaintID = ?`,
      [item.EntityID]
    );
    console.log(`๐๏ธ [PURGE] ุชู ุญุฐู ูุฑููุงุช ุงูุจูุงุบ ${item.EntityID}`);
  } catch (e) {
    console.log(`โ๏ธ [PURGE] ูู ูุชู ุญุฐู ูุฑููุงุช ุงูุจูุงุบ: ${e.message}`);
  }
  
  console.log(`โ [PURGE] ุชู ุญุฐู ุงูุจูุงุบ ${item.EntityID} ููุงุฆูุงู ูู ูุงุนุฏุฉ ุงููุณุชุดูู ${item.HospitalID}`);
}

// ุชุญุฏูุซ ุณุฌู ุงูุณูุฉ ูุชุณุฌูู ููุช ุงูุญุฐู ุงูููุงุฆู
await central.query(
  `UPDATE trash_bin 
   SET PurgedAt = NOW(),
       PurgedByUserID = ?,
       Notes = CONCAT(COALESCE(Notes, ''), ' | ุชู ุงูุญุฐู ุงูููุงุฆู ูู ุงููุธุงู')
   WHERE TrashID = ?`,
  [req.user?.UserID || null, trashId]
);
```

### 3๏ธโฃ **ุฅุตูุงุญ ุชูุฑูุบ ุงูุณูุฉ (Empty Trash)**

#### **ุงููุดููุฉ ุงูุณุงุจูุฉ:**
```javascript
// ูุงู ูุญุฐู ูู trash_bin ููุท
const [result] = await central.query(`DELETE FROM trash_bin WHERE HospitalID=?`, [hospitalId]);
```

#### **ุงูุญู ุงูุฌุฏูุฏ:**
```javascript
// ุฌูุจ ุฌููุน ุงูุนูุงุตุฑ ูู ุงูุณูุฉ ูุจู ุงูุญุฐู
const [items] = await central.query(
  `SELECT TrashID, EntityType, EntityTable, EntityID 
   FROM trash_bin 
   WHERE HospitalID = ? AND PurgedAt IS NULL AND RestoredAt IS NULL`,
  [hospitalId]
);

let deletedCount = 0;
let purgedCount = 0;

// ุญุฐู ูู ุนูุตุฑ ููุงุฆูุงู
for (const item of items) {
  try {
    if (item.EntityTable === 'complaints') {
      // ุญุฐู ุงูุจูุงุบ ูู ูุงุนุฏุฉ ุงููุณุชุดูู
      const { getHospitalPool } = await import('../config/db.js');
      const hospitalPool = await getHospitalPool(hospitalId);
      
      // ุญุฐู ุงูุจูุงุบ ููุงุฆูุงู
      await hospitalPool.query(
        `DELETE FROM complaints WHERE ComplaintID = ?`,
        [item.EntityID]
      );
      
      // ุญุฐู ุงููุฑููุงุช ูุงูุฑุฏูุฏ ุงูุชุงุจุนุฉ
      try {
        await hospitalPool.query(
          `DELETE FROM complaint_responses WHERE ComplaintID = ?`,
          [item.EntityID]
        );
      } catch (e) {
        console.log(`โ๏ธ [EMPTY] ูู ูุชู ุญุฐู ุฑุฏูุฏ ุงูุจูุงุบ ${item.EntityID}: ${e.message}`);
      }
      
      try {
        await hospitalPool.query(
          `DELETE FROM attachments WHERE ComplaintID = ?`,
          [item.EntityID]
        );
      } catch (e) {
        console.log(`โ๏ธ [EMPTY] ูู ูุชู ุญุฐู ูุฑููุงุช ุงูุจูุงุบ ${item.EntityID}: ${e.message}`);
      }
      
      purgedCount++;
    }
    
    // ุชุญุฏูุซ ุณุฌู ุงูุณูุฉ
    await central.query(
      `UPDATE trash_bin 
       SET PurgedAt = NOW(),
           PurgedByUserID = ?,
           Notes = CONCAT(COALESCE(Notes, ''), ' | ุชู ุงูุญุฐู ุงูููุงุฆู ูู ุงููุธุงู (ุชูุฑูุบ ุงูุณูุฉ)')
       WHERE TrashID = ?`,
      [req.user?.UserID || null, item.TrashID]
    );
    
    deletedCount++;
    
  } catch (error) {
    console.error(`ุฎุทุฃ ูู ุญุฐู ุงูุนูุตุฑ ${item.EntityID}:`, error);
    // ูุณุชูุฑ ูุน ุงูุนูุงุตุฑ ุงูุฃุฎุฑู
  }
}
```

## ๐ **ููู ูุนูู ุงููุธุงู ุงูุฌุฏูุฏ**

### **ุชุฏูู ุงูุงุณุชุฑุฌุงุน (Restore):**

1. **ุงูุชุญูู ูู ุงูุตูุงุญูุงุช:** ุงูุชุฃูุฏ ูู ุฃู ุงููุณุชุฎุฏู ููููู ุงููุตูู ูููุณุชุดูู
2. **ุฌูุจ ูุนูููุงุช ุงูุนูุตุฑ:** ูู ุฌุฏูู `trash_bin` ูู ุงููุงุนุฏุฉ ุงููุฑูุฒูุฉ
3. **ุชุญุฏูุซ ูุงุนุฏุฉ ุงููุณุชุดูู:** 
   - ุฅุฐุง ูุงู ุงูุนูุตุฑ `complaints`: ุชุญุฏูุซ `IsDeleted=0` ูู ูุงุนุฏุฉ ุงููุณุชุดูู
   - ุฅุฐุง ูุงู ุนูุตุฑ ุขุฎุฑ: ุชุญุฏูุซ ูู ุงููุงุนุฏุฉ ุงููุฑูุฒูุฉ
4. **ุชุญุฏูุซ ุณุฌู ุงูุณูุฉ:** ุชุณุฌูู `RestoredAt` ู `RestoredByUserID` ูู `trash_bin`

### **ุชุฏูู ุงูุญุฐู ุงูููุงุฆู (Purge):**

1. **ุงูุชุญูู ูู ุงูุตูุงุญูุงุช:** ุงูุชุฃูุฏ ูู ุฃู ุงููุณุชุฎุฏู ููููู ุงููุตูู ูููุณุชุดูู
2. **ุฌูุจ ูุนูููุงุช ุงูุนูุตุฑ:** ูู ุฌุฏูู `trash_bin` ูู ุงููุงุนุฏุฉ ุงููุฑูุฒูุฉ
3. **ุญุฐู ูุนูู:**
   - ุฅุฐุง ูุงู ุงูุนูุตุฑ `complaints`: ุญุฐู ูู ูุงุนุฏุฉ ุงููุณุชุดูู + ุญุฐู ุงููุฑููุงุช ูุงูุฑุฏูุฏ
   - ุฅุฐุง ูุงู ุนูุตุฑ ุขุฎุฑ: ุญุฐู ูู ุงููุงุนุฏุฉ ุงููุฑูุฒูุฉ
4. **ุชุญุฏูุซ ุณุฌู ุงูุณูุฉ:** ุชุณุฌูู `PurgedAt` ู `PurgedByUserID` ูู `trash_bin`

### **ุชุฏูู ุชูุฑูุบ ุงูุณูุฉ (Empty Trash):**

1. **ุฌูุจ ุฌููุน ุงูุนูุงุตุฑ:** ูู `trash_bin` ูููุณุชุดูู ุงููุญุฏุฏ
2. **ุญุฐู ูู ุนูุตุฑ:** ุจุงุณุชุฎุฏุงู ููุณ ููุทู ุงูุญุฐู ุงูููุงุฆู
3. **ุชุญุฏูุซ ุงูุณุฌูุงุช:** ุชุณุฌูู ููุช ุงูุญุฐู ุงูููุงุฆู ููู ุนูุตุฑ
4. **ุฅุฑุฌุงุน ุงูุฅุญุตุงุฆูุงุช:** ุนุฏุฏ ุงูุนูุงุตุฑ ุงููุญุฐููุฉ ูุงููุญุฐููุฉ ููุงุฆูุงู

## ๐ **ูุซุงู ุนูู ุงูุงุณุชุฌุงุจุฉ ุงูุฌุฏูุฏุฉ**

### **ุงุณุชุฑุฌุงุน ูุงุฌุญ:**
```json
{
  "ok": true,
  "success": true,
  "message": "ุชู ุงุณุชุฑุฌุงุน ุงูุนูุตุฑ ุจูุฌุงุญ",
  "data": {
    "trashId": 123,
    "entityType": "COMPLAINT",
    "entityTitle": "ุจูุงุบ ุฑูู #456"
  }
}
```

### **ุญุฐู ููุงุฆู ูุงุฌุญ:**
```json
{
  "ok": true,
  "success": true,
  "message": "ุชู ุงูุญุฐู ุงูููุงุฆู ุจูุฌุงุญ",
  "data": {
    "trashId": 123,
    "entityType": "COMPLAINT",
    "entityTitle": "ุจูุงุบ ุฑูู #456"
  }
}
```

### **ุชูุฑูุบ ุงูุณูุฉ ูุงุฌุญ:**
```json
{
  "ok": true,
  "success": true,
  "message": "ุชู ุชูุฑูุบ ุงูุณูุฉ ุจูุฌุงุญ - ุชู ุญุฐู 5 ุนูุตุฑ ููุงุฆูุงู",
  "deletedCount": 5,
  "purgedCount": 5
}
```

## ๐ **ุงูุฃูุงู ูุงูุญูุงูุฉ**

### **ูุญุต ุงูุตูุงุญูุงุช:**
- ุงูุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ููููู ุงููุตูู ูููุณุชุดูู
- ููุน ุงููุตูู ููุนูุงุตุฑ ุงููุญุฐููุฉ ููุงุฆูุงู ุฃู ุงููุณุชุฑุฌุนุฉ

### **ุงูุญุฐู ุงูุชุณูุณูู:**
- ุญุฐู ุงูุจูุงุบ ุฃููุงู
- ุญุฐู ุงูุฑุฏูุฏ ุงูุชุงุจุนุฉ
- ุญุฐู ุงููุฑููุงุช ุงูุชุงุจุนุฉ
- ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ููู ุฎุทูุฉ

### **ุชุณุฌูู ุงูุนูููุงุช:**
- ุชุณุฌูู ููุช ุงูุงุณุชุฑุฌุงุน ูุงูุญุฐู ุงูููุงุฆู
- ุชุณุฌูู ุงููุณุชุฎุฏู ุงูุฐู ูุงู ุจุงูุนูููุฉ
- ุฅุถุงูุฉ ููุงุญุธุงุช ูู `Notes`

## ๐งช **ุงูุงุฎุชุจุงุฑ**

### **ููุงุฎุชุจุงุฑ:**
1. **ุชุฃูุฏ ูู ุชุดุบูู ุงูุฎุงุฏู:**
   ```bash
   cd backend
   node app.js
   ```

2. **ุงุฎุชุจุฑ ุงูุนูููุงุช:**
   ```bash
   node test-trash-operations.js
   ```

3. **ุงุฎุชุจุฑ ุงููุงุฌูุฉ:**
   - ุงุญุฐู ุจูุงุบ ูุคูุชุงู
   - ุฌุฑุจ ุงูุงุณุชุฑุฌุงุน
   - ุฌุฑุจ ุงูุญุฐู ุงูููุงุฆู
   - ุฌุฑุจ ุชูุฑูุบ ุงูุณูุฉ

## ๐ **ุงููููุงุช ุงููุญุฏุซุฉ**

1. **`backend/controllers/trashController.js`** - ุฅุตูุงุญ ููุทู ุงูุงุณุชุฑุฌุงุน ูุงูุญุฐู ุงูููุงุฆู
2. **`backend/test-trash-operations.js`** - ููู ุงุฎุชุจุงุฑ ุงูุนูููุงุช
3. **`backend/TRASH-OPERATIONS-FIX.md`** - ุชูุซูู ุงูุฅุตูุงุญุงุช

## ๐ฏ **ุงููุฒุงูุง ุงูุฌุฏูุฏุฉ**

### **ุงูุฏูุฉ:**
- ุงูุนูููุงุช ุชุญุฏุซ ูู ุงููุงุนุฏุฉ ุงูุตุญูุญุฉ
- ุชุญุฏูุซ ุฌููุน ุงูุญููู ุงููุทููุจุฉ
- ุญุฐู ูุนูู ููุจูุงูุงุช

### **ุงูุฃูุงู:**
- ูุญุต ุงูุตูุงุญูุงุช ูุจู ูู ุนูููุฉ
- ููุน ุงูุนูููุงุช ุงูููุฑุฑุฉ
- ุชุณุฌูู ุฌููุน ุงูุนูููุงุช

### **ุงูููุซูููุฉ:**
- ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุจุดูู ุตุญูุญ
- ุงูุญุฐู ุงูุชุณูุณูู ูููุฑููุงุช ูุงูุฑุฏูุฏ
- ุงุณุชูุฑุงุฑ ุงูุนูู ุญุชู ูู ูุดู ุนูุตุฑ ูุงุญุฏ

## ๐ **ููุงุญุธุงุช ูููุฉ**

1. **ูุงุนุฏุฉ ุงูุจูุงูุงุช:** ุงูุจูุงุบุงุช ููุฌูุฏุฉ ูู ูุงุนุฏุฉ ุงููุณุชุดููุ ููุณ ุงููุงุนุฏุฉ ุงููุฑูุฒูุฉ
2. **ุงูุญุฐู ุงูุชุณูุณูู:** ูุชู ุญุฐู ุงููุฑููุงุช ูุงูุฑุฏูุฏ ุงูุชุงุจุนุฉ ุชููุงุฆูุงู
3. **ุชุณุฌูู ุงูุนูููุงุช:** ุฌููุน ุงูุนูููุงุช ุชูุณุฌู ูู `trash_bin`
4. **ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:** ุงููุธุงู ูุณุชูุฑ ุญุชู ูู ูุดู ุญุฐู ูุฑูู ุฃู ุฑุฏ
5. **ุงูุตูุงุญูุงุช:** ูุฏูุฑู ุงูุชุฌูุน ูููููู ุงููุตูู ูุฌููุน ุงููุณุชุดููุงุช

## ๐ **ุงูุงุณุชุฎุฏุงู**

ุงููุธุงู ูุนูู ุจููุณ ุงูุทุฑููุฉ ุงูุณุงุจูุฉุ ููู ูุน:
- **ุนูููุงุช ุตุญูุญุฉ** ูู ุงููุงุนุฏุฉ ุงูููุงุณุจุฉ
- **ุญุฐู ูุนูู** ููุจูุงูุงุช
- **ุชุญุฏูุซ ุตุญูุญ** ูุฌููุน ุงูุญููู
- **ุชุณุฌูู ุดุงูู** ููุนูููุงุช

---

**โ ุชู ุฅุตูุงุญ ุนูููุงุช ุณูุฉ ุงููุญุฐููุงุช ุจูุฌุงุญ!**
