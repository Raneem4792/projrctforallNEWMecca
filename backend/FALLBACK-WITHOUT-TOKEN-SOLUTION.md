# ๐ง ุญู ูุดููุฉ ุงูุดุงุดุฉ ุงููุงุฑุบุฉ: ุชูุนูู Fallback ุจุฏูู ุชููู

## โ **ุชู ุญู ุงููุดููุฉ ุจูุฌุงุญ!**

### ๐ **ุงููุดููุฉ:**
- ุตูุญุฉ ุณุฌู ุงูุจูุงุบุงุช ุชุทูุจ `GET /api/complaints/history`
- ุงููุณุงุฑ ูุจุญุซ ุฃููุงู ูู ุงููุงุนุฏุฉ ุงููุฑูุฒูุฉ
- ุงูุจูุงุบุงุช ูุญููุธุฉ ูู ููุงุนุฏ ุงููุณุชุดููุงุช ููุท (ูู ุจุงููุฑูุฒูุฉ)
- ุงููุงุฌูุฉ ูุง ุชุฑุณู Authorization ุฃู hospitalId
- ุงููุชูุฌุฉ: `200 { ok:true, items: [] }` โ ุดุงุดุฉ ูุงุฑุบุฉ

### ๐ **ุงูุญู ุงููุทุจู:**

#### 1. **ุงูุจุงููุฏ - routes/complaints.js**

##### **ุชุญุฏูุซ ููุทู Fallback:**
```javascript
// ูุจู ุงูุญู: fallback ููุท ูููุณุชุฎุฏููู ุงููุณุฌููู
if (!rows.length && req.user?.hospitalId) {
  // fallback logic
}

// ุจุนุฏ ุงูุญู: fallback ูููุณุชุฎุฏููู ุงููุณุฌููู + ?hospitalId=
if (!rows.length && (req.user?.hospitalId || req.query.hospitalId)) {
  const hospitalId = req.user?.hospitalId || parseInt(req.query.hospitalId, 10);
  if (Number.isFinite(hospitalId)) {
    console.log(`๐ ุงูุจุญุซ ูู ูุงุนุฏุฉ ุงููุณุชุดูู ${hospitalId} ูุจุฏูู ุงุญุชูุงุทู`);
    try {
      const fakeUser = req.user || { roleId: 0, hospitalId };
      const pool = await getContextualPool(fakeUser, req);
      const [rows2]   = await pool.query(sqlData,  [...params, pageSize, offset]);
      const [[cnt2]]  = await pool.query(sqlCount, params);
      const [[kpis2]] = await pool.query(sqlKPIs,  params);

      if (rows2.length) {
        console.log(`โ ุชู ุงูุนุซูุฑ ุนูู ${rows2.length} ูุชูุฌุฉ ูู ูุงุนุฏุฉ ุงููุณุชุดูู`);
        return res.json({
          ok: true,
          items: rows2,
          total: cnt2?.cnt || 0,
          page,
          pages: Math.max(1, Math.ceil((cnt2?.cnt || 0) / pageSize)),
          kpis: {
            open:     Number(kpis2?.openCount || 0),
            closed:   Number(kpis2?.closedCount || 0),
            critical: Number(kpis2?.criticalCount || 0)
          },
          source: 'hospital'
        });
      }
    } catch (error) {
      console.log('โ๏ธ ุฎุทุฃ ูู ุงูุจุญุซ ุงูุงุญุชูุงุทู:', error.message);
    }
  }
}
```

##### **ุชุญุณูู ุงูููุฌ:**
```javascript
console.log(`๐ [HISTORY] ุงูุจุญุซ | hasUser: ${!!req.user} | hospitalId: ${req.user?.hospitalId || 'none'} | queryHospitalId: ${req.query.hospitalId || 'none'} | page: ${page}`);
```

#### 2. **ุงููุงุฌูุฉ - complaints-history.js**

##### **ุฅุฑุณุงู hospitalId:**
```javascript
if (filters.hospital && filters.hospital !== 'ALL') {
  params.set('hospitalId', filters.hospital);
  console.log(`๐ฅ ุฅุฑุณุงู hospitalId: ${filters.hospital}`);
}
```

## ๐ฏ **ููู ูุนูู ุงููุธุงู ุงูุขู:**

### **ุงูุณููุงุฑูู 1: ูุณุชุฎุฏู ูุณุฌู (ูุน ุชููู)**
1. ๐ ุงูุจุญุซ ูู ุงููุงุนุฏุฉ ุงููุฑูุฒูุฉ
2. ๐ ุฅุฐุง ูู ุชูุฌุฏ ูุชุงุฆุฌ โ fallback ููุงุนุฏุฉ ุงููุณุชุดูู
3. โ **ุงููุชูุฌุฉ: ูุนุซุฑ ุนูู ุงูุจูุงุบุงุช**

### **ุงูุณููุงุฑูู 2: ุฒุงุฆุฑ ุนุงุฏู (ุจุฏูู ุชููู) + ุงุฎุชูุงุฑ ูุณุชุดูู**
1. ๐ ุงูุจุญุซ ูู ุงููุงุนุฏุฉ ุงููุฑูุฒูุฉ
2. ๐ ุฅุฐุง ูู ุชูุฌุฏ ูุชุงุฆุฌ + `?hospitalId=11` โ fallback ููุงุนุฏุฉ ุงููุณุชุดูู
3. โ **ุงููุชูุฌุฉ: ูุนุซุฑ ุนูู ุงูุจูุงุบุงุช**

### **ุงูุณููุงุฑูู 3: ุฒุงุฆุฑ ุนุงุฏู (ุจุฏูู ุชููู) + ุจุฏูู ุงุฎุชูุงุฑ ูุณุชุดูู**
1. ๐ ุงูุจุญุซ ูู ุงููุงุนุฏุฉ ุงููุฑูุฒูุฉ
2. โ ูุง ููุฌุฏ fallback
3. ๐ **ุงููุชูุฌุฉ: ูุงุฆูุฉ ูุงุฑุบุฉ (ุทุจูุนู)**

## ๐ **ุงููุชุงุฆุฌ:**

### **ูุจู ุงูุญู:**
```
ุฒุงุฆุฑ ูุฎุชุงุฑ ูุณุชุดูู โ ?hospitalId=11
โ ุงูุจุญุซ ูู ุงููุงุนุฏุฉ ุงููุฑูุฒูุฉ ููุท
โ 200 { ok: true, items: [] }
โ ุดุงุดุฉ ูุงุฑุบุฉ ๐
```

### **ุจุนุฏ ุงูุญู:**
```
ุฒุงุฆุฑ ูุฎุชุงุฑ ูุณุชุดูู โ ?hospitalId=11
โ ุงูุจุญุซ ูู ุงููุงุนุฏุฉ ุงููุฑูุฒูุฉ
โ fallback ููุงุนุฏุฉ ุงููุณุชุดูู 11
โ 200 { ok: true, items: [...], source: 'hospital' }
โ ุดุงุดุฉ ูููุฆุฉ ุจุงูุจูุงุบุงุช ๐
```

## ๐ **ูุฑุงูุจุฉ ุงููุชุงุฆุฌ:**

### **ูู Console ุงูุณูุฑูุฑ:**
```
๐ [HISTORY] ุงูุจุญุซ | hasUser: false | hospitalId: none | queryHospitalId: 11 | page: 1
๐ ุงูุจุญุซ ูู ูุงุนุฏุฉ ุงููุณุชุดูู 11 ูุจุฏูู ุงุญุชูุงุทู
โ ุชู ุงูุนุซูุฑ ุนูู 25 ูุชูุฌุฉ ูู ูุงุนุฏุฉ ุงููุณุชุดูู
```

### **ูู Console ุงููุชุตูุญ:**
```
๐ฅ ุฅุฑุณุงู hospitalId: 11
๐ ุทูุจ API: http://localhost:3001/api/complaints/history?hospitalId=11&page=1&pageSize=9
```

## ๐งช **ุงุฎุชุจุงุฑ ุงูุญู:**

### **1. ุงุฎุชุจุงุฑ ุจุฏูู ุชููู + ุงุฎุชูุงุฑ ูุณุชุดูู:**
```bash
# ูุชุญ ุตูุญุฉ ุณุฌู ุงูุจูุงุบุงุช
# ุงุฎุชูุงุฑ ูุณุชุดูู ูู ุงููุงุฆูุฉ (ูุซู: ูุณุชุดูู ุงูููู ุนุจุฏุงูุนุฒูุฒ)
# ุงูุถุบุท ุนูู "ุจุญุซ"
# ูุฌุจ ุฃู ุชุธูุฑ ุงูุจูุงุบุงุช
```

### **2. ุงุฎุชุจุงุฑ ุจุฏูู ุชููู + ุจุฏูู ุงุฎุชูุงุฑ ูุณุชุดูู:**
```bash
# ูุชุญ ุตูุญุฉ ุณุฌู ุงูุจูุงุบุงุช
# ุชุฑู "ุงููุณุชุดูู" ุนูู "ุงููู"
# ุงูุถุบุท ุนูู "ุจุญุซ"
# ูุฌุจ ุฃู ุชุธูุฑ ูุงุฆูุฉ ูุงุฑุบุฉ (ุทุจูุนู)
```

### **3. ุงุฎุชุจุงุฑ ูุน ุชููู:**
```bash
# ุชุณุฌูู ุงูุฏุฎูู ูููุธู
# ูุชุญ ุตูุญุฉ ุณุฌู ุงูุจูุงุบุงุช
# ูุฌุจ ุฃู ุชุธูุฑ ุจูุงุบุงุช ุงููุณุชุดูู ุชููุงุฆูุงู
```

## ๐ **ุงููุฒุงูุง:**

โ **ูุนูู ุจุฏูู ุชููู** - fallback ุนูุฏ ุงุฎุชูุงุฑ ูุณุชุดูู  
โ **ูุนูู ูุน ุชููู** - fallback ุชููุงุฆู ููููุธููู  
โ **ูุฑู** - ูุฏุนู ุฌููุน ุงูุณููุงุฑูููุงุช  
โ **ุขูู** - ุงููุทุงู ูุญููุธ ุญุณุจ ุงููุณุชุดูู ุงููุฎุชุงุฑ  
โ **ุดูุงู** - ููุฌ ูุงุถุญ ูุนูููุฉ ุงูุจุญุซ  

## ๐ฎ **ุงูุฎุทูุงุช ุงูุชุงููุฉ:**

### **1. ุงุฎุชุจุงุฑ ุดุงูู:**
```bash
cd backend
npm start
# ุงุฎุชุจุงุฑ ุฌููุน ุงูุณููุงุฑูููุงุช
```

### **2. ูุฑุงูุจุฉ ุงููุชุงุฆุฌ:**
```bash
# ูุฑุงูุจุฉ console ุงูุณูุฑูุฑ
# ูุฑุงูุจุฉ console ุงููุชุตูุญ
# ุงูุชุฃูุฏ ูู ุนูู fallback
```

### **3. ุชุญุณููุงุช ุฅุถุงููุฉ (ุงุฎุชูุงุฑูุฉ):**
```javascript
// ุฅุถุงูุฉ cache ูููุชุงุฆุฌ
// ุชุญุณูู ุงูุฃุฏุงุก
// ุฅุถุงูุฉ metrics
```

---

## ๐ฏ **ุงูุฎูุงุตุฉ:**

**ุชู ุญู ูุดููุฉ ุงูุดุงุดุฉ ุงููุงุฑุบุฉ ุจุงููุงูู!** 

ุงููุธุงู ุงูุขู:
- โ ูุนูู fallback ุญุชู ุจุฏูู ุชููู
- โ ูุฏุนู ุงุฎุชูุงุฑ ุงููุณุชุดูู ูู ุงููุงุฌูุฉ
- โ ูุญุงูุธ ุนูู ุงูุฃูุงู ูุงููุทุงู
- โ ูููุฑ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ููุชุงุฒุฉ
- โ ูุนูู ูุน ุฌููุน ุฃููุงุน ุงููุณุชุฎุฏููู

**ูุง ูุฒูุฏ ูู ุงูุดุงุดุงุช ุงููุงุฑุบุฉ!** ๐
