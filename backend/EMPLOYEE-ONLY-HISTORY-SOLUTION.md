# ๐ฏ ุญู ุณุฌู ุงูุจูุงุบุงุช ููููุธููู ููุท

## โ **ุชู ุชุทุจูู ุงูุญู ุจูุฌุงุญ!**

### ๐ **ุงููุฏู:**
ุฌุนู "ุณุฌู ุงูุจูุงุบุงุช" ูุฎุตุต ููููุธููู ููุทุ ุญูุซ ูุดุงูุฏ ูู ููุธู ุจูุงุบุงุช ูุณุชุดูุงู ููุทุ ุจุฏูู ุฅููุงููุฉ ุงุฎุชูุงุฑ ูุณุชุดูู ุขุฎุฑ.

## ๐ **ุงูุชุบููุฑุงุช ุงููุทุจูุฉ:**

### 1. **ุงูุจุงููุฏ - routes/complaints.js**

#### **ุชุบููุฑ ูู `optionalAuth` ุฅูู `requireAuth`:**
```javascript
// ูุจู:
router.get('/history', optionalAuth, async (req, res) => {

// ุจุนุฏ:
router.get('/history', requireAuth, async (req, res) => {
```

#### **ุชุญุฏูุซ ููุทู fallback:**
```javascript
// ูู ูุง ููู ูุชุงุฆุฌ ุจุงููุฑูุฒูุฉ โ ุงุณุชุฎุฏู ูุงุนุฏุฉ ูุณุชุดูู ุงูููุธู ุฅุฌุจุงุฑููุง
if (!rows.length) {
  console.log(`๐ ุงูุจุญุซ ูู ูุงุนุฏุฉ ุงููุณุชุดูู ${req.user.hospitalId} ูุจุฏูู ุงุญุชูุงุทู`);
  try {
    const pool = await getContextualPool(req.user, req); // ูุณุชุดูู ุงููุณุชุฎุฏู
    const [rows2] = await pool.query(sqlData, [...params, pageSize, offset]);
    // ... ุจุงูู ุงูููุทู
    return res.json({
      ok: true,
      source: 'hospital',
      items: rows2,
      // ...
    });
  } catch (error) {
    console.log('โ๏ธ ุฎุทุฃ ูู ุงูุจุญุซ ุงูุงุญุชูุงุทู:', error.message);
  }
}
```

### 2. **ุงูุจุงููุฏ - middleware/auth.js**

#### **ุชุญุฏูุซ `hospitalScopeSQL` ููููู ุฅุฌุจุงุฑู:**
```javascript
export function hospitalScopeSQL(user, alias='c', req=null) {
  const SUPER_ADMIN = 1;
  const CLUSTER_MANAGER = 4;

  if (!user) return { where: ' AND 1=0 ', params: [] }; // ุจูุง ุฃู /history ุงูุขู requireAuth

  if ([SUPER_ADMIN, CLUSTER_MANAGER].includes(user.roleId)) {
    // ูุฏูุฑ ุงูุชุฌูุน / ุณูุจุฑ: ูุฑู ุงููู ุฃู ูุญุฏุฏ hospitalId ุงุฎุชูุงุฑููุง
    if (req) {
      const hid = parseInt(req.query.hospitalId || '', 10);
      if (!Number.isNaN(hid)) return { where: ` AND ${alias}.HospitalID = ? `, params: [hid] };
    }
    return { where: '', params: [] };
  }

  // ููุธู ูุณุชุดูู: ุฅุฌุจุงุฑู ุนูู ูุณุชุดูุงู ููุท
  return { where: ` AND ${alias}.HospitalID = ? `, params: [user.hospitalId] };
}
```

### 3. **ุงููุงุฌูุฉ - complaints-history.js**

#### **ุฅุฒุงูุฉ ุฅุฑุณุงู `hospitalId`:**
```javascript
// ูุจู:
if (filters.hospital && filters.hospital !== 'ALL') {
  params.set('hospitalId', filters.hospital);
  console.log(`๐ฅ ุฅุฑุณุงู hospitalId: ${filters.hospital}`);
}

// ุจุนุฏ:
// ูุง ูุฑุณู hospitalId - ุงูุณูุฑูุฑ ูุญุฏุฏู ูู ุงูุชููู
```

### 4. **ุงููุงุฌูุฉ - complaints-history.html**

#### **ุฅุฎูุงุก ููุชุฑ ุงููุณุชุดูู:**
```html
<!-- ูุจู: -->
<div>
  <label>ุงููุณุชุดูู</label>
  <select id="fHospital">
    <option value="ALL">ุงููู</option>
    <option value="11">ูุณุชุดูู ุงูููู ุนุจุฏุงูุนุฒูุฒ</option>
    <!-- ... -->
  </select>
</div>

<!-- ุจุนุฏ: -->
<div class="hidden">
  <!-- ููุชุฑ ุงููุณุชุดูู ูุฎูู ููููุธููู - ุงูุณูุฑูุฑ ูุญุฏุฏู ูู ุงูุชููู -->
  <label>ุงููุณุชุดูู</label>
  <select id="fHospital">
    <!-- ... -->
  </select>
</div>
```

## ๐ฏ **ููู ูุนูู ุงููุธุงู ุงูุขู:**

### **ููููุธููู (ูุน ุชููู):**
1. ๐ **ุชุณุฌูู ุฏุฎูู ุฅุฌุจุงุฑู** - `requireAuth`
2. ๐ฅ **ูุทุงู ุงููุณุชุดูู ุฅุฌุจุงุฑู** - `AND c.HospitalID = ?`
3. ๐ **ุงูุจุญุซ ูู ุงููุงุนุฏุฉ ุงููุฑูุฒูุฉ** ุฃููุงู
4. ๐ **fallback ุฅุฌุจุงุฑู** ููุงุนุฏุฉ ุงููุณุชุดูู ุฅุฐุง ูู ุชูุฌุฏ ูุชุงุฆุฌ
5. โ **ุงููุชูุฌุฉ: ุจูุงุบุงุช ุงููุณุชุดูู ููุท**

### **ูููุฏูุฑูู (ูุน ุชููู):**
1. ๐ **ุชุณุฌูู ุฏุฎูู ุฅุฌุจุงุฑู** - `requireAuth`
2. ๐ **ูุทุงู ููุชูุญ** - ูููู ุฑุคูุฉ ุฌููุน ุงููุณุชุดููุงุช
3. ๐ฅ **ุงุฎุชูุงุฑู** - ูููู ุชุญุฏูุฏ ูุณุชุดูู ูุนูู ุจู `?hospitalId=`
4. โ **ุงููุชูุฌุฉ: ุฌููุน ุงูุจูุงุบุงุช ุฃู ูุณุชุดูู ูุญุฏุฏ**

### **ููุฒูุงุฑ (ุจุฏูู ุชููู):**
1. โ **ููููุน** - `requireAuth` ูููุน ุงููุตูู
2. ๐ซ **ูุง ูููู ุงููุตูู** ูุตูุญุฉ ุณุฌู ุงูุจูุงุบุงุช
3. โ **ุงููุชูุฌุฉ: 401 Unauthorized**

## ๐ **ุงููุชุงุฆุฌ:**

### **ูุจู ุงูุญู:**
```
ุฒุงุฆุฑ โ ูููู ุงููุตูู โ ุดุงุดุฉ ูุงุฑุบุฉ
ููุธู โ ูููู ุงุฎุชูุงุฑ ูุณุชุดูู ุขุฎุฑ โ ูุดููุฉ ุฃูููุฉ
```

### **ุจุนุฏ ุงูุญู:**
```
ุฒุงุฆุฑ โ 401 Unauthorized โ ููููุน
ููุธู โ ูุณุชุดูุงู ููุท โ ุขูู ููุญุฏูุฏ
ูุฏูุฑ โ ุฌููุน ุงููุณุชุดููุงุช โ ูุฑููุฉ ุฅุฏุงุฑูุฉ
```

## ๐ **ูุฑุงูุจุฉ ุงููุชุงุฆุฌ:**

### **ูู Console ุงูุณูุฑูุฑ:**
```
๐ [HISTORY] ุงูุจุญุซ | hospitalId: 11 | roleId: 2 | page: 1
๐ ุงูุจุญุซ ูู ูุงุนุฏุฉ ุงููุณุชุดูู 11 ูุจุฏูู ุงุญุชูุงุทู
โ ุชู ุงูุนุซูุฑ ุนูู 25 ูุชูุฌุฉ ูู ูุงุนุฏุฉ ุงููุณุชุดูู
```

### **ูู Console ุงููุชุตูุญ:**
```
๐ ุฅุฑุณุงู ุงูุชููู ูุน ุทูุจ ุณุฌู ุงูุจูุงุบุงุช
๐ ุทูุจ API: http://localhost:3001/api/complaints/history?page=1&pageSize=9
```

## ๐งช **ุงุฎุชุจุงุฑ ุงููุธุงู:**

### **1. ุงุฎุชุจุงุฑ ุงูููุธู:**
```bash
# ุชุณุฌูู ุงูุฏุฎูู ูููุธู ูุณุชุดูู
# ูุชุญ ุตูุญุฉ ุณุฌู ุงูุจูุงุบุงุช
# ูุฌุจ ุฃู ุชุธูุฑ ุจูุงุบุงุช ุงููุณุชุดูู ููุท
# ูุง ูุฌุจ ุฃู ูุธูุฑ ููุชุฑ ุงููุณุชุดูู
```

### **2. ุงุฎุชุจุงุฑ ุงููุฏูุฑ:**
```bash
# ุชุณุฌูู ุงูุฏุฎูู ููุฏูุฑ ุชุฌูุน
# ูุชุญ ุตูุญุฉ ุณุฌู ุงูุจูุงุบุงุช
# ูุฌุจ ุฃู ุชุธูุฑ ุฌููุน ุงูุจูุงุบุงุช
# ูููู ุชุญุฏูุฏ ูุณุชุดูู ูุนูู ุจู ?hospitalId=11
```

### **3. ุงุฎุชุจุงุฑ ุงูุฒุงุฆุฑ:**
```bash
# ุจุฏูู ุชุณุฌูู ุฏุฎูู
# ูุญุงููุฉ ูุชุญ ุตูุญุฉ ุณุฌู ุงูุจูุงุบุงุช
# ูุฌุจ ุฃู ูุญุตู ุนูู 401 Unauthorized
```

## ๐ **ุงููุฒุงูุง:**

โ **ุฃูุงู ูุงูู** - ุงูููุธู ูุง ููููู ุฑุคูุฉ ุจูุงุบุงุช ูุณุชุดููุงุช ุฃุฎุฑู  
โ **ุจุณุงุทุฉ** - ูุง ุญุงุฌุฉ ูุงุฎุชูุงุฑ ูุณุชุดูู  
โ **ุชููุงุฆู** - ุงููุธุงู ูุญุฏุฏ ุงููุณุชุดูู ูู ุงูุชููู  
โ **ูุฑููุฉ ูููุฏูุฑูู** - ูููููู ุฑุคูุฉ ุฌููุน ุงููุณุชุดููุงุช  
โ **ููุน ุงููุตูู ููุฒูุงุฑ** - ูุฎุตุต ููููุธููู ููุท  

## ๐ฎ **ุงูุฎุทูุงุช ุงูุชุงููุฉ:**

### **1. ุงุฎุชุจุงุฑ ุดุงูู:**
```bash
cd backend
npm start
# ุงุฎุชุจุงุฑ ูุน ุฃููุงุน ูุฎุชููุฉ ูู ุงููุณุชุฎุฏููู
```

### **2. ูุฑุงูุจุฉ ุงููุชุงุฆุฌ:**
```bash
# ูุฑุงูุจุฉ console ุงูุณูุฑูุฑ
# ูุฑุงูุจุฉ console ุงููุชุตูุญ
# ุงูุชุฃูุฏ ูู ุนูู ุงููุทุงู ุงูุตุญูุญ
```

### **3. ุชุญุณููุงุช ุฅุถุงููุฉ (ุงุฎุชูุงุฑูุฉ):**
```javascript
// ุฅุถุงูุฉ ุตูุญุฉ ูููุตูุฉ ููุฏูุฑู ุงูุชุฌูุน
// ุชุญุณูู ูุงุฌูุฉ ุงููุฏูุฑูู
// ุฅุถุงูุฉ ุฅุญุตุงุฆูุงุช ููุตูุฉ
```

---

## ๐ฏ **ุงูุฎูุงุตุฉ:**

**ุชู ุชุทุจูู ุงูุญู ุจูุฌุงุญ!** 

"ุณุฌู ุงูุจูุงุบุงุช" ุงูุขู:
- โ ูุฎุตุต ููููุธููู ููุท
- โ ูู ููุธู ูุฑู ูุณุชุดูุงู ููุท
- โ ูุง ูููู ุงุฎุชูุงุฑ ูุณุชุดูู ุขุฎุฑ
- โ ุขูู ููุญุฏูุฏ
- โ ูุฑู ูููุฏูุฑูู

**ูุธุงู ุขูู ููุญุฏูุฏ ููููุธููู!** ๐
